name: Release Chaos Workers

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
        version:
          description: 'The version to be released'
          required: true
          default: '0.1.0'

jobs:
  after-release:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
          - run: |
              echo "Name: ${{ env.VERSION }}"
              echo "${{ secrets.DOCKER_GCR }}" > keyfile.json
              docker login -u _json_key --password-stdin https://gcr.io < keyfile.json
          - uses: actions/checkout@v2
          - name: Set up JDK 11
            uses: actions/setup-java@v2.4.0
            with:
              java-version: '11'
              distribution: 'adopt'
          #- name: Set release version
           # working-directory: chaos-workers/chaos-worker/
            #run: mvn versions:set "-DnewVersion=${{ github.event.release.name }}" -DgenerateBackupPoms=false
          #- name: Commit version 
            #run: |
              #git config user.name github-actions
              #git config user.email github-actions@github.com
              #git add .
              #git commit -m "Set release version to ${{ env.VERSION }}"
              #git push
          - name: Package with Maven
            run: mvn -B package -DskipTests -f chaos-workers/chaos-worker/pom.xml             
          - name: Build docker image   
            id: build-image
            working-directory: chaos-workers/
            env:
                DOCKER_BUILDKIT: 1
                REGISTRY: gcr.io
                REPOSITORY: zeebe-io/zeebe-chaos-worker
                IMAGE_TAG: ${{ env.VERSION }}
            run: |
                echo "${{ secrets.DOCKER_GCR }}" > keyfile.json
                docker login -u _json_key --password-stdin https://gcr.io < keyfile.json
                docker build . -t $REGISTRY/$REPOSITORY:latest -t $REGISTRY/$REPOSITORY:$IMAGE_TAG --build-arg TOKEN=${{ secrets.SA_TOKEN }}
                docker push $REGISTRY/$REPOSITORY:latest 
                docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
