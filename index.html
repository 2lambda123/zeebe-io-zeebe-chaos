<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Blog Atom Feed"><title data-react-helmet="true">Blog | Zeebe Chaos</title><meta data-react-helmet="true" property="og:title" content="Blog | Zeebe Chaos"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-react-helmet="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/" hreflang="x-default"><script data-react-helmet="true">function maybeInsertBanner(){window.__DOCUSAURUS_INSERT_BASEURL_BANNER&&insertBanner()}function insertBanner(){var n=document.getElementById("docusaurus-base-url-issue-banner-container");if(n){n.innerHTML='\n<div id="docusaurus-base-url-issue-banner" style="border: thick solid red; background-color: rgb(255, 230, 179); margin: 20px; padding: 20px; font-size: 20px;">\n   <p style="font-weight: bold; font-size: 30px;">Your Docusaurus site did not load properly.</p>\n   <p>A very common reason is a wrong site <a href="https://docusaurus.io/docs/docusaurus.config.js/#baseurl" style="font-weight: bold;">baseUrl configuration</a>.</p>\n   <p>Current configured baseUrl = <span style="font-weight: bold; color: red;">/zeebe-chaos/</span> </p>\n   <p>We suggest trying baseUrl = <span id="docusaurus-base-url-issue-banner-suggestion-container" style="font-weight: bold; color: green;"></span></p>\n</div>\n';var e=document.getElementById("docusaurus-base-url-issue-banner-suggestion-container"),s=window.location.pathname,r="/"===s.substr(-1)?s:s+"/";e.innerHTML=r}}window.__DOCUSAURUS_INSERT_BASEURL_BANNER=!0,document.addEventListener("DOMContentLoaded",maybeInsertBanner)</script><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.473f1099.css">
<link rel="preload" href="/zeebe-chaos/assets/js/runtime~main.3a2a0c9e.js" as="script">
<link rel="preload" href="/zeebe-chaos/assets/js/main.7c1e6c56.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div id="docusaurus-base-url-issue-banner-container"></div><div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2021</time> · 3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>It has been awhile since the last post, I&#x27;m happy to be back.</p><p>In today&#x27;s chaos day we want to verify the hypothesis from <a href="https://github.com/zeebe-io/zeebe-chaos/issues/34" target="_blank" rel="noopener noreferrer">zeebe-chaos#34</a> that old
clients can&#x27;t disrupt a running cluster.</p><p>It might happen that after upgrading your Zeebe to the newest shiny version, you might forget to
update some of your workers or starters etc. This should normally not an issue since Zeebe is
backwards compatible, client wise since 1.x. But what happens when older clients are used. Old
clients should not have a negative effect on a running cluster.</p><p><strong>TLDR</strong> Older clients (0.26) have no negative impact on a running cluster (1.2), and clients after
1.x are still working with the latest version. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>We will run a simple setup with, three nodes and three partitions (replication factor 3). The
version we use is the latest release candidate (1.2.0). Normally we run a load of 200 process
instances per second (pi/s) on our benchmarks. This time we will put a load of 100 pi/s to get
something running and start an old starter (v0.26.x) with the same frequency. Later we will scale
the old starter to see whether it makes any effect.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p>We expect that we can start and complete the 100 pi/s, since we can normally run 200 pi/s.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><p>The cluster was first started with starters of the same version, and we saw a stable load of ~100
process instances completed per second. After starting the old starters (with version 0.26.3), we
can&#x27;t observe any difference. </p><p>Interesting is even when scaling the starters up to 10 replicas, which means 1000 PI creations per
second, it doesn&#x27;t seem to make any effect. <em>Side note:</em> The
<a href="https://github.com/camunda-cloud/zeebe/tree/develop/benchmarks/project" target="_blank" rel="noopener noreferrer">starters</a> have been
modified, such they only start instances without deploying the model.</p><p><img alt="old26-general" src="/zeebe-chaos/assets/images/old26-general-1cbfdf95d7c9b19cad8ca10aa921f34b.png"></p><p>The drops we see in the processing are related to restart&#x27;s.</p><p>The gateway and grpc metrics doesn&#x27;t indicate that more requests are sent. </p><p><img alt="old26-grpc" src="/zeebe-chaos/assets/images/old26-grpc-b5da2bbcf038492c59dea93f36619e69.png">
<img alt="old26-gateway" src="/zeebe-chaos/assets/images/old26-gateway-dd4afa5333796343795b4d80ad498e6b.png"></p><p>If we take a look in the clients log, we can see that the request are failing because the RPC Method names have been changed between 0.26 and 1.0. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: UNIMPLEMENTED: Method not found: gateway_protocol.Gateway/CreateWorkflowInstance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: UNIMPLEMENTED: Method not found: gateway_protocol.Gateway/CreateWorkflowInstance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It seems this kind of &quot;old&quot; requests can be blocked quite early in the request chain to make no effect. </p><p>In order to experiment a bit further I created a starter image with version 1.0 to see whether this still works with our newest release candidate 1.2.</p><p>We can see in the metrics right after starting the starter that the throughput goes up and we can reach our 200 pi/s.</p><p><img alt="old10-general" src="/zeebe-chaos/assets/images/old10-general-90bb179937d9178c12b16f0cdea22281.png"></p><p>We run the benchmark overnight, and we haven&#x27;t seen any issues. Be aware that the throughput is calculated over the 24h which makes is lower than 200.</p><p><img alt="general" src="/zeebe-chaos/assets/images/general-67c5d494df6c66211457861139475c6c.png"></p><p>Furthermore, taking a look at the resource consumption, especially at the gateway, gives no evidence that something wrong is going on.</p><p><img alt="res" src="/zeebe-chaos/assets/images/res-951c069149e3ae14d08a997e6fe974b2.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p>We were able to confirm the hypothesis written in <a href="https://github.com/zeebe-io/zeebe-chaos/issues/34" target="_blank" rel="noopener noreferrer">zeebe-chaos#34</a>, that an old client can&#x27;t disrupt a running cluster. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="found-bugs"></a>Found Bugs<a class="hash-link" href="#found-bugs" title="Direct link to heading">#</a></h2><p>None this time :)</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-06T00:00:00.000Z" itemprop="datePublished">July 6, 2021</time> · 6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On a previous <a href="/zeebe-chaos/2020/10/06/toxi-proxy">Chaos Day</a> we played around with <a href="https://github.com/Shopify/toxiproxy" target="_blank" rel="noopener noreferrer">ToxiProxy</a> , which allows injecting failures on the network level. For example dropping packages, causing latency etc.</p><p>Last week <a href="https://github.com/deepthidevaki" target="_blank" rel="noopener noreferrer">@Deepthi</a> mentioned to me that we can do similar things with <a href="https://man7.org/linux/man-pages/man8/tc.8.html" target="_blank" rel="noopener noreferrer">tc</a>, which is a built-in linux command. Today I wanted to experiment with latency between leader and followers using <code>tc</code>.</p><p><strong>TL;DR;</strong> The experiment failed; With adding 100ms network delay to the Leader we broke the complete processing throughput. 💥</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>We want to experiment with network latency and what kind of effect has a slow network on the cluster. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="hypothesis"></a>Hypothesis<a class="hash-link" href="#hypothesis" title="Direct link to heading">#</a></h3><p>We expect that we can handle certain network latency, due to our heartbeat and election time timeouts. After, reaching the deadlines we expect fail overs and followers which are lagging behind.</p><p>This means under a certain threshold we should be able to still process user commands, with slightly delay but without real issues. After reaching the deadline and the fail overs, it should be possible to continue, since we will add only to one node the delay.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="experiment"></a>Experiment<a class="hash-link" href="#experiment" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="tc"></a>TC<a class="hash-link" href="#tc" title="Direct link to heading">#</a></h4><p>TC is a built in linux command, the manpage summarizes it as <code>tc - show / manipulate traffic control settings</code>.</p><p>In order to <a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener noreferrer">add delay to a network interface</a>, we can run the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev eth0 root netem delay 200ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>More details (<a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener noreferrer">taken from the blog post</a>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">qdisc: modify the scheduler (aka queuing discipline)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">add: add a new rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev eth0: rules will be applied on device eth0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root: modify the outbound traffic scheduler (aka known as the egress qdisc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">netem: use the network emulator to emulate a WAN property</span></span><span class="token-line" style="color:#393A34"><span class="token plain">delay: the network property that is modified</span></span><span class="token-line" style="color:#393A34"><span class="token plain">200ms: introduce delay of 200 ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Adding this kind of rule means that we add a delay to all outgoing connections, which are going over this network interface.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h4><p>In order to reduce the blast radius we will run the experiment with one partition on a three broker cluster (replication factor 3).</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="steady-state"></a>Steady State<a class="hash-link" href="#steady-state" title="Direct link to heading">#</a></h5><p> As we can see in the benchmark we are able to reach in avg. ~77 process instance creation and completions per second.</p><p><img alt="base" src="/zeebe-chaos/assets/images/general-18fcb0bda36206ab196aeb507a0c1eac.png"></p><p>The process instance execution time (from start to end) is under 1 second.
<img alt="base" src="/zeebe-chaos/assets/images/latency-50564f2ce63c84257c134178924d2c57.png"></p><p>The commit latency is about 100 ms.
<img alt="base" src="/zeebe-chaos/assets/images/commit-lat-9b72095b6933ef77b97f994ece9d17f9.png"></p><p>We can see that one of the followers is a bit lagging behind, but not too far.</p><p><img alt="base" src="/zeebe-chaos/assets/images/raft-follower-7e8113946fa0a082e57f5ae190a21baa.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="100-ms"></a>100 ms<a class="hash-link" href="#100-ms" title="Direct link to heading">#</a></h5><p>In the first iteration of the experiment we added a 100 ms delay to the leaders outgoing traffic. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos-day/ cluster: zeebe-cluster ns:zell-chaos-day]$ k exec -it zell-chaos-day-zeebe-gateway-579c76978f-npz2k -- zbctl status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - zell-chaos-day-zeebe-0.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Follower, Healthy  Broker 1 - zell-chaos-day-zeebe-1.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Follower, Healthy  Broker 2 - zell-chaos-day-zeebe-2.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader, Healthy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Based on the <code>zbctl</code> output, or the grafana dashboard we can find out who is the leader. Note that the output of <code>zbctl</code> looks still a bit broken, related issue <a href="https://github.com/camunda-cloud/zeebe/issues/6692" target="_blank" rel="noopener noreferrer">#6692</a>.</p><p>With the following commands we can add the delay of 100 ms to the leaders outgoing traffic.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos-day/ cluster: zeebe-cluster ns:zell-chaos-day]$ k exec -it zell-chaos-day-zeebe-2 -- bash</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-day-zeebe-2:/usr/local/zeebe# tc qdisc add dev eth0 root netem delay 100ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-day-zeebe-2:/usr/local/zeebe# tc -s qdisc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc noqueue 0: dev lo root refcnt 2 </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> backlog 0b 0p requeues 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc netem 8001: dev eth0 root refcnt 2 limit 1000 delay 100.0ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 11635496 bytes 10086 pkt (dropped 0, overlimits 0 requeues 0) </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> backlog 339773b 77p requeues 0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Almost immediately we see a drop in our general section of the Grafana Dashboard.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-general-a6a99e2144909bf47c029ebcd8543f33.png"></p><p>The backpressure increased significantly. As expected the commit latency increased.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-commit-lat-e9f2fb099ca82d84761ef6ffaca428db.png"></p><p>The processing latency as well.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-latency-85f7dc47d9d5606469244efc363cc638.png"></p><p>It was unexpected that the throughput breaks down so much. We can see in the send request that a lot of the requests are ended with timeouts or with resource exhausted.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-grpc-5c44c33e0cfa6d55da14c7cc5092c705.png">
<img alt="base" src="/zeebe-chaos/assets/images/100ms-gateway-767136da5cb5e9032275d4ee41b05fff.png"></p><p>Interesting is that no worker is able to activate nor complete any job. This cause increasing of the running process instances, so the state is growing.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-running-proc-8f4fadc0b12cf5ae463c8f82894c5cd5.png"></p><p>Taking a look at the raft metrics we see that this already caused some heartbeat misses, but no leader change.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-heartbeats-1b9a59af419679228f9d703afe1819e9.png"></p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-follower-93ff4bcec9b9cba018a65268f6f069d0.png"></p><p>The follower is now lagging far more behind. We can see in the logs that the Leader tries to send <code>InstallRequests</code>, but these are also timing out.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - InstallRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">currentTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1173627</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">chunkId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1744147670</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">nextChunkId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1283029304</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1083445787</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">initial</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false, </span><span class="token assign-left variable" style="color:#36acaa">complete</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: java.util.concurrent.TimeoutException: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">489616</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">raft-partition-partition-1-install, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zell-chaos-day-zeebe-2.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10647731</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1655826849</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-day-zeebe-1.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26502 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT5S&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The follower is starting regularly elections, but is not able to overturn the existing leader.</p><p>In general, in the Gateway logs we can see the start of the delay injection quite good. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:51.263195Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:53.264480Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.184981Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.213904Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.361408Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.986270Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:56.617134Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.072707Z Expected to handle gRPC request, but request timed out between gateway and broker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.126207Z Expected to handle gRPC request, but request timed out between gateway and broker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.157683Z Expected to handle gRPC request, but request timed out between gateway and broker</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Similar logs we see on the broker side.</p><p>In general, we can say the experiment failed. The cluster was not able to run our normal workload. It seem to behave quite bad, but there were no leader change at all.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="250-ms"></a>250 ms<a class="hash-link" href="#250-ms" title="Direct link to heading">#</a></h5><p>In order to verify whether 250 ms, will cause a leader election we reconfigured the delay. It looked quite similar, performance wise, but the heartbeats for one of the followers increased. Still it was not enough to cause a leader change.</p><p>After several minutes (~30) of running this configuration we were able to observe that one of the other followers missed heartbeats as well. This finally caused a leader change.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-raft-55d2027e863459de3a070d017e813d59.png"></p><p>The throughput came back, it was similar to what is was before.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-general-95e282a9fbe58ff95fe883e7d80c2739.png"></p><p>The processing execution latency was higher than usual.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-latency-0dd3474f142f7d3642605a2b8353186d.png"></p><p>Similar to the commit latency, interesting to see such an affect caused by a follower with network issues.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-commit-lat-0a8e3826a19cdea9b948f42fa639bd6f.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p>As written before the experiment failed, the hypothesis was not met. We were not able to add latency to the network, which is much lower than our deadlines (heartbeat timeout is 2.5 seconds), without causing any harm to our processing throughput/latency.</p><p>Still we had some interesting observations we can use for our next experiments and insight which we need to consider on setting up Zeebe in environment where the network might be unreliable/slow.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-08T00:00:00.000Z" itemprop="datePublished">June 8, 2021</time> · 8 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: <a href="https://github.com/zeebe-io/zeebe-chaos/issues/32" target="_blank" rel="noopener noreferrer">zeebe-chaos#32</a> and <a href="https://github.com/zeebe-io/zeebe-chaos/issues/14" target="_blank" rel="noopener noreferrer">zeebe-chaos#14</a>. This time <a href="https://github.com/korthout" target="_blank" rel="noopener noreferrer">@Nico</a> joined me.</p><p><strong>TL;DR</strong> The experiment was successful 💪 and we found several things in the dashboard which we can improve :)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>With this experiment we want to verify that Zeebe can recover after OOD, which was caused by not exporting to ELS. For that we want to disconnect Zeebe and ELS first and see how it behaves. Afterwards we connect the services again and expect a recovery of the system.</p><p>As usual, we have set up a normal benchmark cluster with three nodes, three partitions and replication factor three. We run 200 PI/s and 12 workers against that cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p>We expect the following properties:</p><ul><li>at the beginning the system is stable (we can start instances without issues)</li><li>after disconnecting ELS we start to fill the disk, since we can&#x27;t export (which means we can&#x27;t compact)</li><li>after reaching the disk limits, Zeebe doesn&#x27;t accept any commands anymore</li><li>after connecting ELS, Zeebe should start to export again (compacting should be possible again)</li><li>after come below the limit, Zeebe should accept commands again</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="network-disconnect-to-els"></a>Network disconnect to ELS<a class="hash-link" href="#network-disconnect-to-els" title="Direct link to heading">#</a></h4><p>In order to disconnect the Brokers with ELS, we wanted to reuse one of our network disconnect scripts, e.g. <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/disconnect-leaders.sh" target="_blank" rel="noopener noreferrer">disconnect-leaders.sh</a>. This resolves the IP&#x27;s of the brokers and creates an unreachable route via the <code>ip</code> tool at the given brokers.</p><p>We copied that and adjusted it to our needs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;elasticsearch-master&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic0Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-0&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic1Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-1&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic2Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-2&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Small note in order to run this against the benchmark cluster you need to set the following environment variables:</em></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">NAMESPACE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubens -c</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># the namespace where the resources are located</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">CHAOS_SETUP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">helm </span><span class="token comment" style="color:#999988;font-style:italic"># indicates that the installation is done via helm, necessary since we use different labels in the helm charts and in CC.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Running the script above didn&#x27;t work as expected. We still saw records being exported. The issue was that we need to use the service IP instead of the IP&#x27;s of the elastic search pods. The Broker uses only the service to connect with ELS. In order to get the IP we can use this <code>kubectl get services elasticsearch-master --template &quot;{{.spec.clusterIP}}&quot;</code>. </p><p>The service will take care of the request routing, which means we just need to block one IP. This helps to simplify the disconnect script.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;elasticsearch-master&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticServiceIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get services elasticsearch-master --template </span><span class="token variable string" style="color:#e3116c">&quot;{{.spec.clusterIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><p>In this section we will describe how we experienced the chaos experiment and what we observed. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="first-try"></a>First Try<a class="hash-link" href="#first-try" title="Direct link to heading">#</a></h4><p>We run the disconnect script and were able to observe that the exporting stopped. </p><p><img alt="elastic-disconnect" src="/zeebe-chaos/assets/images/elastic-disconnect-5638a32fadfab9b778b02fe14a1d3ed7.png"></p><p>As expected we were no longer able to compact, which cause an increasing of log segments.</p><p><img alt="increase-segments" src="/zeebe-chaos/assets/images/increase-segments-bd8431b8424f7c0b8fb0d44307c2ab42.png"></p><p>We realized that our current disk size might be too big (it would take a while until we fill it), so we decided to setup a new benchmark with smaller size and different watermarks.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGECOMMANDWATERMARK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.6&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGEREPLICATIONWATERMARK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.8&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># PVC</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcAccessMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ReadWriteOnce&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16Gi</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcStorageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ssd</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We thought that we might have different performance, because of such a smaller disk size, but this was not the case. We were able to reach the same level, might be worth to think about reducing the disk sizes more in our benchmarks.</p><p><img alt="base" src="/zeebe-chaos/assets/images/next-try-base-12b9f5871392bd43fe1f31224479aa6d.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="second-try"></a>Second Try<a class="hash-link" href="#second-try" title="Direct link to heading">#</a></h4><p><img alt="base1" src="/zeebe-chaos/assets/images/next-try-base1-649226bc28407a654bad7078dca639a0.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disconnecting"></a>Disconnecting<a class="hash-link" href="#disconnecting" title="Direct link to heading">#</a></h5><p>After running our disconnect script we can immediately see that the exporting is stopping.</p><p><img alt="drop-base" src="/zeebe-chaos/assets/images/next-try-drop-base-4fe3db248fb58bb7fdfef0b08e8b8cd1.png"></p><p>Interesting is the elastic section where we see one of our new panels in actions which shows the failure rate. There are two dots, which show the 100% failure rate.</p><p><img alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png"></p><p>After reaching our disk watermark we can see that the processing stops, and we no longer accept commands.</p><p><img alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png"></p><p>The cluster turns to unhealthy, which is expected.</p><p>Interesting is that we have no metrics at all on the gateway side after reaching the watermark.</p><p><img alt="drop-gw" src="/zeebe-chaos/assets/images/next-try-drop-gw-a0e7f885194b47559bb07c6ad46942d0.png"></p><p>We were able to verify that snapshots are still taken, but no compaction.</p><p><img alt="drop-snapshot" src="/zeebe-chaos/assets/images/next-try-drop-snapshot-d38bd5b1657f7b5a4fa763b26ebba239.png"></p><p>No segments are deleted during this time.</p><p><img alt="drop-segments" src="/zeebe-chaos/assets/images/next-try-drop-segments-3d49aaadb3d3455c25a920281a6c9595.png"></p><p>If we take a look at the processing section we can see that the exporters lag way behind, which of course makes sense.</p><p><img alt="drop-processing" src="/zeebe-chaos/assets/images/next-try-drop-processing-4dc3f1fafd42d2e6560cde27e53a3aa2.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="connecting"></a>Connecting<a class="hash-link" href="#connecting" title="Direct link to heading">#</a></h5><p>Luckily we were able to reuse on of our already written reconnect scripts for this experiment, see <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/connect-leaders.sh" target="_blank" rel="noopener noreferrer">connect-leaders.sh</a>.</p><p>After removing the ip route (connecting the Brokers with ELS again) we can see that it immediately starts to export again.</p><p><img alt="connect-base" src="/zeebe-chaos/assets/images/next-try-connect-base-dfe3501b990f198861825cec2fb00735.png"></p><p>When we went under the disk watermarks the processing started again and we accepted new commands.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p><img alt="connect-base2" src="/zeebe-chaos/assets/images/next-try-connect-base2-375310b94ccc02fe3333b76954351a44.png"></p><p><strong>The experiment was successful, our system was able to recover after an elastic network outage and handled it properly.</strong> ✅ 💪</p><p>We noted several issues with the Dashboard, during the chaos experiment observation. For example the Brokers, which went OOD, never went back to the <code>Healthy</code> state again.</p><p><img alt="connect-healthy" src="/zeebe-chaos/assets/images/next-try-connect-healthy-124040b24b536d608e5c1d94eebabbc6.png"></p><p>Furthermore, the not exported panel seems to be broken, depending on the selected time frame.</p><p><img alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png"></p><p>There have been also other issues with the panels and sections which we should take a look at. I have listed them below.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="possible-improvements"></a>Possible Improvements<a class="hash-link" href="#possible-improvements" title="Direct link to heading">#</a></h3><p>We observed several issues with the grafana dashboard which I wrote down here. I will create issues or PR&#x27;s to resolve them.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="general-metric-section"></a>General Metric Section<a class="hash-link" href="#general-metric-section" title="Direct link to heading">#</a></h4><p>If we take a look at the screenshot where we reach our disk watermarks, and the processing stops, the backpressure metrics are not correctly updated. We would expect that the backpressure shows 100%, since all requests are rejected.</p><p><img alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png"></p><p>After the cluster actually becomes healthy again (it accepts new commands) it is not shown as healthy in the panels. The metrics seems not to be updated.</p><p>Another possible improvement would be to make it more visible that the exporting stopped. One idea is to split the processing into exporting and processing, so having two graphs might help.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="processing-section"></a>Processing Section<a class="hash-link" href="#processing-section" title="Direct link to heading">#</a></h4><p>Depending on the time frame the panel <code>Number of records not exported</code>, seems to show quite high values.</p><p><img alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png"></p><p>If we take a look at other metrics, this doesn&#x27;t make any sense. If we had such a backlog we wouldn&#x27;t expect to compact to one segment for example. Furthemore the tables on the right side show numbers which are quite close to each other.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="elastic-metrics-section"></a>Elastic Metrics Section<a class="hash-link" href="#elastic-metrics-section" title="Direct link to heading">#</a></h4><p>We probably can improve the failure panel, such that it shows a graph, and the limit is not set to 130%.</p><p><img alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="grpc-metric-section"></a>GRPC Metric Section<a class="hash-link" href="#grpc-metric-section" title="Direct link to heading">#</a></h4><p>The panel <code>gRPC requests</code> should have an dec ordering on the tooltip and should be renamed to <code>Total gRPC requests</code> it was a bit confusing to us.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="throughput-section"></a>Throughput Section<a class="hash-link" href="#throughput-section" title="Direct link to heading">#</a></h4><p>The StreamProcessor vs Exporter panel has no data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="snapshot-section"></a>Snapshot Section<a class="hash-link" href="#snapshot-section" title="Direct link to heading">#</a></h4><p>We saw that snapshots are created, but the Snapshot replication panel show no data. It seem to be broken (again?).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="resources-section"></a>Resources Section<a class="hash-link" href="#resources-section" title="Direct link to heading">#</a></h4><p>The JVM panel has the legend on the right side, which makes it hard to see the metrics if you have multiple windows open on one screen.</p><p>{% if page.author %}<sup><em>Written by: {{page.author}}</em></sup>{% endif %}</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-05-25T00:00:00.000Z" itemprop="datePublished">May 25, 2021</time> · 9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://confluence.camunda.com/display/ZEEBE/Game+Day+18.05.2021" target="_blank" rel="noopener noreferrer">Recently we run a Game day</a> where a lot of messages with high TTL have been stored in the state. This was based on an earlier incident, which we had seen in production. One suggested approach to resolve that incident was to increase the time, such that all messages are removed from the state. This and the fact that summer and winter time shifts can cause in other systems evil bugs, we wanted to find out how our system can handle time shifts. <a href="https://github.com/saig0" target="_blank" rel="noopener noreferrer">Phil</a> joined me as participant and observer. There was a related issue which covers this topic as well, <a href="https://github.com/zeebe-io/zeebe-chaos/issues/3" target="_blank" rel="noopener noreferrer">zeebe-chaos#3</a>.</p><p><strong>TL;DR;</strong> Zeebe is able to handle time shifts back and forth, without observable issues. Operate seems to dislike it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>As part of the experiment we had to define what we expect, if we change the time. In order to keep it simple we decided to experiment with one-hour move forward and backwards. We wanted to run the experiment first against our normal benchmark cluster and afterwards against a Production - S Cluster on INT. Furthermore, we decided to test the time shift only on leaders, for now.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p><em>If we move the time one-hour forward we expect:</em></p><ul><li>in general, timers should be triggered (snapshot, message TTL, job timeouts, timers etc.)</li><li>the system should operate normal, means zeebe and operate should be healthy and continue working</li></ul><p><em>If we move the time one-hour backwards we expect:</em></p><ul><li>timers should not be triggered, until the deadline + 1 hour is reached</li><li>the system should operate normal</li><li>with operate we were not sure whether it has issues with exported records on the same time</li></ul><p>Before we started, with running the experiment, we had to find out how we can change the time in a docker container.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="changing-time"></a>Changing Time<a class="hash-link" href="#changing-time" title="Direct link to heading">#</a></h3><p><strong>*Note:</strong> If you&#x27;re not interested in how we change the time you can jump to the <a href="#experiment-on-benchmark-cluster">next section</a>*</p><p>If you search for it, you find quite quickly answers in how to change the time in a docker container. For example, we found this <a href="https://serverfault.com/a/898842/283059" target="_blank" rel="noopener noreferrer">answer</a>, which was quite useful.</p><p>In order to apply this, we first need to make sure that we have the right <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">linux capabilities</a> to change the system time. For that we need the <code>SYS_TIME</code> capability. In our benchmarks this is quite easy to do, we just need to change <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/default/zeebe-values.yaml#L16" target="_blank" rel="noopener noreferrer">this line</a> and add <code>SYS_TIME</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">podSecurityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;NET_ADMIN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SYS_TIME&quot;</span><span class="token punctuation" style="color:#393A34">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After changing this, we can set the time via <a href="https://man7.org/linux/man-pages/man1/date.1.html" target="_blank" rel="noopener noreferrer"><code>date -s</code></a>. Since we were not sure whether this really works for our java process, we started a <a href="https://docs.oracle.com/javase/9/tools/jshell.htm#JSWOR-GUID-C337353B-074A-431C-993F-60C226163F00" target="_blank" rel="noopener noreferrer"><code>jshell</code></a> to verify that. <em>Note:</em> the jshell is only available if you use an container image with jdk. This is available, if you build your own zeebe docker image via <a href="https://github.com/camunda-cloud/zeebe/blob/develop/createBenchmark.sh" target="_blank" rel="noopener noreferrer">zeebe/createBenchmark.sh</a>.</p><p>Changing the time:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# date</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May 25 10:29:33 UTC 2021</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# date +%T -s &quot;09:29:00&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">09:29:00</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# date</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May 25 09:29:01 UTC 2021</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# jshell</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Picked up JAVA_TOOL_OPTIONS: -XX:MaxRAMPercentage=25.0 -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/usr/local/zeebe/data -XX:ErrorFile=/usr/local/zeebe/data/zeebe_error%p.log -Xlog:gc*:file=/usr/local/zeebe/data/gc.log:time:filecount=7,filesize=8M</span></span><span class="token-line" style="color:#393A34"><span class="token plain">May 25, 2021 9:29:03 AM java.util.prefs.FileSystemPreferences$1 run</span></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO: Created user preferences directory.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Welcome to JShell -- Version 11.0.11</span></span><span class="token-line" style="color:#393A34"><span class="token plain">|  For an introduction type: /help intro</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; new Date()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$1 ==&gt; Tue May 25 09:29:08 UTC 2021</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After we found out how we can actually change the time we moved forward and run the described chaos experiment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="experiment-on-benchmark-cluster"></a>Experiment on Benchmark Cluster<a class="hash-link" href="#experiment-on-benchmark-cluster" title="Direct link to heading">#</a></h3><p>As usual, we have set up a normal benchmark cluster with three nodes, three partitions and replication factor three. We run 200 PI/s and 12 workers against that cluster.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="move-time-forward"></a>Move Time Forward<a class="hash-link" href="#move-time-forward" title="Direct link to heading">#</a></h4><p>After setting up the cluster we had to find out who is the Leader and picked the one who is Leader for the most of the partitions.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ k </span><span class="token builtin class-name">exec</span><span class="token plain"> -it zell-phil-chaos-zeebe-0 -- zbctl status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> - zell-phil-chaos-zeebe-0.zell-phil-chaos-zeebe.zell-phil-chaos.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain">.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> Follower, Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> Leader, Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> Leader, Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>On Broker 0 we increased the time by one hour.</strong> After doing this we observed the metrics, but we haven&#x27;t noticed any issues. We verified logs in stackdriver, but no errors were thrown.
<img alt="inc-1-hour-general" src="/zeebe-chaos/assets/images/inc-1-hour-general-e76624008b7d3eb96d0c869f5fe6c1af.png"></p><p>We noticed, looking at the metrics, that the snapshot was triggered when we moved the time forward. This was what we actually expected. Plus also new scheduled snapshot have been triggered and created.
<img alt="inc-1-hour-snapshot" src="/zeebe-chaos/assets/images/inc-1-hour-snapshot-bc4a81c9e31d5fcba49d7a916f3e8e52.png"></p><p>On the elastic exporter we can see that flushing has happened earlier than usual, because we increased the time. This was also expected.<br>
<img alt="inc-1-hour-export" src="/zeebe-chaos/assets/images/inc-1-hour-export-f6f3d566842ac4cf305ceb7d010b5c59.png"></p><p><strong>Experiment succeeded</strong> ✔️</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="move-time-backwards"></a>Move Time Backwards<a class="hash-link" href="#move-time-backwards" title="Direct link to heading">#</a></h4><p>In order to run the experiment again, with moving the timer backwards, we set up a new benchmark cluster. This time we run the experiment on Broker 1, since he was the leader of the most partitions.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Broker 1 - zell-phil-chaos-zeebe-1.zell-phil-chaos-zeebe.zell-phil-chaos.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition 1 : Follower, Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition 2 : Leader, Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition 3 : Leader, Healthy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>No general issues have been detected, as expected no longer snapshots were taken.
<img alt="dec-1-hour-general" src="/zeebe-chaos/assets/images/dec-1-hour-general-d20ebf3b510bacc0bae5a2533d7e3f1d.png"></p><p>We have run the benchmark for a bit longer, to see whether the snapshot will be triggered later, which was indeed the case.
<img alt="dec-1-hour-snapshot-later" src="/zeebe-chaos/assets/images/dec-1-hour-snapshot-later-9a9aa6dd1f828ccc63e0d67370765945.png"></p><p>We could also observe how the journal segments increased until we took the next snapshot.
<img alt="dec-1-hour-snapshot-segments" src="/zeebe-chaos/assets/images/dec-1-hour-snapshot-segments-342d9ead5f0535ae7a52b5d0e7f8fe89.png"></p><p><strong>Experiment succeeded</strong> ✔️</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="experiment-on-int"></a>Experiment on INT<a class="hash-link" href="#experiment-on-int" title="Direct link to heading">#</a></h3><p>After running the experiment against our benchmark clusters we were confident to run it against a Production S cluster on INT.
We have set up a Production S cluster in our chaos cluster and run the <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/newCloudBenchmark.sh" target="_blank" rel="noopener noreferrer">cloud benchmark</a> against it. It starts starter and worker against that Production S cluster, turned out not with the same load (luckily this doesn&#x27;t matter for this experiment). The starter and workers are deployed in the Zeebe Team gke cluster.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="how-to-change-the-time-on-int"></a>How to change the time on INT<a class="hash-link" href="#how-to-change-the-time-on-int" title="Direct link to heading">#</a></h4><p>On INT, it is not that simple to get the <code>SYS_TIME</code> capability, which we need to change the time. Luckily we already have experience, with getting the necessary capability we need to have.
On a previous chaos day we have added <code>NET_ADMIN</code> capability to a running zeebe container in order to experiment with network partitioning, you can read about that [here]({{ site.baseurl }}{% link _posts/2021-03-23-camunda-cloud-network-partition.md %}).</p><p>The following patch adds the <code>SYS_TIME</code> cap to our linux container.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zeebe&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SYS_TIME&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The following script applies the patch to our Zeebe cluster.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -euo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">scriptPath</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">cd</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">dirname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable string variable" style="color:#36acaa">${</span><span class="token variable string variable string variable environment constant" style="color:#36acaa">BASH_SOURCE</span><span class="token variable string variable string variable punctuation" style="color:#393A34">[</span><span class="token variable string variable string variable" style="color:#36acaa">0</span><span class="token variable string variable string variable punctuation" style="color:#393A34">]</span><span class="token variable string variable string variable" style="color:#36acaa">}</span><span class="token variable string variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa"> -P </span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CLUSTERID</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${namespace</span><span class="token variable operator" style="color:#393A34">%</span><span class="token variable" style="color:#36acaa">-zeebe}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch zb </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$CLUSTERID</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> --type merge --patch</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{&quot;spec&quot;:{&quot;controller&quot;:{&quot;reconcileDisabled&quot;:true}}}&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch statefulset zeebe -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> --patch </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">cat</span><span class="token string variable" style="color:#36acaa"> $scriptPath/sys_time_patch.yaml</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod -l </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">getLabel</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="move-time-forward-on-int"></a>Move Time Forward on INT<a class="hash-link" href="#move-time-forward-on-int" title="Direct link to heading">#</a></h4><p>After we patched our resources we can now change the time as before.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe</span><span class="token comment" style="color:#999988;font-style:italic"># date</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> 09:55:33 UTC </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe</span><span class="token comment" style="color:#999988;font-style:italic"># date +%T -s &quot;10:55:00&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain">:55:00</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe</span><span class="token comment" style="color:#999988;font-style:italic"># date</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">:55:01 UTC </span><span class="token number" style="color:#36acaa">2021</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the general section of our Grafana Dashboard everything looks fine. We can&#x27;t see any issues here, except that the exporting is much less than the processing.
<img alt="int-inc-1-hour-general" src="/zeebe-chaos/assets/images/int-inc-1-hour-general-f5fa293ae793ae59f4cc83da19456a2d.png"></p><p>We took a closer look at the processing panels and saw that the exporter lag a lot behind, which causes Operate lagging behind and that fewer segments are deleted.
<img alt="int-inc-1-hour-exporting" src="/zeebe-chaos/assets/images/int-inc-1-hour-exporting-ad1008f03377d042cc502110006a02fb.png"></p><p>On moving the time forward we see as expected the snapshotting has been triggered.
<img alt="int-inc-1-hour-snapshot" src="/zeebe-chaos/assets/images/int-inc-1-hour-snapshot-7f4800f402632a8efb38d4a8ef1b370a.png"></p><p>Stackdriver shows no errors for the Zeebe service. But later, in operate we observed that no new data was imported after 11:50, we moved the time at 11:55 forward. In the logs we found the following exceptions, which need to be investigated further.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Exception occurred when importing data: io.camunda.operate.exceptions.PersistenceException: Update request failed </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">operate-import-position-1.0.0_</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> and </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">-process-instance</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> with the message </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Elasticsearch exception </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">version_conflict_engine_exception, </span><span class="token assign-left variable" style="color:#36acaa">reason</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">-process-instance</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: version conflict, required seqNo </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1681</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, primary term </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">. current document has seqNo </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1688</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> and primary term </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The exception in more detail:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">io.camunda.operate.exceptions.PersistenceException: Update request failed for [operate-import-position-1.0.0_] and id [2-job] with the message [Elasticsearch exception [type=version_conflict_engine_exception, reason=[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]]].</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.util.ElasticsearchUtil.executeUpdate(ElasticsearchUtil.java:271) ~[operate-els-schema-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.zeebeimport.ImportPositionHolder.recordLatestLoadedPosition(ImportPositionHolder.java:100) ~[operate-qa-importer-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.zeebeimport.ImportJob.call(ImportJob.java:86) ~[operate-qa-importer-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.zeebeimport.RecordsReader.lambda$scheduleImport$1(RecordsReader.java:217) ~[operate-qa-importer-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.FutureTask.run(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: org.elasticsearch.ElasticsearchStatusException: Elasticsearch exception [type=version_conflict_engine_exception, reason=[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:176) ~[elasticsearch-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:1933) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.parseResponseException(RestHighLevelClient.java:1910) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1667) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1624) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1594) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.update(RestHighLevelClient.java:1061) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.util.ElasticsearchUtil.executeUpdate(ElasticsearchUtil.java:266) ~[operate-els-schema-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 7 more</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Suppressed: org.elasticsearch.client.ResponseException: method [POST], host [http://elasticsearch:9200], URI [/operate-import-position-1.0.0_/_update/2-job?refresh=true&amp;timeout=1m], status line [HTTP/1.1 409 Conflict]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;version_conflict_engine_exception&quot;,&quot;reason&quot;:&quot;[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]&quot;,&quot;index_uuid&quot;:&quot;7jsKYxw7RxWQhba-UIG5Wg&quot;,&quot;shard&quot;:&quot;0&quot;,&quot;index&quot;:&quot;operate-import-position-1.0.0_&quot;}],&quot;type&quot;:&quot;version_conflict_engine_exception&quot;,&quot;reason&quot;:&quot;[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]&quot;,&quot;index_uuid&quot;:&quot;7jsKYxw7RxWQhba-UIG5Wg&quot;,&quot;shard&quot;:&quot;0&quot;,&quot;index&quot;:&quot;operate-import-position-1.0.0_&quot;},&quot;status&quot;:409}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestClient.convertResponse(RestClient.java:326) ~[elasticsearch-rest-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestClient.performRequest(RestClient.java:296) ~[elasticsearch-rest-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestClient.performRequest(RestClient.java:270) ~[elasticsearch-rest-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1654) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1624) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1594) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.update(RestHighLevelClient.java:1061) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.util.ElasticsearchUtil.executeUpdate(ElasticsearchUtil.java:266) ~[operate-els-schema-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.zeebeimport.ImportPositionHolder.recordLatestLoadedPosition(ImportPositionHolder.java:100) ~[operate-qa-importer-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.zeebeimport.ImportJob.call(ImportJob.java:86) ~[operate-qa-importer-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.zeebeimport.RecordsReader.lambda$scheduleImport$1(RecordsReader.java:217) ~[operate-qa-importer-1.0.0.jar!/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.util.concurrent.FutureTask.run(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.lang.Thread.run(Unknown Source) [?:?]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Experiment failed</strong> ❌ </p><p>Operate was not operating normal, the exceptions were not expected.</p><p>It seems that changing the time on INT, causes some unexpected problems for Operate. We need to investigate that further and resolve them before we can continue here and make that an automated test. Furthermore, we need to investigate how problematic it is that our exporting lags behind, which is related to <a href="https://github.com/camunda-cloud/zeebe/issues/6747" target="_blank" rel="noopener noreferrer">zeebe#6747</a>, and how we can resolve that.</p><p>In general, we saw that Zeebe has no real issues with time shifts and that timers can be triggered by changing the underlying system time. Still we should make sure that our containers are running on UTC time nodes (which we do), such that we avoid issues with daylight saving time.</p><p>{% if page.author %}<sup><em>Written by: {{page.author}}</em></sup>{% endif %}</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/data">data</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-10-06T00:00:00.000Z" itemprop="datePublished">October 6, 2020</time> · 4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>First chaos day since my parental leave 🎉.</p><p>Today I wanted to play a bit with <a href="https://github.com/Shopify/toxiproxy" target="_blank" rel="noopener noreferrer">ToxiProxy</a>. Toxiproxy is a framework for simulating network conditions and ideal to do some chaos on the network.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="run-toxiproxy"></a>Run ToxiProxy<a class="hash-link" href="#run-toxiproxy" title="Direct link to heading">#</a></h2><p>Download from the <a href="https://github.com/Shopify/toxiproxy/releases" target="_blank" rel="noopener noreferrer">release page</a> the latest version (server and cli).</p><p>Start a broker via docker.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">docker pull camunda/zeebe:SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -p 26500:26500 camunda/zeebe:SNAPSHOT</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Start the toxi proxy server.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-server-linux-amd64 start</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Create a proxy for zeebe</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-cli-linux-amd64 create zeebe-proxy -l localhost:26379 -u localhost:26500</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Created new proxy zeebe-proxy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You should see something in the toxy proxy server log:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0031] Started proxy                                 name=zeebe-proxy proxy=127.0.0.1:26379 upstream=localhost:26500</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Try zbctl to request the topology.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./zbctl --address localhost:26379 status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 0.25.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - 172.17.0.2:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 0.25.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the toxy proxy server log it should be shown as:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0149] Accepted client                               client=127.0.0.1:41510 name=zeebe-proxy proxy=127.0.0.1:26379 upstream=localhost:26500</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WARN[0149] Source terminated                             bytes=245 err=read tcp 127.0.0.1:56178-&gt;127.0.0.1:26500: use of closed network connection name=zeebe-proxy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Add latency to requests</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./toxiproxy-cli-linux-amd64 toxic add -t latency -a latency=5000 zeebe-proxy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Added downstream latency toxic &#x27;latency_downstream&#x27; on proxy &#x27;zeebe-proxy&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Running zbctl again:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> ./zbctl --address localhost:26379 status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: rpc error: code = DeadlineExceeded desc = context deadline exceeded</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Updating existing toxy:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-cli-linux-amd64 toxic update -n latency_downstream -t latency -a latency=500 zeebe-proxy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Running zbctl again:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">time ./zbctl --address localhost:26379 status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 0.25.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - 172.17.0.2:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 0.25.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m1.045s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.012s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sys 0m0.021s</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Inspect existing toxics:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./toxiproxy-cli-linux-amd64 inspect zeebe-proxy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Name: zeebe-proxy   Listen: 127.0.0.1:26379 Upstream: localhost:26500</span></span><span class="token-line" style="color:#393A34"><span class="token plain">======================================================================</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Upstream toxics:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy has no Upstream toxics enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Downstream toxics:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">latency_downstream: type=latency    stream=downstream   toxicity=1.00   attributes=[    jitter=0    latency=500 ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With toxicity we can change whether it should be applied on all requests or only on some. It is possible to add the latency instead of downstream to upstream. There also other things we can inject, like slicing and delaying packages, dropping packages and limiting the bandwith.</p><p>Possible new experiments:</p><ul><li>introduce latency between one follower and leader - if only one follower experience delays we expect that no election is started</li><li>introduce latency betweem gw and broker - see whether command timeout</li><li>slice packages - drop packages, but not every packages - expect that command is send correctly since requests are retried</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="slice-packages"></a>Slice packages<a class="hash-link" href="#slice-packages" title="Direct link to heading">#</a></h3><p>Slices packages after 128 bytes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-cli-linux-amd64 toxic add zeebe-proxy -t slicer -a average_size=128</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Publish message seem to work:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ time ./zbctl --address localhost:26379 publish message failing --insecure --correlationKey key --variables &quot;{}&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;key&quot;: 2251799813685253</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After limiting it to 32 bytes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./toxiproxy-cli-linux-amd64 toxic update -n slicer_downstream -a average_size=32 zeebe-proxy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Updated toxic &#x27;slicer_downstream&#x27; on proxy &#x27;zeebe-proxy&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The publish message seem to not work as expected.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ time ./zbctl --address localhost:26379 publish message failing --insecure --correlationKey key --variables &quot;{}&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">null</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m0.039s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.007s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sys 0m0.023s</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Actually I would expect here an error instead of just returning null.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="no-leader-change-on-high-load"></a>No Leader change on high load<a class="hash-link" href="#no-leader-change-on-high-load" title="Direct link to heading">#</a></h3><p> Peter volunteered for automating a new chaos experiment, where we put high load on a broker and expect that we have no leader change. This was previous an issue, since the leaders were not able to send heartbeats in time. Related issue #7.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="time-reset"></a>Time reset<a class="hash-link" href="#time-reset" title="Direct link to heading">#</a></h3><p>I wanted to work on the clock reset <a href="https://github.com/zeebe-io/zeebe-chaos/issues/3" target="_blank" rel="noopener noreferrer">#3</a>.
This seems to be not easily possible in kubernetes or at least with our current images, since we need for that root privilges.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-time-reset-zeebe-0:/usr/local/zeebe# date -s $(date +%Y-%m-%dT%H:%M:%S)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">date: cannot set date: Operation not permitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue Oct  6 11:51:19 UTC 2020</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It seems that chaos mesh supports something like that for kubernetes maybe worth to look at
<a href="https://pingcap.com/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node" target="_blank" rel="noopener noreferrer">https://pingcap.com/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="participants"></a>Participants<a class="hash-link" href="#participants" title="Direct link to heading">#</a></h2><ul><li>@pihme</li><li>@zelldon</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/tools">tools</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zeebe-chaos/assets/js/runtime~main.3a2a0c9e.js"></script>
<script src="/zeebe-chaos/assets/js/main.7c1e6c56.js"></script>
</body>
</html>