<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Blog Atom Feed"><title data-react-helmet="true">Full Disk Recovery | Zeebe Chaos</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2021/06/08/Full-Disk"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Full Disk Recovery | Zeebe Chaos"><meta data-react-helmet="true" name="description" content="On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: zeebe-chaos#32 and zeebe-chaos#14. This time @Nico joined me."><meta data-react-helmet="true" property="og:description" content="On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: zeebe-chaos#32 and zeebe-chaos#14. This time @Nico joined me."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-06-08T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/zelldon"><meta data-react-helmet="true" property="article:tag" content="availability"><link data-react-helmet="true" rel="shortcut icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-react-helmet="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2021/06/08/Full-Disk"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/06/08/Full-Disk" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/06/08/Full-Disk" hreflang="x-default"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.473f1099.css">
<link rel="preload" href="/zeebe-chaos/assets/js/runtime~main.bf818ee2.js" as="script">
<link rel="preload" href="/zeebe-chaos/assets/js/main.d3103013.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">All posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Full Disk Recovery</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-08T00:00:00.000Z" itemprop="datePublished">June 8, 2021</time> Â· 8 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: <a href="https://github.com/zeebe-io/zeebe-chaos/issues/32" target="_blank" rel="noopener noreferrer">zeebe-chaos#32</a> and <a href="https://github.com/zeebe-io/zeebe-chaos/issues/14" target="_blank" rel="noopener noreferrer">zeebe-chaos#14</a>. This time <a href="https://github.com/korthout" target="_blank" rel="noopener noreferrer">@Nico</a> joined me.</p><p><strong>TL;DR</strong> The experiment was successful ðŸ’ª and we found several things in the dashboard which we can improve :)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>With this experiment we want to verify that Zeebe can recover after OOD, which was caused by not exporting to ELS. For that we want to disconnect Zeebe and ELS first and see how it behaves. Afterwards we connect the services again and expect a recovery of the system.</p><p>As usual, we have set up a normal benchmark cluster with three nodes, three partitions and replication factor three. We run 200 PI/s and 12 workers against that cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p>We expect the following properties:</p><ul><li>at the beginning the system is stable (we can start instances without issues)</li><li>after disconnecting ELS we start to fill the disk, since we can&#x27;t export (which means we can&#x27;t compact)</li><li>after reaching the disk limits, Zeebe doesn&#x27;t accept any commands anymore</li><li>after connecting ELS, Zeebe should start to export again (compacting should be possible again)</li><li>after come below the limit, Zeebe should accept commands again</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="network-disconnect-to-els"></a>Network disconnect to ELS<a class="hash-link" href="#network-disconnect-to-els" title="Direct link to heading">#</a></h4><p>In order to disconnect the Brokers with ELS, we wanted to reuse one of our network disconnect scripts, e.g. <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/disconnect-leaders.sh" target="_blank" rel="noopener noreferrer">disconnect-leaders.sh</a>. This resolves the IP&#x27;s of the brokers and creates an unreachable route via the <code>ip</code> tool at the given brokers.</p><p>We copied that and adjusted it to our needs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;elasticsearch-master&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic0Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-0&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic1Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-1&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic2Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-2&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Small note in order to run this against the benchmark cluster you need to set the following environment variables:</em></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">NAMESPACE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubens -c</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># the namespace where the resources are located</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">CHAOS_SETUP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">helm </span><span class="token comment" style="color:#999988;font-style:italic"># indicates that the installation is done via helm, necessary since we use different labels in the helm charts and in CC.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Running the script above didn&#x27;t work as expected. We still saw records being exported. The issue was that we need to use the service IP instead of the IP&#x27;s of the elastic search pods. The Broker uses only the service to connect with ELS. In order to get the IP we can use this <code>kubectl get services elasticsearch-master --template &quot;{{.spec.clusterIP}}&quot;</code>. </p><p>The service will take care of the request routing, which means we just need to block one IP. This helps to simplify the disconnect script.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;elasticsearch-master&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticServiceIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get services elasticsearch-master --template </span><span class="token variable string" style="color:#e3116c">&quot;{{.spec.clusterIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><p>In this section we will describe how we experienced the chaos experiment and what we observed. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="first-try"></a>First Try<a class="hash-link" href="#first-try" title="Direct link to heading">#</a></h4><p>We run the disconnect script and were able to observe that the exporting stopped. </p><p><img alt="elastic-disconnect" src="/zeebe-chaos/assets/images/elastic-disconnect-5638a32fadfab9b778b02fe14a1d3ed7.png"></p><p>As expected we were no longer able to compact, which cause an increasing of log segments.</p><p><img alt="increase-segments" src="/zeebe-chaos/assets/images/increase-segments-bd8431b8424f7c0b8fb0d44307c2ab42.png"></p><p>We realized that our current disk size might be too big (it would take a while until we fill it), so we decided to setup a new benchmark with smaller size and different watermarks.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGECOMMANDWATERMARK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.6&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGEREPLICATIONWATERMARK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.8&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># PVC</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcAccessMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ReadWriteOnce&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16Gi</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcStorageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ssd</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We thought that we might have different performance, because of such a smaller disk size, but this was not the case. We were able to reach the same level, might be worth to think about reducing the disk sizes more in our benchmarks.</p><p><img alt="base" src="/zeebe-chaos/assets/images/next-try-base-12b9f5871392bd43fe1f31224479aa6d.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="second-try"></a>Second Try<a class="hash-link" href="#second-try" title="Direct link to heading">#</a></h4><p><img alt="base1" src="/zeebe-chaos/assets/images/next-try-base1-649226bc28407a654bad7078dca639a0.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disconnecting"></a>Disconnecting<a class="hash-link" href="#disconnecting" title="Direct link to heading">#</a></h5><p>After running our disconnect script we can immediately see that the exporting is stopping.</p><p><img alt="drop-base" src="/zeebe-chaos/assets/images/next-try-drop-base-4fe3db248fb58bb7fdfef0b08e8b8cd1.png"></p><p>Interesting is the elastic section where we see one of our new panels in actions which shows the failure rate. There are two dots, which show the 100% failure rate.</p><p><img alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png"></p><p>After reaching our disk watermark we can see that the processing stops, and we no longer accept commands.</p><p><img alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png"></p><p>The cluster turns to unhealthy, which is expected.</p><p>Interesting is that we have no metrics at all on the gateway side after reaching the watermark.</p><p><img alt="drop-gw" src="/zeebe-chaos/assets/images/next-try-drop-gw-a0e7f885194b47559bb07c6ad46942d0.png"></p><p>We were able to verify that snapshots are still taken, but no compaction.</p><p><img alt="drop-snapshot" src="/zeebe-chaos/assets/images/next-try-drop-snapshot-d38bd5b1657f7b5a4fa763b26ebba239.png"></p><p>No segments are deleted during this time.</p><p><img alt="drop-segments" src="/zeebe-chaos/assets/images/next-try-drop-segments-3d49aaadb3d3455c25a920281a6c9595.png"></p><p>If we take a look at the processing section we can see that the exporters lag way behind, which of course makes sense.</p><p><img alt="drop-processing" src="/zeebe-chaos/assets/images/next-try-drop-processing-4dc3f1fafd42d2e6560cde27e53a3aa2.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="connecting"></a>Connecting<a class="hash-link" href="#connecting" title="Direct link to heading">#</a></h5><p>Luckily we were able to reuse on of our already written reconnect scripts for this experiment, see <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/connect-leaders.sh" target="_blank" rel="noopener noreferrer">connect-leaders.sh</a>.</p><p>After removing the ip route (connecting the Brokers with ELS again) we can see that it immediately starts to export again.</p><p><img alt="connect-base" src="/zeebe-chaos/assets/images/next-try-connect-base-dfe3501b990f198861825cec2fb00735.png"></p><p>When we went under the disk watermarks the processing started again and we accepted new commands.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p><img alt="connect-base2" src="/zeebe-chaos/assets/images/next-try-connect-base2-375310b94ccc02fe3333b76954351a44.png"></p><p><strong>The experiment was successful, our system was able to recover after an elastic network outage and handled it properly.</strong> âœ… ðŸ’ª</p><p>We noted several issues with the Dashboard, during the chaos experiment observation. For example the Brokers, which went OOD, never went back to the <code>Healthy</code> state again.</p><p><img alt="connect-healthy" src="/zeebe-chaos/assets/images/next-try-connect-healthy-124040b24b536d608e5c1d94eebabbc6.png"></p><p>Furthermore, the not exported panel seems to be broken, depending on the selected time frame.</p><p><img alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png"></p><p>There have been also other issues with the panels and sections which we should take a look at. I have listed them below.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="possible-improvements"></a>Possible Improvements<a class="hash-link" href="#possible-improvements" title="Direct link to heading">#</a></h3><p>We observed several issues with the grafana dashboard which I wrote down here. I will create issues or PR&#x27;s to resolve them.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="general-metric-section"></a>General Metric Section<a class="hash-link" href="#general-metric-section" title="Direct link to heading">#</a></h4><p>If we take a look at the screenshot where we reach our disk watermarks, and the processing stops, the backpressure metrics are not correctly updated. We would expect that the backpressure shows 100%, since all requests are rejected.</p><p><img alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png"></p><p>After the cluster actually becomes healthy again (it accepts new commands) it is not shown as healthy in the panels. The metrics seems not to be updated.</p><p>Another possible improvement would be to make it more visible that the exporting stopped. One idea is to split the processing into exporting and processing, so having two graphs might help.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="processing-section"></a>Processing Section<a class="hash-link" href="#processing-section" title="Direct link to heading">#</a></h4><p>Depending on the time frame the panel <code>Number of records not exported</code>, seems to show quite high values.</p><p><img alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png"></p><p>If we take a look at other metrics, this doesn&#x27;t make any sense. If we had such a backlog we wouldn&#x27;t expect to compact to one segment for example. Furthemore the tables on the right side show numbers which are quite close to each other.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="elastic-metrics-section"></a>Elastic Metrics Section<a class="hash-link" href="#elastic-metrics-section" title="Direct link to heading">#</a></h4><p>We probably can improve the failure panel, such that it shows a graph, and the limit is not set to 130%.</p><p><img alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="grpc-metric-section"></a>GRPC Metric Section<a class="hash-link" href="#grpc-metric-section" title="Direct link to heading">#</a></h4><p>The panel <code>gRPC requests</code> should have an dec ordering on the tooltip and should be renamed to <code>Total gRPC requests</code> it was a bit confusing to us.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="throughput-section"></a>Throughput Section<a class="hash-link" href="#throughput-section" title="Direct link to heading">#</a></h4><p>The StreamProcessor vs Exporter panel has no data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="snapshot-section"></a>Snapshot Section<a class="hash-link" href="#snapshot-section" title="Direct link to heading">#</a></h4><p>We saw that snapshots are created, but the Snapshot replication panel show no data. It seem to be broken (again?).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="resources-section"></a>Resources Section<a class="hash-link" href="#resources-section" title="Direct link to heading">#</a></h4><p>The JVM panel has the legend on the right side, which makes it hard to see the metrics if you have multiple windows open on one screen.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2021-06-08-Full-Disk/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zeebe-chaos/2021/07/06/Slow-Network"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Slow Network</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zeebe-chaos/2021/05/25/Reset-Clock"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Time travel Experiment Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#chaos-experiment" class="table-of-contents__link">Chaos Experiment</a><ul><li><a href="#expected" class="table-of-contents__link">Expected</a></li><li><a href="#actual" class="table-of-contents__link">Actual</a></li><li><a href="#result" class="table-of-contents__link">Result</a></li><li><a href="#possible-improvements" class="table-of-contents__link">Possible Improvements</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zeebe-chaos/assets/js/runtime~main.bf818ee2.js"></script>
<script src="/zeebe-chaos/assets/js/main.d3103013.js"></script>
</body>
</html>