<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Blog Atom Feed"><title data-react-helmet="true">Deployment Distribution | Zeebe Chaos</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2021/01/26/deployments"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Deployment Distribution | Zeebe Chaos"><meta data-react-helmet="true" name="description" content="On this chaos day we wanted to experiment a bit with deployment&#x27;s and there distribution."><meta data-react-helmet="true" property="og:description" content="On this chaos day we wanted to experiment a bit with deployment&#x27;s and there distribution."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-01-26T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/zelldon"><meta data-react-helmet="true" property="article:tag" content="availability,data"><link data-react-helmet="true" rel="shortcut icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-react-helmet="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2021/01/26/deployments"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/01/26/deployments" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/01/26/deployments" hreflang="x-default"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.878b0132.css">
<link rel="preload" href="/zeebe-chaos/assets/js/runtime~main.a79cb914.js" as="script">
<link rel="preload" href="/zeebe-chaos/assets/js/main.b04faf4d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2022/02/01/High-Snapshot-Frequency">High Snapshot Frequency</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2022/01/19/big-variables">Handling of Big Variables</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance">Worker count should not impact performance</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys">Not produce duplicate Keys</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/10/29/Throughput-on-big-state">Throughput on big state</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Deployment Distribution</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2021</time> Â· 11 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On this chaos day we wanted to experiment a bit with deployment&#x27;s and there distribution.</p><p>We run a chaos experiment with deploying multiple workflows and disconnecting two leaders. We verified whether deployments are distributed later. The chaos experiment was successful and showed a bit how fault tolerant deployment distribution is. ðŸ’ª</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="deployments"></a>Deployments<a class="hash-link" href="#deployments" title="Direct link to heading">#</a></h2><p>In order to continue here we need to explain how the workflow deployment and distribution actually works, if you know it then you can skip this section ðŸ˜‰.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="deployment-distribution"></a>Deployment Distribution<a class="hash-link" href="#deployment-distribution" title="Direct link to heading">#</a></h3><p>If you deploy a workflow and you have multiple partitions, Zeebe needs to make sure that all partitions eventually have the same version of the deployment. This is done with via the deployment distribution.</p><p><img alt="distribution" src="/zeebe-chaos/assets/images/distribution-472ccace62249d74b06e5d0514215dc7.png"></p><p>On deploying a workflow via a client, like the java client, we send a deployment command to the gateway. The gateway sends the received deployment to the &quot;deployment partition&quot;, which is partition one. The partition one is in charge of distributing the deployment. When the client receives a response for the deployment command, this means that the deployment is written/created on partition one. It doesn&#x27;t mean that it is distributed to all other partitions. The distribution is done asynchronously. </p><p>This can cause issues, if you want to create workflow instances immediately after the deployment. If you try to create a workflow instance on a partition which hasn&#x27;t received the deployment yet, then this creation will fail. The gateway sends commands, like workflow instance creation, in a round-robin fashion and if you have multiple partitions, then the chance that you hit another partition is quite high.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="reasoning"></a>Reasoning<a class="hash-link" href="#reasoning" title="Direct link to heading">#</a></h4><p>You may ask why we build it like that. Let me explain this a bit more.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_y2LR" id="why-isnt-the-gateway-in-charge-of-distributing-the-deployment"></a>Why isn&#x27;t the gateway in charge of distributing the deployment?<a class="hash-link" href="#why-isnt-the-gateway-in-charge-of-distributing-the-deployment" title="Direct link to heading">#</a></h5><p>Because the gateway is stateless. If the gateway restarts it has no state it can replay, so it is not able to retry the deployment distributions. If the gateway failed during deployment distribution some partition might lose the deployment update. In the broker we replay the state, which means we can detect whether we distributed the deployment already to a certain partition if not we can retry it.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_y2LR" id="why-the-response-isnt-send-after-the-distribution-is-done-why-it-is-build-in-an-asynchronous-way"></a>Why the response isn&#x27;t send after the distribution is done. Why it is build in an asynchronous way?<a class="hash-link" href="#why-the-response-isnt-send-after-the-distribution-is-done-why-it-is-build-in-an-asynchronous-way" title="Direct link to heading">#</a></h5><p>The simple answer would be, because it can take a long time until the deployment is distributed to all partitions. In a distributed system it is likely that a service fail, which means if one partition is not available the distribution is not complete. With the current approach you can already start creating instances at least at partition one and you can retry the requests if you get an rejection.</p><p>After the small excursion of how deployment distribution look like and why, we can start with our experiment to verify that it works as expected.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>We have a standard setup of three nodes, three partitions and replication factor three.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p>We deploy multiple versions (1000+) of a deployment and assume that at some point all deployments are distributed on all partitions and that we are able to create a workflow instance with the latest version on all partitions. The system should remain stable during distributing the deployments. This can be seen as the steady state.</p><p>If we now disconnect a leader of a different partition (different from partition one) with the leader of partition one, then the deployments can&#x27;t be distributed. If we try to create workflow instances on that partition we should receive rejection&#x27;s. After we connect them again the deployments should be distributed and we should be able to create workflow instances on that specific partition.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="steady-state"></a>Steady State<a class="hash-link" href="#steady-state" title="Direct link to heading">#</a></h4><p>Following Java code was used to verify the steady state. In order to find out on which partition the workflow instances was created I used the <code>Protocol#decodePartitionId</code> method, which is available in the zeebe protocol module. This functionality and the property of the key&#x27;s was already quite useful in the past on doing chaos experiments.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import io.zeebe.client.ZeebeClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.zeebe.model.bpmn.Bpmn;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.zeebe.protocol.Protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ChaosDayMain {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger LOG = LoggerFactory.getLogger(ChaosDayMain.class.getName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final var zeebeClient = ZeebeClient.newClientBuilder().usePlaintext().gatewayAddress(&quot;localhost:26500&quot;).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final var topology = zeebeClient.newTopologyRequest().send().join();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;{}&quot;, topology);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lastVersion = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 1_000; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final var modelInstance = Bpmn.createExecutableProcess(&quot;workflow&quot;).startEvent().endEvent().done();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final var workflow = zeebeClient.newDeployCommand()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          .addWorkflowModel(modelInstance, &quot;workflow&quot;).send().join();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      lastVersion = workflow.getWorkflows().get(0).getVersion();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info(&quot;Last version deployed: {}&quot;, lastVersion);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final var partitions = new ArrayList&lt;&gt;(List.of(1, 2, 3));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (!partitions.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final var workflowInstanceEvent = zeebeClient.newCreateInstanceCommand()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .bpmnProcessId(&quot;workflow&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .version(lastVersion).send().join();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final var workflowInstanceKey = workflowInstanceEvent.getWorkflowInstanceKey();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final var partitionId = Protocol.decodePartitionId(workflowInstanceKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        partitions.remove(Integer.valueOf(partitionId));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;Created workflow instance on partition {}, {} partitions left ({}).&quot;, partitionId, partitions.size(), partitions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // retry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info(&quot;Failed to create workflow instance&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>Small Note</strong> the line: <code>Bpmn.createExecutableProcess(&quot;workflow&quot;).startEvent().endEvent().done()</code> will always create a new version of a workflow, since internally new id&#x27;s are generated.</p><p>After running the code above we can see following output:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">13:45:00.606 [] [main] INFO  ChaosDayMain - TopologyImpl{brokers=[BrokerInfoImpl{nodeId=0, host=&#x27;zell-chaos-zeebe-0.zell-chaos-zeebe.zell-chaos.svc.cluster.local&#x27;, port=26501, version=0.27.0-SNAPSHOT, partitions=[PartitionInfoImpl{partitionId=1, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=2, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=3, role=LEADER, health=HEALTHY}]}, BrokerInfoImpl{nodeId=2, host=&#x27;zell-chaos-zeebe-2.zell-chaos-zeebe.zell-chaos.svc.cluster.local&#x27;, port=26501, version=0.27.0-SNAPSHOT, partitions=[PartitionInfoImpl{partitionId=1, role=LEADER, health=HEALTHY}, PartitionInfoImpl{partitionId=2, role=LEADER, health=HEALTHY}, PartitionInfoImpl{partitionId=3, role=FOLLOWER, health=HEALTHY}]}, BrokerInfoImpl{nodeId=1, host=&#x27;zell-chaos-zeebe-1.zell-chaos-zeebe.zell-chaos.svc.cluster.local&#x27;, port=26501, version=0.27.0-SNAPSHOT, partitions=[PartitionInfoImpl{partitionId=1, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=2, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=3, role=FOLLOWER, health=HEALTHY}]}], clusterSize=3, partitionsCount=3, replicationFactor=3, gatewayVersion=0.27.0-SNAPSHOT}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.384 [] [main] INFO  ChaosDayMain - Last version deployed: 6914</span></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.434 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 2 partitions left ([2, 3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.505 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.571 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 3, 0 partitions left ([]).</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see in the version count I run it already multiple times :). With this we are able to verify our steady state, that the deployments are distributed to all partitions and that we are able to create workflow instances with the specific (last) version on all partitions.</p><p><em>Side note, I needed multiple runs because there was a leader change (of partition one) in between and I had to adjust the code etc. Needs to be investigated whether the deployment distribution caused that.</em></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="chaos-injection-method"></a>Chaos Injection (Method)<a class="hash-link" href="#chaos-injection-method" title="Direct link to heading">#</a></h4><p>The following topology we used to determined who to disconnect:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Cluster size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Partitions count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Replication factor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Gateway version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Brokers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">0.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos.svc.cluster.local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26501</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Leader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Leader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 1 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos.svc.cluster.local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26501</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 2 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">2.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos.svc.cluster.local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26501</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Leader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Based on the work of the last chaos days we are able to disconnect brokers easily.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sh"><pre tabindex="0" class="prism-code language-sh codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">source utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">partition=1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace=$(getNamespace)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway=$(getGateway)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState &quot;$partition&quot; &quot;LEADER&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">leader=$(getBroker &quot;$index&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderIp=$(kubectl get pod &quot;$leader&quot; -n &quot;$namespace&quot; --template=&quot;{{.status.podIP}}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition three</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState &quot;3&quot; &quot;FOLLOWER&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderTwo=$(getBroker &quot;$index&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderTwoIp=$(kubectl get pod &quot;$leaderTwo&quot; -n &quot;$namespace&quot; --template=&quot;{{.status.podIP}}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># To print the topology in the journal</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl exec &quot;$gateway&quot; -n &quot;$namespace&quot; -- zbctl status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># we put all into one function because we need to make sure that even after preemption the </span></span><span class="token-line" style="color:#393A34"><span class="token plain"># dependency is installed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function disconnect() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> toChangedPod=&quot;$1&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> targetIp=&quot;$2&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> # update to have access to ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n &quot;$namespace&quot; &quot;$toChangedPod&quot; -- apt update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n &quot;$namespace&quot; &quot;$toChangedPod&quot; -- apt install -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec &quot;$toChangedPod&quot; -n &quot;$namespace&quot; -- ip route add unreachable &quot;$targetIp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect &quot;$leader&quot; &quot;$leaderTwoIp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect &quot;$leaderTwo&quot; &quot;$leaderIp&quot; </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We used partition three here, since the leader of partition one and two are the same node. After disconnecting and running the Java code from above, we get the following output:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.655 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.713 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.777 [] [main] INFO  ChaosDayMain - Failed to create workflow instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: Command &#x27;CREATE&#x27; rejected with code &#x27;NOT_FOUND&#x27;: Expected to find workflow definition with process ID &#x27;workflow&#x27; and version &#x27;8916&#x27;, but none found</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ChaosDayMain.main(ChaosDayMain.java:37) [classes/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: NOT_FOUND: Command &#x27;CREATE&#x27; rejected with code &#x27;NOT_FOUND&#x27;: Expected to find workflow definition with process ID &#x27;workflow&#x27; and version &#x27;8916&#x27;, but none found</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 1 more</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: NOT_FOUND: Command &#x27;CREATE&#x27; rejected with code &#x27;NOT_FOUND&#x27;: Expected to find workflow definition with process ID &#x27;workflow&#x27; and version &#x27;8916&#x27;, but none found</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[grpc-api-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:478) ~[grpc-stub-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:617) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:803) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:782) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Thread.java:834) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.846 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.907 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.971 [] [main] INFO  ChaosDayMain - Failed to create workflow instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: Command &#x27;CREATE&#x27; rejected with code &#x27;NOT_FOUND&#x27;: Expected to find workflow definition with process ID &#x27;workflow&#x27; and version &#x27;8916&#x27;, but none found</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ChaosDayMain.main(ChaosDayMain.java:37) [classes/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: NOT_FOUND: Command &#x27;CREATE&#x27; rejected with code &#x27;NOT_FOUND&#x27;: Expected to find workflow definition with process ID &#x27;workflow&#x27; and version &#x27;8916&#x27;, but none found</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 1 more</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: NOT_FOUND: Command &#x27;CREATE&#x27; rejected with code &#x27;NOT_FOUND&#x27;: Expected to find workflow definition with process ID &#x27;workflow&#x27; and version &#x27;8916&#x27;, but none found</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[grpc-api-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:478) ~[grpc-stub-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:617) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:803) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:782) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Thread.java:834) ~[?:?]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Which is of course expected, since the deployment is not available at the third partition.</p><p>In the stackdriver we see also warnings regarding the deployment distribution:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-26 14:11:49.439 CET</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to push deployment to node 2 for partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-26 14:11:49.439 CET</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to push deployment to node 2 for partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-26 14:11:49.439 CET</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to push deployment to node 2 for partition 3</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After we connected the leaders again (deleting the ip route), we can see in the application log that the exception changed to deadline exceeded and at some point we are able to create a workflow instance on partition three.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">14:16:21.958 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:22.020 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:32.032 [] [main] INFO  ChaosDayMain - Failed to create workflow instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: deadline exceeded after 9.999911981s. [remote_addr=localhost/127.0.0.1:26500]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ChaosDayMain.main(ChaosDayMain.java:37) [classes/:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 9.999911981s. [remote_addr=localhost/127.0.0.1:26500]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 1 more</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 9.999911981s. [remote_addr=localhost/127.0.0.1:26500]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[grpc-api-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:478) ~[grpc-stub-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:617) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:803) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:782) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[grpc-core-1.34.0.jar:1.34.0]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Thread.java:834) ~[?:?]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:32.062 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:32.125 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:37.596 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 3, 0 partitions left ([]).</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We see the deadline exceeded, because the processor is not able to send the response&#x27;s in time. The reason for that is probably because we have so many deployments to process, which have been pushed by the partition one.</p><p>The resource consumption around that time look ok. We can see that the memory spikes a bit, but it recovers later. On the CPU graph we can see when we connected the nodes again.</p><p><img alt="res" src="/zeebe-chaos/assets/images/res-bfc342434d3419d6a6338dba219cbaad.png">)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p>The chaos experiment was successful. The deployment was distributed even after a network disconnect and we were able to create workflow instance of the latest version on all partitions at the end.</p><p>With this experiment we were able to show that the deployment distribution is fault tolerant in way that it can handle unavailability of other partitions. This means eventually all partitions will receive there deployment&#x27;s and we are able to create workflow instances on these partitions. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="further-work"></a>Further work<a class="hash-link" href="#further-work" title="Direct link to heading">#</a></h4><p>Further possible experiments would be to restart the leader of partition one to see that even after restart we re-distribute the deployments. It is probably also interesting to see how the distribution behaves on more partitions than three.</p><p>During the experiment we have observed some leader changes. It needs to be investigated further, whether this was related to the deployments or something different. It is probably also interesting to see how it behaves with larger deployments, also resource consumption wise.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/zeebe-chaos/tags/availability">availability</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/zeebe-chaos/tags/data">data</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2021-01-26-deployments/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zeebe-chaos/2021/02/23/automate-deployments-dist"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Automating Deployment Distribution Chaos Experiment</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zeebe-chaos/2021/01/19/network-partition"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Network partitions Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deployments" class="table-of-contents__link">Deployments</a><ul><li><a href="#deployment-distribution" class="table-of-contents__link">Deployment Distribution</a></li></ul></li><li><a href="#chaos-experiment" class="table-of-contents__link">Chaos Experiment</a><ul><li><a href="#expected" class="table-of-contents__link">Expected</a></li><li><a href="#actual" class="table-of-contents__link">Actual</a></li><li><a href="#result" class="table-of-contents__link">Result</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zeebe-chaos/assets/js/runtime~main.a79cb914.js"></script>
<script src="/zeebe-chaos/assets/js/main.b04faf4d.js"></script>
</body>
</html>