<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://zeebe-io.github.io/zeebe-chaos/</id>
    <title>Zeebe Chaos Blog</title>
    <updated>2023-02-23T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/"/>
    <subtitle>Zeebe Chaos Blog</subtitle>
    <icon>https://zeebe-io.github.io/zeebe-chaos/img/zeebe-logo.png</icon>
    <entry>
        <title type="html"><![CDATA[Recursive call activity]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2023/02/23/Recursive-call-activity</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2023/02/23/Recursive-call-activity"/>
        <updated>2023-02-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Long time no see. Happy to do my first chaos day this year. In the last week have implemented interesting features, which I would like to experiment with.]]></summary>
        <content type="html"><![CDATA[<p>Long time no see. Happy to do my first chaos day this year. In the last week have implemented interesting features, which I would like to experiment with.
<a href="https://github.com/camunda/zeebe/issues/11416" target="_blank" rel="noopener noreferrer">Batch processing</a> was one of them.</p><p><strong>TL;DR;</strong> Chaos experiment failed. 💥 Batch processing doesn't seem to respect the configured limit, which causes issues with processing and influences the health of the system. We found a bug 💪</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>In today's chaos experiment, we want to experiment with <a href="https://github.com/camunda/zeebe/issues/11416" target="_blank" rel="noopener noreferrer">Batch processing</a> and how it can handle error conditions, like deploying an endless recursive process model.</p><p><img loading="lazy" alt="recursive process" src="/zeebe-chaos/assets/images/call-8d5375c7dcbd4d2e36d20706dd178d3d.png" width="903" height="276" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>When we deploy such a process model and create an instance of it, we expect that the execution is done endlessly. In normal process models with batch processing, the execution of a process instance is done until a wait state is reached. In this process model, there exists no wait state. To handle such cases, we have implemented a batch limit, which can be configured via <a href="https://github.com/camunda/zeebe/blob/main/dist/src/main/config/broker.standalone.yaml.template#L695" target="_blank" rel="noopener noreferrer">maxCommandsInBatch</a>. This configuration is by default set to 100 commands. Meaning the stream processor will process 100 commands until it stops, to make room for other things.</p><p>We expect that our limit handling steps in during the execution and we can execute also other instances or, cancel the problematic process instance. Furthermore, we expect to stay healthy, we should be able to update our health check continuously.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>Before we can start with our experiment we need to start our benchmark Zeebe cluster. This has become easier now since I have written the last post. Previously we had to use the scripts and Makefile in the <a href="https://github.com/camunda/zeebe/tree/main/benchmarks/setup" target="_blank" rel="noopener noreferrer">zeebe/benchmark sub-directory</a>.</p><p>We have now provided new <a href="https://github.com/zeebe-io/benchmark-helm" target="_blank" rel="noopener noreferrer">Benchmark Helm charts</a>, based on our Camunda Platform Helm charts. They allow us to deploy a new zeebe benchmark setup via:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace zell-chaos </span><span class="token comment" style="color:#999988;font-style:italic"># create a new namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubens zell-chaos  </span><span class="token comment" style="color:#999988;font-style:italic"># change context to a new namespace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deploy zeebe benchmark cluster - without starter and worker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> zell-chaos </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zeebe-benchmark/zeebe-benchmark </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --set starter.replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --set worker.replicas</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To deploy the model we can use <a href="https://github.com/zeebe-io/zeebe-chaos/releases/tag/zbchaos-v1.0.0" target="_blank" rel="noopener noreferrer">zbchaos v1.0.0</a>.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ zbchaos deploy process --processModelPath call.bpmn </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> LEADER -1 call.bpmn </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">  msg </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> LEADER -1 </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> LEADER -1 </span><span class="token number" style="color:#36acaa">1677157340943</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> -1 benchmark </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployed given process model call.bpmn, under key </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>Note: Looks like we have some left-over debug logs, which we should remove.</em></p><p>To create an instance we can use:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ zbchaos verify instance-creation --bpmnProcessId super</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> LEADER -1  </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">  msg </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> LEADER -1 </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> LEADER -1 </span><span class="token number" style="color:#36acaa">1677157569058</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> -1 super </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The steady state was successfully verified</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After creating the instance we can observe the behavior of the Zeebe via <a href="https://grafana.dev.zeebe.io/" target="_blank" rel="noopener noreferrer">grafana</a>.</p><p>We can see that the processing starts immediately quite high and is continuously going on. </p><p><img loading="lazy" alt="general" src="/zeebe-chaos/assets/images/general-96c61dbea3faf18172737f97412ce400.png" width="1842" height="421" class="img_ev3q"></p><p><strong>We have two instances running, one on partition three and one on partition one.</strong></p><p><em>One interesting fact is that the topology request rate is also up to 0.400 per second, so potentially every 2.5 seconds we send a topology request to the gateway. But there is no application deployed that does this. <a href="https://github.com/camunda/zeebe/pull/11599#discussion_r1109846523" target="_blank" rel="noopener noreferrer">I have recently found out again</a>, that we have the Zeebe client usage in the gateway to request the topology. Might be worth investigating whether this is an issue.</em></p><p>After observing this cluster for a while we can see that after around five minutes the cluster fails. The processing for the partitions breaks down to 1/10 of what was processed before. A bit later it looks like it tries to come back but, failed again.</p><p><img loading="lazy" alt="fail-general" src="/zeebe-chaos/assets/images/fail-general-7f21e7fd29654bb0b4bac784a956c203.png" width="1853" height="975" class="img_ev3q"></p><p><em>We can see in the metrics that in between also the balancing was triggered. A feature we have as part of our Benchmark Helm charts.</em></p><p>The logs (at stack driver) doesn't give us many insights, <a href="https://console.cloud.google.com/logs/query;query=resource.type%3D%22k8s_container%22%0Aresource.labels.project_id%3D%22zeebe-io%22%0Aresource.labels.location%3D%22europe-west1-b%22%0Aresource.labels.cluster_name%3D%22zeebe-cluster%22%0Aresource.labels.namespace_name%3D%22zell-chaos%22%0Alabels.k8s-pod%2Fapp%3D%22camunda-platform%22%0Alabels.k8s-pod%2Fapp_kubernetes_io%2Fcomponent%3D%22zeebe-broker%22%0Alabels.k8s-pod%2Fapp_kubernetes_io%2Finstance%3D%22zell-chaos%22%0Alabels.k8s-pod%2Fapp_kubernetes_io%2Fmanaged-by%3D%22Helm%22%0Alabels.k8s-pod%2Fapp_kubernetes_io%2Fname%3D%22zeebe%22%0Alabels.k8s-pod%2Fapp_kubernetes_io%2Fpart-of%3D%22camunda-platform%22;timeRange=2023-02-23T12:17:49.128812Z%2F2023-02-23T14:18:59.101Z;pinnedLogId=2023-02-23T13:13:40.945376476Z%2Fdr4gxdklsxtgx6h6;cursorTimestamp=2023-02-23T13:13:40.945376476Z?project=zeebe-io" target="_blank" rel="noopener noreferrer">except that we see that nodes becoming unhealthy</a>. Similar information we can see in the metrics, that followers are unhealthy.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Partition-1 failed, marking it as unhealthy: Broker-2</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Detected </span><span class="token string" style="color:#e3116c">'UNHEALTHY'</span><span class="token plain"> components. The current health status of components: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Partition-2</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, Partition-1</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">UNHEALTHY, </span><span class="token assign-left variable" style="color:#36acaa">issue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HealthIssue</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">message</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">null, </span><span class="token assign-left variable" style="color:#36acaa">throwable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">null, </span><span class="token assign-left variable" style="color:#36acaa">cause</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Broker-2-StreamProcessor-1</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">UNHEALTHY, </span><span class="token assign-left variable" style="color:#36acaa">issue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HealthIssue</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">message</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">actor appears blocked, </span><span class="token assign-left variable" style="color:#36acaa">throwable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">null, </span><span class="token assign-left variable" style="color:#36acaa">cause</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">null</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, Partition-3</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Interesting insights we can get in our new Batch processing metrics. We see that at the beginning we use our limit of 100 commands per batch, but soon as we start with the recursion we use an enormous high batch processing command count.</p><p><img loading="lazy" alt="fail-batchprocessing.png" src="/zeebe-chaos/assets/images/fail-batchprocessing-1db16026a70bf497036fdaf1df98bf26.png" width="1829" height="552" class="img_ev3q"></p><p>The new sequence metric shows similar results, so there must be a problem with not respecting the limit.</p><p><img loading="lazy" alt="sequencer" src="/zeebe-chaos/assets/images/sequencer-e1680cd2da0acc84faf51d494411962b.png" width="1855" height="513" class="img_ev3q"></p><p>With this, I mark this chaos experiment as failed. We need to investigate this further and fix the related issue.💥</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2><ul><li><a href="https://github.com/zeebe-io/zeebe-chaos/issues/323" target="_blank" rel="noopener noreferrer">zbchaos logs debug message on normal usage</a></li><li><a href="https://github.com/camunda/zeebe/issues/11799" target="_blank" rel="noopener noreferrer">Every 2.5 seconds we send a topology request, which is shown in the metrics</a></li><li><a href="https://github.com/camunda/zeebe/issues/11798" target="_blank" rel="noopener noreferrer">Batch processing doesn't respect the limit</a></li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Message Correlation after Network Partition]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2022/08/31/Message-Correlation-after-Network-Partition</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2022/08/31/Message-Correlation-after-Network-Partition"/>
        <updated>2022-08-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the last weeks, we made several changes in our core components, we introduce some new abstractions, and changed how we communicate between partitions.]]></summary>
        <content type="html"><![CDATA[<p>In the last weeks, we made several changes in our core components, we introduce some new abstractions, and changed how we communicate between partitions.</p><p>Due to these changes, we thought it might make sense to run some more chaos experiments in that direction and area since our benchmarks also recently found some interesting edge cases.</p><p>Today we experimented with Message Correlation and what happens when a network partition disturbs the correlation process.</p><p><strong>TL;DR;</strong> The experiment was partially successful (after retry), we were able to publish messages during a network partition that have been correlated after the network partition. We need to verify whether we can also publish messages before a network partition and during the partition create the related instances.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>The experiment is related to our previously described <a href="/zeebe-chaos/2022/08/02/deployment-distribution">deployment distribution experiment</a>.</p><p>When a user/client publishes a message, the message will be sent to a certain partition, based on the correlation key. There is some calculation going on related to the hashcode and the partition count.
This calculation is deterministic in order to find later the message again if we reach a message catch event.</p><p>A message can specify a time-to-live (TTL), <a href="https://docs.camunda.io/docs/components/concepts/messages/#message-buffering" target="_blank" rel="noopener noreferrer">which allows buffering that message</a>. If later a process instance is created and the TTL is not exceeded the message can be still correlated. The creation of process instances
happens round-robin on the existing/available partitions (this is controlled by the gateway). When a process instance is created and reaches a message catch event it will be based on the correlation key search for a message on the expected partition. <em>Actually this happens based on subscriptions, for more details see the <a href="https://docs.camunda.io/docs/components/concepts/messages/#message-subscriptions" target="_blank" rel="noopener noreferrer">docs</a> or the <a href="https://github.com/zeebe-io/enhancements/blob/master/ZEP004-wf-stream-processing.md#message-intermediate-catch-event" target="_blank" rel="noopener noreferrer">ZEP-4</a>.</em> If the message still exists (TTL didn't expire) and this message <a href="https://docs.camunda.io/docs/components/concepts/messages/#message-cardinality" target="_blank" rel="noopener noreferrer">wasn't already correlated to the same process definition</a> then it will be correlated.</p><p>Since both partitions can be on different leader nodes this requires some network communication, which can be interrupted/disturbed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We expect that if the network between the partition where the message was published and where the process instance was created is interrupted that no message correlation happens. But after the network recovers, we expect further that the message will be correlated and the process instance can continue.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>As a setup, I installed our benchmarks, with Operate enabled.
This allows us to also view the details in Operate.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">diff</span><span class="token plain"> zeebe-values.yaml </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/default/zeebe-values.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">,8d4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">   identity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">     auth:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">       enabled: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">28c24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">   containerSecurityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   podSecurityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">139c135</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">   enabled: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   enabled: </span><span class="token boolean" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>During the experiment, it turned out that the <code>podSecurityContext</code> is outdated.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-description">Experiment Description<a href="#experiment-description" class="hash-link" aria-label="Direct link to Experiment Description" title="Direct link to Experiment Description">​</a></h4><p>Since we want to automate this experiment soon, or later I thought it would be a good idea to use the <a href="https://docs.camunda.io/docs/components/concepts/process-instance-creation/#create-and-await-results" target="_blank" rel="noopener noreferrer">create process instance with result</a>. We would start the following process:</p><p><img loading="lazy" alt="msg-catch" src="/zeebe-chaos/assets/images/msg-catch-dba2526317c719b66db25ef1dfaff2a4.png" width="723" height="207" class="img_ev3q"></p><p>Before we start the process we need to publish the message to a certain partition and create a network partition between two partitions. After that, we can create the PI and verify that the message correlation shouldn't happen. Afterward, we would delete the network partition and verify that the process instance is completed.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="details">Details<a href="#details" class="hash-link" aria-label="Direct link to Details" title="Direct link to Details">​</a></h4><p>To make the experiment easier to reproduce and allow us to experiment in different directions later as well I extend our new chaos cli (zbchaos), which I created during the last hack days. I will write a separate blog post about this tool soon.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="message-publish">Message Publish<a href="#message-publish" class="hash-link" aria-label="Direct link to Message Publish" title="Direct link to Message Publish">​</a></h5><p>I added a new feature (<a href="https://github.com/zeebe-io/zeebe-chaos/pull/166" target="_blank" rel="noopener noreferrer">PR #166</a>) that allows us to publish a message to a specific partition:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos publish message -v --partitionId 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully created port forwarding tunnel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Send message 'msg', with correaltion key '2' (ASCII: 50) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Message was sent and returned key 6755399441055796, which corresponds to partition: 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="extend-steady-state-verification">Extend Steady-state verification<a href="#extend-steady-state-verification" class="hash-link" aria-label="Direct link to Extend Steady-state verification" title="Direct link to Extend Steady-state verification">​</a></h5><p>For the steady-state verification, multiple enhancements have been added.</p><ol><li>Previously the <code>zbchaos</code> didn't allow us to create instances of specific models, which is now added as new feature (<a href="https://github.com/zeebe-io/zeebe-chaos/pull/167" target="_blank" rel="noopener noreferrer">PR #167</a>).</li><li>In order to await the process instance completion a new flag was added <code>--awaitResult</code>, which allows us to await the PI completeness.</li><li>To make sure that our message can be correlated we have to set the right correlationKey/value. This means we need to create instances with certain variables, which is now possible as well (<code>--variables</code>).</li></ol><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos verify steady-state -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Verifies the steady state of the Zeebe system.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A process model will be deployed and process instances are created </span><span class="token keyword" style="color:#00009f">until</span><span class="token plain"> the required partition is reached.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zbchaos verify steady-state </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --awaitResult               Specify whether the completion of the created process instance should be awaited.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -h, --help                      </span><span class="token builtin class-name">help</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> steady-state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --partitionId int           Specify the </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> of the partition </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --processModelPath string   Specify the path to a BPMN process model, </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> should be deployed and an instance should be created of.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --variables string          Specify the variables </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the process instance. Expect json string.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Global Flags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v, --verbose   verbose output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="execution-of-the-experiment">Execution of the Experiment<a href="#execution-of-the-experiment" class="hash-link" aria-label="Direct link to Execution of the Experiment" title="Direct link to Execution of the Experiment">​</a></h4><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$./zbchaos verify readiness -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">All Zeebe nodes are running.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After checking the readiness we can check what the current topology is:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos topology</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">Partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">Partition </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">Partition </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">LEADER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">LEADER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">LEADER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that the leaders are well distributed. I pick partition 3 as our message publish partition, and partition 1 as our partition for the process instance. Since we can't control really the round-robin mechanism, we need to create multiple messages and multiple process instances (for each partition). During our experiment, we will only look at the instance on partition one.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos publish message -v --partitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully created port forwarding tunnel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Send message </span><span class="token string" style="color:#e3116c">'msg'</span><span class="token plain">, with correaltion key </span><span class="token string" style="color:#e3116c">'2'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ASCII: </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Message was sent and returned key </span><span class="token number" style="color:#36acaa">6755399441055745</span><span class="token plain">, </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> corresponds to partition: </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell go-chaos/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./zbchaos publish message -v --partitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully created port forwarding tunnel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Send message </span><span class="token string" style="color:#e3116c">'msg'</span><span class="token plain">, with correaltion key </span><span class="token string" style="color:#e3116c">'2'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ASCII: </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Message was sent and returned key </span><span class="token number" style="color:#36acaa">6755399441055746</span><span class="token plain">, </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> corresponds to partition: </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell go-chaos/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./zbchaos publish message -v --partitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully created port forwarding tunnel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Send message </span><span class="token string" style="color:#e3116c">'msg'</span><span class="token plain">, with correaltion key </span><span class="token string" style="color:#e3116c">'2'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ASCII: </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Message was sent and returned key </span><span class="token number" style="color:#36acaa">6755399441055747</span><span class="token plain">, </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> corresponds to partition: </span><span class="token number" style="color:#36acaa">3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Creating the network partition:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos disconnect brokers --broker1PartitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> --broker1Role LEADER --broker2PartitionId </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> --broker2Role LEADER -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully created port forwarding tunnel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found Broker zell-chaos-zeebe-2 as LEADER </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> partition </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found Broker zell-chaos-zeebe-0 as LEADER </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execute </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"apt"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-qq"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"update"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> on pod zell-chaos-zeebe-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disconnect zell-chaos-zeebe-2 from zell-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disconnect zell-chaos-zeebe-0 from zell-chaos-zeebe-2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Creating the process instance and await the result:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos verify steady-state --awaitResult --partitionId </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> --processModelPath </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/msg-catch.bpmn --variables </span><span class="token string" style="color:#e3116c">'{"key":"2"}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Unfortunately, I missed the verbose flag so we can't really see the output. But if failed later with:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Encountered an error during process instance creation. Error: rpc error: code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeadlineExceeded desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Time out between gateway and broker: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">422</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">command-api-1, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.20.4:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">153</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1559826040</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-zeebe-2.zell-chaos-zeebe.zell-chaos.svc:26501 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT15S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encountered an error during process instance creation. Error: rpc error: code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeadlineExceeded desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Time out between gateway and broker: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">441</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">command-api-2, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.20.4:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">153</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-1786651527</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-zeebe-1.zell-chaos-zeebe.zell-chaos.svc:26501 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT15S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encountered an error during process instance creation. Error: rpc error: code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NotFound desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Command </span><span class="token string" style="color:#e3116c">'CREATE_WITH_AWAITING_RESULT'</span><span class="token plain"> rejected with code </span><span class="token string" style="color:#e3116c">'NOT_FOUND'</span><span class="token builtin class-name">:</span><span class="token plain"> Expected to </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> process definition with key </span><span class="token string" style="color:#e3116c">'2251799813685249'</span><span class="token plain">, but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">panic: Expected to create process instance on partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, but timed out after 30s.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goroutine </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/zeebe-io/zeebe-chaos/go-chaos/cmd.glob</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">func10</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x247f740?, </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">0x1758c60?, 0x7?, 0x7?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/src/github.com/zeebe-io/zeebe-chaos/go-chaos/cmd/verify.go:97 +0x1c5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/spf13/cobra.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">*Command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x247f740, </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">0xc000426540, 0x7, 0x7</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/pkg/mod/github.com/spf13/cobra@v1.5.0/command.go:876 +0x67b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/spf13/cobra.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">*Command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.ExecuteC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x24808c0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/pkg/mod/github.com/spf13/cobra@v1.5.0/command.go:990 +0x3bd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/spf13/cobra.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">*Command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/pkg/mod/github.com/spf13/cobra@v1.5.0/command.go:918</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/zeebe-io/zeebe-chaos/go-chaos/cmd.Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/src/github.com/zeebe-io/zeebe-chaos/go-chaos/cmd/root.go:61 +0x25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/src/github.com/zeebe-io/zeebe-chaos/go-chaos/main.go:8 +0x17</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I retried it:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos verify steady-state --awaitResult --partitionId </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> --processModelPath </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/msg-catch.bpmn --variables </span><span class="token string" style="color:#e3116c">'{"key":"2"}'</span><span class="token plain"> -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Successfully created port forwarding tunnel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deploy </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/msg-catch.bpmn </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size: </span><span class="token number" style="color:#36acaa">2980</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployed process model </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/msg-catch.bpmn successful with key </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Create process instance with defition key </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">variables: </span><span class="token string" style="color:#e3116c">'{"key":"2"}'</span><span class="token plain">, awaitResult: true</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encountered an error during process instance creation. Error: rpc error: code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeadlineExceeded desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Time out between gateway and broker: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">509</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">command-api-1, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.20.4:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">153</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1559826040</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-zeebe-2.zell-chaos-zeebe.zell-chaos.svc:26501 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT15S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Create process instance with defition key </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">variables: </span><span class="token string" style="color:#e3116c">'{"key":"2"}'</span><span class="token plain">, awaitResult: true</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encountered an error during process instance creation. Error: rpc error: code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeadlineExceeded desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Time out between gateway and broker: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">530</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">command-api-2, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.20.4:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">153</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-1786651527</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-zeebe-1.zell-chaos-zeebe.zell-chaos.svc:26501 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT14.999S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Create process instance with defition key </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">variables: </span><span class="token string" style="color:#e3116c">'{"key":"2"}'</span><span class="token plain">, awaitResult: true</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Encountered an error during process instance creation. Error: rpc error: code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NotFound desc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Command </span><span class="token string" style="color:#e3116c">'CREATE_WITH_AWAITING_RESULT'</span><span class="token plain"> rejected with code </span><span class="token string" style="color:#e3116c">'NOT_FOUND'</span><span class="token builtin class-name">:</span><span class="token plain"> Expected to </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> process definition with key </span><span class="token string" style="color:#e3116c">'2251799813685249'</span><span class="token plain">, but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">panic: Expected to create process instance on partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, but timed out after 30s.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">goroutine </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/zeebe-io/zeebe-chaos/go-chaos/cmd.glob</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">func10</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x247f740?, </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">0x1758c60?, 0x8?, 0x8?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/src/github.com/zeebe-io/zeebe-chaos/go-chaos/cmd/verify.go:97 +0x1c5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/spf13/cobra.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">*Command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x247f740, </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">0xc00007e500, 0x8, 0x8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/pkg/mod/github.com/spf13/cobra@v1.5.0/command.go:876 +0x67b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/spf13/cobra.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">*Command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.ExecuteC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x24808c0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/pkg/mod/github.com/spf13/cobra@v1.5.0/command.go:990 +0x3bd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/spf13/cobra.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">*Command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/pkg/mod/github.com/spf13/cobra@v1.5.0/command.go:918</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github.com/zeebe-io/zeebe-chaos/go-chaos/cmd.Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/src/github.com/zeebe-io/zeebe-chaos/go-chaos/cmd/root.go:61 +0x25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /home/zell/goPath/src/github.com/zeebe-io/zeebe-chaos/go-chaos/main.go:8 +0x17</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And got a similar exception. Taking a look at Operate we can see that process instances are created. It is likely that the await timed out since the message hasn't been correlated but the returned error is a bit unclear. Interesting is that on partition two the message is also not correlated.</p><p><img loading="lazy" alt="operate" src="/zeebe-chaos/assets/images/operate-efd0c9d98a1666f44bf235ba5bf4cdf2.png" width="1800" height="794" class="img_ev3q"></p><p>Removing the network partition:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos connect brokers -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connecting to zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execute </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"sh"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-c"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"command -v ip"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> on pod zell-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/sbin/ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execute </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"sh"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-c"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ip route | grep -m 1 unreachable"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> on pod zell-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execute </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"sh"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-c"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ip route del unreachable 10.0.17.8"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> on pod zell-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected zell-chaos-zeebe-0 again, removed unreachable routes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execute </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"sh"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-c"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"command -v ip"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> on pod zell-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error on connection Broker: zell-chaos-zeebe-1. Error: Execution exited with </span><span class="token builtin class-name">exit</span><span class="token plain"> code </span><span class="token number" style="color:#36acaa">127</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Command not found</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. It is likely that the broker was not disconnected or restarted </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> between.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execute </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"sh"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-c"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"command -v ip"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> on pod zell-chaos-zeebe-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error on connection Broker: zell-chaos-zeebe-2. Error: Execution exited with </span><span class="token builtin class-name">exit</span><span class="token plain"> code </span><span class="token number" style="color:#36acaa">127</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Command not found</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. It is likely that the broker was not disconnected or restarted </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> between.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It looks like the Broker-2 was restarted in between, which is really the case if we check the <code>kubectl get pods</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell go-chaos/ cluster: zeebe-cluster ns:zell-chaos]$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-27698835-pwdjh     0/1     Completed   0          9m20s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-operate-64bbc6794d-vqtnc         1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running     0          2m48s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-795f87fd64-c9mf4   1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-795f87fd64-h5d9c   1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-795f87fd64-nlr5v   1/1     Running     0          12m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The topology has also completely changed.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zbchaos topology</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">Partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">Partition </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">Partition </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">LEADER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">LEADER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">LEADER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">FOLLOWER </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HEALTHY</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After connecting again the instances haven't been executed. My guess is that the TTL was already reached.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="rerun">Rerun<a href="#rerun" class="hash-link" aria-label="Direct link to Rerun" title="Direct link to Rerun">​</a></h5><p>I will disconnect again partitions one and three and publish a message to partition three. Afterward I will connect them again and see whether the message is correlated.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos disconnect brokers --broker1PartitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> --broker1Role LEADER --broker2PartitionId </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> --broker2Role LEADER -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos publish message -v --partitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos publish message -v --partitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos publish message -v --partitionId </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./zbchaos connect brokers -v</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Take a look at Operate again:</p><p><img loading="lazy" alt="operate2" src="/zeebe-chaos/assets/images/operate2-c96a932956d4207bff7ce70f78cb7544.png" width="1851" height="738" class="img_ev3q"></p><p>We can see that the experiment was successful, and the message has been correlated even if they are published during a network partition. 🎉</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2><ul><li>I learned that the go zeebe client, doesn't set a default TTL which was interesting to find out (and somehow unexpected).</li><li>The zbchaos uses always the same port for connecting to the kubernetes and zeebe cluster, which makes it impossible to run multiple commands. We should use random ports to make this possible.</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Bring Deployment distribution experiment back]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2022/08/02/deployment-distribution</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2022/08/02/deployment-distribution"/>
        <updated>2022-08-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We encountered recently a severe bug zeebe#9877 and I was wondering why we haven't spotted it earlier, since we have chaos experiments for it. I realized two things:]]></summary>
        <content type="html"><![CDATA[<p>We encountered recently a severe bug <a href="https://github.com/camunda/zeebe/issues/9877" target="_blank" rel="noopener noreferrer">zeebe#9877</a> and I was wondering why we haven't spotted it earlier, since we have chaos experiments for it. I realized two things:</p><ol><li>The experiments only check for parts of it (BPMN resource only). The production code has changed, and a new feature has been added (DMN) but the experiments/tests haven't been adjusted.</li><li>More importantly we disabled the automated execution of the deployment distribution experiment because it was flaky due to a missing standalone gateway in Camunda Cloud SaaS <a href="https://github.com/zeebe-io/zeebe-chaos/issues/61" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-chaos#61</a>. This is no longer the case, see <a href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li></ol><p>On this chaos day I want to bring the automation of this chaos experiment back to life. If I have still time I want to enhance the experiment. </p><p><strong>TL;DR;</strong> The experiment still worked, and our deployment distribution is still resilient against network partitions. It also works with DMN resources. I can enable the experiment again, and we can close <a href="https://github.com/zeebe-io/zeebe-chaos/issues/61" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-chaos#61</a>. Unfortunately, we were not able to reproduce <a href="https://github.com/camunda/zeebe/issues/9877" target="_blank" rel="noopener noreferrer">zeebe#9877</a> but we did some good preparation work for it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>To recap, when a deployment is created by a client it is sent to the partition one leader. Partition one is in charge of distributing the deployment to the other partitions. That means it will send the deployment to the other partition leaders, this is retried as long no ACK was received from the corresponding partition leader.</p><p><img loading="lazy" alt="deploymentDistribution" src="/zeebe-chaos/assets/images/deploymentDistribution-d300fff30d9d6cab27d9fe01c6504cd4.png" width="871" height="491" class="img_ev3q"></p><p>We already have covered that in more detail in another chaos day you can read <a href="/zeebe-chaos/2021/01/26/deployments">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p><img loading="lazy" src="/zeebe-chaos/assets/images/deploymentDistributionExperiment-8f120f1fafbca4d31ecf2fb0f8e909ba.png" width="933" height="515" class="img_ev3q"></p><p>As you can see in the image we will create an asymmetric network partition and disconnect the partition one leader from partition three. That means the sending to partition three will not be possible. We use here an asymmetric network partition, in order to reduce the probability to cause a leader change. The partition one leader is a follower of partition three and will still receive heartbeats.</p><p>After disconnecting the leaders we deploy multiple process versions and after connecting the leaders again we expect that the deployments are distributed. It is expected that we can create instances of the last version on all partitions.</p><p>We will run the existing experiment against the latest minor version, to verify whether the experiment still works. When we enable the experiment again for automation it will be executed against SNAPSHOT automatically.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h4><p>As a first step, we created a new Production-S cluster, which has three partitions, three nodes (brokers), and two standalone gateways. The Zeebe version was set to 8.0.4 (latest minor).</p><p>It was a while since I used the <a href="https://chaostoolkit.org/" target="_blank" rel="noopener noreferrer">chaostoolkit</a> which is the reason I had to reinstall it again, which is quite a simple see <a href="https://chaostoolkit.org/reference/usage/install/" target="_blank" rel="noopener noreferrer">here</a>.</p><p>TL;DR:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m venv ~/.venvs/chaostk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source  ~/.venvs/chaostk/bin/activate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install -U chaostoolkit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chaos --version</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="executing-chaos-toolkit">Executing chaos toolkit<a href="#executing-chaos-toolkit" class="hash-link" aria-label="Direct link to Executing chaos toolkit" title="Direct link to Executing chaos toolkit">​</a></h4><p>As mentioned, the deployment distribution was not enabled for Production-S clusters, which is currently the only configuration we test via <a href="https://github.com/zeebe-io/zeebe-cluster-testbench" target="_blank" rel="noopener noreferrer">Zeebe Testbench</a>. We have to use the experiment that is defined under <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-workers/chaos-experiments/camunda-cloud/production-l/deployment-distribution" target="_blank" rel="noopener noreferrer">production-l/deployment-distribution</a>, which is the same*.</p><sub>* That is not 100% true. During running the Production-l experiment I realized that it made some assumptions regarding the <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-workers/chaos-experiments/scripts/disconnect-leaders-one-way.sh#L19" target="_blank" rel="noopener noreferrer">partition count</a> which needs to be adjusted for the Production-S setup.</sub><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> chaos run production-l/deployment-distribution/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Validating the experiment's syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Running experiment: Zeebe deployment distribution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Playing your experiment's method now...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Action: Enable net_admin capabilities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:26 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:26 INFO] Pausing after activity for 180s...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:26 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:33 INFO] Action: Create network partition between leaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:34 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:34 INFO] Action: Deploy different deployment versions.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:40 INFO] Action: Delete network partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:42 INFO] Probe: Create process instance of latest version on partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:43 INFO] Probe: Create process instance of latest version on partition two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:44 INFO] Probe: Create process instance of latest version on partition three</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:44 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:44 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] Let's rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] No declared rollbacks, let's move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Based on the tool output it looks like it succeed, to make sure it really worked, we will take a look at the logs in stackdriver.</p><p>In the following logs we can see that deployment distribution is failing for partition 3 and is retried, which is expected and what we wanted.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.114 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685347-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.115 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685347 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.157 CEST zeebe Received new exporter state {elasticsearch=228, MetricsExporter=228} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.157 CEST zeebe Received new exporter state {elasticsearch=228, MetricsExporter=228}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.241 CEST zeebe Received new exporter state {elasticsearch=232, MetricsExporter=232}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.241 CEST zeebe Received new exporter state {elasticsearch=232, MetricsExporter=232}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.464 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685351-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.466 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685351 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.216 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685353-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.218 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685353 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.224 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685355-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.225 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685355 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.055 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685359-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.057 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685359 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.689 CEST zeebe Received new exporter state {elasticsearch=299, MetricsExporter=299}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.690 CEST zeebe Received new exporter state {elasticsearch=299, MetricsExporter=299}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.089 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685357-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.090 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685357 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.272 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685363-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.273 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685363 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.920 CEST zeebe Failed to receive deployment response for partition 3 (on topic 'deployment-response-2251799813685361-3'). Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.922 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685361 was written on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:39:08.369 CEST zeebe Received new exporter state {elasticsearch=252, MetricsExporter=252}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At some point, the retry stopped, and we can see in the experiment output that we were able to start process instances on all partitions. This is great because it means the experiment was successfully executed and our deployment distribution is failure tolerant.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="enhancement">Enhancement<a href="#enhancement" class="hash-link" aria-label="Direct link to Enhancement" title="Direct link to Enhancement">​</a></h4><p>As described earlier the current experiment deploys a BPMN process model only. It looks like this:</p><p><img loading="lazy" alt="v1" src="/zeebe-chaos/assets/images/multiVersionModel-bae5089e350bb8e3ef1f11b3e01be25c.png" width="999" height="276" class="img_ev3q"></p><p>In order to make DMN part of the experiment, we change the service task to a <a href="https://docs.camunda.io/docs/components/modeler/bpmn/business-rule-tasks/" target="_blank" rel="noopener noreferrer">Business Rule task</a>. </p><p><img loading="lazy" alt="v2" src="/zeebe-chaos/assets/images/multiVersionModelv2-7fa903fb40c6a640222206e5922de001.png" width="999" height="276" class="img_ev3q"></p><p>The decision is really simple and just defines a static input and returns that as output.</p><p><img loading="lazy" alt="decision" src="/zeebe-chaos/assets/images/decision-3e1b9db140fbc19b0250ee1fd804a33d.png" width="1213" height="471" class="img_ev3q"></p><p>When we run our experiment and create process instances on all partitions the DMN needs to be available otherwise the execution would fail. Currently, we can't specify a specific version of the DMN in the Business Rule Task (always the latest will be executed). Because of that, we will not deploy different DMN model versions, since it is currently not that easy to verify whether the right version was chosen. </p><p>After adjusting the model and adjusting the script, we run the experiment again.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ chaos run production-l/deployment-distribution/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Validating the experiment's syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Running experiment: Zeebe deployment distribution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Playing your experiment's method now...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Action: Enable net_admin capabilities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Pausing after activity for 180s...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:14 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:14 INFO] Action: Create network partition between leaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:16 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:16 INFO] Action: Deploy different deployment versions.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:25 INFO] Action: Delete network partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:27 INFO] Probe: Create process instance of latest version on partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:27 INFO] Probe: Create process instance of latest version on partition two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:28 INFO] Probe: Create process instance of latest version on partition three</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Let's rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] No declared rollbacks, let's move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It succeeded as well.</p><p>Taking a look at Operate we can see some incidents.</p><p><img loading="lazy" alt="dmn-error" src="/zeebe-chaos/assets/images/dmn-error-422b88cf3273e715c442c76ecce338d9.png" width="1000" height="175" class="img_ev3q"></p><p>It seems the process instance execution runs into the Business Rule Task, but the DMN resource was not available on the partition. </p><p><img loading="lazy" alt="dmn-retry" src="/zeebe-chaos/assets/images/dmn-retry-665320690997b2566a40ac99505a2f84.png" width="2528" height="698" class="img_ev3q"></p><p>After retrying in Operate the incident was resolved, which means the DMN resource was distributed at that time.</p><p>We can adjust the experiment further to await the result of the process execution, but I will stop here and leave that for a later point.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="reproduce-our-bug">Reproduce our bug<a href="#reproduce-our-bug" class="hash-link" aria-label="Direct link to Reproduce our bug" title="Direct link to Reproduce our bug">​</a></h4><p>The current experiment didn't reproduce the bug in <a href="https://github.com/camunda/zeebe/issues/9877" target="_blank" rel="noopener noreferrer">zeebe#9877</a>, since the DMN resource has to be distributed multiple times. Currently, we create a network partition such that the distribution doesn't work at all. </p><p><img loading="lazy" src="/zeebe-chaos/assets/images/deploymentDistributionExperimentV2-271448cf9bf1690fc24acdd0f89581d9.png" width="933" height="515" class="img_ev3q"></p><p>In order to reproduce our scenario, we can set the network partition in the other direction, such that the acknowledgment is not received by the leader one.</p><p>Adjusting the experiment (script) like this:</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">retryUntilSuccess disconnect "$leader" "$leaderTwoIp"</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">retryUntilSuccess disconnect "$leaderTwo" "$leaderIp"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Should do the trick, but I was not yet able to reproduce the issue with 8.0.4. It seems we need to spend some more time reproducing the bug. But I think with today's changes we already did a good step in the right direction, and we can improve based on that. I will create a follow-up issue to improve our experiment.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-work">Further Work<a href="#further-work" class="hash-link" aria-label="Direct link to Further Work" title="Direct link to Further Work">​</a></h2><p>Based on today's outcome we can enable again the Deployment Distribution experiment for Production-S, such that is executed by Zeebe Testbench (our automation tooling). We can close <a href="https://github.com/zeebe-io/zeebe-chaos/issues/61" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-chaos#61</a></p><p>We should adjust our Chaos Worker implementation such that we also deploy DMN resources as we did in today's Chaos Day, since the scripts we changed aren't used in the automation.</p><p> I will create a follow-up issue to improve our experiment, so we can reproduce the critical bug.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2><p><em>none</em></p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Standalone Gateway in CCSaaS]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS"/>
        <updated>2022-02-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We recently introduced the Zeebe Standalone Gateway in CCSaaS. Today I wanted to do a first simple]]></summary>
        <content type="html"><![CDATA[<p>We recently introduced the Zeebe Standalone Gateway in CCSaaS. Today I wanted to do a first simple
chaos experiment with the gateway, where we just restart one gateway. </p><p>Ideally in the future we could enable some gateway chaos experiments again, which we currently only support for <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-workers/chaos-experiments/helm" target="_blank" rel="noopener noreferrer">helm</a>.</p><p><strong>TL;DR;</strong> Our Camunda Cloud clusters can handle gateway restarts without issues. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>This experiment is a simple restart / kill pod experiment. We want to verify that our cluster
can still make progress even if a gateway is restarted / killed in between. Currently, we are running two gateway replicas in the CCSaaS. </p><p>In order to start with our experiment we created a new CCSaaS cluster with a <code>Production - S</code> plan, and the latest version (1.3.4).
To run some load on the cluster we used the cloud benchmark deployments, which you can find <a href="https://github.com/camunda-cloud/zeebe/tree/main/benchmarks/setup/cloud-default" target="_blank" rel="noopener noreferrer">here</a>.
The load was rather low with ~ 100 PI/s.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p><em>Hypothesis: When restarting / killing a zeebe standalone gateway we expect only a small
impact on current requests, new requests should be routed to the right gateway and the cluster can
make progress.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>After creating the cluster and starting the benchmark we checked the current resource usage, to find a cluster which does most of the work. It looks like that the requests are well distributed.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell zell-chaos/ cluster: ultrachaos ns:448f5091-8d15-4c01-a0ee-202437c09d83-zeebe</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ k </span><span class="token function" style="color:#d73a49">top</span><span class="token plain"> pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                     CPU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   MEMORY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-gateway-6c9f95b557-f2zbf                           294m         407Mi           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-gateway-6c9f95b557-gk57z                           202m         396Mi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We deleted the first pod <code>zeebe-gateway-6c9f95b557-f2zbf</code> and observed the metrics.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos/ cluster: ultrachaos ns:448f5091-8d15-4c01-a0ee-202437c09d83-zeebe]$ k delete pod zeebe-gateway-6c9f95b557-f2zbf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod "zeebe-gateway-6c9f95b557-f2zbf" deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that a new gateway pod is created quite fast.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos/ cluster: ultrachaos ns:448f5091-8d15-4c01-a0ee-202437c09d83-zeebe]$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                     READY   STATUS             RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-gateway-6c9f95b557-flgz6                           0/1     Running            0          16s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-gateway-6c9f95b557-gk57z                           1/1     Running            0          156m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As expected we see no high impact due to the restart. </p><p><img loading="lazy" src="/zeebe-chaos/assets/images/restart-5fbac0a50fb69d699a0721209d956d9d.png" width="1834" height="682" class="img_ev3q"></p><p>Just out of interest I deleted all gateway pods:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ k delete pod -l app.kubernetes.io/component</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">standalone-gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">"zeebe-gateway-6c9f95b557-flgz6"</span><span class="token plain"> deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">"zeebe-gateway-6c9f95b557-gk57z"</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that the throughput goes almost directly down, but recovers again. It took ~4 min until we
reached the normal state (normal throughput of 100 PI/s) again. But we can also see that it is only a short period
of time, where nothing happens. </p><p><img loading="lazy" src="/zeebe-chaos/assets/images/restart2-a5fd3b37472ebf79e5edac7f1ed513e5.png" width="1828" height="685" class="img_ev3q"></p><p>Ideally we would define some anti-affinity on the gateway pods, to reduce the risk of losing all gateways at once.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h2><p>We were able to verify and proof our hypothesis.</p><blockquote><p><em>Hypothesis: When restarting / killing a zeebe standalone gateway we expect only a small
impact on current requests, new requests should be routed to the right gateway and the cluster can
make progress.</em></p></blockquote><p>As we saw above the resources were almost equally used, which is in our normal zeebe benchmarks not the case.
In the benchmarks we use the helm charts and there is no ingress controller enabled,
so we have no good load balancing of the incoming requests.</p><p>The benefit of the standalone gateway now stands out: losing one is not too problematic than one broker with an embedded gateway,
since a broker takes longer to restart and is likely to be an leader for a partition, which will then also cause a leader change.
Furthermore, we can scale the gateways independently. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-issues">Found Issues<a href="#found-issues" class="hash-link" aria-label="Direct link to Found Issues" title="Direct link to Found Issues">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimize-resources">Optimize resources<a href="#optimize-resources" class="hash-link" aria-label="Direct link to Optimize resources" title="Direct link to Optimize resources">​</a></h3><p>During experiment with the CCSaaS cluster I observed that the Optimize importer was crashlooping due to this load (PI 100/s).</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell zell-chaos/ cluster: ultrachaos ns:448f5091-8d15-4c01-a0ee-202437c09d83-zeebe</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                     READY   STATUS             RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">optimize-deployment-importer-archiver-65679b6449-pb7kz   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1     CrashLoopBackOff   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">          128m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Checking the pod shows:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    State:          Waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Reason:       CrashLoopBackOff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Last State:     Terminated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Reason:       Error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Exit Code:    </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Started:      Tue, </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> Feb </span><span class="token number" style="color:#36acaa">2022</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:25:36 +0100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Finished:     Tue, </span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> Feb </span><span class="token number" style="color:#36acaa">2022</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:26:33 +0100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ready:          False</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Checking the logs we can see that it runs continuously out of memory.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zell￼  </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> minutes ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:32:48.493 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ZeebeImportScheduler-1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> WARN  org.elasticsearch.client.RestClient - request </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">POST http://elasticsearch:9200/zeebe-record-process-instance/_search?routing</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">typed_keys</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">max_concurrent_shard_requests</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">ignore_unavailable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">expand_wildcards</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">open</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">allow_no_indices</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">ignore_throttled</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">request_cache</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">search_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">query_then_fetch</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">batched_reduce_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">ccs_minimize_roundtrips</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> returned </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> warnings: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">299</span><span class="token plain"> Elasticsearch-7.16.2-2b937c44140b6559905130a8650c64dbd0879cfb </span><span class="token string" style="color:#e3116c">"[ignore_throttled] parameter is deprecated because frozen indices have been deprecated. Consider cold or frozen tiers in place of frozen indices."</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:32:49.104 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ImportJobExecutor-pool-ZeebeProcessInstanceImportService-0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> WARN  org.elasticsearch.client.RestClient - request </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">HEAD http://elasticsearch:9200/optimize-process-instance-benchmark?ignore_throttled</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">ignore_unavailable</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">expand_wildcards</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">open%2Cclosed</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">allow_no_indices</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> returned </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> warnings: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">299</span><span class="token plain"> Elasticsearch-7.16.2-2b937c44140b6559905130a8650c64dbd0879cfb </span><span class="token string" style="color:#e3116c">"[ignore_throttled] parameter is deprecated because frozen indices have been deprecated. Consider cold or frozen tiers in place of frozen indices."</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.OutOfMemoryError: Java heap space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dumping heap to java_pid8.hprof </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Heap dump </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> created </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">611503401</span><span class="token plain"> bytes </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.070</span><span class="token plain"> secs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terminating due to java.lang.OutOfMemoryError: Java heap space</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gateway-metrics">Gateway metrics<a href="#gateway-metrics" class="hash-link" aria-label="Direct link to Gateway metrics" title="Direct link to Gateway metrics">​</a></h3><p>It looks like that in our latest ccsm helm charts, we no longer export the gateway metrics which we should fix.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gateway-anti-affinity">Gateway Anti-affinity<a href="#gateway-anti-affinity" class="hash-link" aria-label="Direct link to Gateway Anti-affinity" title="Direct link to Gateway Anti-affinity">​</a></h3><p>Currently, we have no anti-affinity defined for the gateway, which could cause on preemption to take down all gateways.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[High Snapshot Frequency]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2022/02/01/High-Snapshot-Frequency</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2022/02/01/High-Snapshot-Frequency"/>
        <updated>2022-02-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today we wanted to experiment with the snapshot interval and verify that a high snapshot frequency will not impact our availability (#21).]]></summary>
        <content type="html"><![CDATA[<p>Today we wanted to experiment with the snapshot interval and verify that a high snapshot frequency will not impact our availability (<a href="https://github.com/zeebe-io/zeebe-chaos/issues/21" target="_blank" rel="noopener noreferrer">#21</a>).</p><p><strong>TL;DR;</strong> The chaos experiment succeeded 💪 We were able to prove our hypothesis.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="snapshot-interval">Snapshot Interval<a href="#snapshot-interval" class="hash-link" aria-label="Direct link to Snapshot Interval" title="Direct link to Snapshot Interval">​</a></h3><p>As we can see in the <a href="https://docs.camunda.io/docs/self-managed/zeebe-deployment/operations/resource-planning/#snapshots" target="_blank" rel="noopener noreferrer">docs</a> a snapshot is defined as:</p><blockquote><p>A snapshot is a projection of all events that represent the current running state of the processes running on the partition. It contains all active data, for example, deployed processes, active process instances, and not yet completed jobs.</p></blockquote><p>Per default snapshots are taken every 5 minutes, by leaders and followers. If a follower is lagging behind (with replication) the leader will, after reaching a certain threshold, prefer to send the follower a snapshot instead of replicating X amount of records. We recently observed that this currently happens quite often, see <a href="https://github.com/camunda-cloud/zeebe/issues/8565" target="_blank" rel="noopener noreferrer">#8565</a>.</p><p>The snapshot interval can be changed via an environment variable: <code>ZEEBE_BROKER_DATA_SNAPSHOTPERIOD</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We expect that even if the snapshot interval is low (so the frequency of taking snapshot is high) we not run into any availability issues and the cluster should still be healthy. Lower snapshot interval might impact the performance, since taking a snapshot can take some time but other than that it shouldn't have any effect.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>As usual, we run again two benchmarks to compare them. One base which has the <a href="https://github.com/camunda-cloud/zeebe/tree/develop/benchmarks/setup/default" target="_blank" rel="noopener noreferrer">default benchmark configuration</a> and one with a changed snapshot interval.</p><p>For the second benchmark we set the snapshot interval to one minute. Like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: ZEEBE_BROKER_DATA_SNAPSHOTPERIOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: "1m"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Throughput wise we can see a small difference, but this might be more related that on the base benchmark one node is leader for all partitions.</p><table><thead><tr><th>Base</th><th>Chaos</th></tr></thead><tbody><tr><td><img loading="lazy" src="/zeebe-chaos/assets/images/chaos-base-general-93cd02e76e4ef0ed2125c457d5137ac0.png" width="1842" height="992" class="img_ev3q"></td><td><img loading="lazy" src="/zeebe-chaos/assets/images/chaos-general-5d09330d3230f0843593e5384da1563f.png" width="1834" height="994" class="img_ev3q"></td></tr></tbody></table><p>In general the cluster with the small snapshot interval shows no negative effect. What we can see is that the install request rate increased. It seems to be currently have no affect, but it is likely that if more partitions are added it might become an issue.</p><table><thead><tr><th>Base</th><th>Chaos</th></tr></thead><tbody><tr><td><img loading="lazy" src="/zeebe-chaos/assets/images/chaos-base-install-freq-8110ca25fd510d004d558c30a6a75ad6.png" width="1832" height="539" class="img_ev3q"></td><td><img loading="lazy" src="/zeebe-chaos/assets/images/chaos-install-freq-aea78deeffe000efe95cf1c111dade6f.png" width="1831" height="538" class="img_ev3q"></td></tr></tbody></table><p>Further investigation needs to be done as part of <a href="https://github.com/camunda-cloud/zeebe/issues/8565" target="_blank" rel="noopener noreferrer">#8565</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="smaller-intervals">Smaller intervals<a href="#smaller-intervals" class="hash-link" aria-label="Direct link to Smaller intervals" title="Direct link to Smaller intervals">​</a></h4><p>The smallest interval which Zeebe supports is <code>1m == 1 minute</code>. If we configure for example <code>1s</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: ZEEBE_BROKER_DATA_SNAPSHOTPERIOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: "1s"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see the following exception in the log and the broker fails to start.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.IllegalArgumentException: Snapshot period PT1S needs to be larger then or equals to one minute.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bigger-intervals">Bigger intervals<a href="#bigger-intervals" class="hash-link" aria-label="Direct link to Bigger intervals" title="Direct link to Bigger intervals">​</a></h4><p>In order to verify how Zeebe reacts on a bigger snapshot interval we have set the interval to 30 minutes.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: ZEEBE_BROKER_DATA_SNAPSHOTPERIOD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: "30m"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In general, it looked good. What we can see is that one node was restarted in between and took a while to come back. </p><p><img loading="lazy" src="/zeebe-chaos/assets/images/big-general-799179b5b7dc76032320f1a31488778f.png" width="1840" height="986" class="img_ev3q"></p><p>This is expected due to the high snapshot interval, but interesting to observe. The leader had no snapshot yet produced, which means it had to replicate all events to the restarted follower. Only if the follower catches up on all partitions its bootstrap process is complete, and it can mark itself as ready. As we see it can take a while if there is no snapshot available, since new records are incoming all the time. </p><p>After the leader of partition two took a snapshot and the leader sent this snapshot to the follower, the follower were able to become ready.</p><p>Even with a big snapshot interval we can see that as soon as a new snapshot is taken it is sent to the followers, which is suboptimal.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/big-install-freq-ec4ff83707c476e44d9469cc1969b106.png" width="2472" height="274" class="img_ev3q"></p><p>An important thing to keep in mind when playing around with snapshots is the logstream/journal size. The journal is only compacted after taking a snapshot, if we take snapshot less frequent this means we clean up less frequent. The log can grow much bigger with big snapshot intervals.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/big-interval-log-84637b403e2e447d914fbf9fc386e164.png" width="1219" height="295" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>The chaos experiment succeeded 🎉 We verified that a smaller snapshot interval has no negative impact on the cluster availability, at least for a small amount of partitions. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2><ul><li>Existing issue regarding the install requests <a href="https://github.com/camunda-cloud/zeebe/issues/8565" target="_blank" rel="noopener noreferrer">#8565</a></li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Handling of Big Variables]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2022/01/19/big-variables</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2022/01/19/big-variables"/>
        <updated>2022-01-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[New Year;New Chaos]]></summary>
        <content type="html"><![CDATA[<p>New Year;🎉New Chaos🐒</p><p>This time I wanted to experiment with "big" variables. Zeebe supports a <code>maxMessageSize</code> of 4 MB, which is quite big. In general, it should be clear that using big variables will cause performance issues, but today I also want to find out whether the system can handle big variables (~1 MB) at all. </p><p><strong>TL;DR;</strong> Our Chaos experiment failed! Zeebe and Camunda Cloud is not able to handle (per default) big variables (~1 MB) without issues.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>Normally we run our benchmarks with ~32 KB payload size. This time we want to try out a payload size of ~1 MB and verify whether the system can handle such payload sizes. The payload we use can be found <a href="big_payload.json" target="_blank" rel="noopener noreferrer">here</a>. </p><p>The benchmark setup, is similar to default Zeebe benchmarks you can find <a href="https://github.com/camunda-cloud/zeebe/tree/develop/benchmarks/setup/default" target="_blank" rel="noopener noreferrer">here</a>. To make it work and fair we updated the starter and worker resources for both, base and the chaos cluster.</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/benchmarks/setup/default/starter.yaml b/benchmarks/setup/default/starter.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index 78c6e81dbb..d0404d4d3e 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token coord">--- a/benchmarks/setup/default/starter.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token coord">+++ b/benchmarks/setup/default/starter.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -30,11 +30,11 @@ spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            value: "warn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            cpu: 250m</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            cpu: 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            memory: 2Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            cpu: 250m</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            cpu: 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            memory: 2Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token plain">diff --git a/benchmarks/setup/default/worker.yaml b/benchmarks/setup/default/worker.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index cd6f5ffeb6..05b195291f 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token coord">--- a/benchmarks/setup/default/worker.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token coord">+++ b/benchmarks/setup/default/worker.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -31,11 +31,11 @@ spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">            value: "warn"</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            cpu: 500m</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            cpu: 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            memory: 1Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            cpu: 500m</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">            memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            cpu: 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">            memory: 1Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>It is expected that the performance will drop, we formulate the following hypothesis.</p><p><strong>Hypothesis: With a bigger payload size of e.g. 1 MB, Zeebe should be still able to handle process instances, maybe under a degraded performance, but in general the availability must not suffer from such a payload size.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="base">Base<a href="#base" class="hash-link" aria-label="Direct link to Base" title="Direct link to Base">​</a></h4><p>We started a base benchmark with ~32 KB to verify how it looks like normally.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/base-general-6f2d98f4e1437e7d6ccaeb9106e1ad4e.png" width="1838" height="912" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="small-payload">Small Payload<a href="#small-payload" class="hash-link" aria-label="Direct link to Small Payload" title="Direct link to Small Payload">​</a></h4><p>In order to verify how Zeebe handles different payload, we first started with a small payload ~130 bytes, which is part of the Starter application (called <code>small_payload.json</code>). </p><p><img loading="lazy" alt="small-payload" src="/zeebe-chaos/assets/images/small-payload-7275166d05a6c32e2a0e7d86125f3c44.png" width="1835" height="910" class="img_ev3q"></p><p>We can see that the system handles such payload without any issues, and we can reach ~190 process instances per second (PI/s).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="big-payload">Big Payload<a href="#big-payload" class="hash-link" aria-label="Direct link to Big Payload" title="Direct link to Big Payload">​</a></h4><p>After running with a small payload, we changed the payload to a size of ~1 MB. This immediately broke the standalone gateways.</p><p><img loading="lazy" alt="big-payload" src="/zeebe-chaos/assets/images/big-payload-starter-gw-restarts-18e517c14c161d58190bd23b618b87cf.png" width="1835" height="904" class="img_ev3q"></p><p>The gateways went out of memory (OOM) in a loop. No processing was made in this time.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="increasing-resources">Increasing Resources<a href="#increasing-resources" class="hash-link" aria-label="Direct link to Increasing Resources" title="Direct link to Increasing Resources">​</a></h5><p>In order to continue the experiment and to verify how Zeebe itself can handle it, we increased the gateway resources.</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diff --git a/benchmarks/setup/default/zeebe-values.yaml b/benchmarks/setup/default/zeebe-values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index 371ba538dc..7a11c10366 100644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token coord">--- a/benchmarks/setup/default/zeebe-values.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token coord">+++ b/benchmarks/setup/default/zeebe-values.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -38,10 +38,10 @@ gateway:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      cpu: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">      memory: 512Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      memory: 4Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      cpu: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">      memory: 512Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">      memory: 4Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But this doesn't help. The gateway went no longer OOM, but it was still not able to handle the payload.</p><p><img loading="lazy" alt="increase-res" src="/zeebe-chaos/assets/images/big-payload-increase-res-ccf66088a1363c2c7bbf3d10cd430c9e.png" width="1834" height="912" class="img_ev3q"></p><p>We can see that in a short period of time some events have been processed (small spike in the "Current Events" panel), but this stopped quite fast again. In the gateway logs there are endless warnings:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Warning 2022-01-20 10:09:32.644 CET zeebe-cluster-helm "Stream Error"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning 2022-01-20 10:09:56.847 CET zeebe-cluster-helm "Stream Error"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With an underlying exception: <code>io.netty.handler.codec.http2.Http2Exception$StreamException: Stream closed before write could take place</code> </p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Stacktrace</summary><div><div class="collapsibleContent_i85q">``` io.netty.handler.codec.http2.Http2Exception$StreamException: Stream closed before write could take place at io.netty.handler.codec.http2.Http2Exception.streamError(Http2Exception.java:172) ~[netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2RemoteFlowController$FlowState.cancel(DefaultHttp2RemoteFlowController.java:481) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2RemoteFlowController$1.onStreamClosed(DefaultHttp2RemoteFlowController.java:105) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2Connection.notifyClosed(DefaultHttp2Connection.java:357) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2Connection$ActiveStreams.removeFromActiveStreams(DefaultHttp2Connection.java:1007) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2Connection$ActiveStreams.deactivate(DefaultHttp2Connection.java:963) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2Connection$DefaultStream.close(DefaultHttp2Connection.java:515) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2Connection$DefaultStream.close(DefaultHttp2Connection.java:521) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.Http2ConnectionHandler.closeStream(Http2ConnectionHandler.java:613) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2ConnectionDecoder$FrameReadListener.onRstStreamRead(DefaultHttp2ConnectionDecoder.java:444) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.Http2InboundFrameLogger$1.onRstStreamRead(Http2InboundFrameLogger.java:80) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2FrameReader.readRstStreamFrame(DefaultHttp2FrameReader.java:509) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2FrameReader.processPayloadState(DefaultHttp2FrameReader.java:259) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2FrameReader.readFrame(DefaultHttp2FrameReader.java:159) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.Http2InboundFrameLogger.readFrame(Http2InboundFrameLogger.java:41) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.DefaultHttp2ConnectionDecoder.decodeFrame(DefaultHttp2ConnectionDecoder.java:173) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.Http2ConnectionHandler$FrameDecoder.decode(Http2ConnectionHandler.java:378) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:438) [netty-codec-http2-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:510) [netty-codec-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:449) [netty-codec-4.1.73.Final.jar:4.1.73.Final] at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:279) [netty-codec-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) [netty-transport-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:795) [netty-transport-classes-epoll-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480) [netty-transport-classes-epoll-4.1.73.Final.jar:4.1.73.Final] at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378) [netty-transport-classes-epoll-4.1.73.Final.jar:4.1.73.Final] at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986) [netty-common-4.1.73.Final.jar:4.1.73.Final] at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) [netty-common-4.1.73.Final.jar:4.1.73.Final] at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-common-4.1.73.Final.jar:4.1.73.Final] at java.lang.Thread.run(Unknown Source) ```</div></div></details><p>On the client side we can see that the Zeebe cluster seems to be unavailable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="camunda-cloud">Camunda Cloud<a href="#camunda-cloud" class="hash-link" aria-label="Direct link to Camunda Cloud" title="Direct link to Camunda Cloud">​</a></h3><p>We wanted to verify how Camunda Cloud and our standard Cluster plan (GA Hardware Plan) handles such a payload. But the result was the same.</p><p><img loading="lazy" alt="cc-general" src="/zeebe-chaos/assets/images/cc-general-bd2b9235be276f75cd8c485229bf9b44.png" width="1835" height="882" class="img_ev3q"></p><p>The processing stopped quite fast due to OOM of the gateway. We can see that operate is also not able to handle such load.</p><p><img loading="lazy" alt="failed-op" src="/zeebe-chaos/assets/images/failed-operate-6cc764529ec07f8c422fb62e53289a02.png" width="1866" height="713" class="img_ev3q"></p><p>In our console overview we see that all services (exception Zeebe) went unhealthy</p><p><img loading="lazy" alt="console-healthy" src="/zeebe-chaos/assets/images/console-healthy-23ed317bbe9dc53934403731fb72b55c.png" width="739" height="733" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><blockquote><p><em>Hypothesis: With a bigger payload size of e.g. 1 MB Zeebe, should be still able to handle process instances, maybe under a degraded performance but in general the availability must not suffer from such a payload size.</em></p></blockquote><p><strong>We were not able to validate our hypothesis, which means our chaos experiment failed!</strong> 💥</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h3><p>We opened the following bug issues:</p><ul><li>Gateway can't handle bigger payload sizes <a href="https://github.com/camunda-cloud/zeebe/issues/8621" target="_blank" rel="noopener noreferrer">#8621</a></li></ul><h1>Outtakes</h1><p>Interesting issues I run into when doing the chaos experiment, could be count as TIL events and mentioning them might help others.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="message-pack-is-not-valid">Message pack is not valid<a href="#message-pack-is-not-valid" class="hash-link" aria-label="Direct link to Message pack is not valid" title="Direct link to Message pack is not valid">​</a></h2><p>When I first generated the JSON payload, it was an array on root level, which is not supported by Zeebe. </p><p>I spent sometime to understand why I see no progress in processing. Taking a look at the gateway logs we can see:</p><p><code>"Expected to handle gRPC request, but messagepack property was invalid: io.camunda.zeebe.msgpack.MsgpackPropertyException: Property 'variables' is invalid: Expected document to be a root level object, but was 'ARRAY'"</code></p><p>On the client side (if the logging is turned on, starter needs info logging) we see:</p><p><code>INVALID_ARGUMENT: Property 'variables' is invalid: Expected document to be a root level object, but was 'ARRAY'</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-the-starter-payload">Configure the Starter payload<a href="#configure-the-starter-payload" class="hash-link" aria-label="Direct link to Configure the Starter payload" title="Direct link to Configure the Starter payload">​</a></h2><p>In order to use different JSON payload for the starter we support a configuration on the starter application (<code>-Dapp.starter.payloadPath</code>). I had a lot of <em>"fun"</em> to find out the right syntax:</p><ul><li>-Dapp.starter.payloadPath="bpmn/small_payload.json" - <em>DOESN'T WORK</em></li><li>-Dapp.starter.payloadPath="/bpmn/small_payload.json" - <em>DOESN'T WORK</em></li><li>-Dapp.starter.payloadPath=/bpmn/small_payload.json - <em>DOESN'T WORK</em></li><li>-Dapp.starter.payloadPath=bpmn/big_payload.json - <em>WORKS</em></li></ul><p>So be aware don't use <code>"</code> and no <code>/</code> in front, otherwise you might get a <code>java.io.FileNotFoundException: "bpmn/small_payload.json" (No such file or directory)</code> in your starter deployment and wonder why you see no progress.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Worker count should not impact performance]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance"/>
        <updated>2021-11-24T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this chaos day we experimented with the worker count, since we saw recently that it might affect the performance (throughput) negatively if there are more workers deployed. This is related to #7955 and #8244.]]></summary>
        <content type="html"><![CDATA[<p>In this chaos day we experimented with the worker count, since we saw recently that it might affect the performance (throughput) negatively if there are more workers deployed. This is related to <a href="https://github.com/camunda-cloud/zeebe/issues/7955" target="_blank" rel="noopener noreferrer">#7955</a> and <a href="https://github.com/camunda-cloud/zeebe/issues/8244" target="_blank" rel="noopener noreferrer">#8244</a>.</p><p>We wanted to prove, that even if we have more workers deployed the throughput of the process instance execution should not have an negative impact.</p><p><strong>TL;DR;</strong> We were not able to prove our hypothesis. Scaling of workers can have a negative impact on performance. Check out the <a href="#third-chaos-experiment">third chaos experiment</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="first-chaos-experiment">First Chaos Experiment<a href="#first-chaos-experiment" class="hash-link" aria-label="Direct link to First Chaos Experiment" title="Direct link to First Chaos Experiment">​</a></h2><p>We run the first experiment with one partition, three brokers, one standalone gateway and one starter which creates 100 PI/s. In this experiment we deployed different zeebe <a href="https://github.com/camunda-cloud/zeebe/tree/develop/benchmarks" target="_blank" rel="noopener noreferrer">benchmarks</a> with 4, 8 and 16 workers.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>The workers should be able to complete all created instances and if the workers are scaled the throughput should remain.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-worker">4 Worker<a href="#4-worker" class="hash-link" aria-label="Direct link to 4 Worker" title="Direct link to 4 Worker">​</a></h4><p><img loading="lazy" alt="worker-4-p1-general.png" src="/zeebe-chaos/assets/images/worker-4-p1-general-62ffbfc05a0d98a217d628ea1c11dfe0.png" width="1828" height="902" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="8-worker">8 Worker<a href="#8-worker" class="hash-link" aria-label="Direct link to 8 Worker" title="Direct link to 8 Worker">​</a></h4><p><img loading="lazy" alt="worker-8-p1-general.png" src="/zeebe-chaos/assets/images/worker-8-p1-general-d9a0c1f55aeb25f8a41b43f0caf44f47.png" width="1833" height="901" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="16-worker">16 Worker<a href="#16-worker" class="hash-link" aria-label="Direct link to 16 Worker" title="Direct link to 16 Worker">​</a></h4><p><img loading="lazy" alt="worker-16-p1-general.png" src="/zeebe-chaos/assets/images/worker-16-p1-general-6af6d38ff8109ecc304b34fb149d24dc.png" width="1826" height="897" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h5><p>What we can see is that if we increase the worker number it will decrease the throughput, this might be explained with the case that we sent more activation requests / commands which need to be handled by the Brokers. We can see that the back pressure is higher with 16 workers.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="second-chaos-experiment">Second Chaos Experiment<a href="#second-chaos-experiment" class="hash-link" aria-label="Direct link to Second Chaos Experiment" title="Direct link to Second Chaos Experiment">​</a></h2><p>We will repeat first experiment with some changes, to the partition count. We will now use three partitions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected-1">Expected<a href="#expected-1" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>The workers should be able to complete all created instances and if the workers are scaled the throughput should remain or be better.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual-1">Actual<a href="#actual-1" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-worker-1">4 Worker<a href="#4-worker-1" class="hash-link" aria-label="Direct link to 4 Worker" title="Direct link to 4 Worker">​</a></h4><p><img loading="lazy" alt="worker-4-p3-general.png" src="/zeebe-chaos/assets/images/worker-4-p3-general-3e773f9f2734c854f579cf560474f558.png" width="1840" height="898" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="8-worker-1">8 Worker<a href="#8-worker-1" class="hash-link" aria-label="Direct link to 8 Worker" title="Direct link to 8 Worker">​</a></h4><p><img loading="lazy" alt="worker-8-p3-general.png" src="/zeebe-chaos/assets/images/worker-8-p3-general-25f411adf3701877e4ab7a040b401434.png" width="1836" height="903" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="16-worker-1">16 Worker<a href="#16-worker-1" class="hash-link" aria-label="Direct link to 16 Worker" title="Direct link to 16 Worker">​</a></h4><p><img loading="lazy" alt="worker-16-p3-general.png" src="/zeebe-chaos/assets/images/worker-16-p3-general-9e04e4d183f59d59573917fc264a04e0.png" width="1832" height="906" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="result-1">Result<a href="#result-1" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h5><p>In this experiment we can see that all benchmarks reach almost the same throughput, since we not really stressing the system and have enough resources to work with. There is no backpressure at all. In the next experiment we will increase the load.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="third-chaos-experiment">Third Chaos Experiment<a href="#third-chaos-experiment" class="hash-link" aria-label="Direct link to Third Chaos Experiment" title="Direct link to Third Chaos Experiment">​</a></h2><p>We will repeat second experiment with some changes to the instance creation count. We will now start 300 process instances per second, with one starter.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected-2">Expected<a href="#expected-2" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>The workers should be able to complete most of the instances, we would expect that with more workers we would be able to complete more instances and have no negative impact on the system.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual-2">Actual<a href="#actual-2" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-worker-2">4 Worker<a href="#4-worker-2" class="hash-link" aria-label="Direct link to 4 Worker" title="Direct link to 4 Worker">​</a></h4><p><img loading="lazy" alt="worker-4-p3-300-general.png" src="/zeebe-chaos/assets/images/worker-4-p3-300-general-632f8cc19401a161b90ab68bef7978ed.png" width="1825" height="903" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="8-worker-2">8 Worker<a href="#8-worker-2" class="hash-link" aria-label="Direct link to 8 Worker" title="Direct link to 8 Worker">​</a></h4><p><img loading="lazy" alt="worker-8-p3-general.png" src="/zeebe-chaos/assets/images/worker-8-p3-300-general-32b3a55b2d73fc15983195071742b18c.png" width="1832" height="911" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="16-worker-2">16 Worker<a href="#16-worker-2" class="hash-link" aria-label="Direct link to 16 Worker" title="Direct link to 16 Worker">​</a></h4><p><img loading="lazy" alt="worker-16-p3-general.png" src="/zeebe-chaos/assets/images/worker-16-p3-300-general-edb0fc05b8ef76f9991a26e215232366.png" width="1837" height="915" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="result-2">Result<a href="#result-2" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h5><p>Between eight and four workers we see the expected difference, that more workers increases the throughput and we are able to complete more instances in a second. The result of 16 workers is completely unexpected. We observed that after short time frame the completion throughput completely droped, and only process instances are created. </p><p>We were able to reproduce this behavior, which shows the weakness again.</p><p><img loading="lazy" alt="worker-16-p3-general-reproduce.png" src="/zeebe-chaos/assets/images/worker-16-p3-300-general-reproduce-23ede1412500950de080d9b90f080400.png" width="1827" height="886" class="img_ev3q"></p><p>We were not able to prove our hypothesis, that scaling of workers has no negative impact on performance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-analysis">Further Analysis<a href="#further-analysis" class="hash-link" aria-label="Direct link to Further Analysis" title="Direct link to Further Analysis">​</a></h2><p>We created a bug issue to analyze and fix this weakness <a href="https://github.com/camunda-cloud/zeebe/issues/8267" target="_blank" rel="noopener noreferrer">#8267</a>.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="performance" term="performance"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Not produce duplicate Keys]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys"/>
        <updated>2021-11-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Due to some incidents and critical bugs we observed in the last weeks, I wanted to spent some time to understand the issues better and experiment how we could detect them. One of the issue we have observed was that keys were generated more than once, so they were no longer unique (#8129). I will describe this property in the next section more in depth.]]></summary>
        <content type="html"><![CDATA[<p>Due to some incidents and critical bugs we observed in the last weeks, I wanted to spent some time to understand the issues better and experiment how we could detect them. One of the issue we have observed was that keys were generated more than once, so they were no longer unique (<a href="https://github.com/camunda-cloud/zeebe/issues/8129" target="_blank" rel="noopener noreferrer">#8129</a>). I will describe this property in the next section more in depth.</p><p><strong>TL;DR;</strong> We were able to design an experiment which helps us to detect duplicated keys in the log. Further work should be done to automate such experiment and run it agains newer versions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unique-keys">Unique Keys<a href="#unique-keys" class="hash-link" aria-label="Direct link to Unique Keys" title="Direct link to Unique Keys">​</a></h2><p>In Zeebe each element must have an cluster wide unique key. This is a property we expect in several areas inside, but also outside of Zeebe (external services). We can call it an invariant we have to guarantee.</p><p>In order to have cluster wide unique key's we encode the partition id in the key's. You can check this <a href="https://github.com/camunda-cloud/zeebe/blob/develop/protocol/src/main/java/io/camunda/zeebe/protocol/Protocol.java#L71-L73" target="_blank" rel="noopener noreferrer">code</a> for more details. Furthermore only the Leader (of a partition) are in charge and allowed to generate new keys. If a fail-over happens the new leader need to continue with generating new keys, he has to resume where the other Leader have left-of. </p><p>The last part was exactly the issue we had, see <a href="https://github.com/camunda-cloud/zeebe/issues/8129" target="_blank" rel="noopener noreferrer">#8129</a>. The new leader generated key's, which have been already generated by the previous leader. This caused inconsistency in our internal state, but also in external services like Operate.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>This time it is a bit different approach, since we know it will <em>fail</em> and we want to examine how we can detect the weakness.
In order to understand how we can detect and prevent/verify that this will not happen again, I want to run an experiment against 1.2.0. Later we should try to automate this experiment and run it against newer versions.</p><p>As described <a href="#unique-keys">above</a> the issue was caused due to a fail-over, to be more specific, the Follower has already reached the end of the log (replayed all events) and on fail-over he had nothing to replay. In order to reproduce this situation we will do the following experiment:</p><ol><li>Deploy an simple process model, with start and end event.</li><li>Start an instance and await the result <code>zbctl create instance "simpleProcess" --withResult --insecure</code></li><li>Wait a short period of time</li><li>Restart the current Leader <code>k delete pod zell-chaos-zeebe-2</code></li><li>Wait until a new Leader is choosen</li><li>Start an instance and await the result <code>zbctl create instance "simpleProcess" --withResult --insecure</code></li></ol><p>After doing this we should copy the data from the new Leader and exermine the log (with <a href="https://github.com/Zelldon/zdb" target="_blank" rel="noopener noreferrer">zdb</a>). Alternatively, we could also verify the exporter log in elastic.</p><p>In general it should be clear that if we take a look at the log the key can appear multiple times, but they should only reference one single entity/element.</p><p>A key is normally generated when processing a command and written as follow up event the first time to the log. For example when we process the <code>ACTIVATE_ELEMENT</code> command we write the key of the new entity on <code>ELEMENT_ACTIVATED</code> to the log.
Keys are assigned for other types of entities as well, like process instance creations, deployments etc. Here it works similar.</p><p>If the follow-up event contains a key which doesn't occurre the first time, then we have a problem, and this is how we want to detect it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>To follow the chaos engineering approach we will define here a hypothesis, even if we know it might not true for 1.2.0. But later we can reuse it for newer version, because here it should apply.</p><p><em>We expect even if we processed all records and have a fail-over that the new leader should not generate the same keys again.</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>We started a benchmark with version 1.2.0, three brokers and one partition to reduce the scope and followed the described experiment above.</p><p>The second process instance creation returned a key (<code>2251799813685258</code>) which was incremented by one, compared to the other process instance (<code>2251799813685257</code>). Here we already knew that our experiment caused the issue. Because, multiple new entities are generated during processing of a process instance and we awaited the result, at the first process instance creation. This means we have generated already more than one key (on the old leader), which hasn't been picked up by the new leader.</p><p>We copyed the data from the new Leader and exermined the log via <code>zdb</code>. First we printed the complete log into a separate file as json:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  zdb log print -p raft-partition/partitions/1 | jq &gt; data.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This makes it human readable and also processable by other tools, like <code>jq</code>. After checking the file we already found one duplicate.</p><p>The first key was part of index 12 in term one and the duplicate was part of index 20 in term 2 (new leader term)</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"term"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"entries"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"partitionId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processDefinitionKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"bpmnProcessId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"simpleProcess"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"parentElementInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"flowScopeKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"parentProcessInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"elementId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"simpleProcess"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"bpmnElementType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PROCESS"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1636627776427</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"position"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"valueType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PROCESS_INSTANCE"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"intent"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ACTIVATE_ELEMENT"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"recordType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"COMMAND"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"NULL_VAL"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionReason"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"brokerVersion"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.2.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"sourceRecordPosition"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"key"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"partitionId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processDefinitionKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"bpmnProcessId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"simpleProcess"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"variables"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1636627776427</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"position"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">27</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"valueType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PROCESS_INSTANCE_CREATION"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"intent"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"CREATED"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"recordType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"EVENT"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"NULL_VAL"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionReason"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"brokerVersion"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.2.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"sourceRecordPosition"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"key"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685257</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"index"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"term"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"entries"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"partitionId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processDefinitionKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"bpmnProcessId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"simpleProcess"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685257</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"parentElementInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"flowScopeKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"parentProcessInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"elementId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"simpleProcess"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"bpmnElementType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PROCESS"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1636627887305</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"position"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">46</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"valueType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PROCESS_INSTANCE"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"intent"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ACTIVATE_ELEMENT"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"recordType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"COMMAND"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"NULL_VAL"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionReason"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"brokerVersion"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.2.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"sourceRecordPosition"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">45</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"key"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685257</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"partitionId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"value"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processDefinitionKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685249</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"bpmnProcessId"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"simpleProcess"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"processInstanceKey"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685257</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"variables"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"timestamp"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1636627887305</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"position"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">47</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"valueType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PROCESS_INSTANCE_CREATION"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"intent"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"CREATED"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"recordType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"EVENT"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionType"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"NULL_VAL"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"rejectionReason"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"brokerVersion"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.2.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"sourceRecordPosition"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">45</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"key"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2251799813685258</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since reading and checking the complete file is a bit hard and error prone, we tried to exermine the data with <code>jq</code>. This worked quite well, we were able to detect the duplicates with an <code>jq</code> expression.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat data.json | jq -r '.records[] | select(.entries  != null) |  .entries[] | select (.intent == "ELEMENT_ACTIVATED" or .intent == "CREATED") | .key' data.json | sort | uniq -c -d | awk '{print $2}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2251799813685257</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2251799813685258</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2251799813685263</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2251799813685264</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This expression we can use for further experiments and for automating such.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="data" term="data"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Throughput on big state]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/10/29/Throughput-on-big-state</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/10/29/Throughput-on-big-state"/>
        <updated>2021-10-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this chaos day we wanted to prove the hypothesis that the throughput should not significantly change even if we have bigger state, see zeebe-chaos#64]]></summary>
        <content type="html"><![CDATA[<p>In this chaos day we wanted to prove the hypothesis that the throughput should not significantly change even if we have bigger state, see <a href="https://github.com/zeebe-io/zeebe-chaos/issues/64" target="_blank" rel="noopener noreferrer">zeebe-chaos#64</a></p><p>This came up due observations from the <a href="/zeebe-chaos/2021/10/05/recovery-time">last chaos day</a>. We already had a bigger investigation here <a href="https://github.com/camunda-cloud/zeebe/issues/7955" target="_blank" rel="noopener noreferrer">zeebe#7955</a>. </p><p><strong>TL;DR;</strong> We were not able to prove the hypothesis. Bigger state, more than 100k+ process instances in the state, seems to have an big impact on the processing throughput.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>Similar to the <a href="/zeebe-chaos/2021/10/05/recovery-time">last chaos day</a> we set up three brokers, with one partition and replication factor three. </p><p>As first part of the experiment we start some amount of instances, afterwards we want to complete them with our workers. Based on the <a href="/zeebe-chaos/2021/10/05/recovery-time">last chaos day</a> we know what we can complete ~100 process instances with one worker and a capacity of <code>12</code>. An example worker configuration can be found <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/default/worker.yaml" target="_blank" rel="noopener noreferrer">here</a></p><p>We changed the following:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ diff default/worker.yaml zell-chaos/worker.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11c11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;   replicas: 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;   replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">26c26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;               -Dapp.worker.capacity=120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt;               -Dapp.worker.capacity=12</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-one">Experiment One<a href="#experiment-one" class="hash-link" aria-label="Direct link to Experiment One" title="Direct link to Experiment One">​</a></h3><p>As first experiment we start with creating <code>100.000</code> instances, afterwards we start the worker.</p><p>In order to do that easily we can configure the <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/default/starter.yaml" target="_blank" rel="noopener noreferrer">starter</a> and reduce the rate to <code>100</code> and set the duration limit to <code>1000</code>. This means it will run for <code>1000</code> second and start each second <code>100</code> instances (which makes <code>100.000</code>).</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">diff</span><span class="token plain"> default/starter.yaml zell-chaos/starter.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">24</span><span class="token plain">,26c24,26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">               -Dapp.starter.rate</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">               -Dapp.starter.durationLimit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">               -Dapp.starter.rate</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">               -Dapp.starter.durationLimit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h4><p>We expected that we can create <code>100.000</code> instances and can complete them with a rate of <code>~100</code>, as we have seen in other experiments.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h4><p>We were able to create all instances without any issues.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp1-100k-instances-ed40fdd974ae9c8814edac7067da9732.png" width="1824" height="654" class="img_ev3q"></p><p>We were able to complete all instances without any issues and the throughput was ~100 completion per second.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp1-completion-abed9e37390c8651d43576a0a0d040d7.png" width="1832" height="637" class="img_ev3q"></p><p>We can see that the snapshot was at some point ~650 MB big.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp1-state-abdb40eedb529ef2dcb2a34d841b3327.png" width="1833" height="918" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-two">Experiment Two<a href="#experiment-two" class="hash-link" aria-label="Direct link to Experiment Two" title="Direct link to Experiment Two">​</a></h3><p>As second experiment we wanted to increase the state by factor <code>10</code>, which means <code>1.000.000</code> instances in the state and then start the worker.</p><p>In order to do that we changed the following in the starter configuration:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">diff</span><span class="token plain"> default/starter.yaml zell-chaos/starter.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">24</span><span class="token plain">,26c24,26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">               -Dapp.starter.rate</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">               -Dapp.starter.durationLimit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">               -Dapp.starter.rate</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">               -Dapp.starter.durationLimit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="expected-1">Expected<a href="#expected-1" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h4><p>We expect that we can create <code>1.000.000</code> instances and can complete them with a rate of <code>~100</code>, as we have seen in other experiments.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="actual-1">Actual<a href="#actual-1" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h4><p>We were <strong>not</strong> able to create all instances without issues.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp2-starting-general-90285fc89bbadf62e2171be8ded4684f.png" width="1825" height="643" class="img_ev3q"></p><p>We see that at some point the throughput drops and backpressure seem to kick in. When this happens the state is only a bit bigger than in the previous experiment</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp2-state-4b557cf5a0c465d33ea8a378c5b93414.png" width="1838" height="878" class="img_ev3q"></p><p>The running instances seem to be around ~170K at this time.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp2-running-17d829e56e06a32e935cae47c68aeae6.png" width="1828" height="653" class="img_ev3q"></p><p>We can see that the processing queue increased at the same time and reached a critical point (over 150 records in the backlog).</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp2-queue-080a6c7f13f9b67e38f6c322f9d5f6fa.png" width="1827" height="300" class="img_ev3q"></p><p>The overall latency seems to increase after this time (which makes sense)</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp2-latency-5d21d638de8b582d99853871ddf73f9f.png" width="1828" height="786" class="img_ev3q"></p><p>We haven't started the workers for this experiment, since the throughput already break before.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-three">Experiment Three<a href="#experiment-three" class="hash-link" aria-label="Direct link to Experiment Three" title="Direct link to Experiment Three">​</a></h3><p>In order to make sure that this is related to the state we run an experiment with the <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/default/simpleStarter.yaml" target="_blank" rel="noopener noreferrer">simpleStarter</a>. This starter starts a process, which contains only a start and end event.</p><p>We let this starter run for more than one day and haven't experienced any issues on this one.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/exp3-general-1000c96b073da25d9e76e2611d28b747.png" width="1830" height="914" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h2><p>As written above the throughput seem to break, after we reach a certain state size.</p><p>It might be just a trigger to get the system into stumblling, which means: after one thing takes a bit longer the processing queue gets longer and the processor is not able to catch up any more. This causes then backpressure to kick in etc.</p><p>I think we need to further investigate this.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="performance" term="performance"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Recovery (Fail Over) time]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/10/05/recovery-time</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/10/05/recovery-time"/>
        <updated>2021-10-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the last quarter we worked on a new "feature" which is called "building state on followers". In short,]]></summary>
        <content type="html"><![CDATA[<p>In the last quarter we worked on a new "feature" which is called "building state on followers". In short,
it means that the followers apply the events to build there state, which makes regular snapshot
replication unnecessary and allows faster role transition between Follower-to-Leader. In this chaos
day I wanted to experiment a bit with this property, we already did some benchmarks <a href="https://github.com/camunda-cloud/zeebe/issues/7515" target="_blank" rel="noopener noreferrer">here</a>.
Today, I want to see how it behaves with larger state (bigger snapshots), since this needed to be
copied in previous versions of Zeebe, and the broker had to replay more than with the newest version.</p><p>If you want to now more about build state on followers check out the <a href="https://github.com/zeebe-io/enhancements/blob/master/ZEP007-build-state-on-followers.md" target="_blank" rel="noopener noreferrer">ZEP</a></p><p><strong>TL;DR;</strong> In our experiment we had almost no downtime, with version 1.2, the new leader was very fast able to pick up the next work (accept new commands). </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="first-chaos-experiment">First Chaos Experiment<a href="#first-chaos-experiment" class="hash-link" aria-label="Direct link to First Chaos Experiment" title="Direct link to First Chaos Experiment">​</a></h2><p>We will run two benchmarks one with 1.1 version and one with 1.2, to compare the differences between
the versions. We will run three brokers, with one partition and replication factor three. </p><p>In order to build up state we run the <code>starter</code> with a <code>durationLimit</code>, example cfg:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">            value: </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -Dapp.brokerUrl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zell-chaos-12-zeebe-gateway:26500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -Dapp.starter.rate</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -Dapp.starter.durationLimit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -Dzeebe.client.requestTimeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">62000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -XX:+HeapDumpOnOutOfMemoryError</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This means that we run a rate of 100 PI/s creations over 1000 seconds. We expect at the end around
100.000 PI, which should be enough to simulate a "big state". </p><p>After executing the starters we can see in the metrics the running instances:</p><p><img loading="lazy" alt="instances" src="/zeebe-chaos/assets/images/instances-8b991c2d040baa3627ded5a001ef43d1.png" width="1187" height="191" class="img_ev3q"></p><p>And that the snapshot is around 600 to 700 MB.</p><p><img loading="lazy" alt="snapshot" src="/zeebe-chaos/assets/images/snapshot-73e2affb2bb52e3c38343994b6b7bf7f.png" width="591" height="304" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We expect that if we restart the current leader that a new leader is fast (under seconds) able to
take over and continues the work. The version 1.2 should perform here much better than 1.1.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>Just normal bootstrap takes some time, on version 1.1:</p><p><img loading="lazy" alt="base-start-up" src="/zeebe-chaos/assets/images/base-start-up-990e2a69500f27068362d59e86bedbdc.png" width="2468" height="501" class="img_ev3q"></p><p>For version 1.2:</p><p><img loading="lazy" alt="12-start-up" src="/zeebe-chaos/assets/images/12-start-up-04e2050bd718b765993f07dc097b7678.png" width="2477" height="494" class="img_ev3q"></p><p>After running the starters for a certain duration and restarting the leader we can see that
the processor recovery takes by <em>factor 10</em> longer on version 1.1. Unfortunately, we have not the
leader transition metric in that version to compare against.</p><table><thead><tr><th><strong>Version</strong></th><th><strong>1.1</strong></th><th><strong>1.2</strong></th></tr></thead><tbody><tr><td>Recovery</td><td><a target="_blank" href="/zeebe-chaos/assets/files/base-recovery-bee7a028446f8d3ee578efdcfb0ce458.png"><img loading="lazy" alt="base-recovery" src="/zeebe-chaos/assets/images/base-recovery-bee7a028446f8d3ee578efdcfb0ce458.png" width="1198" height="490" class="img_ev3q"></a></td><td><a target="_blank" href="/zeebe-chaos/assets/files/12-recovery-fadf67de59709ef23de1048730aa1fa6.png"><img loading="lazy" alt="12-recovery" src="/zeebe-chaos/assets/images/12-recovery-fadf67de59709ef23de1048730aa1fa6.png" width="1191" height="495" class="img_ev3q"></a></td></tr><tr><td>General</td><td><a target="_blank" href="/zeebe-chaos/assets/files/base-recovery-general-71b7de7df76b17ee89efd539b6a3b5b3.png"><img loading="lazy" alt="base-recovery-general" src="/zeebe-chaos/assets/images/base-recovery-general-71b7de7df76b17ee89efd539b6a3b5b3.png" width="1188" height="957" class="img_ev3q"></a></td><td><a target="_blank" href="/zeebe-chaos/assets/files/12-recovery-general-fa5b6920c1d994b36be40ee7130c86b0.png"><img loading="lazy" alt="12-recovery-general" src="/zeebe-chaos/assets/images/12-recovery-general-fa5b6920c1d994b36be40ee7130c86b0.png" width="1191" height="948" class="img_ev3q"></a></td></tr></tbody></table><p><em>Sorry for the small pictures</em></p><p>In general what we have seen is that it is not so easy to compare if there is no longer load on the
system, which is the reason I did a second experiment with: A) "big state" and B) steady load.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="second-chaos-experiment">Second Chaos Experiment<a href="#second-chaos-experiment" class="hash-link" aria-label="Direct link to Second Chaos Experiment" title="Direct link to Second Chaos Experiment">​</a></h2><p>Similar setup to the first experiment, but additionally after the "big state" is reached a steady
load is put on the system. One starter with a rate of 100 PI/s and one worker completing some jobs.</p><p>With that setup we want to verify how it affects the system if now a leader change happens.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected-1">Expected<a href="#expected-1" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>Similar to above expect that if we restart the current leader that a new leader is fast
(under seconds) able to take over and continues the work. The version 1.2 should perform here much
better than 1.1.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual-1">Actual<a href="#actual-1" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><table><thead><tr><th><strong>Version</strong></th><th><strong>1.1</strong></th><th><strong>1.2</strong></th></tr></thead><tbody><tr><td>Recovery</td><td><a target="_blank" href="/zeebe-chaos/assets/files/base-general-state-and-throughput-recover-time-b9c20296a6c02ab22b64a90c8e5b0f3a.png"><img loading="lazy" alt="base-general-state-and-throughput-recover-time.png" src="/zeebe-chaos/assets/images/base-general-state-and-throughput-recover-time-b9c20296a6c02ab22b64a90c8e5b0f3a.png" width="1192" height="489" class="img_ev3q"></a></td><td><a target="_blank" href="/zeebe-chaos/assets/files/12-general-state-and-throughput-recovery-time-25934f696f3d76a60017fd5c85dda9ea.png"><img loading="lazy" alt="12-general-state-and-throughput-recover-time.png" src="/zeebe-chaos/assets/images/12-general-state-and-throughput-recovery-time-25934f696f3d76a60017fd5c85dda9ea.png" width="1195" height="487" class="img_ev3q"></a></td></tr><tr><td>General</td><td><a target="_blank" href="/zeebe-chaos/assets/files/base-general-state-and-throughput-recover-general-494ebfac74f239ed6ab1e40c424e6719.png"><img loading="lazy" alt="base-general-state-and-throughput-recover-general.png" src="/zeebe-chaos/assets/images/base-general-state-and-throughput-recover-general-494ebfac74f239ed6ab1e40c424e6719.png" width="1187" height="953" class="img_ev3q"></a></td><td><a target="_blank" href="/zeebe-chaos/assets/files/12-general-state-and-throughput-recovery-general-803fd268a252c919fb75fd5a0368a6a7.png"><img loading="lazy" alt="12-general-state-and-throughput-recover-general.png" src="/zeebe-chaos/assets/images/12-general-state-and-throughput-recovery-general-803fd268a252c919fb75fd5a0368a6a7.png" width="1194" height="970" class="img_ev3q"></a></td></tr></tbody></table><p>After running the experiment again, this time with load, we can see that the version 1.1 took almost
2 minutes! The newest Zeebe version (1.2), with building state on followers, took ~80 milliseconds!</p><p>We can see this much better also in the processing and throughput metrics on version 1.1 we have ~2
minutes gap.</p><p><img loading="lazy" alt="base-general-state-and-throughput-recover-general-zoom.png" src="/zeebe-chaos/assets/images/base-general-state-and-throughput-recover-general-zoom-346e51e9a7d1c8fd37a995dcf13ec030.png" width="1185" height="650" class="img_ev3q"></p><p>The exporters can recover a bit faster than the processing, but we are for a while not able to accept
any commands.</p><p>In version 1.2 on the other hand we are able to almost immediately continue with the processing, some
metrics are not even able to show a gap in between, like the current events.</p><p><img loading="lazy" alt="12-general-state-and-throughput-recover-general-zoom.png" src="/zeebe-chaos/assets/images/12-general-state-and-throughput-recovery-general-zoom-cbb1fd991e637f0f84eded0bcb33ba3f.png" width="1191" height="680" class="img_ev3q"></p><h1>Result</h1><p>In general, we were able to show that the new approach of building state on followers, gives us an
excellent benefit in transitioning between Follower and Leader. Furthermore, it allows us to handle
much larger state, since this doesn't need to be replicated on a regular basis.</p><h1>Found Bugs</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-instances">Running Instances<a href="#running-instances" class="hash-link" aria-label="Direct link to Running Instances" title="Direct link to Running Instances">​</a></h2><p>When experimenting with the clusters, building the state and deploying the steady load I
accidentally deployed to many workers. This caused to complete all existing running instances. The
issues here is that on the new leader the metric is zero, which results in a negative metric. </p><p><img loading="lazy" alt="broken-metric" src="/zeebe-chaos/assets/images/broken-metric-11b08dba5d36a8392efda2c2ebe5580d.png" width="1193" height="196" class="img_ev3q"></p><p>More problematic is actually that if you than build state again, you might reach the zero and if you
observe the cluster you can't be sure what the actual count of instances are. This makes the metric
kind of useless.</p><p><img loading="lazy" alt="broken-metric" src="/zeebe-chaos/assets/images/broken-metric-zero-5d8e95304f288e82921bf536402882d5.png" width="1191" height="825" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h2><p>During the experimenting it looked like that the performance of 1.2 degraded compared to 1.1. At the
end I had on each benchmark one starter with 100 PI/s and one worker with capacity 12.</p><p>With version 1.1 it looked like we reached ~100 PI/s created/completed
<img loading="lazy" alt="base-general-state-and-throughput-recovery-general-perf.png" src="/zeebe-chaos/assets/images/base-general-state-and-throughput-recovery-general-perf-cfb3b2c8bfa21e6c6499cda6b58d19f0.png" width="1193" height="928" class="img_ev3q"></p><p>With version 1.2 we just reached ~30, which means it reduced by factor 3.
<img loading="lazy" alt="12-general-state-and-throughput-recovery-general-perf.png" src="/zeebe-chaos/assets/images/12-general-state-and-throughput-recovery-general-perf-2e3b08a10dd42bd106818643de200518.png" width="1188" height="912" class="img_ev3q"></p><p>I think we need to verify whether this is really the case.</p><p><strong>Update:</strong></p><p>I run again a benchmark for both versions, with one worker and one starter. It showed no significant
difference on throughput.</p><table><thead><tr><th><strong>Version</strong></th><th><strong>1.1</strong></th><th><strong>1.2</strong></th></tr></thead><tbody><tr><td>Performance</td><td><a target="_blank" href="/zeebe-chaos/assets/files/perf-11-a3343c029716f6f663f5b3d93db133bc.png"><img loading="lazy" alt="perf-11" src="/zeebe-chaos/assets/images/perf-11-a3343c029716f6f663f5b3d93db133bc.png" width="2468" height="789" class="img_ev3q"></a></td><td><a target="_blank" href="/zeebe-chaos/assets/files/perf-12-92bc1dfd1a0442252e1541a3bd41b310.png"><img loading="lazy" alt="perf-12" src="/zeebe-chaos/assets/images/perf-12-92bc1dfd1a0442252e1541a3bd41b310.png" width="2483" height="786" class="img_ev3q"></a></td></tr></tbody></table><p>My current assumption is that it was related to the previous build up state and switching between
different worker configurations etc. Let us see whether we can observe this again.</p><p><strong>Update 2:</strong></p><p>The second benchmark failed several days again, without any intervention. I investigated that issue further and it seem to be related to frequent install requests, which are sent by the leader. See for more information the related issue <a href="https://github.com/camunda-cloud/zeebe/issues/7955" target="_blank" rel="noopener noreferrer">https://github.com/camunda-cloud/zeebe/issues/7955</a></p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Old-Clients]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/09/23/Old-Clients</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/09/23/Old-Clients"/>
        <updated>2021-09-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[It has been awhile since the last post, I'm happy to be back.]]></summary>
        <content type="html"><![CDATA[<p>It has been awhile since the last post, I'm happy to be back.</p><p>In today's chaos day we want to verify the hypothesis from <a href="https://github.com/zeebe-io/zeebe-chaos/issues/34" target="_blank" rel="noopener noreferrer">zeebe-chaos#34</a> that old
clients can't disrupt a running cluster.</p><p>It might happen that after upgrading your Zeebe to the newest shiny version, you might forget to
update some of your workers or starters etc. This should normally not an issue since Zeebe is
backwards compatible, client wise since 1.x. But what happens when older clients are used. Old
clients should not have a negative effect on a running cluster.</p><p><strong>TLDR</strong> Older clients (0.26) have no negative impact on a running cluster (1.2), and clients after
1.x are still working with the latest version. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>We will run a simple setup with, three nodes and three partitions (replication factor 3). The
version we use is the latest release candidate (1.2.0). Normally we run a load of 200 process
instances per second (pi/s) on our benchmarks. This time we will put a load of 100 pi/s to get
something running and start an old starter (v0.26.x) with the same frequency. Later we will scale
the old starter to see whether it makes any effect.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We expect that we can start and complete the 100 pi/s, since we can normally run 200 pi/s.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>The cluster was first started with starters of the same version, and we saw a stable load of ~100
process instances completed per second. After starting the old starters (with version 0.26.3), we
can't observe any difference. </p><p>Interesting is even when scaling the starters up to 10 replicas, which means 1000 PI creations per
second, it doesn't seem to make any effect. <em>Side note:</em> The
<a href="https://github.com/camunda-cloud/zeebe/tree/develop/benchmarks/project" target="_blank" rel="noopener noreferrer">starters</a> have been
modified, such they only start instances without deploying the model.</p><p><img loading="lazy" alt="old26-general" src="/zeebe-chaos/assets/images/old26-general-1cbfdf95d7c9b19cad8ca10aa921f34b.png" width="2481" height="992" class="img_ev3q"></p><p>The drops we see in the processing are related to restart's.</p><p>The gateway and grpc metrics doesn't indicate that more requests are sent. </p><p><img loading="lazy" alt="old26-grpc" src="/zeebe-chaos/assets/images/old26-grpc-b5da2bbcf038492c59dea93f36619e69.png" width="2480" height="641" class="img_ev3q">
<img loading="lazy" alt="old26-gateway" src="/zeebe-chaos/assets/images/old26-gateway-dd4afa5333796343795b4d80ad498e6b.png" width="2469" height="650" class="img_ev3q"></p><p>If we take a look in the clients log, we can see that the request are failing because the RPC Method names have been changed between 0.26 and 1.0. </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: UNIMPLEMENTED: Method not found: gateway_protocol.Gateway/CreateWorkflowInstance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: UNIMPLEMENTED: Method not found: gateway_protocol.Gateway/CreateWorkflowInstance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It seems this kind of "old" requests can be blocked quite early in the request chain to make no effect. </p><p>In order to experiment a bit further I created a starter image with version 1.0 to see whether this still works with our newest release candidate 1.2.</p><p>We can see in the metrics right after starting the starter that the throughput goes up and we can reach our 200 pi/s.</p><p><img loading="lazy" alt="old10-general" src="/zeebe-chaos/assets/images/old10-general-90bb179937d9178c12b16f0cdea22281.png" width="2484" height="1000" class="img_ev3q"></p><p>We run the benchmark overnight, and we haven't seen any issues. Be aware that the throughput is calculated over the 24h which makes is lower than 200.</p><p><img loading="lazy" alt="general" src="/zeebe-chaos/assets/images/general-67c5d494df6c66211457861139475c6c.png" width="2481" height="994" class="img_ev3q"></p><p>Furthermore, taking a look at the resource consumption, especially at the gateway, gives no evidence that something wrong is going on.</p><p><img loading="lazy" alt="res" src="/zeebe-chaos/assets/images/res-951c069149e3ae14d08a997e6fe974b2.png" width="2473" height="647" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>We were able to confirm the hypothesis written in <a href="https://github.com/zeebe-io/zeebe-chaos/issues/34" target="_blank" rel="noopener noreferrer">zeebe-chaos#34</a>, that an old client can't disrupt a running cluster. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2><p>None this time :)</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Slow Network]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/07/06/Slow-Network</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/07/06/Slow-Network"/>
        <updated>2021-07-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[On a previous Chaos Day we played around with ToxiProxy , which allows injecting failures on the network level. For example dropping packages, causing latency etc.]]></summary>
        <content type="html"><![CDATA[<p>On a previous <a href="/zeebe-chaos/2020/10/06/toxi-proxy">Chaos Day</a> we played around with <a href="https://github.com/Shopify/toxiproxy" target="_blank" rel="noopener noreferrer">ToxiProxy</a> , which allows injecting failures on the network level. For example dropping packages, causing latency etc.</p><p>Last week <a href="https://github.com/deepthidevaki" target="_blank" rel="noopener noreferrer">@Deepthi</a> mentioned to me that we can do similar things with <a href="https://man7.org/linux/man-pages/man8/tc.8.html" target="_blank" rel="noopener noreferrer">tc</a>, which is a built-in linux command. Today I wanted to experiment with latency between leader and followers using <code>tc</code>.</p><p><strong>TL;DR;</strong> The experiment failed; With adding 100ms network delay to the Leader we broke the complete processing throughput. 💥</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>We want to experiment with network latency and what kind of effect has a slow network on the cluster. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hypothesis">Hypothesis<a href="#hypothesis" class="hash-link" aria-label="Direct link to Hypothesis" title="Direct link to Hypothesis">​</a></h3><p>We expect that we can handle certain network latency, due to our heartbeat and election time timeouts. After, reaching the deadlines we expect fail overs and followers which are lagging behind.</p><p>This means under a certain threshold we should be able to still process user commands, with slightly delay but without real issues. After reaching the deadline and the fail overs, it should be possible to continue, since we will add only to one node the delay.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment">Experiment<a href="#experiment" class="hash-link" aria-label="Direct link to Experiment" title="Direct link to Experiment">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tc">TC<a href="#tc" class="hash-link" aria-label="Direct link to TC" title="Direct link to TC">​</a></h4><p>TC is a built in linux command, the manpage summarizes it as <code>tc - show / manipulate traffic control settings</code>.</p><p>In order to <a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener noreferrer">add delay to a network interface</a>, we can run the following:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev eth0 root netem delay 200ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>More details (<a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener noreferrer">taken from the blog post</a>):</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">qdisc: modify the scheduler (aka queuing discipline)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add: add a new rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev eth0: rules will be applied on device eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root: modify the outbound traffic scheduler (aka known as the egress qdisc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">netem: use the network emulator to emulate a WAN property</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delay: the network property that is modified</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">200ms: introduce delay of 200 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Adding this kind of rule means that we add a delay to all outgoing connections, which are going over this network interface.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h4><p>In order to reduce the blast radius we will run the experiment with one partition on a three broker cluster (replication factor 3).</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="steady-state">Steady State<a href="#steady-state" class="hash-link" aria-label="Direct link to Steady State" title="Direct link to Steady State">​</a></h5><p> As we can see in the benchmark we are able to reach in avg. ~77 process instance creation and completions per second.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/general-18fcb0bda36206ab196aeb507a0c1eac.png" width="1194" height="963" class="img_ev3q"></p><p>The process instance execution time (from start to end) is under 1 second.
<img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/latency-50564f2ce63c84257c134178924d2c57.png" width="1189" height="636" class="img_ev3q"></p><p>The commit latency is about 100 ms.
<img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/commit-lat-9b72095b6933ef77b97f994ece9d17f9.png" width="594" height="265" class="img_ev3q"></p><p>We can see that one of the followers is a bit lagging behind, but not too far.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/raft-follower-7e8113946fa0a082e57f5ae190a21baa.png" width="1187" height="575" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="100-ms">100 ms<a href="#100-ms" class="hash-link" aria-label="Direct link to 100 ms" title="Direct link to 100 ms">​</a></h5><p>In the first iteration of the experiment we added a 100 ms delay to the leaders outgoing traffic. </p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos-day/ cluster: zeebe-cluster ns:zell-chaos-day]$ k exec -it zell-chaos-day-zeebe-gateway-579c76978f-npz2k -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 1.1.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - zell-chaos-day-zeebe-0.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Follower, Healthy  Broker 1 - zell-chaos-day-zeebe-1.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Follower, Healthy  Broker 2 - zell-chaos-day-zeebe-2.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader, Healthy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Based on the <code>zbctl</code> output, or the grafana dashboard we can find out who is the leader. Note that the output of <code>zbctl</code> looks still a bit broken, related issue <a href="https://github.com/camunda-cloud/zeebe/issues/6692" target="_blank" rel="noopener noreferrer">#6692</a>.</p><p>With the following commands we can add the delay of 100 ms to the leaders outgoing traffic.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos-day/ cluster: zeebe-cluster ns:zell-chaos-day]$ k exec -it zell-chaos-day-zeebe-2 -- bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-day-zeebe-2:/usr/local/zeebe# tc qdisc add dev eth0 root netem delay 100ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-day-zeebe-2:/usr/local/zeebe# tc -s qdisc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc noqueue 0: dev lo root refcnt 2 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> backlog 0b 0p requeues 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc netem 8001: dev eth0 root refcnt 2 limit 1000 delay 100.0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 11635496 bytes 10086 pkt (dropped 0, overlimits 0 requeues 0) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> backlog 339773b 77p requeues 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Almost immediately we see a drop in our general section of the Grafana Dashboard.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-general-a6a99e2144909bf47c029ebcd8543f33.png" width="1196" height="962" class="img_ev3q"></p><p>The backpressure increased significantly. As expected the commit latency increased.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-commit-lat-e9f2fb099ca82d84761ef6ffaca428db.png" width="597" height="266" class="img_ev3q"></p><p>The processing latency as well.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-latency-85f7dc47d9d5606469244efc363cc638.png" width="1191" height="642" class="img_ev3q"></p><p>It was unexpected that the throughput breaks down so much. We can see in the send request that a lot of the requests are ended with timeouts or with resource exhausted.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-grpc-5c44c33e0cfa6d55da14c7cc5092c705.png" width="1187" height="640" class="img_ev3q">
<img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-gateway-767136da5cb5e9032275d4ee41b05fff.png" width="1191" height="647" class="img_ev3q"></p><p>Interesting is that no worker is able to activate nor complete any job. This cause increasing of the running process instances, so the state is growing.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-running-proc-8f4fadc0b12cf5ae463c8f82894c5cd5.png" width="1181" height="419" class="img_ev3q"></p><p>Taking a look at the raft metrics we see that this already caused some heartbeat misses, but no leader change.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-heartbeats-1b9a59af419679228f9d703afe1819e9.png" width="1193" height="613" class="img_ev3q"></p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/100ms-follower-93ff4bcec9b9cba018a65268f6f069d0.png" width="1194" height="576" class="img_ev3q"></p><p>The follower is now lagging far more behind. We can see in the logs that the Leader tries to send <code>InstallRequests</code>, but these are also timing out.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - InstallRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">currentTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1173627</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">chunkId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1744147670</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">nextChunkId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1283029304</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1083445787</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">initial</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false, </span><span class="token assign-left variable" style="color:#36acaa">complete</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: java.util.concurrent.TimeoutException: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">489616</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">raft-partition-partition-1-install, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zell-chaos-day-zeebe-2.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10647731</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1655826849</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-day-zeebe-1.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26502 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT5S"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The follower is starting regularly elections, but is not able to overturn the existing leader.</p><p>In general, in the Gateway logs we can see the start of the delay injection quite good. </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:51.263195Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:53.264480Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.184981Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.213904Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.361408Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.986270Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:56.617134Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.072707Z Expected to handle gRPC request, but request timed out between gateway and broker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.126207Z Expected to handle gRPC request, but request timed out between gateway and broker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.157683Z Expected to handle gRPC request, but request timed out between gateway and broker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similar logs we see on the broker side.</p><p>In general, we can say the experiment failed. The cluster was not able to run our normal workload. It seem to behave quite bad, but there were no leader change at all.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="250-ms">250 ms<a href="#250-ms" class="hash-link" aria-label="Direct link to 250 ms" title="Direct link to 250 ms">​</a></h5><p>In order to verify whether 250 ms, will cause a leader election we reconfigured the delay. It looked quite similar, performance wise, but the heartbeats for one of the followers increased. Still it was not enough to cause a leader change.</p><p>After several minutes (~30) of running this configuration we were able to observe that one of the other followers missed heartbeats as well. This finally caused a leader change.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/250ms-raft-55d2027e863459de3a070d017e813d59.png" width="1204" height="603" class="img_ev3q"></p><p>The throughput came back, it was similar to what is was before.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/250ms-general-95e282a9fbe58ff95fe883e7d80c2739.png" width="1191" height="964" class="img_ev3q"></p><p>The processing execution latency was higher than usual.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/250ms-latency-0dd3474f142f7d3642605a2b8353186d.png" width="1187" height="645" class="img_ev3q"></p><p>Similar to the commit latency, interesting to see such an affect caused by a follower with network issues.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/250ms-commit-lat-0a8e3826a19cdea9b948f42fa639bd6f.png" width="597" height="265" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>As written before the experiment failed, the hypothesis was not met. We were not able to add latency to the network, which is much lower than our deadlines (heartbeat timeout is 2.5 seconds), without causing any harm to our processing throughput/latency.</p><p>Still we had some interesting observations we can use for our next experiments and insight which we need to consider on setting up Zeebe in environment where the network might be unreliable/slow.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full Disk Recovery]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/06/08/Full-Disk</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/06/08/Full-Disk"/>
        <updated>2021-06-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: zeebe-chaos#32 and zeebe-chaos#14. This time @Nico joined me.]]></summary>
        <content type="html"><![CDATA[<p>On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: <a href="https://github.com/zeebe-io/zeebe-chaos/issues/32" target="_blank" rel="noopener noreferrer">zeebe-chaos#32</a> and <a href="https://github.com/zeebe-io/zeebe-chaos/issues/14" target="_blank" rel="noopener noreferrer">zeebe-chaos#14</a>. This time <a href="https://github.com/korthout" target="_blank" rel="noopener noreferrer">@Nico</a> joined me.</p><p><strong>TL;DR</strong> The experiment was successful 💪 and we found several things in the dashboard which we can improve :)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>With this experiment we want to verify that Zeebe can recover after OOD, which was caused by not exporting to ELS. For that we want to disconnect Zeebe and ELS first and see how it behaves. Afterwards we connect the services again and expect a recovery of the system.</p><p>As usual, we have set up a normal benchmark cluster with three nodes, three partitions and replication factor three. We run 200 PI/s and 12 workers against that cluster.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We expect the following properties:</p><ul><li>at the beginning the system is stable (we can start instances without issues)</li><li>after disconnecting ELS we start to fill the disk, since we can't export (which means we can't compact)</li><li>after reaching the disk limits, Zeebe doesn't accept any commands anymore</li><li>after connecting ELS, Zeebe should start to export again (compacting should be possible again)</li><li>after come below the limit, Zeebe should accept commands again</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-disconnect-to-els">Network disconnect to ELS<a href="#network-disconnect-to-els" class="hash-link" aria-label="Direct link to Network disconnect to ELS" title="Direct link to Network disconnect to ELS">​</a></h4><p>In order to disconnect the Brokers with ELS, we wanted to reuse one of our network disconnect scripts, e.g. <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/disconnect-leaders.sh" target="_blank" rel="noopener noreferrer">disconnect-leaders.sh</a>. This resolves the IP's of the brokers and creates an unreachable route via the <code>ip</code> tool at the given brokers.</p><p>We copied that and adjusted it to our needs:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"elasticsearch-master"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic0Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-0"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{{.status.podIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic1Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-1"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{{.status.podIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic2Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-2"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{{.status.podIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>Small note in order to run this against the benchmark cluster you need to set the following environment variables:</em></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">NAMESPACE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubens -c</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># the namespace where the resources are located</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">CHAOS_SETUP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">helm </span><span class="token comment" style="color:#999988;font-style:italic"># indicates that the installation is done via helm, necessary since we use different labels in the helm charts and in CC.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Running the script above didn't work as expected. We still saw records being exported. The issue was that we need to use the service IP instead of the IP's of the elastic search pods. The Broker uses only the service to connect with ELS. In order to get the IP we can use this <code>kubectl get services elasticsearch-master --template "{{.spec.clusterIP}}"</code>. </p><p>The service will take care of the request routing, which means we just need to block one IP. This helps to simplify the disconnect script.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"elasticsearch-master"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticServiceIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get services elasticsearch-master --template </span><span class="token variable string" style="color:#e3116c">"{{.spec.clusterIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>In this section we will describe how we experienced the chaos experiment and what we observed. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="first-try">First Try<a href="#first-try" class="hash-link" aria-label="Direct link to First Try" title="Direct link to First Try">​</a></h4><p>We run the disconnect script and were able to observe that the exporting stopped. </p><p><img loading="lazy" alt="elastic-disconnect" src="/zeebe-chaos/assets/images/elastic-disconnect-5638a32fadfab9b778b02fe14a1d3ed7.png" width="1195" height="961" class="img_ev3q"></p><p>As expected we were no longer able to compact, which cause an increasing of log segments.</p><p><img loading="lazy" alt="increase-segments" src="/zeebe-chaos/assets/images/increase-segments-bd8431b8424f7c0b8fb0d44307c2ab42.png" width="598" height="311" class="img_ev3q"></p><p>We realized that our current disk size might be too big (it would take a while until we fill it), so we decided to setup a new benchmark with smaller size and different watermarks.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGECOMMANDWATERMARK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.6"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGEREPLICATIONWATERMARK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.8"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># PVC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcAccessMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"ReadWriteOnce"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcStorageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ssd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We thought that we might have different performance, because of such a smaller disk size, but this was not the case. We were able to reach the same level, might be worth to think about reducing the disk sizes more in our benchmarks.</p><p><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/next-try-base-12b9f5871392bd43fe1f31224479aa6d.png" width="1198" height="919" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="second-try">Second Try<a href="#second-try" class="hash-link" aria-label="Direct link to Second Try" title="Direct link to Second Try">​</a></h4><p><img loading="lazy" alt="base1" src="/zeebe-chaos/assets/images/next-try-base1-649226bc28407a654bad7078dca639a0.png" width="1189" height="911" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="disconnecting">Disconnecting<a href="#disconnecting" class="hash-link" aria-label="Direct link to Disconnecting" title="Direct link to Disconnecting">​</a></h5><p>After running our disconnect script we can immediately see that the exporting is stopping.</p><p><img loading="lazy" alt="drop-base" src="/zeebe-chaos/assets/images/next-try-drop-base-4fe3db248fb58bb7fdfef0b08e8b8cd1.png" width="1195" height="912" class="img_ev3q"></p><p>Interesting is the elastic section where we see one of our new panels in actions which shows the failure rate. There are two dots, which show the 100% failure rate.</p><p><img loading="lazy" alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png" width="1190" height="795" class="img_ev3q"></p><p>After reaching our disk watermark we can see that the processing stops, and we no longer accept commands.</p><p><img loading="lazy" alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png" width="1195" height="906" class="img_ev3q"></p><p>The cluster turns to unhealthy, which is expected.</p><p>Interesting is that we have no metrics at all on the gateway side after reaching the watermark.</p><p><img loading="lazy" alt="drop-gw" src="/zeebe-chaos/assets/images/next-try-drop-gw-a0e7f885194b47559bb07c6ad46942d0.png" width="1198" height="642" class="img_ev3q"></p><p>We were able to verify that snapshots are still taken, but no compaction.</p><p><img loading="lazy" alt="drop-snapshot" src="/zeebe-chaos/assets/images/next-try-drop-snapshot-d38bd5b1657f7b5a4fa763b26ebba239.png" width="1182" height="637" class="img_ev3q"></p><p>No segments are deleted during this time.</p><p><img loading="lazy" alt="drop-segments" src="/zeebe-chaos/assets/images/next-try-drop-segments-3d49aaadb3d3455c25a920281a6c9595.png" width="1189" height="613" class="img_ev3q"></p><p>If we take a look at the processing section we can see that the exporters lag way behind, which of course makes sense.</p><p><img loading="lazy" alt="drop-processing" src="/zeebe-chaos/assets/images/next-try-drop-processing-4dc3f1fafd42d2e6560cde27e53a3aa2.png" width="1187" height="410" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="connecting">Connecting<a href="#connecting" class="hash-link" aria-label="Direct link to Connecting" title="Direct link to Connecting">​</a></h5><p>Luckily we were able to reuse on of our already written reconnect scripts for this experiment, see <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/connect-leaders.sh" target="_blank" rel="noopener noreferrer">connect-leaders.sh</a>.</p><p>After removing the ip route (connecting the Brokers with ELS again) we can see that it immediately starts to export again.</p><p><img loading="lazy" alt="connect-base" src="/zeebe-chaos/assets/images/next-try-connect-base-dfe3501b990f198861825cec2fb00735.png" width="1196" height="913" class="img_ev3q"></p><p>When we went under the disk watermarks the processing started again and we accepted new commands.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p><img loading="lazy" alt="connect-base2" src="/zeebe-chaos/assets/images/next-try-connect-base2-375310b94ccc02fe3333b76954351a44.png" width="1197" height="959" class="img_ev3q"></p><p><strong>The experiment was successful, our system was able to recover after an elastic network outage and handled it properly.</strong> ✅ 💪</p><p>We noted several issues with the Dashboard, during the chaos experiment observation. For example the Brokers, which went OOD, never went back to the <code>Healthy</code> state again.</p><p><img loading="lazy" alt="connect-healthy" src="/zeebe-chaos/assets/images/next-try-connect-healthy-124040b24b536d608e5c1d94eebabbc6.png" width="1185" height="865" class="img_ev3q"></p><p>Furthermore, the not exported panel seems to be broken, depending on the selected time frame.</p><p><img loading="lazy" alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png" width="1188" height="409" class="img_ev3q"></p><p>There have been also other issues with the panels and sections which we should take a look at. I have listed them below.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="possible-improvements">Possible Improvements<a href="#possible-improvements" class="hash-link" aria-label="Direct link to Possible Improvements" title="Direct link to Possible Improvements">​</a></h3><p>We observed several issues with the grafana dashboard which I wrote down here. I will create issues or PR's to resolve them.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="general-metric-section">General Metric Section<a href="#general-metric-section" class="hash-link" aria-label="Direct link to General Metric Section" title="Direct link to General Metric Section">​</a></h4><p>If we take a look at the screenshot where we reach our disk watermarks, and the processing stops, the backpressure metrics are not correctly updated. We would expect that the backpressure shows 100%, since all requests are rejected.</p><p><img loading="lazy" alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png" width="1195" height="906" class="img_ev3q"></p><p>After the cluster actually becomes healthy again (it accepts new commands) it is not shown as healthy in the panels. The metrics seems not to be updated.</p><p>Another possible improvement would be to make it more visible that the exporting stopped. One idea is to split the processing into exporting and processing, so having two graphs might help.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="processing-section">Processing Section<a href="#processing-section" class="hash-link" aria-label="Direct link to Processing Section" title="Direct link to Processing Section">​</a></h4><p>Depending on the time frame the panel <code>Number of records not exported</code>, seems to show quite high values.</p><p><img loading="lazy" alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png" width="1188" height="409" class="img_ev3q"></p><p>If we take a look at other metrics, this doesn't make any sense. If we had such a backlog we wouldn't expect to compact to one segment for example. Furthemore the tables on the right side show numbers which are quite close to each other.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="elastic-metrics-section">Elastic Metrics Section<a href="#elastic-metrics-section" class="hash-link" aria-label="Direct link to Elastic Metrics Section" title="Direct link to Elastic Metrics Section">​</a></h4><p>We probably can improve the failure panel, such that it shows a graph, and the limit is not set to 130%.</p><p><img loading="lazy" alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png" width="1190" height="795" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="grpc-metric-section">GRPC Metric Section<a href="#grpc-metric-section" class="hash-link" aria-label="Direct link to GRPC Metric Section" title="Direct link to GRPC Metric Section">​</a></h4><p>The panel <code>gRPC requests</code> should have an dec ordering on the tooltip and should be renamed to <code>Total gRPC requests</code> it was a bit confusing to us.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="throughput-section">Throughput Section<a href="#throughput-section" class="hash-link" aria-label="Direct link to Throughput Section" title="Direct link to Throughput Section">​</a></h4><p>The StreamProcessor vs Exporter panel has no data.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="snapshot-section">Snapshot Section<a href="#snapshot-section" class="hash-link" aria-label="Direct link to Snapshot Section" title="Direct link to Snapshot Section">​</a></h4><p>We saw that snapshots are created, but the Snapshot replication panel show no data. It seem to be broken (again?).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="resources-section">Resources Section<a href="#resources-section" class="hash-link" aria-label="Direct link to Resources Section" title="Direct link to Resources Section">​</a></h4><p>The JVM panel has the legend on the right side, which makes it hard to see the metrics if you have multiple windows open on one screen.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Time travel Experiment]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/05/25/Reset-Clock</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/05/25/Reset-Clock"/>
        <updated>2021-05-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Recently we run a Game day where a lot of messages with high TTL have been stored in the state. This was based on an earlier incident, which we had seen in production. One suggested approach to resolve that incident was to increase the time, such that all messages are removed from the state. This and the fact that summer and winter time shifts can cause in other systems evil bugs, we wanted to find out how our system can handle time shifts. Phil joined me as participant and observer. There was a related issue which covers this topic as well, zeebe-chaos#3.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://confluence.camunda.com/display/ZEEBE/Game+Day+18.05.2021" target="_blank" rel="noopener noreferrer">Recently we run a Game day</a> where a lot of messages with high TTL have been stored in the state. This was based on an earlier incident, which we had seen in production. One suggested approach to resolve that incident was to increase the time, such that all messages are removed from the state. This and the fact that summer and winter time shifts can cause in other systems evil bugs, we wanted to find out how our system can handle time shifts. <a href="https://github.com/saig0" target="_blank" rel="noopener noreferrer">Phil</a> joined me as participant and observer. There was a related issue which covers this topic as well, <a href="https://github.com/zeebe-io/zeebe-chaos/issues/3" target="_blank" rel="noopener noreferrer">zeebe-chaos#3</a>.</p><p><strong>TL;DR;</strong> Zeebe is able to handle time shifts back and forth, without observable issues. Operate seems to dislike it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>As part of the experiment we had to define what we expect, if we change the time. In order to keep it simple we decided to experiment with one-hour move forward and backwards. We wanted to run the experiment first against our normal benchmark cluster and afterwards against a Production - S Cluster on INT. Furthermore, we decided to test the time shift only on leaders, for now.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p><em>If we move the time one-hour forward we expect:</em></p><ul><li>in general, timers should be triggered (snapshot, message TTL, job timeouts, timers etc.)</li><li>the system should operate normal, means zeebe and operate should be healthy and continue working</li></ul><p><em>If we move the time one-hour backwards we expect:</em></p><ul><li>timers should not be triggered, until the deadline + 1 hour is reached</li><li>the system should operate normal</li><li>with operate we were not sure whether it has issues with exported records on the same time</li></ul><p>Before we started, with running the experiment, we had to find out how we can change the time in a docker container.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="changing-time">Changing Time<a href="#changing-time" class="hash-link" aria-label="Direct link to Changing Time" title="Direct link to Changing Time">​</a></h3><p><strong>*Note:</strong> If you're not interested in how we change the time you can jump to the <a href="#experiment-on-benchmark-cluster">next section</a>*</p><p>If you search for it, you find quite quickly answers in how to change the time in a docker container. For example, we found this <a href="https://serverfault.com/a/898842/283059" target="_blank" rel="noopener noreferrer">answer</a>, which was quite useful.</p><p>In order to apply this, we first need to make sure that we have the right <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">linux capabilities</a> to change the system time. For that we need the <code>SYS_TIME</code> capability. In our benchmarks this is quite easy to do, we just need to change <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/default/zeebe-values.yaml#L16" target="_blank" rel="noopener noreferrer">this line</a> and add <code>SYS_TIME</code>.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">podSecurityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"NET_ADMIN"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"SYS_TIME"</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After changing this, we can set the time via <a href="https://man7.org/linux/man-pages/man1/date.1.html" target="_blank" rel="noopener noreferrer"><code>date -s</code></a>. Since we were not sure whether this really works for our java process, we started a <a href="https://docs.oracle.com/javase/9/tools/jshell.htm#JSWOR-GUID-C337353B-074A-431C-993F-60C226163F00" target="_blank" rel="noopener noreferrer"><code>jshell</code></a> to verify that. <em>Note:</em> the jshell is only available if you use an container image with jdk. This is available, if you build your own zeebe docker image via <a href="https://github.com/camunda-cloud/zeebe/blob/develop/createBenchmark.sh" target="_blank" rel="noopener noreferrer">zeebe/createBenchmark.sh</a>.</p><p>Changing the time:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May 25 10:29:33 UTC 2021</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# date +%T -s "09:29:00"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09:29:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May 25 09:29:01 UTC 2021</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-phil-chaos-zeebe-1:/usr/local/zeebe# jshell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Picked up JAVA_TOOL_OPTIONS: -XX:MaxRAMPercentage=25.0 -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/usr/local/zeebe/data -XX:ErrorFile=/usr/local/zeebe/data/zeebe_error%p.log -Xlog:gc*:file=/usr/local/zeebe/data/gc.log:time:filecount=7,filesize=8M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 25, 2021 9:29:03 AM java.util.prefs.FileSystemPreferences$1 run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO: Created user preferences directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Welcome to JShell -- Version 11.0.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  For an introduction type: /help intro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; new Date()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$1 ==&gt; Tue May 25 09:29:08 UTC 2021</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After we found out how we can actually change the time we moved forward and run the described chaos experiment.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-on-benchmark-cluster">Experiment on Benchmark Cluster<a href="#experiment-on-benchmark-cluster" class="hash-link" aria-label="Direct link to Experiment on Benchmark Cluster" title="Direct link to Experiment on Benchmark Cluster">​</a></h3><p>As usual, we have set up a normal benchmark cluster with three nodes, three partitions and replication factor three. We run 200 PI/s and 12 workers against that cluster.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="move-time-forward">Move Time Forward<a href="#move-time-forward" class="hash-link" aria-label="Direct link to Move Time Forward" title="Direct link to Move Time Forward">​</a></h4><p>After setting up the cluster we had to find out who is the Leader and picked the one who is Leader for the most of the partitions.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ k </span><span class="token builtin class-name">exec</span><span class="token plain"> -it zell-phil-chaos-zeebe-0 -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> - zell-phil-chaos-zeebe-0.zell-phil-chaos-zeebe.zell-phil-chaos.svc.cluster.local:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain">.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> Follower, Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> Leader, Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> Leader, Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>On Broker 0 we increased the time by one hour.</strong> After doing this we observed the metrics, but we haven't noticed any issues. We verified logs in stackdriver, but no errors were thrown.
<img loading="lazy" alt="inc-1-hour-general" src="/zeebe-chaos/assets/images/inc-1-hour-general-e76624008b7d3eb96d0c869f5fe6c1af.png" width="1195" height="901" class="img_ev3q"></p><p>We noticed, looking at the metrics, that the snapshot was triggered when we moved the time forward. This was what we actually expected. Plus also new scheduled snapshot have been triggered and created.
<img loading="lazy" alt="inc-1-hour-snapshot" src="/zeebe-chaos/assets/images/inc-1-hour-snapshot-bc4a81c9e31d5fcba49d7a916f3e8e52.png" width="1191" height="633" class="img_ev3q"></p><p>On the elastic exporter we can see that flushing has happened earlier than usual, because we increased the time. This was also expected.<br>
<img loading="lazy" alt="inc-1-hour-export" src="/zeebe-chaos/assets/images/inc-1-hour-export-f6f3d566842ac4cf305ceb7d010b5c59.png" width="1191" height="411" class="img_ev3q"></p><p><strong>Experiment succeeded</strong> ✔️</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="move-time-backwards">Move Time Backwards<a href="#move-time-backwards" class="hash-link" aria-label="Direct link to Move Time Backwards" title="Direct link to Move Time Backwards">​</a></h4><p>In order to run the experiment again, with moving the timer backwards, we set up a new benchmark cluster. This time we run the experiment on Broker 1, since he was the leader of the most partitions.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Broker 1 - zell-phil-chaos-zeebe-1.zell-phil-chaos-zeebe.zell-phil-chaos.svc.cluster.local:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Version: 1.1.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition 1 : Follower, Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition 2 : Leader, Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Partition 3 : Leader, Healthy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>No general issues have been detected, as expected no longer snapshots were taken.
<img loading="lazy" alt="dec-1-hour-general" src="/zeebe-chaos/assets/images/dec-1-hour-general-d20ebf3b510bacc0bae5a2533d7e3f1d.png" width="1196" height="895" class="img_ev3q"></p><p>We have run the benchmark for a bit longer, to see whether the snapshot will be triggered later, which was indeed the case.
<img loading="lazy" alt="dec-1-hour-snapshot-later" src="/zeebe-chaos/assets/images/dec-1-hour-snapshot-later-9a9aa6dd1f828ccc63e0d67370765945.png" width="1195" height="579" class="img_ev3q"></p><p>We could also observe how the journal segments increased until we took the next snapshot.
<img loading="lazy" alt="dec-1-hour-snapshot-segments" src="/zeebe-chaos/assets/images/dec-1-hour-snapshot-segments-342d9ead5f0535ae7a52b5d0e7f8fe89.png" width="1185" height="612" class="img_ev3q"></p><p><strong>Experiment succeeded</strong> ✔️</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-on-int">Experiment on INT<a href="#experiment-on-int" class="hash-link" aria-label="Direct link to Experiment on INT" title="Direct link to Experiment on INT">​</a></h3><p>After running the experiment against our benchmark clusters we were confident to run it against a Production S cluster on INT.
We have set up a Production S cluster in our chaos cluster and run the <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/setup/newCloudBenchmark.sh" target="_blank" rel="noopener noreferrer">cloud benchmark</a> against it. It starts starter and worker against that Production S cluster, turned out not with the same load (luckily this doesn't matter for this experiment). The starter and workers are deployed in the Zeebe Team gke cluster.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-change-the-time-on-int">How to change the time on INT<a href="#how-to-change-the-time-on-int" class="hash-link" aria-label="Direct link to How to change the time on INT" title="Direct link to How to change the time on INT">​</a></h4><p>On INT, it is not that simple to get the <code>SYS_TIME</code> capability, which we need to change the time. Luckily we already have experience, with getting the necessary capability we need to have.
On a previous chaos day we have added <code>NET_ADMIN</code> capability to a running zeebe container in order to experiment with network partitioning, you can read about that <a href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">here</a>.</p><p>The following patch adds the <code>SYS_TIME</code> cap to our linux container.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"zeebe"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"SYS_TIME"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following script applies the patch to our Zeebe cluster.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">scriptPath</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">cd</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">dirname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable string" style="color:#e3116c">"</span><span class="token variable string variable string variable" style="color:#36acaa">${</span><span class="token variable string variable string variable environment constant" style="color:#36acaa">BASH_SOURCE</span><span class="token variable string variable string variable punctuation" style="color:#393A34">[</span><span class="token variable string variable string variable" style="color:#36acaa">0</span><span class="token variable string variable string variable punctuation" style="color:#393A34">]</span><span class="token variable string variable string variable" style="color:#36acaa">}</span><span class="token variable string variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa"> -P </span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CLUSTERID</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${namespace</span><span class="token variable operator" style="color:#393A34">%</span><span class="token variable" style="color:#36acaa">-zeebe}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch zb </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$CLUSTERID</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> --type merge --patch</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'{"spec":{"controller":{"reconcileDisabled":true}}}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch statefulset zeebe -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> --patch </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">cat</span><span class="token string variable" style="color:#36acaa"> $scriptPath/sys_time_patch.yaml</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod -l </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">getLabel</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="move-time-forward-on-int">Move Time Forward on INT<a href="#move-time-forward-on-int" class="hash-link" aria-label="Direct link to Move Time Forward on INT" title="Direct link to Move Time Forward on INT">​</a></h4><p>After we patched our resources we can now change the time as before.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe</span><span class="token comment" style="color:#999988;font-style:italic"># date</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> 09:55:33 UTC </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe</span><span class="token comment" style="color:#999988;font-style:italic"># date +%T -s "10:55:00"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token plain">:55:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe</span><span class="token comment" style="color:#999988;font-style:italic"># date</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue May </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">:55:01 UTC </span><span class="token number" style="color:#36acaa">2021</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the general section of our Grafana Dashboard everything looks fine. We can't see any issues here, except that the exporting is much less than the processing.
<img loading="lazy" alt="int-inc-1-hour-general" src="/zeebe-chaos/assets/images/int-inc-1-hour-general-f5fa293ae793ae59f4cc83da19456a2d.png" width="1198" height="901" class="img_ev3q"></p><p>We took a closer look at the processing panels and saw that the exporter lag a lot behind, which causes Operate lagging behind and that fewer segments are deleted.
<img loading="lazy" alt="int-inc-1-hour-exporting" src="/zeebe-chaos/assets/images/int-inc-1-hour-exporting-ad1008f03377d042cc502110006a02fb.png" width="1195" height="424" class="img_ev3q"></p><p>On moving the time forward we see as expected the snapshotting has been triggered.
<img loading="lazy" alt="int-inc-1-hour-snapshot" src="/zeebe-chaos/assets/images/int-inc-1-hour-snapshot-7f4800f402632a8efb38d4a8ef1b370a.png" width="1200" height="644" class="img_ev3q"></p><p>Stackdriver shows no errors for the Zeebe service. But later, in operate we observed that no new data was imported after 11:50, we moved the time at 11:55 forward. In the logs we found the following exceptions, which need to be investigated further.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Exception occurred when importing data: io.camunda.operate.exceptions.PersistenceException: Update request failed </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">operate-import-position-1.0.0_</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> and </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">-process-instance</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> with the message </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Elasticsearch exception </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">version_conflict_engine_exception, </span><span class="token assign-left variable" style="color:#36acaa">reason</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">-process-instance</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: version conflict, required seqNo </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1681</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, primary term </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">. current document has seqNo </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1688</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> and primary term </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The exception in more detail:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">io.camunda.operate.exceptions.PersistenceException: Update request failed for [operate-import-position-1.0.0_] and id [2-job] with the message [Elasticsearch exception [type=version_conflict_engine_exception, reason=[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]]].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.util.ElasticsearchUtil.executeUpdate(ElasticsearchUtil.java:271) ~[operate-els-schema-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.zeebeimport.ImportPositionHolder.recordLatestLoadedPosition(ImportPositionHolder.java:100) ~[operate-qa-importer-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.zeebeimport.ImportJob.call(ImportJob.java:86) ~[operate-qa-importer-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.zeebeimport.RecordsReader.lambda$scheduleImport$1(RecordsReader.java:217) ~[operate-qa-importer-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.FutureTask.run(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: org.elasticsearch.ElasticsearchStatusException: Elasticsearch exception [type=version_conflict_engine_exception, reason=[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:176) ~[elasticsearch-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:1933) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.parseResponseException(RestHighLevelClient.java:1910) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1667) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1624) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1594) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.elasticsearch.client.RestHighLevelClient.update(RestHighLevelClient.java:1061) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.camunda.operate.util.ElasticsearchUtil.executeUpdate(ElasticsearchUtil.java:266) ~[operate-els-schema-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 7 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Suppressed: org.elasticsearch.client.ResponseException: method [POST], host [http://elasticsearch:9200], URI [/operate-import-position-1.0.0_/_update/2-job?refresh=true&amp;timeout=1m], status line [HTTP/1.1 409 Conflict]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{"error":{"root_cause":[{"type":"version_conflict_engine_exception","reason":"[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]","index_uuid":"7jsKYxw7RxWQhba-UIG5Wg","shard":"0","index":"operate-import-position-1.0.0_"}],"type":"version_conflict_engine_exception","reason":"[2-job]: version conflict, required seqNo [1765], primary term [1]. current document has seqNo [1771] and primary term [1]","index_uuid":"7jsKYxw7RxWQhba-UIG5Wg","shard":"0","index":"operate-import-position-1.0.0_"},"status":409}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestClient.convertResponse(RestClient.java:326) ~[elasticsearch-rest-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestClient.performRequest(RestClient.java:296) ~[elasticsearch-rest-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestClient.performRequest(RestClient.java:270) ~[elasticsearch-rest-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1654) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1624) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1594) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at org.elasticsearch.client.RestHighLevelClient.update(RestHighLevelClient.java:1061) ~[elasticsearch-rest-high-level-client-7.12.1.jar!/:7.12.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.util.ElasticsearchUtil.executeUpdate(ElasticsearchUtil.java:266) ~[operate-els-schema-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.zeebeimport.ImportPositionHolder.recordLatestLoadedPosition(ImportPositionHolder.java:100) ~[operate-qa-importer-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.zeebeimport.ImportJob.call(ImportJob.java:86) ~[operate-qa-importer-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at io.camunda.operate.zeebeimport.RecordsReader.lambda$scheduleImport$1(RecordsReader.java:217) ~[operate-qa-importer-1.0.0.jar!/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.util.concurrent.FutureTask.run(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        at java.lang.Thread.run(Unknown Source) [?:?]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Experiment failed</strong> ❌ </p><p>Operate was not operating normal, the exceptions were not expected.</p><p>It seems that changing the time on INT, causes some unexpected problems for Operate. We need to investigate that further and resolve them before we can continue here and make that an automated test. Furthermore, we need to investigate how problematic it is that our exporting lags behind, which is related to <a href="https://github.com/camunda-cloud/zeebe/issues/6747" target="_blank" rel="noopener noreferrer">zeebe#6747</a>, and how we can resolve that.</p><p>In general, we saw that Zeebe has no real issues with time shifts and that timers can be triggered by changing the underlying system time. Still we should make sure that our containers are running on UTC time nodes (which we do), such that we avoid issues with daylight saving time.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="data" term="data"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Corrupted Snapshot Experiment Investigation]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/04/29/Corrupted-Snapshot"/>
        <updated>2021-04-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment here. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers.]]></summary>
        <content type="html"><![CDATA[<p>A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-experiments/helm/snapshot-corruption" target="_blank" rel="noopener noreferrer">here</a>. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers. </p><p><strong>NEW</strong> If a follower is restarted and has a corrupted snapshot it will detect it on bootstrap and will refuse to
start related services and crash. This means the pod will end in a crash loop, until this is manually fixed.</p><p><strong>OLD</strong> The follower only detects the corrupted snapshot on becoming leader when opening the database. On the restart of a follower this will not be detected.</p><p>The behavior change caused to fail our automated chaos experiments, since we corrupt the snapshot on followers and on a later experiment we restart followers. For this reason we had to disable the execution of the snapshot corruption experiment, see related issue
<a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/303" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-cluster-testbench#303</a>.</p><p>In this chaos day we wanted to investigate whether we can improve the experiment and bring it back. For reference, I also opened a issue to discuss the current corruption detection approach <a href="https://github.com/camunda-cloud/zeebe/issues/6907" target="_blank" rel="noopener noreferrer">zeebe#6907</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>This time we look at an already existing experiment. I will run our normal setup and execute the experiment (each step) manually and observe what happens.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment">Experiment<a href="#experiment" class="hash-link" aria-label="Direct link to Experiment" title="Direct link to Experiment">​</a></h3><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.1.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe can recover from corrupted snapshots"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"description"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe should be able to detect and recover from corrupted snapshot"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"contributions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"reliability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"availability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"steady-state-hypothesis"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe is alive"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"probes"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"All pods should be ready"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"verify-readiness.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Should be able to create process instances on partition 3"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"verify-steady-state.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"method"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Corrupt snapshots on followers"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"corruptFollowers.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Terminate leader of partition 3"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"shutdown-gracefully-partition.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Leader"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"rollbacks"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As written before we have our normal benchmark setup and I will run the referenced scripts manually and observe the behavior via grafana. The panels below show the base or steady state.
<img loading="lazy" alt="before-general" src="/zeebe-chaos/assets/images/before-general-c5e2d4a84d58bfe92397a1950bce66ab.png" width="1816" height="572" class="img_ev3q">
<img loading="lazy" alt="before-snap" src="/zeebe-chaos/assets/images/before-snap-af75897dcbf32d097c6a0e79300c23fd.png" width="1843" height="645" class="img_ev3q"></p><p>The first script we will run, corrupts for a certain partition the snapshots of all followers. It does it via just simply deleting some <code>*.sst</code> files.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell scripts/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./corruptFollowers.sh </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zell-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">followers</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'zell-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">zell-chaos-zeebe-2'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kubectl -n zell-chaos </span><span class="token builtin class-name">exec</span><span class="token plain"> zell-chaos-zeebe-0 -- ./corrupting.sh </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partitionDir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">snapshotDir</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$partitionDir</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">/snapshots/*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619 -name </span><span class="token string" style="color:#e3116c">'*.sst'</span><span class="token plain"> -print -quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">fileName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000110.sst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000110.sst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kubectl -n zell-chaos </span><span class="token builtin class-name">exec</span><span class="token plain"> zell-chaos-zeebe-2 -- ./corrupting.sh </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partitionDir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">snapshotDir</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$partitionDir</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">/snapshots/*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619 -name </span><span class="token string" style="color:#e3116c">'*.sst'</span><span class="token plain"> -print -quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">fileName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000112.sst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000112.sst</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The second script just terminated the Leader for the referenced partition.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell scripts/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./terminate-partition.sh </span><span class="token string" style="color:#e3116c">"Leader"</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">"zell-chaos-zeebe-1"</span><span class="token plain"> deleted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On the first try we had the "luck" that there was a snapshot replication in between, such that the follower was able to become Leader, since it had again a valid snapshot. </p><p><img loading="lazy" alt="luck-general" src="/zeebe-chaos/assets/images/luck-general-6284a961fb55242e685ef99a31487f34.png" width="1841" height="649" class="img_ev3q">
<img loading="lazy" alt="luck-replication" src="/zeebe-chaos/assets/images/luck-replication-2564925f2731e3c9b5279a8db021b902.png" width="1832" height="649" class="img_ev3q"></p><p>On the second try we were actually able to reproduce the behavior we want to see. We have corrupted the snapshot and restarted the Leader and the partition can make only progress - if the previous leader comes back. This is because the others have a corrupted snapshot and can't take over.</p><p><img loading="lazy" alt="no-luck-restart-general" src="/zeebe-chaos/assets/images/no-luck-restart-general-1f6e7cdad4128ad263669bf62557bb4f.png" width="1835" height="645" class="img_ev3q">
<img loading="lazy" alt="no-luck-restart" src="/zeebe-chaos/assets/images/no-luck-restart-556f37ee3d483e799428e83ad20d1aa5.png" width="1837" height="658" class="img_ev3q"></p><p>In all cases above we were able to make progress. The issue now arises when one of the affected follower is restarted. For our experiment I restarted Broker-2, which was at this point in time follower for Partition 3. After I restarted the follower it first looked like the partition one was completely down.</p><p><img loading="lazy" alt="follower-restart-partition-1" src="/zeebe-chaos/assets/images/follower-restart-partition-1-196eaa9f08944822a7eb9bc3e10b3aa1.png" width="1831" height="653" class="img_ev3q"></p><p>After serveral minutes the system recovered and continued.</p><p><img loading="lazy" alt="follower-restart-partition-1-cont" src="/zeebe-chaos/assets/images/follower-restart-partition-1-cont-9ea01572ab691821683a0145afeb5c80.png" width="1814" height="613" class="img_ev3q"></p><p>Via Grafana but also via <code>kubectl</code> we can see that the pod doesn't become ready again.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          13m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          17m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m4s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-854dd5dd5c-b8cpl   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          45m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  Warning  Unhealthy               4m59s               kubelet                  Readiness probe failed: HTTP probe failed with statuscode: </span><span class="token number" style="color:#36acaa">503</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Warning  Unhealthy               9s </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x30 over 5m9s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet                  Readiness probe failed: Get http://10.0.29.26:9600/ready: dial tcp </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.29.26:9600: connect: connection refused</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In camunda cloud this will end in a crash loop, because we restart pods after 15 minutes if they are not ready in time. It is interesting to see that it seems not to restart by itself, <strong>which I had expected</strong>. After checking the logs we can also see why.</p><div class="language-md codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-md codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:44.205851Z RaftServer{raft-partition-partition-1} - Server join completed. Waiting for the server to be READY </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">W 2021-04-29T11:20:44.220338Z Cannot load snapshot in /usr/local/zeebe/data/raft-partition/partitions/3/snapshots/1387684-4-4014493-4014014. The checksum stored does not match the checksum calculated.</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:44.737724Z Loaded disk segment: 33 (raft-partition-partition-3-33.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:44.738579Z Found segment: 33 (raft-partition-partition-3-33.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.024028Z Loaded disk segment: 34 (raft-partition-partition-3-34.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.024688Z Found segment: 34 (raft-partition-partition-3-34.log) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2021-04-29T11:20:45.025826Z Bootstrap Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">6/13</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> cluster</span><span class="token plain"> services failed with unexpected exception. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.038260Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">1/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> subscription</span><span class="token plain"> api </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.040467Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">1/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> subscription</span><span class="token plain"> api closed in 1 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.040926Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">2/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api handler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.042116Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">2/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api handler closed in 1 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.042524Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">3/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api transport </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:46.163435Z Created segment: JournalSegment{id=2, index=1556849} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.065203Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.066007Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">3/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api transport closed in 2023 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.066552Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">4/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> membership</span><span class="token plain"> and replication protocol </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2021-04-29T11:20:47.067664Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">4/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> membership</span><span class="token plain"> and replication protocol failed to close. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.069050Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">5/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> actor</span><span class="token plain"> scheduler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.069503Z Closing actor thread ground 'Broker-2-zb-fs-workers' </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.071276Z Closing actor thread ground 'Broker-2-zb-fs-workers': closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.071642Z Closing actor thread ground 'Broker-2-zb-actors' </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.073287Z Closing actor thread ground 'Broker-2-zb-actors': closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.074101Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">5/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> actor</span><span class="token plain"> scheduler closed in 4 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.074468Z Closing Broker-2 succeeded. Closed 5 steps in 2036 ms. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">E 2021-04-29T11:20:47.074845Z Failed to start broker 2!</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.078669Z </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">E 2021-04-29T11:20:47.093828Z Application run failed</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.120419Z Shutting down ExecutorService 'applicationTaskExecutor' </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.132016Z RaftServer{raft-partition-partition-1}{role=FOLLOWER} - No heartbeat from null in the last PT2.926S (calculated from last 2926 ms), sending poll requests </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.260582Z RaftServer{raft-partition-partition-1} - Found leader 0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.262407Z RaftServer{raft-partition-partition-1} - Setting firstCommitIndex to 1507899. RaftServer is ready only after it has committed events upto this index </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.263428Z RaftPartitionServer{raft-partition-partition-1} - Successfully started server for partition PartitionId{id=1, group=raft-partition} in 10098ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:21:05.128572Z Created segment: JournalSegment{id=3, index=1570617} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:21:26.376398Z Created segment: JournalSegment{id=4, index=1584886} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:21:28.129677Z RaftPartitionServer{raft-partition-partition-2} - Successfully started server for partition PartitionId{id=2, group=raft-partition} in 51572ms </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see in the logs that the corruption is detected and the broker seems to stop, but actually it doesn't.
After <code>Failed to start broker 2</code> the process should normally end. It looks like the thread for the other raft partitions are still running and continuing. This is a bug which I reported in one of my last chaos days,
see <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a>.</p><p>With this current behavior we could easily fix the snapshot corruption experiments, since we just need a separate clean up step. It could look like this:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> k </span><span class="token builtin class-name">exec</span><span class="token plain"> -it zell-chaos-zeebe-2 -- </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -r data/raft-partition/partitions/3 </span><span class="token comment" style="color:#999988;font-style:italic"># remove partition three data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> k delete pod zell-chaos-zeebe-2 </span><span class="token comment" style="color:#999988;font-style:italic"># restart broker 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I tried this and it worked, after some minutes the Broker-2 was able to come back.</p><p><img loading="lazy" alt="success-after-fix.png" src="/zeebe-chaos/assets/images/success-after-fix-6c7506d3368e85a046fc4d0745965292.png" width="1824" height="647" class="img_ev3q"></p><p>Why does it work you may ask. If we remove the corrupted partition data from the follower and restart it, then it will join the cluster with an empty state. The Leader for that partition will immediately replicate the snapshot for that partition, such that the follower is up to date again. This allows the follower then to bootstrap without issues again.</p><p>One problem with this approach we have if we actually fix the bug above, where we're not shutting down, then we have the issue that we might not be able to access the data, since the pod is not up. I need to do some more research to solve this, but one possible solution I can think of would be to patch the <em>StatefulSet</em>, such that we can claim the PV via multiple pods. This would allow us to start a separate POD in order to access the data and delete it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h2><ul><li>Broker is not shutting down properly <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a></li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[BPMN meets Chaos Engineering]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering"/>
        <updated>2021-04-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[On the first of April (2021) we ran our Spring Hackday at Camunda. This is an event where the developers at camunda come together to work on projects they like or on new ideas/approaches they want to try out. This time we (Philipp and me) wanted to orchestrate our Chaos Experiments with BPMN. If you already know how we automated our chaos experiments before, you can skip the next section]]></summary>
        <content type="html"><![CDATA[<p>On the first of April (2021) we ran our Spring Hackday at Camunda. This is an event where the developers at camunda come together to work on projects they like or on new ideas/approaches they want to try out. This time we (<a href="https://github.com/saig0" target="_blank" rel="noopener noreferrer">Philipp</a> and <a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer">me</a>) wanted to orchestrate our Chaos Experiments with BPMN. If you already know how we automated our chaos experiments before, you can skip the next section
and jump directly to the <a href="#hackday-project">Hackday Project section</a>.</p><p>In order to understand this blogpost make sure that you have a little understanding of Zeebe, Camunda Cloud and Chaos Engineering. Read the following resources to get a better understanding.</p><ul><li><a href="https://docs.camunda.io/docs/guides/" target="_blank" rel="noopener noreferrer">Get Started with Camund cloud</a></li><li><a href="https://docs.camunda.io/docs/product-manuals/clients/cli-client/get-started" target="_blank" rel="noopener noreferrer">Quickstart Guide</a></li><li><a href="https://camunda.com/de/products/cloud/" target="_blank" rel="noopener noreferrer">Camunda Cloud</a></li><li><a href="https://docs.camunda.io/docs/product-manuals/zeebe/zeebe-overview/" target="_blank" rel="noopener noreferrer">Zeebe Process Engine</a></li><li><a href="https://www.omg.org/spec/BPMN/2.0/About-BPMN/" target="_blank" rel="noopener noreferrer">BPMN 2.0</a></li><li><a href="https://principlesofchaos.org/" target="_blank" rel="noopener noreferrer">Principles of Chaos</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="previous-chaos-automation">Previous Chaos Automation<a href="#previous-chaos-automation" class="hash-link" aria-label="Direct link to Previous Chaos Automation" title="Direct link to Previous Chaos Automation">​</a></h2><p>In the previous Chaos Day summaries I described that we use <a href="https://chaostoolkit.org/" target="_blank" rel="noopener noreferrer">ChaosToolkit</a> to run our chaos experiments. The chaos experiments have as prerequisite that an Zeebe cluster is already running, on which they should be executed. ChaosToolkit needs/uses a specific DSL to describe and execute Chaos Experiments. An example experiment looks like the following:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.1.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe follower restart non-graceful experiment"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"description"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe should be fault-tolerant. Zeebe should be able to handle followers terminations."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"contributions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"reliability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"availability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"steady-state-hypothesis"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe is alive"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"probes"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"All pods should be ready"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"verify-readiness.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Should be able to create workflow instances on partition 1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"verify-steady-state.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"method"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Terminate follower of partition 1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"terminate-partition.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Follower"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"rollbacks"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This JSON describes a chaos experiment where a follower of partition one is terminated, and where we expect that we can create a new process instance before and after this termination. The follower termination should not affect our steady state.</p><p>In the JSON structure we can see the defined steady state of the Zeebe Cluster and the method/action which should be executed (the chaos which should be injected). The defined steady state is verified at the beginning of the experiment and at the end, after the methods are executed. The execution logic is quite simple. You can also define rollback actions, which should be executed if the experiment fails. Timeouts can be defined for each action and probe. Since the <code>chaosToolkit</code> is written in Python you can reference python modules/functions, which should be called during execution. Additionally, it supports bash scripts, which we normally use. Unfortunately bash scripts are sometimes not easy to understand and to maintain. This is one of the reason why we already thought more than once to replace the <code>chaosToolkit</code> with something different.</p><p>The <code>chaosToolkit</code> has more features and extensions, but these are not used by us. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="list-of-chaos-experiments">List of Chaos Experiments<a href="#list-of-chaos-experiments" class="hash-link" aria-label="Direct link to List of Chaos Experiments" title="Direct link to List of Chaos Experiments">​</a></h3><p>The experiment above is just one experiment of our continuous growing collection of chaos experiments, which we have already defined. There exist chaos experiments for the helm charts, but also for camunda cloud, for each cluster plan separately. You can find them <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-experiments" target="_blank" rel="noopener noreferrer">here</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="automated-chaos-experiments">Automated Chaos Experiments<a href="#automated-chaos-experiments" class="hash-link" aria-label="Direct link to Automated Chaos Experiments" title="Direct link to Automated Chaos Experiments">​</a></h3><p>Chaos experiments need to be executed continously, not only once. For that we have build an automated pipeline, which runs the chaos experiments every night or if requested. We did that with help of the <a href="https://github.com/zeebe-io/zeebe-cluster-testbench" target="_blank" rel="noopener noreferrer">Zeebe Cluster Testbench</a>, we call it just <code>testbench</code>. The <code>testbench</code> creates for each cluster plan, in camunda cloud, a Zeebe cluster and runs the corresponding experiments against these clusters. The process model looks quite simple.</p><p><img loading="lazy" alt="chaos-test" src="/zeebe-chaos/assets/images/chaos-test-8f97386338e64270714be0f3a7adc291.png" width="783" height="276" class="img_ev3q"></p><p>It is executed via a <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/tree/develop/core/chaos-workers" target="_blank" rel="noopener noreferrer">zbctl chaos worker</a>, which is part of the <code>testbench</code>. The <code>chaos worker</code> polls for new jobs at the <code>testbench</code>. On new jobs it executes, based on the cluster plan, against the given/created Zeebe cluster the chaos experiments, via the <code>chaostoolkit</code>.</p><p>In general this was a good first solution, which is quite extensible since we just needed to add new experiments in the <a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer">zeebe-chaos</a> repository and on the next run the experiments are executed, without any further adjustments. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a href="#challenges" class="hash-link" aria-label="Direct link to Challenges" title="Direct link to Challenges">​</a></h3><p>Still, we had some challenges with this approach. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="additional-dependency">Additional Dependency<a href="#additional-dependency" class="hash-link" aria-label="Direct link to Additional Dependency" title="Direct link to Additional Dependency">​</a></h4><p>With the <code>chaosToolkit</code> we had an additional dependency. If you want to implement/write new chaos experiments you need to set up the <code>chaosToolkit</code> on your machine, with the correct Python etc. In general the setup guide was straight forward, but still it was something you need to have. It made the adoption harder.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="root-cause-analysis">Root Cause Analysis<a href="#root-cause-analysis" class="hash-link" aria-label="Direct link to Root Cause Analysis" title="Direct link to Root Cause Analysis">​</a></h4><p>Due to our setup it was a bit more challenging todo the root cause analysis.</p><p><img loading="lazy" alt="ChaosOutput" src="/zeebe-chaos/assets/images/ChaosOutput-d308a3d2d0bcccb37e4f284e6f0644ad.png" width="692" height="597" class="img_ev3q"></p><p>We run a <code>zbctl</code> worker in a docker image, which picks up the <code>chaos</code> typed jobs. An <code>zbctl</code> worker will complete jobs with the output of the called handler script. This means that everything, which you want to log, needs to be logged in a separate file. The <code>chaosToolkit</code> will print its output into an own log file. The output of the bash scripts, which are executed by the <code>chaosToolkit</code>, will also end in that <code>chaosToolkit.log</code> file. I tried to visualize this a bit with the image above.</p><p><img loading="lazy" alt="chaos-test" src="/zeebe-chaos/assets/images/failed-chaos-experiment-testbench-31d2cac3b2dd367edfa979255a11ba49.png" width="1897" height="921" class="img_ev3q"></p><p>If the chaos worker completes a job, the process instance in <code>testbench</code> is continued. If a chaos experiment fails, then the job is still completed normally, but with an error result. In the process instance execution this means that a different path is taken. The <code>testbench</code> will write a slack notification to a specific channel, such that the current Zeebe medic can look at it. </p><p><img loading="lazy" alt="run-test" src="/zeebe-chaos/assets/images/run-test-in-camunda-cloud-61406278623b76fb1720819df03769a1.png" width="3504" height="816" class="img_ev3q"></p><p>After the notification the medic needs to find out which experiment has failed, this is part of the payload of the completed job at least, but he also needs to find out why the experiment failed. For this root cause analysis he has to check the log of the <code>chaostoolkit</code>, which is stored somewhere in the chaos worker pod (<code>data/chaostoolkit.log</code> it is an ever growing log).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hackday-project">Hackday Project<a href="#hackday-project" class="hash-link" aria-label="Direct link to Hackday Project" title="Direct link to Hackday Project">​</a></h2><p>With our Hackday Project we had two goals:</p><ol><li>lower the bar for team adoption </li><li>make root cause analysis easier</li></ol><p>For that we wanted to replace <code>chaosToolkit</code> with a BPMN Process, which should be executed by Zeebe. We wanted to stick with the experiment description (the <code>chaosToolkit</code>/openchaos DSL) for our chaos experiments.</p><p>We modeled two processes. One root process, which reads for a given cluster plan all experiments and runs then each experiment. This is done via a <a href="https://docs.camunda.io/docs/0.25/product-manuals/zeebe/bpmn-workflows/multi-instance/multi-instance/" target="_blank" rel="noopener noreferrer">multi instance</a> <a href="https://docs.camunda.io/docs/reference/bpmn-workflows/call-activities/call-activities/" target="_blank" rel="noopener noreferrer">call activity</a>.</p><p><img loading="lazy" alt="ChaosOutput" src="/zeebe-chaos/assets/images/chaosToolkit-b205b8a3611844c5a45a1f0a6f0723bd.png" width="1449" height="312" class="img_ev3q"></p><p>The other process model is used for the real chaos experiment execution. As the <code>chaosToolkit</code> execution itself was quite simple, the resulting BPMN model is as well. All activities are
sequential multi instances, since we can have multiple probes/actions for the steady state, but also for the injection of chaos. On the root level of the process we have an interrupting <a href="https://docs.camunda.io/docs/reference/bpmn-workflows/event-subprocesses/event-subprocesses/" target="_blank" rel="noopener noreferrer">event sub process</a> to timeout the chaos experiment if the experiment takes to long.</p><p><img loading="lazy" alt="ChaosExperiment" src="/zeebe-chaos/assets/images/chaosExperiment-a625cf5634ccf0629a70f3717115be82.png" width="1923" height="1215" class="img_ev3q"></p><p>As payload of the process instances we have the defined chaos experiment in JSON, which we have seen earlier. In this JSON we have all information we need to orchestrate this experiment.</p><p>We have implemented two Kotlin workers, one to read all experiment JSON files and one to execute the bash scripts, which are referenced in the chaos experiment descriptions. You can find the code <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-model/chaos-worker" target="_blank" rel="noopener noreferrer">here</a>, it is just 100 lines long.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="results">Results<a href="#results" class="hash-link" aria-label="Direct link to Results" title="Direct link to Results">​</a></h3><p>We orchestrated the follower/leader termination and graceful shutdown experiments via Camunda Cloud and the created process models. The experiments have been executed against another Zeebe cluster successfully.</p><p><img loading="lazy" alt="success" src="/zeebe-chaos/assets/images/success-run-d7e1671a0d070ea7290ae2565902b4a8.png" width="1911" height="817" class="img_ev3q"></p><p>To see how we improved the observability, we provoked an experiment to fail. Operate shows use via an incident that an experiment failed, and exactly at which step. </p><p><img loading="lazy" alt="failure" src="/zeebe-chaos/assets/images/fail-run-4f1f6cbbb18170bd0947abf0a9d471f8.png" width="1906" height="838" class="img_ev3q"></p><p>We can even see the standard output and error output of the executed script in operate, without searching different log files.</p><p><img loading="lazy" alt="failuremsg" src="/zeebe-chaos/assets/images/fail-run-output-06271ff74f1049c9036ce88895dfb39e.png" width="1909" height="832" class="img_ev3q"></p><p>An timeout of an experiment will look like this:</p><p><img loading="lazy" alt="timeout" src="/zeebe-chaos/assets/images/timeout-run-67874e1d4b6c866fc3c04dfdf16148dd.png" width="1907" height="822" class="img_ev3q"></p><p>As we can see the observability improved here a lot. We are able to understand why it failed based on the error message, since the complete error output is printed, and we can see the progress of the process instance on running the chaos experiment. </p><p>With these models we were able to completely replace the <code>chaosToolkit</code> usage, so in the end we can remove an additional dependency.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="further-work">Further Work<a href="#further-work" class="hash-link" aria-label="Direct link to Further Work" title="Direct link to Further Work">​</a></h3><p>Next step would be to integrate this in <code>testbench</code>, such that we can replace the old <code>chaos worker</code>.</p><p>Furthermore, we plan to replace step by step the new worker, which calls the scripts, by workers which have the script logic inside. For example with workers written in go or kotlin. This should improve the adoption and maintainability further.</p><p>For simplicity and to make progress we modeled quite generic process models, which are feed with the chaos experiment DSL. In the future we can also think of modeling the chaos experiments directly as BPMN model.</p><p><strong>Thanks to <a href="https://github.com/pihme" target="_blank" rel="noopener noreferrer">Peter</a> for giving the impulse and his awesome work on <code>testbench</code> and <a href="https://github.com/saig0" target="_blank" rel="noopener noreferrer">Philipp</a> which worked with me on this Hackday project.</strong></p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="tools" term="tools"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Set file immutable]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/03/30/set-file-immutable</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/03/30/set-file-immutable"/>
        <updated>2021-03-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This chaos day was a bit different. Actually I wanted to experiment again with camunda cloud and verify that our high load chaos experiments are now working with the newest cluster plans, see zeebe-cluster-testbench#135.]]></summary>
        <content type="html"><![CDATA[<p>This chaos day was a bit different. Actually I wanted to experiment again with camunda cloud and verify that our high load chaos experiments are now working with the newest cluster plans, see <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/135" target="_blank" rel="noopener noreferrer">zeebe-cluster-testbench#135</a>.
Unfortunately I found out that our test chaos cluster was in a way broken, that we were not able to create new clusters. Luckily this was fixed at the end of the day, thanks to @immi :) </p><p>Because of these circumstances I thought about different things to experiment with, and I remembered that in the <a href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">last chaos day</a> we worked with patching running deployments, in order to add more capabilities.
This allowed us to create ip routes and experiment with the zeebe deployment distribution. During this I have read the <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">capabilities list of linux</a>, and found out that we can mark files as immutable, which might be interesting for a chaos experiment.</p><p>In this chaos day I planned to find out how marking a file immutable affects our brokers and I made the hypothesis that: <em>If a leader has a write error, which is not recoverable, it will step down and another leader should take over.</em> I put this in our hypothesis backlog (<a href="https://github.com/zeebe-io/zeebe-chaos/issues/52" target="_blank" rel="noopener noreferrer">zeebe-chaos#52</a>). </p><p>In order to really run this kind of experiment I need to find out whether marking a file immutable will cause any problems and if not how I can cause write errors such that affects the broker.
Unfortunately it turned out that immutable files will not cause issues on already opened file channels, but I found some other bugs/issues, which you can read below.</p><p>In the next chaos days I will search for a way to cause write errors proactively, so we can verify that our system can handle such issues.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="immutable-file">Immutable File<a href="#immutable-file" class="hash-link" aria-label="Direct link to Immutable File" title="Direct link to Immutable File">​</a></h3><p>In order to <a href="https://delightlylinux.wordpress.com/2012/12/11/file-immutable-attribute/" target="_blank" rel="noopener noreferrer">mark a file as immutable</a> we can use the command <code>chattr +i</code>. For that we need a specific capability called <code>LINUX_IMMUTABLE</code>. Since we were at this time not able to create new clusters I tested it with the helm charts, where it is anyway easier to give us these capabilities.</p><p>We just need to add in our <em>values</em> files the following:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">podSecurityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LINUX_IMMUTABLE"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since we want to experiment with leaders I need to get the current topology from the gateway, here I found an issue on our latest zbctl build and the human output (<a href="https://github.com/camunda-cloud/zeebe/issues/6692" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6692</a>). This is already fixed, thanks to <a href="https://github.com/MiguelPires" target="_blank" rel="noopener noreferrer">Miguel</a> 🚀!</p><p>After finding the correct leader we can execute on the corresponding broker/pod following commands to mark a file as immutable.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ k </span><span class="token builtin class-name">exec</span><span class="token plain"> -it zell-chaos-zeebe-1 -- </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># opens an interactive shell on zell-chaos-zeebe-1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-zeebe-1</span><span class="token comment" style="color:#999988;font-style:italic"># cd data/raft-partition/partitions/1/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-zeebe-1</span><span class="token comment" style="color:#999988;font-style:italic"># chattr +i raft-partition-partition-1-1.log # marks the log file immutable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-zeebe-1</span><span class="token comment" style="color:#999988;font-style:italic"># lsattr raft-partition-partition-1-1.log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----i---------e---- raft-partition-partition-1-1.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With the last command <code>lsattr</code> we print out the file attributes, where we see that the immutable flag is set (the <code>i</code> in the output).
After setting the log file to immutable nothing really happens. I checked again the manual page and read that this not affects already created file channels.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CHATTR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                           General Commands Manual                          CHATTR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       chattr - change </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> attributes on a Linux </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      i      A  </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> with the </span><span class="token string" style="color:#e3116c">'i'</span><span class="token plain"> attribute cannot be modified: it cannot be deleted or renamed, no </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> can be created to this file, </span><span class="token function" style="color:#d73a49">most</span><span class="token plain"> of the </span><span class="token function" style="color:#d73a49">file</span><span class="token string" style="color:#e3116c">'s metadata can not be modified, and the</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              file can not be opened in write mode.  Only the superuser or a process possessing the CAP_LINUX_IMMUTABLE capability can set or clear this attribute.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      BUGS AND LIMITATIONS</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       The '</span><span class="token plain">c</span><span class="token string" style="color:#e3116c">', '</span><span class="token plain">s</span><span class="token string" style="color:#e3116c">',  and '</span><span class="token plain">u</span><span class="token string" style="color:#e3116c">' attributes are not honored by the ext2, ext3, and ext4 filesystems as implemented in the current mainline Linux kernels.  Setting '</span><span class="token plain">a</span><span class="token string" style="color:#e3116c">' and '</span><span class="token plain">i' attributes will not</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       affect the ability to </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> to already existing </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> descriptors.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So we actually are not able to use it to cause any write errors on a running leader, but interesting was what happened later when the pod was restarted. The pod was not able to restart, since the log was still immutable. We can see the following bootstrap sequence and the related errors:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.433467Z Found segment: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raft-partition-partition-2-1.log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.499079Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Transitioning to FOLLOWER </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.500847Z RaftPartitionServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Starting server </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> partition PartitionId</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">group</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">raft-partition</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.506876Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Server </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> completed. Waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the server to be READY </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.508400Z Bootstrap Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">/13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: cluster services failed with unexpected exception. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.523239Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: subscription api </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.525497Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: subscription api closed </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.526484Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">command</span><span class="token plain"> api handler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.528108Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">command</span><span class="token plain"> api handler closed </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:02.528740Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">command</span><span class="token plain"> api transport </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:03.519309Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Found leader </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:03.521376Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Setting firstCommitIndex to </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">. RaftServer is ready only after it has committed events upto this index </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:03.522206Z RaftPartitionServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Successfully started server </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> partition PartitionId</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">group</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">raft-partition</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> 1171ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.553825Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.555166Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: </span><span class="token builtin class-name">command</span><span class="token plain"> api transport closed </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2026</span><span class="token plain"> ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.556177Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: membership and replication protocol </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.558282Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Transitioning to INACTIVE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.558408Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: membership and replication protocol failed to close. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.560776Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: actor scheduler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.561558Z Closing actor thread ground </span><span class="token string" style="color:#e3116c">'Broker-1-zb-fs-workers'</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.563600Z Closing segment: JournalSegment</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.563881Z Closing actor thread ground </span><span class="token string" style="color:#e3116c">'Broker-1-zb-fs-workers'</span><span class="token builtin class-name">:</span><span class="token plain"> closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.564448Z Closing actor thread ground </span><span class="token string" style="color:#e3116c">'Broker-1-zb-actors'</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.566157Z Closing actor thread ground </span><span class="token string" style="color:#e3116c">'Broker-1-zb-actors'</span><span class="token builtin class-name">:</span><span class="token plain"> closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.567716Z Closing Broker-1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">/5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: actor scheduler closed </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.568366Z Closing Broker-1 succeeded. Closed </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> steps </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2045</span><span class="token plain"> ms. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.568908Z Failed to start broker </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.574482Z </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error starting ApplicationContext. To display the conditions report re-run your application with </span><span class="token string" style="color:#e3116c">'debug'</span><span class="token plain"> enabled. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.595919Z Application run failed </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:04.627321Z Shutting down ExecutorService </span><span class="token string" style="color:#e3116c">'applicationTaskExecutor'</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following exception occurred on opening the log:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.util.concurrent.CompletionException: io.zeebe.journal.JournalException: java.nio.file.FileSystemException: /usr/local/zeebe/data/raft-partition/partitions/1/raft-partition-partition-1-1.log: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.encodeThrowable(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.completeThrowable(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.zeebe.journal.JournalException: java.nio.file.FileSystemException: /usr/local/zeebe/data/raft-partition/partitions/1/raft-partition-partition-1-1.log: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.journal.file.SegmentedJournal.openChannel(SegmentedJournal.java:468) ~[zeebe-journal-1.0.0-SNAPSHOT.jar:1.0.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.journal.file.SegmentedJournal.loadSegments(SegmentedJournal.java:490) ~[zeebe-journal-1.0.0-SNAPSHOT.jar:1.0.0-SNAPSHOT]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After this exception on bootstrap the broker tries to close itself, and we see an error on closing a step <code>2021-03-30 11:11:04.558 CEST Closing Broker-1 [4/5]: membership and replication protocol failed to close.</code> This seems to be caused by a NPE.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.NullPointerException: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.atomix.raft.partition.impl.RaftPartitionServer.stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RaftPartitionServer.java:141</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">atomix-cluster-1.0.0-SNAPSHOT.jar:1.0.0-SNAPSHOT</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.atomix.raft.partition.RaftPartition.closeServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RaftPartition.java:165</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">atomix-cluster-1.0.0-SNAPSHOT.jar:1.0.0-SNAPSHOT</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.atomix.raft.partition.RaftPartition.close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RaftPartition.java:155</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ~</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">atomix-cluster-1.0.0-SNAPSHOT.jar:1.0.0-SNAPSHOT</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The problem now here is that the broker never comes back. It is not restarted, which is a bit confusing. Furthermore it hasn't retried on opening, which is also unexpected, since it might be a temporary exception. </p><p>We can see in stackdriver that the new leader is not able to connect, which is expected. But we also see that the other Broker never comes back which is unexpected!</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:05.006825Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.atomix.cluster.messaging.MessagingException</span><span class="token variable" style="color:#36acaa">$NoRemoteHandler</span><span class="token builtin class-name">:</span><span class="token plain"> No remote message handler registered </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> this message </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:05.256830Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.atomix.cluster.messaging.MessagingException</span><span class="token variable" style="color:#36acaa">$NoRemoteHandler</span><span class="token builtin class-name">:</span><span class="token plain"> No remote message handler registered </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> this message </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:08.450683Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-3</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.atomix.cluster.messaging.MessagingException</span><span class="token variable" style="color:#36acaa">$NoRemoteHandler</span><span class="token builtin class-name">:</span><span class="token plain"> No remote message handler registered </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> this message </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:12.897492Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.atomix.cluster.messaging.MessagingException</span><span class="token variable" style="color:#36acaa">$NoRemoteHandler</span><span class="token builtin class-name">:</span><span class="token plain"> No remote message handler registered </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> this message </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-30T09:11:25.950363Z RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-3</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.atomix.cluster.messaging.MessagingException</span><span class="token variable" style="color:#36acaa">$NoRemoteHandler</span><span class="token builtin class-name">:</span><span class="token plain"> No remote message handler registered </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> this message</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We need to investigate this issue <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a> further, and I need to find out how we can cause write errors proactively.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h4><ul><li>Int Console was not able to create new clusters in ultrachaos </li><li>Zbctl human output looks broken <a href="https://github.com/camunda-cloud/zeebe/issues/6692" target="_blank" rel="noopener noreferrer">#6692</a></li><li>Broker is not correctly shutdown <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">#6702</a></li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Camunda Cloud network partition]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/03/23/camunda-cloud-network-partition</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/03/23/camunda-cloud-network-partition"/>
        <updated>2021-03-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This time Deepthi was joining me on my regular Chaos Day.]]></summary>
        <content type="html"><![CDATA[<p>This time <a href="https://github.com/deepthidevaki" target="_blank" rel="noopener noreferrer">Deepthi</a> was joining me on my regular Chaos Day. 🎉</p><p><a href="/zeebe-chaos/2021/02/23/automate-deployments-dist">In the second last chaos day</a> I created an automated chaos experiment, which verifies that the deployments are distributed after a network partition. Later it turned out that this doesn't work for camunda cloud, only for our helm setup. <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/237" target="_blank" rel="noopener noreferrer">The issue</a> was that on our camunda cloud zeebe clusters we had no <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="noopener noreferrer">NET_ADMIN</a> capability to create ip routes (used for the network partitions). After discussing with our SRE's they proposed a good way to overcome this. On running chaos experiments, which are network related, we will patch our target cluster to add this capability. This means we don't need to add such functionality in camunda cloud and the related zeebe operate/controller. Big thanks to <a href="https://github.com/hisImminence" target="_blank" rel="noopener noreferrer">Immi</a> and <a href="https://github.com/Faffnir" target="_blank" rel="noopener noreferrer">David</a> for providing this fix.</p><p><strong>TL;DR;</strong></p><p>We were able to enhance the deployment distribution experiment and run it in the camunda cloud via testbench. We have enabled the experiment for Production M and L cluster plans. We had to adjust the rights for the testbench service account to make this work.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>We already had a <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/helm/deployment-distribution/experiment.json" target="_blank" rel="noopener noreferrer">prepared chaos experiment</a>, but we needed to enhance that. Deepthi was so kind to create <a href="https://github.com/zeebe-io/zeebe-chaos/pull/50" target="_blank" rel="noopener noreferrer">PR</a> for that.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enhancement">Enhancement<a href="#enhancement" class="hash-link" aria-label="Direct link to Enhancement" title="Direct link to Enhancement">​</a></h3><p>The changes contain a new step before creating the network partition on the deployment distribution experiment, see <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/camunda-cloud/production-l/deployment-distribution/experiment.json#L25-L35" target="_blank" rel="noopener noreferrer">here</a>.</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Enable net_admin capabilities"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"apply_net_admin.sh"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"pauses"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"after"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">180</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>apply_net_admin.sh</code> contains the following code:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -euo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">scriptPath</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">cd</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">dirname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable string" style="color:#e3116c">"</span><span class="token variable string variable string variable" style="color:#36acaa">${</span><span class="token variable string variable string variable environment constant" style="color:#36acaa">BASH_SOURCE</span><span class="token variable string variable string variable punctuation" style="color:#393A34">[</span><span class="token variable string variable string variable" style="color:#36acaa">0</span><span class="token variable string variable string variable punctuation" style="color:#393A34">]</span><span class="token variable string variable string variable" style="color:#36acaa">}</span><span class="token variable string variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa"> -P </span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CLUSTERID</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${namespace</span><span class="token variable operator" style="color:#393A34">%</span><span class="token variable" style="color:#36acaa">-zeebe}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch zb </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$CLUSTERID</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> --type merge --patch</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'{"spec":{"controller":{"reconcileDisabled":true}}}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch statefulset zeebe -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> --patch </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">cat</span><span class="token string variable" style="color:#36acaa"> $scriptPath/net_admin_patch.yaml</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It disables reconciliation for the target zeebe cluster and applies the following patch, which adds the <code>NET_ADMIN</code> capability:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"zeebe"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"NET_ADMIN"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Big thanks to <a href="https://github.com/hisImminence" target="_blank" rel="noopener noreferrer">Immi</a> and <a href="https://github.com/Faffnir" target="_blank" rel="noopener noreferrer">David</a> for providing this fix.</p><p>After we applied the patch, we need to make sure that the all pods are restarted and have the requested change. This is the reason we wait after the action for some minutes. This was the easiest way for us to think of, but ideally we find a better way here to make sure the patch was applied and we can continue.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="verification">Verification<a href="#verification" class="hash-link" aria-label="Direct link to Verification" title="Direct link to Verification">​</a></h3><p>We run this experiment with a Production L cluster (v1.0.0-alpha2) and it succeeded. This is quite nice, because this also contains already the rewritten <a href="https://github.com/camunda-cloud/zeebe/issues/6173" target="_blank" rel="noopener noreferrer">deployment distribution</a> logic.</p><p>To verify whether the experiment really does something we checked the metrics and the logs. In the metrics we were not really able to tell that there was a network partition going on. There were no heart beats missing. The reason for that was that in the experiment the Leader for partition 3 (Node 1) and Leader for partition 1 (Node 0) have been disconnected. If we check the <a href="https://github.com/camunda-cloud/zeebe/blob/develop/benchmarks/docs/scripts/partitionDistribution.sh" target="_blank" rel="noopener noreferrer">partition distribution</a> we can see that they have no partitions in common. </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./partitionDistribution.sh </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Distribution:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">N</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    N </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    N </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    N </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    N </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    N </span><span class="token number" style="color:#36acaa">4</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    N </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">3</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">4</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">6</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P </span><span class="token number" style="color:#36acaa">7</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    L  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    F  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    -  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions per Node:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fortunately we saw in the logs that the Node 1, was retrying to send the deployments and at some point it succeeds.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.163 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to receive deployment response </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> partitions </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topic </span><span class="token string" style="color:#e3116c">'deployment-response-2251799813685304'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.164 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pushed deployment </span><span class="token number" style="color:#36acaa">2251799813685304</span><span class="token plain"> to all partitions.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.164 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685304</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.164 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685304</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.164 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685304</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.165 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685304</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.175 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment </span><span class="token number" style="color:#36acaa">2251799813685304</span><span class="token plain"> distributed to all partitions successfully.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.763 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to receive deployment response </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> partitions </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topic </span><span class="token string" style="color:#e3116c">'deployment-response-2251799813685306'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. Retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.764 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pushed deployment </span><span class="token number" style="color:#36acaa">2251799813685306</span><span class="token plain"> to all partitions.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.764 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685306</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.764 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685306</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.765 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685306</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.765 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment CREATE </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> deployment </span><span class="token number" style="color:#36acaa">2251799813685306</span><span class="token plain"> was written on partition </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:11:54.773 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deployment </span><span class="token number" style="color:#36acaa">2251799813685306</span><span class="token plain"> distributed to all partitions successfully.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="testbench">Testbench<a href="#testbench" class="hash-link" aria-label="Direct link to Testbench" title="Direct link to Testbench">​</a></h3><p>After the experiment has succeeded and we had verified the execution we run this again on testbench.</p><p>We saw a non completing chaos worker after checking the chaostoolkit logs, we saw that it was still in the phase of disconnecting the nodes, which was the same issue as before <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/237" target="_blank" rel="noopener noreferrer">#237</a>.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:40:24 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">activity:161</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Enable net_admin capabilities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:40:24 DEBUG</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">process:53</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Running: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/../scripts/apply_net_admin.sh'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:40:24 WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">process:66</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This process returned a non-zero </span><span class="token builtin class-name">exit</span><span class="token plain"> code. This may indicate some error and not what you expected. Please have a </span><span class="token function" style="color:#d73a49">look</span><span class="token plain"> at the logs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:40:24 DEBUG</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__init__:142</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Data encoding detected as </span><span class="token string" style="color:#e3116c">'ascii'</span><span class="token plain"> with a confidence of </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:40:24 DEBUG</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">activity:180</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> succeeded with </span><span class="token string" style="color:#e3116c">'{'</span><span class="token plain">status</span><span class="token string" style="color:#e3116c">': 1, '</span><span class="token plain">stdout</span><span class="token string" style="color:#e3116c">': '</span><span class="token plain">', </span><span class="token string" style="color:#e3116c">'stderr'</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Error from server (Forbidden): zeebeclusters.cloud.camunda.io "cc108db7-768c-45cc-a6c5-098dc28f260c" is forbidden: User "system:serviceaccount:zeebe-chaos:zeebe-chaos-sa" cannot get resource "zeebeclusters" in API group "cloud.camunda.io" at the cluster scope\n'</span><span class="token punctuation" style="color:#393A34">}</span><span class="token string" style="color:#e3116c">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:40:24 INFO] [activity:198] Pausing after activity for 180s...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on '</span><span class="token plain">activity</span><span class="token string" style="color:#e3116c">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on '</span><span class="token plain">activity</span><span class="token string" style="color:#e3116c">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 INFO] [activity:161] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [process:53] Running: ['</span><span class="token plain">/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/scripts/verify-readiness.sh</span><span class="token string" style="color:#e3116c">']</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [__init__:142] Data encoding detected as '</span><span class="token plain">ascii</span><span class="token string" style="color:#e3116c">' with a confidence of 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [__init__:142] Data encoding detected as '</span><span class="token plain">ascii</span><span class="token string" style="color:#e3116c">' with a confidence of 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [activity:180]   =&gt; succeeded with '</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">'status'</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'stdout'</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pod/zeebe-0 condition met\npod/zeebe-1 condition met\npod/zeebe-2 condition met\npod/zeebe-3 condition met\npod/zeebe-4 condition met\npod/zeebe-5 condition met\n'</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">'stderr'</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"+ source utils.sh</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">++ CHAOS_SETUP=cloud</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">++ getNamespace</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">+++ kubectl config view --minify --output 'jsonpath={..namespace}'</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">++ namespace=cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">++ echo cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">+ namespace=cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">+ '[' cloud == cloud ']'</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">+ kubectl wait --for=condition=Ready pod -l app.kubernetes.io/app=zeebe --timeout=900s -n cc108db7-768c-45cc-a6c5-098dc28f260c-zeebe</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token string" style="color:#e3116c">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on '</span><span class="token plain">activity</span><span class="token string" style="color:#e3116c">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [__init__:355] No controls to apply on '</span><span class="token plain">activity</span><span class="token string" style="color:#e3116c">'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 INFO] [activity:161] Action: Create network partition between leaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-23 12:43:24 DEBUG] [process:53] Running: ['</span><span class="token plain">/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/scripts/disconnect-leaders.sh'</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the logs we also saw that the patch didn't worked as expected with the used service account, so we need to fix here the permission and after that it should hopefully work. 🤞</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">'Error from server (Forbidden): zeebeclusters.cloud.camunda.io "XXX" is forbidden: User "system:serviceaccount:zeebe-chaos:zeebe-chaos-sa" cannot get resource "zeebeclusters" in API group "cloud.camunda.io" at the cluster scope\n'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After checking with Immi, we were sure that we need to adjust the <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/blob/develop/core/chaos-workers/deployment/service-account/zeebe-chaos-role.yaml#L9" target="_blank" rel="noopener noreferrer">serviceaccount roles</a>. After changing the apiGroups to <code>["*"]</code> the experiments are running in testbench and the patch can be applied. We can now see in the log the following:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:21:24 DEBUG</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">process:53</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Running: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'/home/chaos/zeebe-chaos/chaos-experiments/camunda-cloud/../scripts/apply_net_admin.sh'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:21:25 DEBUG</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__init__:142</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Data encoding detected as </span><span class="token string" style="color:#e3116c">'ascii'</span><span class="token plain"> with a confidence of </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:21:25 DEBUG</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">activity:180</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> succeeded with </span><span class="token string" style="color:#e3116c">'{'</span><span class="token plain">status</span><span class="token string" style="color:#e3116c">': 0, '</span><span class="token plain">stdout</span><span class="token string" style="color:#e3116c">': '</span><span class="token plain">zeebecluster.cloud.camunda.io/cc108db7-768c-45cc-a6c5-098dc28f260c patched</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">nstatefulset.apps/zeebe patched</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">n</span><span class="token string" style="color:#e3116c">', '</span><span class="token plain">stderr</span><span class="token string" style="color:#e3116c">': '</span><span class="token plain">'</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Thanks for participating <a href="https://github.com/deepthidevaki" target="_blank" rel="noopener noreferrer">Deepthi</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="re-connecting-might-fail">Re-connecting might fail<a href="#re-connecting-might-fail" class="hash-link" aria-label="Direct link to Re-connecting might fail" title="Direct link to Re-connecting might fail">​</a></h5><p>We realized during testing the experiment that the re-connecting might fail, because the pod can be rescheduled and then a ip route can't be delete since it no longer exist. <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/connect-leaders.sh#L45-L48" target="_blank" rel="noopener noreferrer">This is now fixed</a>. We check for existence of the command <code>ip</code>, if this doesn't exist we know the pod was restarted and we ignore it.</p><p><em>Before:</em></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route del unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>After:</em></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin class-name">command</span><span class="token plain"> -v </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route del unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Fault-tolerant processing of process instances]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/03/09/cont-workflow-instance</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/03/09/cont-workflow-instance"/>
        <updated>2021-03-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today I wanted to add another chaos experiment, to increase our automated chaos experiments collection. This time we will deploy a process model (with timer start event), restart a node and complete the process instance via zbctl.]]></summary>
        <content type="html"><![CDATA[<p>Today I wanted to add another chaos experiment, to increase our automated chaos experiments collection. This time we will deploy a process model (with timer start event), restart a node and complete the process instance via <code>zbctl</code>.</p><p><strong>TL;DR;</strong></p><p>I was able to create the chaos toolkit experiment. It shows us that we are able to restore our state after fail over, which means we can trigger timer start events to create process instances even if they have been deployed before fail-over. Plus we are able to complete these instances.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>For testing, I have run our normal setup of three nodes, three partitions and replication factor three in our zeebe gke cluster.
Later I want to automate the experiment against the production cluster plans.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We want to verify whether the processing of process instances continues even if we restart a leader in between. For that we do the following experiment:</p><ol><li>Verify Steady State: All Pods are ready</li><li>Introduce Chaos:<ol><li><em>Action:</em> Deploy process with timer start event (<code>PT1M</code>)</li><li><em>Action:</em> Restart leader of partition one</li><li><em>Probe:</em> We can activate and complete an job of a specific type</li></ol></li><li>Verify Steady State: All Pods are ready</li></ol><p><strong>Note:</strong> <em>We know that timer start events currently only scheduled on partition one, which means it is enough to just restart the leader of partition one for our experiment.</em> We use this property to reduce the blast radius. Later we could introduce an intermediate timer catch event and start many workflow instances on multiple partitions to verify whether this works on all partitions.</p><p>Model will look like this:</p><p><img loading="lazy" alt="model" src="/zeebe-chaos/assets/images/chaosTimerStart-0c9330fda76374b0b56d57e595aea79d.png" width="903" height="276" class="img_ev3q">)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-definition">Experiment Definition<a href="#experiment-definition" class="hash-link" aria-label="Direct link to Experiment Definition" title="Direct link to Experiment Definition">​</a></h3><p>The experiment definition looks like the following:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.1.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe process instance continuation"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"description"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe processing of process instances should be fault-tolerant. Zeebe should be able to handle fail-overs and continue process instances after a new leader starts with processing."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"contributions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"reliability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"availability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"steady-state-hypothesis"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe is alive"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"probes"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"All pods should be ready"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"verify-readiness.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"method"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Deploy process model"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"deploy-specific-model.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"chaosTimerStart.bpmn"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Restart partition leader"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"shutdown-gracefully-partition.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Leader"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Complete process instance"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"complete-instance.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"chaos"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"rollbacks"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="timer-start-events">Timer start events<a href="#timer-start-events" class="hash-link" aria-label="Direct link to Timer start events" title="Direct link to Timer start events">​</a></h4><p>In order to trigger the timer start event, after 1 minute, after successful deployment. I used the following <a href="https://docs.camunda.io/docs/reference/feel/what-is-feel" target="_blank" rel="noopener noreferrer">feel expression</a>: <code>=now()+ duration("PT1M")</code>. This is necessary, since only date and cycle are supported for <a href="https://docs.camunda.io/docs/reference/bpmn-workflows/timer-events/timer-events/#timer-start-events" target="_blank" rel="noopener noreferrer">timer start events</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="continue-process-instance">Continue process instance<a href="#continue-process-instance" class="hash-link" aria-label="Direct link to Continue process instance" title="Direct link to Continue process instance">​</a></h4><p>To continue and finish the process instance, we will activate the job with the <code>chaos</code> job type and complete that job. If there is no job to activate/complete we will loop here until we reach the timeout. With this we can make sure that the timer was scheduled and the process instance was created even after restart. We are not using here an job worker, since the activate-complete commands make it currently easier to mark it as success or fail. With the job worker we would introduce another concurrency layer. </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -euox pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">jobType</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">pod</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">completeJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># we want to first activate the job with the given job type and then complete it with the given job key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># if we are not able to activate an job with the given type the function will return an error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># and retried from outside</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">jobs</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl </span><span class="token variable builtin class-name" style="color:#36acaa">exec</span><span class="token variable" style="color:#36acaa"> -it </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$pod</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -- zbctl --insecure activate </span><span class="token variable function" style="color:#d73a49">jobs</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$jobType</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">key</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$jobs</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq -r </span><span class="token variable string" style="color:#e3116c">'.jobs[0].key'</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -it </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$pod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- zbctl --insecure complete job </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$key</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess completeJob</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="outcome">Outcome<a href="#outcome" class="hash-link" aria-label="Direct link to Outcome" title="Direct link to Outcome">​</a></h3><p>After running this experiment we get the following output, which shows us that the experiment <strong>SUCCEEDED</strong>.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chaostk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell helm/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ chaos run process-continuation/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:16:34 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Validating the experiment</span><span class="token string" style="color:#e3116c">'s syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:34 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:34 INFO] Running experiment: Zeebe process instance continuation</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:34 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:34 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:34 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:34 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:35 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:16:35 INFO] Playing your experiment'</span><span class="token plain">s method now</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:16:35 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Deploy process model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:16:37 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Restart partition leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:16:46 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: Complete process instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:17:38 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:17:38 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:17:38 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Steady state hypothesis is met</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:17:38 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Let</span><span class="token string" style="color:#e3116c">'s rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:17:38 INFO] No declared rollbacks, let'</span><span class="token plain">s move on.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="testbench">Testbench<a href="#testbench" class="hash-link" aria-label="Direct link to Testbench" title="Direct link to Testbench">​</a></h4><p>Tbd.</p><p>We have currently some problems with running the chaos experiments against camunda cloud, like <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/247" target="_blank" rel="noopener noreferrer">testbench#247</a> or <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/248" target="_blank" rel="noopener noreferrer">testbench#248</a>. This is the reason why I postponed it.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiments-not-working-correctly">Chaos Experiments not working correctly<a href="#chaos-experiments-not-working-correctly" class="hash-link" aria-label="Direct link to Chaos Experiments not working correctly" title="Direct link to Chaos Experiments not working correctly">​</a></h5><p>I realized that most of the experiments are no longer run correctly, since they referring to <code>"Leader"</code> as the raft role, where the raft role in the topology is <code>LEADER</code>. This causes that on some experiments pods are not really restarted.</p><p>Almost everywhere we use constructs like:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"type"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"name"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Terminate leader of partition 3"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"provider"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"type"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"path"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"shutdown-gracefully-partition.sh"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"arguments"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Leader"</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">"3"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the utils script we use a <code>jq</code> expression to get the node which is in a certain state for a certain partition.</p><p>The <code>jq</code> expression looks like this:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$topology</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq "</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">.brokers</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa">select</span><span class="token variable punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">.partitions</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> select</span><span class="token variable punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">.partitionId </span><span class="token variable operator" style="color:#393A34">==</span><span class="token variable" style="color:#36acaa"> $partition</span><span class="token variable punctuation" style="color:#393A34">)</span><span class="token variable" style="color:#36acaa"> and .role </span><span class="token variable operator" style="color:#393A34">==</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">"$state</span><span class="token variable punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.nodeId"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>jq</code> is not able to find the raft <code>state</code> which is returned by topology, if we use not capital letters.</p><p>When we run the chaos experiment we see warnings like:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chaostk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell helm/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ chaos run process-continuation/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:27:01 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Validating the experiment</span><span class="token string" style="color:#e3116c">'s syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:01 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:01 INFO] Running experiment: Zeebe process instance continuation</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:01 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:01 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:01 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:01 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:02 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-03-09 13:27:02 INFO] Playing your experiment'</span><span class="token plain">s method now</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:27:02 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Deploy process model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:27:03 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Restart partition leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-03-09 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:27:05 WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This process returned a non-zero </span><span class="token builtin class-name">exit</span><span class="token plain"> code. This may indicate some error and not what you expected. Please have a </span><span class="token function" style="color:#d73a49">look</span><span class="token plain"> at the logs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The experiment still continues (in effect it does nothing, since it was not able to find the right pod to restart).
Converting the state into capital letters fixes this issue easily.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">getIndexOfPodForPartitionInState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># expect caps for raft roles</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">state</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${2</span><span class="token variable operator" style="color:#393A34">^^</span><span class="token variable" style="color:#36acaa">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="redeployment-causes-retrigger-timer">Redeployment causes retrigger timer<a href="#redeployment-causes-retrigger-timer" class="hash-link" aria-label="Direct link to Redeployment causes retrigger timer" title="Direct link to Redeployment causes retrigger timer">​</a></h5><p>During running the chaos experiment and testing the scripts I realized that the timer start event is retriggered everytime I redeployed the exact deployment, which was kind of unexpected.
I created a bug issue for that <a href="https://github.com/camunda-cloud/zeebe/issues/6515" target="_blank" rel="noopener noreferrer">zeebe#6515</a>.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
        <category label="data" term="data"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Automating Deployment Distribution Chaos Experiment]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/02/23/automate-deployments-dist</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/02/23/automate-deployments-dist"/>
        <updated>2021-02-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This time I wanted to automate a chaos experiment via the ChaosToolkit, which I did on the last chaos day. For a recap check out the last chaos day summary.]]></summary>
        <content type="html"><![CDATA[<p>This time I wanted to automate a chaos experiment via the <a href="https://chaostoolkit.org/" target="_blank" rel="noopener noreferrer">ChaosToolkit</a>, which I did on the last chaos day. For a recap check out the <a href="/zeebe-chaos/2021/01/26/deployments">last chaos day summary</a>.</p><p><strong>TL;DR;</strong></p><p>I was able to automate the deployment distribution chaos experiment successfully and deployed it on testbench for a <code>Production - M</code> cluster plan.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>For testing, I have run our normal setup of three nodes, three partitions and replication factor three.
Later I wanted to automate the experiment against the production cluster plans.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We want to verify whether deployments are still distributed after a network partition, for that we will write the following chaos experiment:</p><ol><li>Verify Steady State: All Pods are ready</li><li>Introduce Chaos:<ol><li><em>Action:</em> Disconnect two leaders (Leader of partition one and another leader)</li><li><em>Action:</em> Deploy multiple versions of a workflow</li><li><em>Action:</em> Connect two leaders again</li><li><em>Probe</em>: I can create workflow instance on all partitions with the last workflow version</li></ol></li><li>Verify Steady State: All Pods are ready</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-definition">Experiment Definition<a href="#experiment-definition" class="hash-link" aria-label="Direct link to Experiment Definition" title="Direct link to Experiment Definition">​</a></h3><p>The experiment definition looks like the following:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.1.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe deployment distribution"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"description"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe deployment distribution should be fault-tolerant. Zeebe should be able to handle network outages and fail-overs and distribute the deployments after partitions are available again."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"contributions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"reliability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"availability"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"high"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"steady-state-hypothesis"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"title"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zeebe is alive"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"probes"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"All pods should be ready"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"verify-readiness.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"method"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Create network partition between leaders"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"disconnect-leaders.sh"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Deploy different deployment versions."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"deploy-different-versions.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Follower"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"3"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"action"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Delete network partition"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"connect-leaders.sh"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Create workflow instance of latest version on partition one"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"start-instance-on-partition-with-version.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Create workflow instance of latest version on partition two"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"start-instance-on-partition-with-version.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"probe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Create workflow instance of latest version on partition three"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"tolerance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"provider"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"process"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"start-instance-on-partition-with-version.sh"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"arguments"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"3"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"timeout"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"rollbacks"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-network-partition-between-leaders">Create network partition between leaders<a href="#create-network-partition-between-leaders" class="hash-link" aria-label="Direct link to Create network partition between leaders" title="Direct link to Create network partition between leaders">​</a></h4><p>We reuse a script which we introduce in earlier chaos days. It needed to be improved a bit, since we haven't handled clusters where one node leads multiple partitions.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># determine leader for partition one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getIndexOfPodForPartitionInState </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$partition</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"LEADER"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$index</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">leaderIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$leader</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{{.status.podIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># determine leader for partition three</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getIndexOfPodForPartitionInState </span><span class="token variable string" style="color:#e3116c">"3"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"LEADER"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">leaderTwo</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$index</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">leaderTwoIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$leaderTwo</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{{.status.podIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leaderTwo</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leader</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># determine leader for partition two</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getIndexOfPodForPartitionInState </span><span class="token variable string" style="color:#e3116c">"2"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"LEADER"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">leaderTwo</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$index</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">leaderTwoIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$leaderTwo</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{{.status.podIP}}"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leaderTwo</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leader</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># We could try to kill the pod and hope that he is not able to become leader again,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># but there is a high chance that it is able to do so after restart. It can make our test fragile,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># especially if we want to connect again, which is the reason why we do nothing in that case.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># To print the topology in the journal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$gateway</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leader</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leaderTwoIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leaderTwo</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leaderIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="delete-network-partition">Delete network partition<a href="#delete-network-partition" class="hash-link" aria-label="Direct link to Delete network partition" title="Direct link to Delete network partition">​</a></h4><p>Looks similar to the disconnect script.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-different-deployment-versions">Deploy different deployment versions<a href="#deploy-different-deployment-versions" class="hash-link" aria-label="Direct link to Deploy different deployment versions" title="Direct link to Deploy different deployment versions">​</a></h5><p>This script is interesting. My first approach was to have one workflow model, where I replace an comment via <code>sed</code> before redeploying. Later I realized it is much easier to just have two versions of the same worfklow model in the repository and deploy them in an alternating manner. This reduced the dependecy of an extra tool (<code>sed</code>), which might not be available everywhere or work differently on different linux distributions. </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">scriptPath</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">cd</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$(</span><span class="token variable string variable function" style="color:#d73a49">dirname</span><span class="token variable string variable" style="color:#36acaa"> </span><span class="token variable string variable string" style="color:#e3116c">"</span><span class="token variable string variable string variable" style="color:#36acaa">${</span><span class="token variable string variable string variable environment constant" style="color:#36acaa">BASH_SOURCE</span><span class="token variable string variable string variable punctuation" style="color:#393A34">[</span><span class="token variable string variable string variable" style="color:#36acaa">0</span><span class="token variable string variable string variable punctuation" style="color:#393A34">]</span><span class="token variable string variable string variable" style="color:#36acaa">}</span><span class="token variable string variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">)</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa"> -P </span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">pod</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">bpmnPath</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$scriptPath</span><span class="token string" style="color:#e3116c">/../bpmn/"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put both together in one function to retry both, because it might be that pod has been restarted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># then the model is not longer on the node, which cause endless retries of deployments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">deployModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$bpmnPath</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$pod</span><span class="token string" style="color:#e3116c">:/tmp/"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">..</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># the models differ in one line, the share the same name and process id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># if we deploy them after another it will create two different deployment versions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># the deploy command only compares the last applied deployment - so we can do that in a loop to cause</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># multiple deployments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$pod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> -c </span><span class="token string" style="color:#e3116c">"zbctl deploy /tmp/bpmn/multi-version/multiVersionModel.bpmn --insecure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$pod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> -c </span><span class="token string" style="color:#e3116c">"zbctl deploy /tmp/bpmn/multi-version/multiVersionModel_v2.bpmn --insecure"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess deployModel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When running this script we deploy <code>10</code> new versions of the workflow <code>multiVersion</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-workflow-instance-of-latest-version-on-partition-x">Create workflow instance of latest version on partition X<a href="#create-workflow-instance-of-latest-version-on-partition-x" class="hash-link" aria-label="Direct link to Create workflow instance of latest version on partition X" title="Direct link to Create workflow instance of latest version on partition X">​</a></h4><p>The following script allows us to be sure that we can create a workflow instance on a specific partition with the given version of the <code>multiVersion</code> workflow.
This means we can verify that on all partitions the last deployment version is deployed/distributed.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -xo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Please provide an required partition!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Please provide an required deployment version!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">pod</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">requiredPartition</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">requiredDeploymentVersion</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">processId</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"multiVersion"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency are installed, which is in this case is the deployment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">startInstancesOnPartition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">until</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$partition</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -eq </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$requiredPartition</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">workflowInstanceKey</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl </span><span class="token variable builtin class-name" style="color:#36acaa">exec</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$pod</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -- zbctl create instance </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$processId</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --version </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$requiredDeploymentVersion</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --insecure</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">workflowInstanceKey</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$workflowInstanceKey</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq </span><span class="token variable string" style="color:#e3116c">'.workflowInstanceKey'</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa"> workflowInstanceKey </span><span class="token variable operator" style="color:#393A34">&gt;&gt;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">51</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Started workflow with key </span><span class="token string variable" style="color:#36acaa">$workflowInstanceKey</span><span class="token string" style="color:#e3116c">, corresponding partition </span><span class="token string variable" style="color:#36acaa">$partition</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess startInstancesOnPartition</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="outcome">Outcome<a href="#outcome" class="hash-link" aria-label="Direct link to Outcome" title="Direct link to Outcome">​</a></h3><p>After running this experiment we get the following output, which shows us that the experiment <strong>SUCCEEDED</strong>.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chaostk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell camunda-cloud/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ chaos run production-m/deployment-distribution/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:06 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Validating the experiment</span><span class="token string" style="color:#e3116c">'s syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:06 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:06 INFO] Running experiment: Zeebe deployment distribution</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:06 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:06 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:06 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:06 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:07 INFO] Probe: Should be able to create workflow instances on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:10 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:10 INFO] Playing your experiment'</span><span class="token plain">s method now</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:10 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Create network partition between leaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:26 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Deploy thousand different deployment versions.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:31 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Action: Delete network partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:43 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: Create workflow instance of latest version on partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:43 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: Create workflow instance of latest version on partition two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:51 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: Create workflow instance of latest version on partition three</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:52 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:52 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:52 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Probe: Should be able to create workflow instances on partition </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:55 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Steady state hypothesis is met</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:55 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Let</span><span class="token string" style="color:#e3116c">'s rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[2021-02-23 14:15:55 INFO] No declared rollbacks, let'</span><span class="token plain">s move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-02-23 </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:15:55 INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="testbench">Testbench<a href="#testbench" class="hash-link" aria-label="Direct link to Testbench" title="Direct link to Testbench">​</a></h4><p>I executed the new experiment via zeebe testbench, to verify that this works with the <code>Production - M</code> cluster plan and it was successful 💪</p><p><img loading="lazy" alt="operate" src="/zeebe-chaos/assets/images/operate-success-6cfd18e98918ee25187b83ca4b925442.png" width="1913" height="918" class="img_ev3q"></p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"results"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"production-m/deployment-distribution/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/follower-restart/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/follower-terminate/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/leader-restart/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/leader-terminate/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/msg-correlation/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/multiple-leader-restart/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/snapshot-corruption/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/stress-cpu-on-broker/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">"production-m/worker-restart/experiment.json completed successfully"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="tests" term="tests"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Deployment Distribution]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/01/26/deployments</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/01/26/deployments"/>
        <updated>2021-01-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[On this chaos day we wanted to experiment a bit with deployment's and there distribution.]]></summary>
        <content type="html"><![CDATA[<p>On this chaos day we wanted to experiment a bit with deployment's and there distribution.</p><p>We run a chaos experiment with deploying multiple workflows and disconnecting two leaders. We verified whether deployments are distributed later. The chaos experiment was successful and showed a bit how fault tolerant deployment distribution is. 💪</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployments">Deployments<a href="#deployments" class="hash-link" aria-label="Direct link to Deployments" title="Direct link to Deployments">​</a></h2><p>In order to continue here we need to explain how the workflow deployment and distribution actually works, if you know it then you can skip this section 😉.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-distribution">Deployment Distribution<a href="#deployment-distribution" class="hash-link" aria-label="Direct link to Deployment Distribution" title="Direct link to Deployment Distribution">​</a></h3><p>If you deploy a workflow and you have multiple partitions, Zeebe needs to make sure that all partitions eventually have the same version of the deployment. This is done with via the deployment distribution.</p><p><img loading="lazy" alt="distribution" src="/zeebe-chaos/assets/images/distribution-472ccace62249d74b06e5d0514215dc7.png" width="1911" height="982" class="img_ev3q"></p><p>On deploying a workflow via a client, like the java client, we send a deployment command to the gateway. The gateway sends the received deployment to the "deployment partition", which is partition one. The partition one is in charge of distributing the deployment. When the client receives a response for the deployment command, this means that the deployment is written/created on partition one. It doesn't mean that it is distributed to all other partitions. The distribution is done asynchronously. </p><p>This can cause issues, if you want to create workflow instances immediately after the deployment. If you try to create a workflow instance on a partition which hasn't received the deployment yet, then this creation will fail. The gateway sends commands, like workflow instance creation, in a round-robin fashion and if you have multiple partitions, then the chance that you hit another partition is quite high.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="reasoning">Reasoning<a href="#reasoning" class="hash-link" aria-label="Direct link to Reasoning" title="Direct link to Reasoning">​</a></h4><p>You may ask why we build it like that. Let me explain this a bit more.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="why-isnt-the-gateway-in-charge-of-distributing-the-deployment">Why isn't the gateway in charge of distributing the deployment?<a href="#why-isnt-the-gateway-in-charge-of-distributing-the-deployment" class="hash-link" aria-label="Direct link to Why isn't the gateway in charge of distributing the deployment?" title="Direct link to Why isn't the gateway in charge of distributing the deployment?">​</a></h5><p>Because the gateway is stateless. If the gateway restarts it has no state it can replay, so it is not able to retry the deployment distributions. If the gateway failed during deployment distribution some partition might lose the deployment update. In the broker we replay the state, which means we can detect whether we distributed the deployment already to a certain partition if not we can retry it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="why-the-response-isnt-send-after-the-distribution-is-done-why-it-is-build-in-an-asynchronous-way">Why the response isn't send after the distribution is done. Why it is build in an asynchronous way?<a href="#why-the-response-isnt-send-after-the-distribution-is-done-why-it-is-build-in-an-asynchronous-way" class="hash-link" aria-label="Direct link to Why the response isn't send after the distribution is done. Why it is build in an asynchronous way?" title="Direct link to Why the response isn't send after the distribution is done. Why it is build in an asynchronous way?">​</a></h5><p>The simple answer would be, because it can take a long time until the deployment is distributed to all partitions. In a distributed system it is likely that a service fail, which means if one partition is not available the distribution is not complete. With the current approach you can already start creating instances at least at partition one and you can retry the requests if you get an rejection.</p><p>After the small excursion of how deployment distribution look like and why, we can start with our experiment to verify that it works as expected.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>We have a standard setup of three nodes, three partitions and replication factor three.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We deploy multiple versions (1000+) of a deployment and assume that at some point all deployments are distributed on all partitions and that we are able to create a workflow instance with the latest version on all partitions. The system should remain stable during distributing the deployments. This can be seen as the steady state.</p><p>If we now disconnect a leader of a different partition (different from partition one) with the leader of partition one, then the deployments can't be distributed. If we try to create workflow instances on that partition we should receive rejection's. After we connect them again the deployments should be distributed and we should be able to create workflow instances on that specific partition.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="steady-state">Steady State<a href="#steady-state" class="hash-link" aria-label="Direct link to Steady State" title="Direct link to Steady State">​</a></h4><p>Following Java code was used to verify the steady state. In order to find out on which partition the workflow instances was created I used the <code>Protocol#decodePartitionId</code> method, which is available in the zeebe protocol module. This functionality and the property of the key's was already quite useful in the past on doing chaos experiments.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import io.zeebe.client.ZeebeClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.zeebe.model.bpmn.Bpmn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.zeebe.protocol.Protocol;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ChaosDayMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger LOG = LoggerFactory.getLogger(ChaosDayMain.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final var zeebeClient = ZeebeClient.newClientBuilder().usePlaintext().gatewayAddress("localhost:26500").build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final var topology = zeebeClient.newTopologyRequest().send().join();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info("{}", topology);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lastVersion = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 1_000; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      final var modelInstance = Bpmn.createExecutableProcess("workflow").startEvent().endEvent().done();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      final var workflow = zeebeClient.newDeployCommand()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .addWorkflowModel(modelInstance, "workflow").send().join();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lastVersion = workflow.getWorkflows().get(0).getVersion();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info("Last version deployed: {}", lastVersion);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final var partitions = new ArrayList&lt;&gt;(List.of(1, 2, 3));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (!partitions.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final var workflowInstanceEvent = zeebeClient.newCreateInstanceCommand()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .bpmnProcessId("workflow")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .version(lastVersion).send().join();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final var workflowInstanceKey = workflowInstanceEvent.getWorkflowInstanceKey();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final var partitionId = Protocol.decodePartitionId(workflowInstanceKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        partitions.remove(Integer.valueOf(partitionId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info("Created workflow instance on partition {}, {} partitions left ({}).", partitionId, partitions.size(), partitions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOG.info("Failed to create workflow instance", e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Small Note</strong> the line: <code>Bpmn.createExecutableProcess("workflow").startEvent().endEvent().done()</code> will always create a new version of a workflow, since internally new id's are generated.</p><p>After running the code above we can see following output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">13:45:00.606 [] [main] INFO  ChaosDayMain - TopologyImpl{brokers=[BrokerInfoImpl{nodeId=0, host='zell-chaos-zeebe-0.zell-chaos-zeebe.zell-chaos.svc.cluster.local', port=26501, version=0.27.0-SNAPSHOT, partitions=[PartitionInfoImpl{partitionId=1, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=2, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=3, role=LEADER, health=HEALTHY}]}, BrokerInfoImpl{nodeId=2, host='zell-chaos-zeebe-2.zell-chaos-zeebe.zell-chaos.svc.cluster.local', port=26501, version=0.27.0-SNAPSHOT, partitions=[PartitionInfoImpl{partitionId=1, role=LEADER, health=HEALTHY}, PartitionInfoImpl{partitionId=2, role=LEADER, health=HEALTHY}, PartitionInfoImpl{partitionId=3, role=FOLLOWER, health=HEALTHY}]}, BrokerInfoImpl{nodeId=1, host='zell-chaos-zeebe-1.zell-chaos-zeebe.zell-chaos.svc.cluster.local', port=26501, version=0.27.0-SNAPSHOT, partitions=[PartitionInfoImpl{partitionId=1, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=2, role=FOLLOWER, health=HEALTHY}, PartitionInfoImpl{partitionId=3, role=FOLLOWER, health=HEALTHY}]}], clusterSize=3, partitionsCount=3, replicationFactor=3, gatewayVersion=0.27.0-SNAPSHOT}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.384 [] [main] INFO  ChaosDayMain - Last version deployed: 6914</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.434 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 2 partitions left ([2, 3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.505 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13:46:04.571 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 3, 0 partitions left ([]).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see in the version count I run it already multiple times :). With this we are able to verify our steady state, that the deployments are distributed to all partitions and that we are able to create workflow instances with the specific (last) version on all partitions.</p><p><em>Side note, I needed multiple runs because there was a leader change (of partition one) in between and I had to adjust the code etc. Needs to be investigated whether the deployment distribution caused that.</em></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-injection-method">Chaos Injection (Method)<a href="#chaos-injection-method" class="hash-link" aria-label="Direct link to Chaos Injection (Method)" title="Direct link to Chaos Injection (Method)">​</a></h4><p>The following topology we used to determined who to disconnect:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Cluster size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Partitions count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Replication factor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Gateway version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Brokers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">0.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos.svc.cluster.local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26501</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Leader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Leader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 1 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos.svc.cluster.local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26501</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 2 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">2.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zeebe.zell</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">chaos.svc.cluster.local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">26501</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.27.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Follower</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">Partition 3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Leader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Healthy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Based on the work of the last chaos days we are able to disconnect brokers easily.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState "$partition" "LEADER")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader=$(getBroker "$index")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderIp=$(kubectl get pod "$leader" -n "$namespace" --template="{{.status.podIP}}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition three</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState "3" "FOLLOWER")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderTwo=$(getBroker "$index")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderTwoIp=$(kubectl get pod "$leaderTwo" -n "$namespace" --template="{{.status.podIP}}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># To print the topology in the journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl exec "$gateway" -n "$namespace" -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># we put all into one function because we need to make sure that even after preemption the </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># dependency is installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function disconnect() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> toChangedPod="$1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> targetIp="$2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # update to have access to ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n "$namespace" "$toChangedPod" -- apt update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n "$namespace" "$toChangedPod" -- apt install -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec "$toChangedPod" -n "$namespace" -- ip route add unreachable "$targetIp"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect "$leader" "$leaderTwoIp"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect "$leaderTwo" "$leaderIp" </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We used partition three here, since the leader of partition one and two are the same node. After disconnecting and running the Java code from above, we get the following output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.655 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.713 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.777 [] [main] INFO  ChaosDayMain - Failed to create workflow instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: Command 'CREATE' rejected with code 'NOT_FOUND': Expected to find workflow definition with process ID 'workflow' and version '8916', but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ChaosDayMain.main(ChaosDayMain.java:37) [classes/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: NOT_FOUND: Command 'CREATE' rejected with code 'NOT_FOUND': Expected to find workflow definition with process ID 'workflow' and version '8916', but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 1 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: NOT_FOUND: Command 'CREATE' rejected with code 'NOT_FOUND': Expected to find workflow definition with process ID 'workflow' and version '8916', but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[grpc-api-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:478) ~[grpc-stub-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:617) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:803) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:782) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Thread.java:834) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.846 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.907 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:11:56.971 [] [main] INFO  ChaosDayMain - Failed to create workflow instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: Command 'CREATE' rejected with code 'NOT_FOUND': Expected to find workflow definition with process ID 'workflow' and version '8916', but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ChaosDayMain.main(ChaosDayMain.java:37) [classes/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: NOT_FOUND: Command 'CREATE' rejected with code 'NOT_FOUND': Expected to find workflow definition with process ID 'workflow' and version '8916', but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 1 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: NOT_FOUND: Command 'CREATE' rejected with code 'NOT_FOUND': Expected to find workflow definition with process ID 'workflow' and version '8916', but none found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[grpc-api-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:478) ~[grpc-stub-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:617) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:803) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:782) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Thread.java:834) ~[?:?]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Which is of course expected, since the deployment is not available at the third partition.</p><p>In the stackdriver we see also warnings regarding the deployment distribution:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-26 14:11:49.439 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to push deployment to node 2 for partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-26 14:11:49.439 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to push deployment to node 2 for partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-01-26 14:11:49.439 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Failed to push deployment to node 2 for partition 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After we connected the leaders again (deleting the ip route), we can see in the application log that the exception changed to deadline exceeded and at some point we are able to create a workflow instance on partition three.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">14:16:21.958 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:22.020 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:32.032 [] [main] INFO  ChaosDayMain - Failed to create workflow instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: deadline exceeded after 9.999911981s. [remote_addr=localhost/127.0.0.1:26500]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at ChaosDayMain.main(ChaosDayMain.java:37) [classes/:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 9.999911981s. [remote_addr=localhost/127.0.0.1:26500]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[zeebe-client-java-0.26.0.jar:0.26.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 1 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 9.999911981s. [remote_addr=localhost/127.0.0.1:26500]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[grpc-api-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:478) ~[grpc-stub-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:617) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:803) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:782) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[grpc-core-1.34.0.jar:1.34.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Thread.java:834) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:32.062 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 1, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:32.125 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 2, 1 partitions left ([3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14:16:37.596 [] [main] INFO  ChaosDayMain - Created workflow instance on partition 3, 0 partitions left ([]).</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see the deadline exceeded, because the processor is not able to send the response's in time. The reason for that is probably because we have so many deployments to process, which have been pushed by the partition one.</p><p>The resource consumption around that time look ok. We can see that the memory spikes a bit, but it recovers later. On the CPU graph we can see when we connected the nodes again.</p><p><img loading="lazy" alt="res" src="/zeebe-chaos/assets/images/res-bfc342434d3419d6a6338dba219cbaad.png" width="1833" height="646" class="img_ev3q">)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>The chaos experiment was successful. The deployment was distributed even after a network disconnect and we were able to create workflow instance of the latest version on all partitions at the end.</p><p>With this experiment we were able to show that the deployment distribution is fault tolerant in way that it can handle unavailability of other partitions. This means eventually all partitions will receive there deployment's and we are able to create workflow instances on these partitions. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="further-work">Further work<a href="#further-work" class="hash-link" aria-label="Direct link to Further work" title="Direct link to Further work">​</a></h4><p>Further possible experiments would be to restart the leader of partition one to see that even after restart we re-distribute the deployments. It is probably also interesting to see how the distribution behaves on more partitions than three.</p><p>During the experiment we have observed some leader changes. It needs to be investigated further, whether this was related to the deployments or something different. It is probably also interesting to see how it behaves with larger deployments, also resource consumption wise.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
        <category label="data" term="data"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Network partitions]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/01/19/network-partition</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/01/19/network-partition"/>
        <updated>2021-01-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[As you can see, I migrated the old chaos day summaries to github pages, for better readability.]]></summary>
        <content type="html"><![CDATA[<p>As you can see, I migrated the old chaos day summaries to github pages, for better readability.
I always wanted to play around with github pages and jekyll so this was a good opportunity. I hope you like it. 😄</p><p>On the last Chaos Day, we experimented with disconnecting a Leader and <em>one</em> follower. We expected no bigger disturbance, since we still have quorum and can process records. Today I want to experiment with bigger network partitions.</p><ul><li>In the first chaos experiment: I had a cluster of 5 nodes and split that into two groups, the processing continued as expected, since we had still quorum. 💪</li><li>In the second chaos experiment: I split the cluster again into two groups, but this time we added one follower of the bigger group to the smaller group after snapshot was taken and compaction was done. The smaller group needed to keep up with the newer state, before new processing can be started again, but everything worked fine.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="first-chaos-experiment">First Chaos Experiment<a href="#first-chaos-experiment" class="hash-link" aria-label="Direct link to First Chaos Experiment" title="Direct link to First Chaos Experiment">​</a></h2><p>Say we have cluster of 5 nodes, one partition with replication factor 3 and we split the cluster in two parts (2 nodes and 3 nodes).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>We expect if we partition two followers away that one part of the cluster can still continue, since it has quorum. Quorum is defined as <code>quorum=floor(nodes/2) + 1</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p><img loading="lazy" alt="general" src="/zeebe-chaos/assets/images/general-77265212a425429df275210ec40dc0d3.png" width="1867" height="967" class="img_ev3q"></p><p>When partitioning two followers, this means we would have two groups. First group would be Broker-0 and Broker-1, the second group contains then Broker-2, Broker-3 and Broker-4. I adjusted the disconnect script from the last chaos day a bit. It looks now like this:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># this scripts expects a setup of 5 nodes with replication factor 5 or higher</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"0"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$broker0</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ { .status.podIP } }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"1"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$broker1</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ { .status.podIP } }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"2"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$broker2</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ { .status.podIP } }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker3</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"3"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker3Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$broker3</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ { .status.podIP } }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker4</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"4"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker4Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$broker4</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ { .status.podIP } }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># To print the topology in the journal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$gateway</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Broker 0 and 1 is one group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker3Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker4Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker3Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker4Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Broker 2, 3 and 4 is the other group</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker3</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker3</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker4</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker4</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="general-network-partition" src="/zeebe-chaos/assets/images/general-network-partition-0-667e6f6ccbd7b800d06b9fc27fc540a6.png" width="1850" height="981" class="img_ev3q"></p><p>It works quite well, we can see that another broker took over the leadership and continues with processing. We reach almost the same throughput, interesting is that the activate job requests seem to scale up, which is totally unexpected! We drop now 82% of our requests because we are overloaded with activate job requests.</p><p><img loading="lazy" alt="growing-request-network-partition" src="/zeebe-chaos/assets/images/growing-requests-network-partition-0-a3d400e4e8bec72c48189151d7bbff0d.png" width="1828" height="646" class="img_ev3q"></p><p>In the atomix section we can see that the both nodes, which are partitioned away, miss a lot of heatbeats and we can see the leader change, which has happened earlier.
<img loading="lazy" alt="atomix-network-partition" src="/zeebe-chaos/assets/images/atomix-network-partition-0-d4d3535d5499fe7ae391d2626f501d31.png" width="1832" height="608" class="img_ev3q"></p><p>Quite early after the network partition a node preemption happened.</p><p><img loading="lazy" alt="node-died" src="/zeebe-chaos/assets/images/node-died-0-a0f1aa1003ea8ee0c626c80a217975ec.png" width="1843" height="913" class="img_ev3q"></p><p>We see that the processing completely stops, two reasons here: one is that the gateway was restarted and another is that the leader was restarted and we lost quourum, since we already have the network partition in place. After the restart the Broker-4 actually should know again the other nodes, which is why the heartbeat misses stopped.</p><p><img loading="lazy" alt="atomix-after-restart" src="/zeebe-chaos/assets/images/atomix-after-restart-ee22493581d1ecdb434285c5765e44eb.png" width="1839" height="877" class="img_ev3q"></p><p>After the Broker comes back the processing started again.</p><p><img loading="lazy" alt="new-start-broker-4" src="/zeebe-chaos/assets/images/new-start-broker-4-c366161635e83933b3e5bd108ebc23fe.png" width="1840" height="1003" class="img_ev3q"></p><p>As mentioned earlier the grpc requests increased significantly, we now drop 100% of the requests. We have ~3k incoming activate job requests.</p><p><img loading="lazy" alt="grpc-after-restart" src="/zeebe-chaos/assets/images/grpc-after-restart-8a184cf51d1500f578f3ef9c091bcc53.png" width="1840" height="648" class="img_ev3q"></p><p>Some time later we can see that the grpc requests has stabilized again.</p><p><img loading="lazy" alt="grpc-stabilized" src="/zeebe-chaos/assets/images/grpc-stabilized-bc0d89ce10d5ac3f12cad3098bc06156.png" width="1826" height="651" class="img_ev3q"></p><p>This should be investigated further, but we will stop here with this experiment since it worked as expected that we kept processing even if we partition two brokers away.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="second-chaos-experiment">Second Chaos Experiment<a href="#second-chaos-experiment" class="hash-link" aria-label="Direct link to Second Chaos Experiment" title="Direct link to Second Chaos Experiment">​</a></h2><p>After the first experiment succeeded, I wanted to experiment how the cluster behaves if we add one follower back to group one and remove it from the second group. As you might remember we have in the first group (Broker-0, Broker-1) and in the second group (Broker-2, Broker-3, Broker-4).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected-1">Expected<a href="#expected-1" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>When the network partition is created and we continue with processing at some point a snapshot is taken and the log is compacted. The first group will not receive any events, which means it has the old state. If we now add Broker-2 to the first group we would expect that the first group now can take over, since it has quorum, and the second will stop working. Before it can start with further processing the Broker-0 and Broker-1 need to get the latest state of Broker-2. We expect that Broker-2 becomes leader in the first group, since it has the longer (latest) log.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual-1">Actual<a href="#actual-1" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>Again same set up, 5 nodes, one partition and replication factor 3. I'm using the same script as above. I will wait until a snapshot is taken, we could also trigger it now via an end point.</p><p>We can see no difference in processing throughput after setting up the network partition again.</p><p><img loading="lazy" alt="new-partition" src="/zeebe-chaos/assets/images/new-partition-70b12561484d135dc4fe7f01543cd558.png" width="1837" height="940" class="img_ev3q"></p><p>Furthermore, the grpc requests seem to be stable, so it must be something related to the gateway or leader restart.</p><p><img loading="lazy" alt="new-grpc" src="/zeebe-chaos/assets/images/new-grpc-ca15020aa84f56bf831a442262a2f91f.png" width="1833" height="648" class="img_ev3q"></p><p>When we take a look at the atomix metrics we see that both brokers are missing heartbeats, which is expected. </p><p><img loading="lazy" alt="new-heartbeats" src="/zeebe-chaos/assets/images/new-heartbeats-7313901d7e8d103c49ac15df8246d1e8.png" width="1837" height="620" class="img_ev3q"></p><p>Node preemption wanted to annoy me again... Broker 2 was restarted, because of node preemption. Since we had no quorum, a new election was started. Broker-2 came back voted for Broker-3, but missed soon also heartbeats, so it started an election again and became leader, because it was able to talk with all nodes again. This was not what we wanted to test, but it is nice to know that it works 😆</p><p><img loading="lazy" alt="second-restart" src="/zeebe-chaos/assets/images/second-restart-5a3f48be2651f0086c23d6bf7a52b868.png" width="1839" height="974" class="img_ev3q"></p><p>So again, I re-deployed the cluster and created a snapshot by hand (via API).</p><p>For that I port-forwarded our admin port (9600)</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ k port-forward zell-chaos-zeebe-1 </span><span class="token number" style="color:#36acaa">9600</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On the leader we send the POST request to take a snapshot.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos/ cluster: zeebe-cluster ns:zell-chaos]$ curl -X POST http://localhost:9600/actuator/partitions/takeSnapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{"1":{"role":"LEADER","snapshotId":"591299-1-1611061561457-718421-717758","processedPosition":723973,"processedPositionInSnapshot":718421,"streamProcessorPhase":"PROCESSING","exporterPhase":"EXPORTING","exportedPosition":722841}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see in the metrics that a snapshot was taken (probably two, because I accidently executed the command twice).</p><p><img loading="lazy" alt="snapshot.png" src="/zeebe-chaos/assets/images/snapshot-f716de884366a3f30bcaa747daea36c5.png" width="1834" height="636" class="img_ev3q"></p><p>For the Broker 2 we check whether it already received the snapshot:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell zell-chaos/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET http://localhost:9600/actuator/partitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"1"</span><span class="token plain">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">"snapshotId"</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">"595599-1-1611061566584-723972-722841"</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">"processedPosition"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"processedPositionInSnapshot"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"streamProcessorPhase"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"exporterPhase"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"exportedPosition"</span><span class="token plain">:null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We also verify that Broker-0 hasn't received any snapshots nor events.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell zell-chaos/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X GET http://localhost:9600/actuator/partitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"1"</span><span class="token plain">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">"snapshotId"</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">"44199-1-1611061147163-76565-53432"</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">"processedPosition"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"processedPositionInSnapshot"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"streamProcessorPhase"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"exporterPhase"</span><span class="token plain">:null,</span><span class="token string" style="color:#e3116c">"exportedPosition"</span><span class="token plain">:null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After that, we start with the disconnection to group two and connect Broker-2 to group one (Broker-0 and Broker-1).</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker3Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker4Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> retryUntilSuccess connect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> retryUntilSuccess connect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see that we now have no leader at all, because I missed to connect the first group with Broker-2 in the reverse and disconnecting group 2 from Broker-2.</p><p><img loading="lazy" alt="network-partition-happening.png" src="/zeebe-chaos/assets/images/network-partition-happening-333f089ad90b18a58d1e6711fc276b23.png" width="1848" height="978" class="img_ev3q"></p><p>After doing so:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker3</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker4</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess connect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess connect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$broker2Ip</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">    </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see in the logs but also in the metrics that snapshots are replicated to Broker-0 and Broker-1.</p><p><img loading="lazy" alt="snapshot-metrics.png" src="/zeebe-chaos/assets/images/snapshot-metrics-e54d615ace93975f93b7224031f07140.png" width="1836" height="639" class="img_ev3q"></p><p>I would expect that we also see something in the atomix snapshot panels, but here it looks like only the duration is published.</p><p><img loading="lazy" alt="atomix-snapshot-metrics.png" src="/zeebe-chaos/assets/images/atomix-snapshot-metrics-1cfd735171f66d16cffec1e816230b35.png" width="1831" height="526" class="img_ev3q"></p><p>After connecting the Broker's we see that Broker-0 and Broker-1 are not missing heartbeats anymore and that a new leader has been chosen, Broker-2 which was the expected leader! </p><p><img loading="lazy" alt="after-connect-all.png" src="/zeebe-chaos/assets/images/after-connect-all-e3ddb2f28034af3671012e2916cee6f0.png" width="1847" height="614" class="img_ev3q"></p><p>The processing started and cluster seem to look healthy again.</p><p><img loading="lazy" alt="healed.png" src="/zeebe-chaos/assets/images/healed-dcae54d03eb0087d45932ad50d05d3c8.png" width="1839" height="957" class="img_ev3q"></p><p>Experiment was successful! 👍</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2><ul><li>Unexpected request count on network partition/node restart</li><li>Snapshot metrics are unclear, which show what and Atomix snapshot metrics are not showing values</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Disconnect Leader and one Follower]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2021/01/07/disconnect-leader-and-follower</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2021/01/07/disconnect-leader-and-follower"/>
        <updated>2021-01-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Happy new year everyone]]></summary>
        <content type="html"><![CDATA[<p>Happy new year everyone 🎉</p><p>This time I wanted to verify the following hypothesis <code>Disconnecting Leader and one Follower should not make cluster disruptive</code> (<a href="https://github.com/zeebe-io/zeebe-chaos/issues/45" target="_blank" rel="noopener noreferrer">#45</a>).
But in order to do that we need to extract the Leader and Follower node for a partition from the Topology. Luckily in December we got an <a href="https://github.com/zeebe-io/zeebe/pull/5943" target="_blank" rel="noopener noreferrer">external contribution</a> which allows us to print <code>zbctl status</code> as json.
This gives us now more possibilities, since we can extract values much better out of it.</p><p><strong>TL;DR</strong> The experiment was successful 👍</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preparation">Preparation<a href="#preparation" class="hash-link" aria-label="Direct link to Preparation" title="Direct link to Preparation">​</a></h2><p>Before we start with the experiment I wanted to extract the right node id's for the follower's and leader from the <code>zbctl status</code> output via <code>jq</code>. If we have that we can use this for other use cases.</p><p>I stored the <code>zbctl</code> json output in a file, to make the lines a bit more readable and that I can focus on the jq stuff. The tested output looks like this:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> test.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"brokers"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"nodeId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"host"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"zeebe-chaos-zeebe-1.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"port"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26501</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"partitions"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LEADER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LEADER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LEADER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"version"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.27.0-SNAPSHOT"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"nodeId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"host"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"zeebe-chaos-zeebe-2.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"port"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26501</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"partitions"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LEADER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"version"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.27.0-SNAPSHOT"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"nodeId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"host"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"port"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">26501</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"partitions"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"partitionId"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"role"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FOLLOWER"</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"health"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"HEALTHY"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"version"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.27.0-SNAPSHOT"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"clusterSize"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"partitionsCount"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"replicationFactor"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"gatewayVersion"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.27.0-SNAPSHOT"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I had a really hard time to find the correct <code>jq</code> expression, but here is it:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> test.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq </span><span class="token string" style="color:#e3116c">".brokers[]|select(.partitions[]| select(.partitionId == 3) and .role == </span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">LEADER</span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">)"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You may ask why there are multiple <a href="https://stedolan.github.io/jq/manual/#select(boolean_expression)" target="_blank" rel="noopener noreferrer">selects</a>. I tried it previous with one and the issue is that it then works like an cartesian-product. It takes broker objects, which take part of the partition 3 and it will take broker objects, which are leader for an partition into the output. This is obviously not that what I want.
The current expression filters brokers for partitions which have the partitionId and are leader for that partition. This <a href="https://gist.github.com/olih/f7437fb6962fb3ee9fe95bda8d2c8fa4#gistcomment-3257810" target="_blank" rel="noopener noreferrer">gist comment</a> helped me here.</p><p>Examples:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> test.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq </span><span class="token string" style="color:#e3116c">".brokers[]|select(.partitions[]| select(.partitionId == 3) and .role == </span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">LEADER</span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">)|.nodeId"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> test.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> jq </span><span class="token string" style="color:#e3116c">".brokers[]|select(.partitions[]| select(.partitionId == 2) and .role == </span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">LEADER</span><span class="token string entity" style="color:#36acaa">\"</span><span class="token string" style="color:#e3116c">)|.nodeId"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Later I realized that this doesn't work for followers, since you can have multiple ones, BUT also this can be solved. <a href="https://stackoverflow.com/questions/38500363/get-the-first-or-nth-element-in-a-jq-json-parsing" target="_blank" rel="noopener noreferrer">Just put it in an array and get the first entry</a>.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jq "</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">.brokers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">.partitions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">.partitionId </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$partition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> and .role </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">"</span><span class="token variable" style="color:#36acaa">$state</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.nodeId</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see <code>jq</code> is quite powerful and I learned a lot about it this day. If you interested you can also check <a href="https://stedolan.github.io/jq/manual/" target="_blank" rel="noopener noreferrer">the manual</a> which has ton's of examples.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a href="#resources" class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources">​</a></h3><ul><li><a href="https://stackoverflow.com/questions/18592173/select-objects-based-on-value-of-variable-in-object-using-jq" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/18592173/select-objects-based-on-value-of-variable-in-object-using-jq</a></li><li><a href="https://unix.stackexchange.com/questions/404699/using-multiple-wildcards-in-jq-to-select-objects-in-a-json-file" target="_blank" rel="noopener noreferrer">https://unix.stackexchange.com/questions/404699/using-multiple-wildcards-in-jq-to-select-objects-in-a-json-file</a></li><li><a href="https://stedolan.github.io/jq/manual/#Builtinoperatorsandfunctions" target="_blank" rel="noopener noreferrer">https://stedolan.github.io/jq/manual/#Builtinoperatorsandfunctions</a></li><li><a href="https://stackoverflow.com/questions/33057420/jq-select-multiple-conditions" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/33057420/jq-select-multiple-conditions</a></li><li><a href="https://github.com/stedolan/jq/issues/319" target="_blank" rel="noopener noreferrer">https://github.com/stedolan/jq/issues/319</a></li><li><a href="https://unix.stackexchange.com/questions/491669/jq-get-attribute-of-nested-object" target="_blank" rel="noopener noreferrer">https://unix.stackexchange.com/questions/491669/jq-get-attribute-of-nested-object</a></li><li><a href="https://stackoverflow.com/questions/27562424/jq-nested-object-extract-top-level-id-and-lift-a-value-from-internal-object" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/27562424/jq-nested-object-extract-top-level-id-and-lift-a-value-from-internal-object</a></li><li><em>false track</em> <a href="https://stackoverflow.com/questions/28615174/jq-filter-on-sub-object-value" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/28615174/jq-filter-on-sub-object-value</a></li><li>final key: <a href="https://gist.github.com/olih/f7437fb6962fb3ee9fe95bda8d2c8fa4#gistcomment-3257810" target="_blank" rel="noopener noreferrer">https://gist.github.com/olih/f7437fb6962fb3ee9fe95bda8d2c8fa4#gistcomment-3257810</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="script">Script<a href="#script" class="hash-link" aria-label="Direct link to Script" title="Direct link to Script">​</a></h3><p>I was able to replace the old utility:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">getIndexOfPodForPartitionInState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">state</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">pod</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># To print the topology in the journal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">until</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">topology</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">kubectl </span><span class="token string variable builtin class-name" style="color:#36acaa">exec</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable string variable" style="color:#36acaa">$pod</span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa"> -n </span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable string variable" style="color:#36acaa">$namespace</span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa"> -- zbctl status --insecure</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># For cluster size 3 and replication factor 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># we know the following partition matrix</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># partition \ node  0    1     2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#     1             L    F     F</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#     2             F    L     F</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#     3             F    F     L</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#    etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># This means broker 1, 2 or 3 participates on partition 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># BE AWARE the topology above is just an example and the leader can every node participating node.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa">$</span><span class="token variable punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">echo "$topology" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">    </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> grep "Partition $partition" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">    </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> grep </span><span class="token variable operator" style="color:#393A34">-</span><span class="token variable" style="color:#36acaa">n "$state" </span><span class="token variable operator" style="color:#393A34">-</span><span class="token variable" style="color:#36acaa">m </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">    </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> sed 's</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa">\</span><span class="token variable punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">[</span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable operator" style="color:#393A34">-</span><span class="token variable number" style="color:#36acaa">9</span><span class="token variable" style="color:#36acaa">]</span><span class="token variable operator" style="color:#393A34">*</span><span class="token variable" style="color:#36acaa">\</span><span class="token variable punctuation" style="color:#393A34">)</span><span class="token variable" style="color:#36acaa">.</span><span class="token variable operator" style="color:#393A34">*</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa">\</span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable operator" style="color:#393A34">/</span><span class="token variable" style="color:#36acaa">'</span><span class="token variable punctuation" style="color:#393A34">)</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">-</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$index</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">getIndexOfPodForPartitionInState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">state</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">pod</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># To print the topology in the journal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">until</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">topology</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">kubectl </span><span class="token string variable builtin class-name" style="color:#36acaa">exec</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable string variable" style="color:#36acaa">$pod</span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa"> -n </span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable string variable" style="color:#36acaa">$namespace</span><span class="token string variable string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa"> -- zbctl status --insecure -o json</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$topology</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq "</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">.brokers</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa">select</span><span class="token variable punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">.partitions</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> select</span><span class="token variable punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">.partitionId </span><span class="token variable operator" style="color:#393A34">==</span><span class="token variable" style="color:#36acaa"> $partition</span><span class="token variable punctuation" style="color:#393A34">)</span><span class="token variable" style="color:#36acaa"> and .role </span><span class="token variable operator" style="color:#393A34">==</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">"$state</span><span class="token variable punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.nodeId</span><span class="token string" style="color:#e3116c">")</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  echo "</span><span class="token variable" style="color:#36acaa">$index</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The previous function worked only with homogeneous clusters, which means where the partitions are equally distributed. This caused issues on experiments on Production L clusters, where partitions are heterogeneous distributed, see related issue <a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/154" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-cluster-testbench#154</a>. With this new utility we can create some new experiments also for Production - L clusters.</p><p>I wrote a new script based on the <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/disconnect-standalone-gateway.sh" target="_blank" rel="noopener noreferrer">older disconnect/connect gateway scripts</a>, where we disconnect the gateway with the brokers. The new one disconnects an leader for an partition with the follower and vice-versa.</p><p>Disconnect Leader-Follower:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getGateway</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># determine leader for partition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getIndexOfPodForPartitionInState </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$partition</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"LEADER"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$index</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">leaderIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$leader</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ {.status.podIP} }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getIndexOfPodForPartitionInState </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$partition</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">"FOLLOWER"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">follower</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$index</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">followerIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$follower</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">"</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">"{ {.status.podIP} }"</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># To print the topology in the journal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$gateway</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leader</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$followerIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$follower</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">$leaderIp</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>We want to disconnect a leader and a follower from a specific partition.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hypothesis">Hypothesis<a href="#hypothesis" class="hash-link" aria-label="Direct link to Hypothesis" title="Direct link to Hypothesis">​</a></h3><p>We expect that even if the leader and the follower can't talk with each other the follower is not able to disrupt the cluster and no new election is started, such that he becomes the leader.
On reconnect we expect that the follower keeps up again and is eventually on the same page with the other follower and leader.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>We deployed a cluster with one partition for simplicity. We run the above posted script to disconnect one leader with a follower and the same follower with the leader.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="disconnect">Disconnect<a href="#disconnect" class="hash-link" aria-label="Direct link to Disconnect" title="Direct link to Disconnect">​</a></h4><p>After running the disconnect script we see in general no disruption. The processing is still continuing.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/general-938c446793091f9fb5b8aa5c13435b01.png" width="2470" height="652" class="img_ev3q"></p><p>We can see that the followers misses a lot of heartbeats, which is expected.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/heartbeats-e178f780060b967d8c5748a7de390971.png" width="2473" height="571" class="img_ev3q"></p><p>This is also visible in the logs:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:22:28.320 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">role</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">FOLLOWER</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - No heartbeat from null </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the last PT2.98S </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">calculated from last </span><span class="token number" style="color:#36acaa">2980</span><span class="token plain"> ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">, sending poll requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:22:28.321 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">role</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">FOLLOWER</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - Poll request to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: io.netty.channel.AbstractChannel</span><span class="token variable" style="color:#36acaa">$AnnotatedConnectException</span><span class="token builtin class-name">:</span><span class="token plain"> connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed: No route to host: zeebe-chaos-zeebe-1.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.0.7:26502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:22:28.625 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">checksums</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2755920</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.netty.channel.AbstractChannel</span><span class="token variable" style="color:#36acaa">$AnnotatedConnectException</span><span class="token builtin class-name">:</span><span class="token plain"> connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed: No route to host: zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.7.13:26502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:22:28.977 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">checksums</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2756276</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.netty.channel.AbstractChannel</span><span class="token variable" style="color:#36acaa">$AnnotatedConnectException</span><span class="token builtin class-name">:</span><span class="token plain"> connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed: No route to host: zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.7.13:26502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:22:29.382 CET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zeebe-chaos-zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - AppendRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">prevLogTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">entries</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">checksums</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">commitIndex</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2756571</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> failed: java.util.concurrent.CompletionException: io.netty.channel.AbstractChannel</span><span class="token variable" style="color:#36acaa">$AnnotatedConnectException</span><span class="token builtin class-name">:</span><span class="token plain"> connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed: No route to host: zeebe-chaos-zeebe-0.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local/10.0.7.13:26502</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The follower is failing  to send poll requests to Broker-1, which is the leader. I assume we don't see that the follower sends the other follower poll requests because our log level is to high.
Furthermore we can see that the leader is not able to send append requests. We have a panel where we can see how many entries the follower lags behind.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/slow-follower-91a64717a739d49ce14bd269b4bf9142.png" width="2464" height="196" class="img_ev3q"></p><p>Interesting that the java heap of the follower is growing.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/resources-follower-3f36ecf328d6f31df4a86fcb17dff4de.png" width="2466" height="658" class="img_ev3q"></p><p>But after some time GC steps in and it goes back to normal.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/later-gc-7c3d259d82ab97139cdcc22496ef3320.png" width="2471" height="349" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="connect">Connect<a href="#connect" class="hash-link" aria-label="Direct link to Connect" title="Direct link to Connect">​</a></h4><p>After running the connect script we can see in the log that almost immediately a snapshot is send to the follower.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.042908Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000333.log of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.045690Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000334.sst of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.052229Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000335.log of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.068270Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk 000336.sst of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.076135Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk CURRENT of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.081880Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk MANIFEST-000003 of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-01-07T19:26:24.089900Z zeebe-chaos-zeebe-0 Consume snapshot snapshotChunk OPTIONS-000090 of snapshot </span><span class="token number" style="color:#36acaa">2643199</span><span class="token plain">-1-1610047230637-3215713-3214967  zeebe-chaos-zeebe-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is also visible in the metrics</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/raft-snap-3f95d18c325b9228ff52a4ae00ebc895.png" width="2467" height="526" class="img_ev3q"></p><p>We see a healed raft.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/healed-raft-523127360be6b5750d2d52428ed00e08.png" width="2476" height="879" class="img_ev3q"></p><p>What I was wondering is why the metric which shows the lag of the follower is not really recovering.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/metrics-is-not-correct-574cdd8d0d22b8d62145b132cdf10d1d.png" width="2482" height="189" class="img_ev3q"></p><p>Even after almost 12 hours it is still showing ~4K</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/failing-metric-c363880bb7fb57b7dc9a40b01e86545d.png" width="1192" height="192" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h2><p>As we can see the experiment was successful, we were able to verify our hypothesis. The new extraction of the leader and follower from the topology gives us new possibilities for new chaos experiments.
I think we can also experiment a bit more with disconnecting different nodes, to see how the cluster behaves.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2><ul><li>Metric: Follower lag doesn't recover</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Message Correlation after Failover]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/11/24/message-correlation-after-failover</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/11/24/message-correlation-after-failover"/>
        <updated>2020-11-24T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today I wanted to finally implement an experiment which I postponed for long time, see #24.]]></summary>
        <content type="html"><![CDATA[<p>Today I wanted to finally implement an experiment which I postponed for long time, see <a href="https://github.com/zeebe-io/zeebe-chaos/issues/24" target="_blank" rel="noopener noreferrer">#24</a>.
The problem was that previous we were not able to determine on which partition the message was published, so we were not able to assert that it was published on the correct partition. With this <a href="https://github.com/zeebe-io/zeebe/issues/4794" target="_blank" rel="noopener noreferrer">#4794</a> it is now possible, which was btw an community contribution. 🎉</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>We want to publish a message to a specific partition. After publishing the message we want to restart the corresponding leader of that partition, deploy and create a workflow instance to which the message should correlate to. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hypothesis">Hypothesis<a href="#hypothesis" class="hash-link" aria-label="Direct link to Hypothesis" title="Direct link to Hypothesis">​</a></h3><p>We expect that even due to a leader change messages can be correlated to a workflow instance, after a new leader comes up for that partition.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a href="#implementation" class="hash-link" aria-label="Direct link to Implementation" title="Direct link to Implementation">​</a></h4><p> The experiment should ideally work on all cluster plans, since we run the chaos experiments now with all existing cluster plans. For that we want to publish the message on partition one. In Zeebe the messages are distributed over the partitions via the correlation key. Our current cluster plans have 1, 4 or 8 partitions. In order to always reach the same partition we need a correlation key which is modulo the partition count always the same number. Ideally it is just one character, which makes the calculation easier. If we take a look at the ASCII table we see that for example <code>48 mod 1, 4 or 8</code> is always <code>0</code>. This would correspond then to partition one, since in the partition calculation we add 1. If we use "0" as correlation key we can be sure this will end up in the production clusters on partition one. For more information about the calculate you can check the <a href="https://github.com/zeebe-io/zeebe/blob/develop/protocol-impl/src/main/java/io/zeebe/protocol/impl/SubscriptionUtil.java" target="_blank" rel="noopener noreferrer">SubscriptionUtil</a> class.</p><p>The process is quite simple, we just have one intermediate message catch event and we will create an new instance and await the result. With that we make sure that the message was correlated correctly.</p><p><img loading="lazy" alt="oneReceiveMsgEvent" src="/zeebe-chaos/assets/images/oneReceiveMsgEvent-2795ef3f34dd852761d225085a683cf3.png" width="723" height="144" class="img_ev3q"></p><p>On testing the separate scripts I had at the begining problems with the <code>awaitResult</code>. I got always timeouts.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error: rpc error: code = DeadlineExceeded desc = Time out between gateway and broker: Request type command-api-4 timed out in 8999 milliseconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">command terminated with exit code 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ echo 'Failed to execute: '\''awaitInstance'\''. Retry.'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="operate" src="/zeebe-chaos/assets/images/operate-bd2d8997ed8f19c2f1e3c0364ffc01f8.png" width="2151" height="866" class="img_ev3q"></p><p>Via operate nor via zbctl it is easy to find out what is the real issue. I'm not able to see any details regarding the intermediate message catch event in operate. With help of <a href="https://github.com/Zelldon/zdb" target="_blank" rel="noopener noreferrer">zdb</a> I was able to track down the issue. The time to live was to small. The published messages have been already deleted before I created the corresponding workflow instancs. Per default the time to live is <code>5s</code> with <code>zbctl</code>. It is not easy to find out why the message doesn't correlate. After setting the <code>ttl</code> quite high it works and I can run my experiment successfully.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ chaos run production-m/msg-correlation/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Validating the experiment's syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Running experiment: Zeebe message correlation experiment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Playing your experiment's method now...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:28 INFO] Action: Publish message to partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:29 INFO] Action: Terminate leader of partition 1 non-gracefully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:34 INFO] Probe: Should be able to create a workflow and await the message correlation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:39 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:56:39 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:57:16 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:57:16 INFO] Let's rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:57:16 INFO] No declared rollbacks, let's move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-11-24 14:57:16 INFO] Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Experiment added to all cluster plans:</p><ul><li><a href="https://github.com/zeebe-io/zeebe-chaos/commit/adeab53915e12b4a76fd4d49bb359684619b117f" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe-chaos/commit/adeab53915e12b4a76fd4d49bb359684619b117f</a></li><li><a href="https://github.com/zeebe-io/zeebe-chaos/commit/93daf11864fdd851267dae67fdfc31e0ea78b407" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe-chaos/commit/93daf11864fdd851267dae67fdfc31e0ea78b407</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2><ul><li>Operate: Show details of an intermediate catch event <a href="https://jira.camunda.com/browse/OPE-1165" target="_blank" rel="noopener noreferrer">OPE-1165</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Many Job Timeouts]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/11/11/job-timeouts</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/11/11/job-timeouts"/>
        <updated>2020-11-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the last game day (on friday 06.11.2020) I wanted to test whether we can break a partition if many messages time out at the same time. What I did was I send many many messages with a decreasing TTL, which all targeting a specific point in time, such that they will all timeout at the same time. I expected that if this happens that the processor will try to time out all at once and break because the batch is to big. Fortunately this didn't happen, the processor was able to handle this.]]></summary>
        <content type="html"><![CDATA[<p>In the last game day (on friday 06.11.2020) I wanted to test whether we can break a partition if many messages time out at the same time. What I did was I send many many messages with a decreasing TTL, which all targeting a specific point in time, such that they will all timeout at the same time. I expected that if this happens that the processor will try to time out all at once and break because the batch is to big. Fortunately this didn't happen, the processor was able to handle this.</p><p>I wanted to verify the same with job time out's.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p>I setup an Production S cluster in camunda cloud. Deployed an normal starter, which starts 20 workflow instances per second. I used similar code to activate jobs with a decreasing timeout, such that they all timeout at the same time. The target time was 3 PM. I started the test ~11 am.</p><p><strong>Code:</strong></p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">            var now = DateTime.Now;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var today3PM = now.Date.AddHours(15);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int count = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var totalMilli = (today3PM - now).TotalMilliseconds;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    await client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .NewActivateJobsCommand()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .JobType("benchmark-task")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .MaxJobsToActivate(100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .Timeout(TimeSpan.FromMilliseconds(totalMilli))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .WorkerName("lol")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .Send(TimeSpan.FromSeconds(30));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    count++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    totalMilli = (today3PM - DateTime.Now).TotalMilliseconds;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (count % 10 == 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Console.WriteLine("Activated next 1000, count:" + count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Console.WriteLine("Total " + totalMilli + " ms until 3 am");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                catch (Exception ex)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Console.WriteLine("Failed to activate job, because of " + ex.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } while (totalMilli &gt; 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I experienced a lot of pod restarts during the experiment, but at 3 pm the processor seems to handle the situation correctly and has no problems with so many events.</p><p><img loading="lazy" alt="timebomb" src="/zeebe-chaos/assets/images/timeout-bomb-49bcb43661c399c7467ceee9c8f9d4c8.png" width="1820" height="679" class="img_ev3q">
<img loading="lazy" alt="timebomb-general" src="/zeebe-chaos/assets/images/timeout-bomb-general-2882c1cebcf4e21a03bc95ffb53fbe55.png" width="1833" height="652" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="related-issues">Related issues<a href="#related-issues" class="hash-link" aria-label="Direct link to Related issues" title="Direct link to Related issues">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-worker-name">No worker name<a href="#no-worker-name" class="hash-link" aria-label="Direct link to No worker name" title="Direct link to No worker name">​</a></h3><p>First I missed the <code>.WorkerName</code> in the activation command and this broke somehow the activation.
In the client I got either timeouts or resource exhausted responses, but in the gateway I saw that the worker name is missing.</p><p><strong>Gateway output:</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.gateway.cmd.BrokerRejectionException: Command (ACTIVATE) rejected (INVALID_ARGUMENT): Expected to activate job batch with worker to be present, but it was blank</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.gateway.impl.broker.BrokerRequestManager.handleResponse(BrokerRequestManager.java:185) ~[zeebe-gateway-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.gateway.impl.broker.BrokerRequestManager.lambda$sendRequestInternal$2(BrokerRequestManager.java:137) ~[zeebe-gateway-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.future.FutureContinuationRunnable.run(FutureContinuationRunnable.java:28) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorJob.invoke(ActorJob.java:76) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorJob.execute(ActorJob.java:39) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorTask.execute(ActorTask.java:122) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorThread.executeCurrentTask(ActorThread.java:107) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorThread.doWork(ActorThread.java:91) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorThread.run(ActorThread.java:204) [zeebe-util-0.25.0.jar:0.25.0]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Client output:</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Failed to activate job, because of Status(StatusCode="DeadlineExceeded", Detail="Deadline Exceeded", DebugException="Grpc.Core.Internal.CoreErrorDetailException: {"created":"@1605092309.325960242","description":"Error received from peer ipv4:35.205.156.246:443","file":"/var/local/git/grpc/src/core/lib/surface/call.cc","file_line":1062,"grpc_message":"Deadline Exceeded","grpc_status":4}")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After adding the worker name it works, but begins with lot of resource exhausted. I created a new issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5812" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/issues/5812</a> .</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod-restarts">Pod restarts<a href="#pod-restarts" class="hash-link" aria-label="Direct link to Pod restarts" title="Direct link to Pod restarts">​</a></h2><p><img loading="lazy" alt="preempt" src="/zeebe-chaos/assets/images/preemptions-43f8fecfee26ee1a36ce8c5e1c64800b.png" width="1825" height="565" class="img_ev3q"></p><p>Every 10 min it seems to be a node dying, which causes resource exhausted then.</p><p>After looking at the <a href="https://console.cloud.google.com/logs/viewer?interval=PT1H&amp;authuser=1&amp;organizationId=669107107215&amp;project=camunda-cloud-240911&amp;minLogLevel=0&amp;expandAll=false&amp;timestamp=2020-11-11T14:04:53.000000000Z&amp;customFacets=&amp;limitCustomFacetWidth=true&amp;advancedFilter=jsonPayload.kind%3D%22Event%22%0Aresource.labels.cluster_name%3D%22ultrachaos%22%0AjsonPayload.involvedObject.namespace%3D%2299c029a3-b6ae-4e7b-a2aa-6496adebf94c-zeebe%22%0AjsonPayload.involvedObject.name:%22zeebe%22&amp;scrollTimestamp=2020-11-11T13:49:52.000000000Z&amp;dateRangeEnd=2020-11-11T14:06:47.813Z&amp;dateRangeStart=2020-11-11T13:06:47.813Z" target="_blank" rel="noopener noreferrer">gke events</a> I saw now evidence that this is caused by node preemptions. </p><p>I checked the pods directly and saw no heap dumps in the data folder. After describing the pod I can see:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zeebe-cluster-testbench/ ns:99c029a3-b6ae-4e7b-a2aa-6496adebf94c-zeebe]$ k describe pod zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    99c029a3-b6ae-4e7b-a2aa-6496adebf94c-zeebe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Priority:     0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Node:         gke-ultrachaos-compute-fea23edf-tqbm/10.132.0.58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start Time:   Wed, 11 Nov 2020 14:49:52 +0100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       app.kubernetes.io/app=zeebe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              app.kubernetes.io/component=gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              controller-revision-hash=zeebe-66b694fbfc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              statefulset.kubernetes.io/pod-name=zeebe-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Status:       Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP:           10.56.7.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IP:           10.56.7.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controlled By:  StatefulSet/zeebe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zeebe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Container ID:   docker://a55fe90d3184bea064aec29d845680241096b0d971d66b05a35495857c5d7427</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image:          camunda/zeebe:0.25.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Image ID:       docker-pullable://camunda/zeebe@sha256:1286086e786975837dcbf664daa29d41d2666af4daf4abd3192fff1426804dd6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ports:          9600/TCP, 26500/TCP, 26501/TCP, 26502/TCP, 26503/TCP, 26504/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Host Ports:     0/TCP, 0/TCP, 0/TCP, 0/TCP, 0/TCP, 0/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    State:          Waiting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Reason:       CrashLoopBackOff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Last State:     Terminated    &lt;=====</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Reason:       OOMKilled    &lt;====</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Exit Code:    137   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Started:      Wed, 11 Nov 2020 16:06:59 +0100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Finished:     Wed, 11 Nov 2020 16:16:19 +0100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ready:          False</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Furthermore we can see the <code>JAVA_OPTIONS</code>, which are:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">JAVA_TOOL_OPTIONS:                                -XX:MaxRAMPercentage=50.0 -XX:InitialRAMPercentage=25.0 -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I was wondering why we not setting any path for the heap dump. @npepinpe mentioned that this is done in the start up script.</p><p>It is true this is part of the script:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zeebe-cluster-testbench/ ns:99c029a3-b6ae-4e7b-a2aa-6496adebf94c-zeebe]$ k describe configmaps zeebe-configmap </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:         zeebe-configmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:    99c029a3-b6ae-4e7b-a2aa-6496adebf94c-zeebe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:       cloud.camunda.io/channel=Internal_Dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cloud.camunda.io/clusterPlan=Production_S_v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cloud.camunda.io/clusterPlanType=Production_S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cloud.camunda.io/generation=Zeebe_0_25_0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cloud.camunda.io/internalSalesPlan=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cloud.camunda.io/orgName=the_org_with_the_big_cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cloud.camunda.io/salesPlan=Paid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:  &lt;none&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">====</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">startup.sh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># append datestamped heapdump path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export JAVA_TOOL_OPTIONS="${JAVA_TOOL_OPTIONS} -XX:HeapDumpPath=/usr/local/zeebe/data/java_started_$(date +%s).hprof"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec /usr/local/zeebe/bin/broker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Unfortunately this is not visible outside of this context, which is why I thought it is not set.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe# java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Picked up JAVA_TOOL_OPTIONS: -XX:MaxRAMPercentage=50.0 -XX:InitialRAMPercentage=25.0 -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool HeapDumpBeforeFullGC                     = false                                  {manageable} {default}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     bool HeapDumpOnOutOfMemoryError               = true                                   {manageable} {environment}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ccstr HeapDumpPath                             =                                        {manageable} {default}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uintx HeapFirstMaximumCompactionCount          = 3                                         {product} {default}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe# env | grep JAVA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JAVA_HOME=/usr/local/openjdk-11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JAVA_TOOL_OPTIONS=-XX:MaxRAMPercentage=50.0 -XX:InitialRAMPercentage=25.0 -XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JAVA_VERSION=11.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zeebe-0:/usr/local/zeebe# </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I think we should give the production s cluster plans a bit more memory, currently has 2 gig and java can use only 1 gig. It is currently quite easy to overload the brokers and kill them with a small load.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2><ul><li><a href="https://github.com/zeebe-io/zeebe/issues/5812" target="_blank" rel="noopener noreferrer">#5812</a> </li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="availability" term="availability"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Investigate failing Chaos Tests]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/11/03/investigate-failing-tests</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/11/03/investigate-failing-tests"/>
        <updated>2020-11-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today as part of the Chaos Day I wanted to investigate why our current Chaos Tests are failing and why our targeting cluster has been broken by them,]]></summary>
        <content type="html"><![CDATA[<p>Today as part of the Chaos Day I wanted to investigate why our current Chaos Tests are failing and why our targeting cluster has been broken by them,
see the related issue <a href="https://github.com/zeebe-io/zeebe/issues/5688" target="_blank" rel="noopener noreferrer">#5688</a>.</p><p><strong>TL;DR</strong></p><p>We found three new bugs regarding the reprocessing detection and deployment distribution, but still were not able to reproduce the real issue.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigation">Investigation<a href="#investigation" class="hash-link" aria-label="Direct link to Investigation" title="Direct link to Investigation">​</a></h2><p>I started already yesterday with the investigation and found out that two brokers (<code>Broker-0</code> and <code>Broker-2</code>) are failing to restart on partition three, but <code>Broker-0</code> is able to start the processing on partition three. See this <a href="https://github.com/zeebe-io/zeebe/issues/5688#issuecomment-720401612" target="_blank" rel="noopener noreferrer">comment</a> for more information. Note that partition three is receiving deployment from partition one via deployment distribution.</p><p>Together with @saig0 I looked at the code and we found out that reprocessing can be a bit problematic in some situations regarding the <code>WorkflowPersistenceCache</code>, see related <a href="https://github.com/zeebe-io/zeebe/issues/5688#issuecomment-721021464" target="_blank" rel="noopener noreferrer">comment</a>.</p><p>The cache is used in the <code>DeploymentCreateProcessor</code> to verify that the deployment is new and to add it to the state. If this deployment with the same key already exists (in-memory) then the processor rejects the <code>CREATE</code> command.
Now we can have situations which might be problematic. Say we have two of the <code>CREATE</code> commands on normal processing, this can happen when the first partition re-distributes the deployment. When the first one is processed we create a follow up event (<code>CREATED</code>), on the second <code>CREATE</code> we will write a rejection, since it is already in-memory. If a leader change happens, then it is crucial where the snapshot was taken. If the snapshot position is <strong>AFTER</strong> the first <code>CREATE</code> this means that we will handle the second <code>CREATE</code> as the first one, which means we will generate on reprocessing a <code>CREATE</code> but on the log is a rejection written. This is because the in-memory state doesn't reflect the real state. Opened an issue for this <a href="https://github.com/zeebe-io/zeebe/issues/5753" target="_blank" rel="noopener noreferrer">#5753</a>.</p><p>The bug which we found was not the real issue we currently have with the broken cluster, since we have two nodes which have the <strong>same</strong> snapshot, but on one Broker it fails and another it doesn't. To really understand what the issue is we need the related log, so we need to reproduce this issue.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reproducing-chaos">Reproducing Chaos<a href="#reproducing-chaos" class="hash-link" aria-label="Direct link to Reproducing Chaos" title="Direct link to Reproducing Chaos">​</a></h3><p>I created a benchmark with the Zeebe version <code>0.24.4</code>. Check <a href="https://github.com/zeebe-io/zeebe/tree/develop/benchmarks/setup" target="_blank" rel="noopener noreferrer">this</a> for how to setup a benchmark. I realized that creating a benchmark for an earlier version is currently not working because we set the <code>useMMap</code> flag in the <code>zeebe-values.yaml</code> file. After removing that it works without problems.</p><p>To run all experiments in a loop I used in the <code>chaos-experiments/kubernetes</code> folder</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> while [ $? -eq 0 ]; do for ex in */experiment.json; do chaos run $ex; done; done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>During running the experiments I found a bug in our chaos experiments, where it seems that some experiments are not executed correctly, see <a href="https://github.com/zeebe-io/zeebe-chaos/issues/43" target="_blank" rel="noopener noreferrer">#43</a>.</p><p>It took a while, but at some point the experiments start to fail. Interesting is that if you look at the pods all seem to be ready, but in the metrics we can see that one partition is unhealthy (Partition one this time).
Checking the logs I found this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.engine.processor.InconsistentReprocessingException: Reprocessing issue detected! Restore the data from a backup and follow the recommended upgrade procedure. [cause: "The key of the record on the log stream doesn't match to the record from reprocessing.", log-stream-record: {"partitionId":1,"value":{"errorMessage":"","type":"benchmark-task","errorCode":"","variables":{},"worker":"benchmark-worker","deadline":1604403149010,"bpmnProcessId":"benchmark","workflowKey":2251799813685250,"customHeaders":{},"retries":3,"elementId":"task","elementInstanceKey":2251799813688892,"workflowDefinitionVersion":1,"workflowInstanceKey":2251799813688864},"sourceRecordPosition":8054,"timestamp":1604403162815,"position":9274,"valueType":"JOB","intent":"TIME_OUT","recordType":"COMMAND","rejectionReason":"","rejectionType":"NULL_VAL","key":2251799813688902}, reprocessing-record: {key=2251799813688825, sourceRecordPosition=8054, intent=DeploymentIntent:DISTRIBUTED, recordType=EVENT}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.engine.processor.ReProcessingStateMachine.lambda$verifyRecordMatchesToReprocessing$12(ReProcessingStateMachine.java:400) ~[zeebe-workflow-engine-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.Optional.ifPresent(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.engine.processor.ReProcessingStateMachine.verifyRecordMatchesToReprocessing(ReProcessingStateMachine.java:394) ~[zeebe-workflow-engine-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.engine.processor.ReProcessingStateMachine.reprocessEvent(ReProcessingStateMachine.java:258) ~[zeebe-workflow-engine-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.engine.processor.ReProcessingStateMachine.reprocessNextEvent(ReProcessingStateMachine.java:226) ~[zeebe-workflow-engine-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorJob.invoke(ActorJob.java:73) [zeebe-util-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorJob.execute(ActorJob.java:39) [zeebe-util-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorTask.execute(ActorTask.java:118) [zeebe-util-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorThread.executeCurrentTask(ActorThread.java:107) [zeebe-util-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorThread.doWork(ActorThread.java:91) [zeebe-util-0.24.4.jar:0.24.4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.sched.ActorThread.run(ActorThread.java:204) [zeebe-util-0.24.4.jar:0.24.4]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I think this is caused by <a href="https://github.com/zeebe-io/zeebe/issues/3124" target="_blank" rel="noopener noreferrer">#3124</a>, because if the distribution succeeds we want to write a <code>DISTRUBITED</code> event on the log, with the stream writer from the context. This can happen concurrently with our reprocessing.
My assumption was that this is caused by a race condition, which might get fixed when we restart the pod. I restarted the <code>Broker-2</code>, which was leader for partition 3 and <code>Broker-1</code> took over and started the partition successfully.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2020-11-03 14:54:32.916 CET Broker-1-StreamProcessor-1 Processor finished reprocessing at event position 18711</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I started the chaos experiments again. They are running now for a while.</p><p>Together with @npepinpe I discussed the open issues. We found another problematic bug with the in-memory state of the workflow cache. If on reprocessing an error/exception happens, then we retry the processing of this record, endless.
Before we retry we normally rollback the current transaction to discard all changes in the state. This doesn't apply for the in-memory state of the workflow cache, so this can lead to our specific scenario. We checked the log but found no
indication that on reprocessing another exception happen, which caused an retry. In anyway we need to fix the cache to avoid the bugs we have described. We concluded that we need the log of the failing cluster to really understand what was happening. We will try to fix the bugs above soon as possible and in parallel run the experiments endless until they fail again.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h3><p>To investigate the disks I prepared the follwing commands, which I can use to download the state of the brokers to my local machine.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec zell-chaos-0244-zeebe-2 -- tar -cf data.tar.gz data/ # compress the data dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cp zell-chaos-0244-zeebe-2:/usr/local/zeebe/data.tar.gz broker-2/data.tar.gz # download the tarball</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd broker-2/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar -xvf broker-2-data.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2><ul><li>Gateway experiments are not executed <a href="https://github.com/zeebe-io/zeebe-chaos/issues/43" target="_blank" rel="noopener noreferrer">#43</a></li><li>Deployment Reprocessing inconsistencies <a href="https://github.com/zeebe-io/zeebe/issues/5753" target="_blank" rel="noopener noreferrer">#5753</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@saig0</li><li>@npepinpe</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="tests" term="tests"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Non-graceful Shutdown Broker]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/10/20/non-graceful-shutdown</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/10/20/non-graceful-shutdown"/>
        <updated>2020-10-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today I had not much time for the chaos day, because of writing Gameday Summary, Incident review, taking part of incidents etc. So enough chaos for one day :)]]></summary>
        <content type="html"><![CDATA[<p>Today I had not much time for the chaos day, because of writing Gameday Summary, Incident review, taking part of incidents etc. So enough chaos for one day :)</p><p>But I wanted to merge the PR from Peter and test how our brokers behave if they are not gracefully shutdown.
I did that on Wednesday (21-10-2020).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pr-merge">PR Merge<a href="#pr-merge" class="hash-link" aria-label="Direct link to PR Merge" title="Direct link to PR Merge">​</a></h2><p>I tried again the new chaos experiment with a Production M cluster, before merging. It worked quite smooth.
PR is merged <a href="https://github.com/zeebe-io/zeebe-chaos/pull/41" target="_blank" rel="noopener noreferrer">#41</a> 🎉</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="non-graceful-shutdown">Non-graceful shutdown<a href="#non-graceful-shutdown" class="hash-link" aria-label="Direct link to Non-graceful shutdown" title="Direct link to Non-graceful shutdown">​</a></h2><p>Currently in our experiments we do a normal <code>kubectl delete pod</code>, which does an graceful shutdown. The application has time to stop it's services etc. It would be interesting how Zeebe handles non-graceful shutdowns. In order to achieve that we can use the option <code>--grace-period=0</code>. For more information you can read for example <a href="https://kubernetes.io/docs/tasks/run-application/force-delete-stateful-set-pod/#force-deletion" target="_blank" rel="noopener noreferrer">this</a></p><p>I added additional experiments to our normal follower and leader restarts experiments, such that we have both graceful and non-graceful restarts.
Both seem to work without any issues. I was also able to fix some bash script error with the help of <a href="https://github.com/koalaman/shellcheck" target="_blank" rel="noopener noreferrer">shellcheck</a>. Related issue <a href="https://github.com/zeebe-io/zeebe-chaos/issues/42" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe-chaos/issues/42</a>.</p><p>Example output:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(chaostk) [zell kubernetes/ ns:f45d4dee-f73a-4733-9cd4-a4aa8b022376-zeebe]$ chaos run leader-terminate/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Validating the experiment's syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Running experiment: Zeebe Leader restart non-graceful experiment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:23 INFO] Probe: Should be able to create workflow instances on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:27 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:27 INFO] Playing your experiment's method now...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:27 INFO] Action: Terminate leader of partition 3 non-gracefully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:33 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:57:33 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:58:28 INFO] Probe: Should be able to create workflow instances on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:58:32 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:58:32 INFO] Let's rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:58:32 INFO] No declared rollbacks, let's move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-21 15:58:32 INFO] Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Related commits:</p><ul><li><a href="https://github.com/zeebe-io/zeebe-chaos/commit/e6260cb8612a983c8ed74fd2a37a249987ad3d3d" target="_blank" rel="noopener noreferrer">Restart leader non-gracefully</a></li><li><a href="https://github.com/zeebe-io/zeebe-chaos/commit/63c481c0c7dd7026f03be4e51d61a918613b0140" target="_blank" rel="noopener noreferrer">Restart follower non-gracefully</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Gateway memory consumption]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/10/27/standalone-gw-memory</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/10/27/standalone-gw-memory"/>
        <updated>2020-10-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the last weeks I check multiple benchmarks and clusters in incidents. Often I had the feeling that the memory consumption from the gateway is not ideal]]></summary>
        <content type="html"><![CDATA[<p>In the last weeks I check multiple benchmarks and clusters in incidents. Often I had the feeling that the memory consumption from the gateway is not ideal
or that there is a memory leak. I wanted to experiment regarding this memory consumptions. Since we saw in investigating <a href="https://github.com/zeebe-io/zeebe/issues/5641" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/issues/5641</a> a high memory spike
when the gateway was not able to talk to other nodes I suspected that here might be some bugs hiding</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos experiment" title="Direct link to Chaos experiment">​</a></h2><p>We will run the Standalone gateway without the brokers and put load on it. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p>All requests are rejected by the gateway and the memory doesn't grow infinitly on a steady load. The memory consumption should be stable at some point.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p>First I run the standalone gateway without any load. It seems that benchmarks without brokers are not shown in our dashboard namespaces. I fixed that for my experiment in my local grafana session. The issue was that we search for a <code>atomix_role</code> metric to get the related namespaces. This metrics is only published on broker side.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/memory-gw-no-broker-no-load-573bc03afb7f975be6703ed7d306354a.png" width="1833" height="708" class="img_ev3q"></p><p>We can see that even if there is no load the memory is already growing.</p><p>Putting more load on it showed that it doesn't drastically increase the memory consumption, but still it was growing.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/memory-gw-no-broker-high-load-79c5d9ec96d30db64a3e527e368deb57.png" width="1833" height="721" class="img_ev3q"></p><p>I think the issue here is that we currently have no limits set for the gateway, which means it will use as many as it can. There is also no pressure for the GC to run or reclaim memory.
We probably want to limit it at somepoint. I created an issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5699" target="_blank" rel="noopener noreferrer">#5699</a> In order to find out whether we have a memory leak I used a profiler.</p><p>I restarted the experiment with new settings:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># JavaOpts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># DEFAULTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JavaOpts: &gt;-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # other options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Djava.rmi.server.hostname=127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Dcom.sun.management.jmxremote.port=9010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Dcom.sun.management.jmxremote.rmi.port=9010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Dcom.sun.management.jmxremote.authenticate=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Dcom.sun.management.jmxremote.ssl=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Dcom.sun.management.jmxremote.local.only=false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>This will open a remote, unauthenticated, plaintext JMX connection - do not use this configuration in production!
See <a href="https://github.com/zeebe-io/zeebe/blob/develop/benchmarks/docs/debug/README.md#remote_jmx" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/blob/develop/benchmarks/docs/debug/README.md#remote_jmx</a></p></blockquote><p>After I added a port forwarding I was able to open an JMX connection with Java Mission Control.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3><p>I profiled the gateway with and without load but haven't found any memory leak so far.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/result-e55c32125c64c4cb680c4df77b690dbd.png" width="1555" height="921" class="img_ev3q"></p><p>Also with VisualVM and triggering multiple GC's I was not able to spot any thing problematic.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/visualvm-2a1bba44385aa57d3754764946e36e37.png" width="1546" height="803" class="img_ev3q"></p><p>In order to avoid that it uses too much memory and the memory continously grows we should set a limit for the Gateway (<a href="https://github.com/zeebe-io/zeebe/issues/5699" target="_blank" rel="noopener noreferrer">#5699</a>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-observations">Other Observations<a href="#other-observations" class="hash-link" aria-label="Direct link to Other Observations" title="Direct link to Other Observations">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="serialgc-usage">SerialGC usage<a href="#serialgc-usage" class="hash-link" aria-label="Direct link to SerialGC usage" title="Direct link to SerialGC usage">​</a></h4><p>Java Mission Control reported as an error that on a multi-core machine the serial garabage collector was used.
If we check the JVM properties we can see that as well.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/gc-settings-f4dcdc35aa83cff6c3e04b8236d7f227.png" width="1140" height="645" class="img_ev3q"></p><p>This is weird because we don't set any GC in our benchmarks, so I would suspect the G1 is used with Java 11. Unfortunately this depends on the available resources which are "detected" by the JVM.
Related to that <a href="https://stackoverflow.com/questions/52474162/why-is-serialgc-chosen-over-g1gc" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/52474162/why-is-serialgc-chosen-over-g1gc</a>
I think we should investigate that further, because we can see in Java mission control that we have GC pauses up to 8 seconds! I created a new issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5700" target="_blank" rel="noopener noreferrer">#5700</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="unexpected-responses">Unexpected responses<a href="#unexpected-responses" class="hash-link" aria-label="Direct link to Unexpected responses" title="Direct link to Unexpected responses">​</a></h4><p>When we start the <code>starters</code> they will first try to deploy a workflow model and loop in this state until they succeed.
In the metrics we can see that the responses to the deployment commands are <code>NOT_FOUND</code> instead of <code>PARTITION_NOT_AVAILABLE</code>, which I would expect.</p><p><img loading="lazy" src="/zeebe-chaos/assets/images/unexepcted-result-e571536d49a097f1e4feedcd0a10a61e.png" width="1820" height="300" class="img_ev3q"></p><p>We can also see that in the log of the starter:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">11:01:18.035 [main] WARN  io.zeebe.Starter - Failed to deploy workflow, retrying</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io.zeebe.client.api.command.ClientStatusException: Expected to execute command, but this command refers to an element that doesn't exist.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.transformExecutionException(ZeebeClientFutureImpl.java:93) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:50) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.Starter.deployWorkflow(Starter.java:128) [app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.Starter.run(Starter.java:55) [app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.App.createApp(App.java:50) [app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.Starter.main(Starter.java:142) [app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: NOT_FOUND: Expected to execute command, but this command refers to an element that doesn't exist.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.reportGet(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.CompletableFuture.get(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.client.impl.ZeebeClientFutureImpl.join(ZeebeClientFutureImpl.java:48) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 4 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: NOT_FOUND: Expected to execute command, but this command refers to an element that doesn't exist.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.Status.asRuntimeException(Status.java:533) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:460) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.PartialForwardingClientCallListener.onClose(PartialForwardingClientCallListener.java:39) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.ForwardingClientCallListener.onClose(ForwardingClientCallListener.java:23) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at me.dinowernli.grpc.prometheus.MonitoringClientCallListener.onClose(MonitoringClientCallListener.java:50) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:426) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl.access$500(ClientCallImpl.java:66) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl.close(ClientCallImpl.java:689) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl.access$900(ClientCallImpl.java:577) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:751) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:740) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[app.jar:0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[app.jar :0.24.2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Unknown Source) ~[?:?]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This doesn't make any sense. I created a new issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5702" target="_blank" rel="noopener noreferrer">#5702</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-issues">New Issues<a href="#new-issues" class="hash-link" aria-label="Direct link to New Issues" title="Direct link to New Issues">​</a></h2><ul><li>Limit Gateway <a href="https://github.com/zeebe-io/zeebe/issues/5699" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/issues/5699</a></li><li>SerialGC usage <a href="https://github.com/zeebe-io/zeebe/issues/5700" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/issues/5700</a></li><li>Wrong error response on deployment command <a href="https://github.com/zeebe-io/zeebe/issues/5702" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/issues/5702</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Multiple Leader Changes]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/10/13/multiple-leader-changes</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/10/13/multiple-leader-changes"/>
        <updated>2020-10-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Today I wanted to add new chaostoolkit experiment, which we can automate.]]></summary>
        <content type="html"><![CDATA[<p>Today I wanted to add new chaostoolkit experiment, which we can automate.
We already have experiments like restarting followers and leaders for a partition, but in the past what also caused issues was multiple restarts/leader changes
in a short period of time. This is the reason why I created <a href="https://github.com/zeebe-io/zeebe-chaos/issues/39" target="_blank" rel="noopener noreferrer">#39</a>. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment-multiple-leader-elections">Chaos Experiment: Multiple Leader Elections<a href="#chaos-experiment-multiple-leader-elections" class="hash-link" aria-label="Direct link to Chaos Experiment: Multiple Leader Elections" title="Direct link to Chaos Experiment: Multiple Leader Elections">​</a></h2><p>In order to reduce the blast radius I setup an new Zeebe cluster with one partition (clusterplan: production-s). This makes it possible that we exactly restart the leader for that one partition.
Later we can also try it out with multiple partitions. In our automated environment it is anyway executed with multiple partitions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="steady-state">Steady State<a href="#steady-state" class="hash-link" aria-label="Direct link to Steady State" title="Direct link to Steady State">​</a></h3><p>All Brokers are ready and we are able to create new workflow instances on the partition one.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hypothesis">Hypothesis<a href="#hypothesis" class="hash-link" aria-label="Direct link to Hypothesis" title="Direct link to Hypothesis">​</a></h3><p>Even if we cause multiple leader changes due to broker restarts we should still be able to start new workflow instances on the corresponding partition.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="method">Method<a href="#method" class="hash-link" aria-label="Direct link to Method" title="Direct link to Method">​</a></h3><p>We requesting the Topology, determine the leader for partition one restart that corresponding node and wait until it is up again. We repeat that multiple times (three times).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>The corresponding experiment was added via this <a href="https://github.com/zeebe-io/zeebe-chaos/commit/11c3a96fc87991f649fb1559363ba335b2bf42a1" target="_blank" rel="noopener noreferrer">commit</a>.
We were able to prove that our hypothesis is true. we are able to handle multiple leader changes even in a short period of time.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics">Metrics<a href="#metrics" class="hash-link" aria-label="Direct link to Metrics" title="Direct link to Metrics">​</a></h4><p>In the metrics we can see the behavior during the experiment and also we can see that it becomes healthy at the end.</p><p><img loading="lazy" alt="general.png" src="/zeebe-chaos/assets/images/general-c5d51de85e74d262744025b00dcbb6f8.png" width="1835" height="648" class="img_ev3q"></p><p><img loading="lazy" alt="atomix.png" src="/zeebe-chaos/assets/images/atomix-21a9647bff5ea46a48d314b015a95687.png" width="1823" height="615" class="img_ev3q"></p><p>I also run this with a cluster plan M cluster with the same results:</p><p><img loading="lazy" alt="multiple.png" src="/zeebe-chaos/assets/images/multiple-6ca96f4dfef92ecc711e92eb2f739444.png" width="1821" height="842" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="chaostoolkit">Chaostoolkit<a href="#chaostoolkit" class="hash-link" aria-label="Direct link to Chaostoolkit" title="Direct link to Chaostoolkit">​</a></h4><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(chaostk) [zell kubernetes/ ns:4ac065c1-a67e-4f47-8782-38a10d67515d-zeebe]$ chaos run multiple-leader-restart/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Validating the experiment's syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Running experiment: Zeebe Leader restart multiple times experiment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:30 INFO] Probe: Should be able to create workflow instances on partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:32 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:32 INFO] Playing your experiment's method now...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:32 INFO] Action: Terminate leader of partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:42 INFO] Pausing after activity for 5s...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:01:47 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:02:32 INFO] Action: Terminate leader of partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:02:41 INFO] Pausing after activity for 5s...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:02:46 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:03:23 INFO] Action: Terminate leader of partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:03:33 INFO] Pausing after activity for 5s...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:03:38 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:03:38 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:04:12 INFO] Probe: Should be able to create workflow instances on partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:04:16 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:04:16 INFO] Let's rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:04:16 INFO] No declared rollbacks, let's move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2020-10-13 14:04:16 INFO] Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment-high-load">Chaos Experiment: High Load<a href="#chaos-experiment-high-load" class="hash-link" aria-label="Direct link to Chaos Experiment: High Load" title="Direct link to Chaos Experiment: High Load">​</a></h2><p>As mentioned last week @pihme has reported voluntarily that he wants to implement another chaos experiment.
He worked on #7, where we expect that even we put high load on the Zeebe cluster we will cause no leader changes. This was in the past an failure case, where high load disrupted the cluster.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="steady-state-1">Steady State<a href="#steady-state-1" class="hash-link" aria-label="Direct link to Steady State" title="Direct link to Steady State">​</a></h3><p>All Brokers are ready and we can create workflow instances on all partitions. We store the begining topology for later.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hypothesis-1">Hypothesis<a href="#hypothesis-1" class="hash-link" aria-label="Direct link to Hypothesis" title="Direct link to Hypothesis">​</a></h3><p>We expect that even on high load we are not able to disrupt the cluster and that this will not cause any leader changes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="method-1">Method<a href="#method-1" class="hash-link" aria-label="Direct link to Method" title="Direct link to Method">​</a></h3><p>Put high load on the cluster for several minutes, via creating workflow instances</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="result-1">Result<a href="#result-1" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h3><p>@pihme create a new PR to add the experiment <a href="https://github.com/zeebe-io/zeebe-chaos/pull/41" target="_blank" rel="noopener noreferrer">#41</a> </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-1">Metrics<a href="#metrics-1" class="hash-link" aria-label="Direct link to Metrics" title="Direct link to Metrics">​</a></h4><p>We see that we already put some load on the cluster but it is not enough to exhaust the request limits and reach back pressure.</p><p><img loading="lazy" alt="highload" src="/zeebe-chaos/assets/images/highload-d7d6a7b22d9314ca056bb4b669dfe8fd.png" width="1828" height="656" class="img_ev3q"></p><p>We neeed to find a good way how put high load on the Zeebe cluster. We will continue on this.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@pihme</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Play around with ToxiProxy]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/10/06/toxi-proxy</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/10/06/toxi-proxy"/>
        <updated>2020-10-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[First chaos day since my parental leave.]]></summary>
        <content type="html"><![CDATA[<p>First chaos day since my parental leave 🎉.</p><p>Today I wanted to play a bit with <a href="https://github.com/Shopify/toxiproxy" target="_blank" rel="noopener noreferrer">ToxiProxy</a>. Toxiproxy is a framework for simulating network conditions and ideal to do some chaos on the network.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="run-toxiproxy">Run ToxiProxy<a href="#run-toxiproxy" class="hash-link" aria-label="Direct link to Run ToxiProxy" title="Direct link to Run ToxiProxy">​</a></h2><p>Download from the <a href="https://github.com/Shopify/toxiproxy/releases" target="_blank" rel="noopener noreferrer">release page</a> the latest version (server and cli).</p><p>Start a broker via docker.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker pull camunda/zeebe:SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -p 26500:26500 camunda/zeebe:SNAPSHOT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Start the toxi proxy server.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-server-linux-amd64 start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create a proxy for zeebe</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-cli-linux-amd64 create zeebe-proxy -l localhost:26379 -u localhost:26500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created new proxy zeebe-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see something in the toxy proxy server log:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0031] Started proxy                                 name=zeebe-proxy proxy=127.0.0.1:26379 upstream=localhost:26500</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Try zbctl to request the topology.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zbctl --address localhost:26379 status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 0.25.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - 172.17.0.2:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 0.25.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the toxy proxy server log it should be shown as:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0149] Accepted client                               client=127.0.0.1:41510 name=zeebe-proxy proxy=127.0.0.1:26379 upstream=localhost:26500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARN[0149] Source terminated                             bytes=245 err=read tcp 127.0.0.1:56178-&gt;127.0.0.1:26500: use of closed network connection name=zeebe-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add latency to requests</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./toxiproxy-cli-linux-amd64 toxic add -t latency -a latency=5000 zeebe-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Added downstream latency toxic 'latency_downstream' on proxy 'zeebe-proxy'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Running zbctl again:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> ./zbctl --address localhost:26379 status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: rpc error: code = DeadlineExceeded desc = context deadline exceeded</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Updating existing toxy:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-cli-linux-amd64 toxic update -n latency_downstream -t latency -a latency=500 zeebe-proxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Running zbctl again:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">time ./zbctl --address localhost:26379 status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 0.25.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - 172.17.0.2:26501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 0.25.0-SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m1.045s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.012s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys 0m0.021s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Inspect existing toxics:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./toxiproxy-cli-linux-amd64 inspect zeebe-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name: zeebe-proxy   Listen: 127.0.0.1:26379 Upstream: localhost:26500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">======================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Upstream toxics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy has no Upstream toxics enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Downstream toxics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">latency_downstream: type=latency    stream=downstream   toxicity=1.00   attributes=[    jitter=0    latency=500 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With toxicity we can change whether it should be applied on all requests or only on some. It is possible to add the latency instead of downstream to upstream. There also other things we can inject, like slicing and delaying packages, dropping packages and limiting the bandwith.</p><p>Possible new experiments:</p><ul><li>introduce latency between one follower and leader - if only one follower experience delays we expect that no election is started</li><li>introduce latency betweem gw and broker - see whether command timeout</li><li>slice packages - drop packages, but not every packages - expect that command is send correctly since requests are retried</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="slice-packages">Slice packages<a href="#slice-packages" class="hash-link" aria-label="Direct link to Slice packages" title="Direct link to Slice packages">​</a></h3><p>Slices packages after 128 bytes:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./toxiproxy-cli-linux-amd64 toxic add zeebe-proxy -t slicer -a average_size=128</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Publish message seem to work:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ time ./zbctl --address localhost:26379 publish message failing --insecure --correlationKey key --variables "{}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "key": 2251799813685253</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After limiting it to 32 bytes:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./toxiproxy-cli-linux-amd64 toxic update -n slicer_downstream -a average_size=32 zeebe-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Updated toxic 'slicer_downstream' on proxy 'zeebe-proxy'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The publish message seem to not work as expected.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ time ./zbctl --address localhost:26379 publish message failing --insecure --correlationKey key --variables "{}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m0.039s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.007s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys 0m0.023s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Actually I would expect here an error instead of just returning null.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-leader-change-on-high-load">No Leader change on high load<a href="#no-leader-change-on-high-load" class="hash-link" aria-label="Direct link to No Leader change on high load" title="Direct link to No Leader change on high load">​</a></h3><p> Peter volunteered for automating a new chaos experiment, where we put high load on a broker and expect that we have no leader change. This was previous an issue, since the leaders were not able to send heartbeats in time. Related issue #7.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-reset">Time reset<a href="#time-reset" class="hash-link" aria-label="Direct link to Time reset" title="Direct link to Time reset">​</a></h3><p>I wanted to work on the clock reset <a href="https://github.com/zeebe-io/zeebe-chaos/issues/3" target="_blank" rel="noopener noreferrer">#3</a>.
This seems to be not easily possible in kubernetes or at least with our current images, since we need for that root privilges.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-time-reset-zeebe-0:/usr/local/zeebe# date -s $(date +%Y-%m-%dT%H:%M:%S)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date: cannot set date: Operation not permitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tue Oct  6 11:51:19 UTC 2020</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It seems that chaos mesh supports something like that for kubernetes maybe worth to look at
<a href="https://pingcap.com/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node" target="_blank" rel="noopener noreferrer">https://pingcap.com/blog/simulating-clock-skew-in-k8s-without-affecting-other-containers-on-node</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@pihme</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
        <category label="tools" term="tools"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Experiment with Camunda Cloud]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud"/>
        <updated>2020-08-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In order to make our chaos experiments more realistic we have setup a new gke cluster, which is similar to the Camunda Cloud gke cluster.]]></summary>
        <content type="html"><![CDATA[<p>In order to make our chaos experiments more realistic we have setup a new gke cluster, which is similar to the Camunda Cloud gke cluster.
It allows us to test and experiment with Zeebe clusters which have the same configuration as Zeebe clusters in the Camunda cloud.</p><p>As part of the chaos day I run the same benchmark we normally run in our gke with our configuration against the Camunda Cloud Zeebe clusters.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configurations-of-zeebe-clusters">Configurations of Zeebe Clusters<a href="#configurations-of-zeebe-clusters" class="hash-link" aria-label="Direct link to Configurations of Zeebe Clusters" title="Direct link to Configurations of Zeebe Clusters">​</a></h2><p>In the following table I want to highlight the different configurations of the different Zeebe Clusters (cluster types).</p><table><thead><tr><th>Name</th><th>Our Default</th><th>Prod S</th><th>Prod M</th><th>Prod L</th></tr></thead><tbody><tr><td>Partitions</td><td>3</td><td>1</td><td>4</td><td>8</td></tr><tr><td>Nodes</td><td>3</td><td>3</td><td>3</td><td>6</td></tr><tr><td>Replication</td><td>3</td><td>3</td><td>3</td><td>3</td></tr><tr><td>SnapshotPeriod</td><td>15</td><td>5</td><td>5</td><td>5</td></tr><tr><td>CPU_THREADS</td><td>4</td><td>1</td><td>4</td><td>4</td></tr><tr><td>IO_THREADS</td><td>4</td><td>2</td><td>4</td><td>4</td></tr><tr><td>CPU LIMIT</td><td>5</td><td>1</td><td>4</td><td>4</td></tr><tr><td>CPU REQUEST</td><td>5</td><td>200m</td><td>200m</td><td>200m</td></tr><tr><td>RAM LIMIT</td><td>12Gi</td><td>2Gi</td><td>8Gi</td><td>8Gi</td></tr><tr><td>RAM REQUEST</td><td>12Gi</td><td>250Mi</td><td>250Mi</td><td>250Mi</td></tr><tr><td>Gateway</td><td>Standalone</td><td>Embedded</td><td>Embedded</td><td>Embedded</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmarks">Benchmarks<a href="#benchmarks" class="hash-link" aria-label="Direct link to Benchmarks" title="Direct link to Benchmarks">​</a></h2><table><thead><tr><th>Name</th><th>Our Default</th><th>Prod S</th><th>Prod M</th><th>Prod L</th></tr></thead><tbody><tr><td>General</td><td><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/base-73443f959dc96d682767e07346c354b3.png" width="1846" height="922" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-s-general-cb2523b958125e7fa9b10c7c12b77d73.png" width="1850" height="638" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-m-general-5f960be92707983d4c2125897f2e2bfd.png" width="1839" height="679" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-l-general-7fec281ff6544c737c11c77ae6fa092c.png" width="1835" height="903" class="img_ev3q"></td></tr><tr><td>Resources</td><td><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/base-res-6c4945e3aa2f2f1a1b4b45b0196ad365.png" width="1826" height="634" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-s-res-e834f5c4d95bffb7c93f080202bc025a.png" width="1838" height="679" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-m-res-761847f9331f508da2fb49a24b4bcb0f.png" width="1835" height="672" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-l-res-eb60dc64e81a2073b7b541367303b2db.png" width="1838" height="668" class="img_ev3q"></td></tr><tr><td>Disk usage</td><td></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-s-disk-59ab7c9655bb2a694991d15312831415.png" width="1843" height="276" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-m-disk-9d098bd49e1df8c956d53734500382d0.png" width="1830" height="277" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-l-disk-11ab26036642262b3c3d1bd47b3dfa48.png" width="1834" height="283" class="img_ev3q"></td></tr><tr><td>Latency</td><td><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/base-latency-b3584d4828338cc30cd0f98d4e5364b2.png" width="1853" height="911" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-s-latency-e5f8673c8e3f2224087e77ccf7accdf9.png" width="1842" height="862" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-m-latency-0acc9fe1f8065a925d6219e539134d0f.png" width="1834" height="852" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-l-latency-e73d60cffd48e34d391fdaae755d36c1.png" width="1829" height="910" class="img_ev3q"></td></tr><tr><td>Working</td><td><img loading="lazy" alt="base" src="/zeebe-chaos/assets/images/base-73443f959dc96d682767e07346c354b3.png" width="1846" height="922" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-s-working-3ca710d13ef5785cdd18a73c333e4a47.png" width="1838" height="681" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-m-working-9634d13df175c735233358b629115470.png" width="1839" height="683" class="img_ev3q"></td><td><img loading="lazy" alt="prods" src="/zeebe-chaos/assets/images/prod-l-working-8888402c802b3a2200214226c12f9f43.png" width="1849" height="689" class="img_ev3q"></td></tr></tbody></table><p>In general we can see that the clusters haven't survived long. This is also visible in our Camunda Cloud status page.
<img loading="lazy" alt="status" src="/zeebe-chaos/assets/images/status-cbabee80ac866c2fed379253c9dc31d7.png" width="1397" height="523" class="img_ev3q"></p><p>I think it is kind of related with the preemtable nodes, high load, long restarts and that pods are restarted after 15 minutes, when there are not getting ready.
One of the reasons why restarting takes so long is fixed now with <a href="https://github.com/zeebe-io/zeebe/pull/5189" target="_blank" rel="noopener noreferrer">#5189</a> so I hope that this gets better. But currently it is an issue, since you start replicating a snapshot and reprocess on start up. If this takes longer then 15 min the pod will be restarted because of this configuration: <code>Liveness:   http-get http://:9600/ready delay=900s timeout=1s period=15s #success=1 #failure=3</code> after restarting the pod you haven't gained any value you just need to start again the complete procedure. In k8 we can see a high restart count of the pods.</p><p>Interesting is if we take a look at the working part of Prod S then we clearly see how often actually a pod is preemted or leader change happens.</p><p><img loading="lazy" alt="prod-s" src="/zeebe-chaos/assets/images/prod-s-working-3ca710d13ef5785cdd18a73c333e4a47.png" width="1838" height="681" class="img_ev3q"></p><p>It is a known issue that currently the nodes are preemted quite often in Camunda Cloud and they working on a solution to it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="throughput">Throughput<a href="#throughput" class="hash-link" aria-label="Direct link to Throughput" title="Direct link to Throughput">​</a></h3><p>If we take a look at the Working part we can see that we scale based on the partition count (or prod cluster sizes) in Camunda Cloud. For Prod S we reach in avg ~24 workflow instance creation/completions per second. For Prod M we reach in avg ~46 workflow instance creation/completions per second. For Prod L we reach in avg ~99 workflow instance creations and completions. To be fair I run the benchmark on these cluster sizes only with three workers, which have 8 threads an activation count of 120 and they completing an job after 150 ms delay, and an starter which starts 100 workflow instances per second. Normally we use in our benchmarks 12 workers and start 300 workflow instances per second. I tried that with the Prod L cluster, but this failed quite fast after increasing the load. Here we probably need to investigate further. If we take a look at our cluster setup then we reach in avg ~147 workflow instance creations/completions per second.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="latency">Latency<a href="#latency" class="hash-link" aria-label="Direct link to Latency" title="Direct link to Latency">​</a></h3><p>If take a look at the latency we can see that in Prod M cluster the latency seems to be a bit problematic, where in Prod S and L it seems similar. In our default cluster we get the best latency. Might be worth to take a look as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-observations">Other Observations<a href="#other-observations" class="hash-link" aria-label="Direct link to Other Observations" title="Direct link to Other Observations">​</a></h3><p>During the benchmark observations I saw that some metrics are missing.</p><p>For example the Gateway metrics are not shown:</p><p><img loading="lazy" alt="gw" src="/zeebe-chaos/assets/images/missing-gw-metrics-8a3189d807658f5c0a1b4c0fd4fdfd72.png" width="1821" height="671" class="img_ev3q"></p><p>Furthermore I saw that all container related and pvc related metrics are missing. I was not able to check the IO metrics nor the CPU metrics and other.</p><p><img loading="lazy" alt="io" src="/zeebe-chaos/assets/images/missing-io-bcbcfa26798cbc4d03b1ae9cbc0983d0.png" width="1833" height="682" class="img_ev3q"></p><p>If we want to run more tests and chaos experiments we need to fix these missing metrics before. Opened a new issue for it <a href="https://github.com/camunda-cloud/monitoring/issues/242" target="_blank" rel="noopener noreferrer">#242</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-automated-chaos-experiments">Running automated Chaos experiments<a href="#running-automated-chaos-experiments" class="hash-link" aria-label="Direct link to Running automated Chaos experiments" title="Direct link to Running automated Chaos experiments">​</a></h2><p>In order to run automated chaos experiments in our new gke. I had to create a new serviceaccount and rolebindings, such that our Jenkins can access the new Kubernetes cluster and our experiments can delete and create new resources.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Experiment with Low Load]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/08/06/low-load</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/08/06/low-load"/>
        <updated>2020-08-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Run a benchmark with low load]]></summary>
        <content type="html"><![CDATA[<ul><li>Run a benchmark with low load</li><li>Investigate last benchmark failures</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p> We currently seem to have issues with RocksDB, which sometimes generates a lot of SST files during the Broker lifetime. This causes to fail the snapshot replication at some point.
This is especially problematic after pod's get restarted, since a follower normally need either to be catched up with the log or the leader will send a snapshot to the follower.
If the snapshot contains a lot of files this get's problematic. In order to understand this better we would like to find out how we can reproduce it. We expected this happens only on low load,
the assumption is that RocksDB will not trigger the compaction so often, because we are not reaching a certain threshold. See the related issue <a href="https://github.com/zeebe-io/zeebe/issues/4887" target="_blank" rel="noopener noreferrer">#4887</a> .</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p> When creating workflow instances and completing them directly afterwards we normally expect that there is nothing left and nothing should accumulate together. If we do it on low load, which means 1 workflow instance creation and completion per second then we expect the same. Furthermore we expect that the used resources are lower then on higher load.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p> We have setup our default benchmark with three partition, three nodes and replication factor three. We starting one workflow instance at a time. We running one worker, which completes the related workflow.</p><p>In the general overview we can see that we start and complete one workflow per second.
<img loading="lazy" alt="general" src="/zeebe-chaos/assets/images/general-one-workflow-23b6ac315531261b67f51825470c1644.png" width="1838" height="660" class="img_ev3q"></p><p>The resource consumption looks ok.
<img loading="lazy" alt="resource" src="/zeebe-chaos/assets/images/resources-one-workflow-3d9f5643ae307a587750fd1b8ce5dd3b.png" width="1836" height="644" class="img_ev3q"></p><p>But the RocksDB used size and snapshot files seem to be increasing.
<img loading="lazy" alt="rocks1" src="/zeebe-chaos/assets/images/rocks1-f8199bda1be44e00cba4128d19d75f37.png" width="1846" height="853" class="img_ev3q">
<img loading="lazy" alt="rocks2" src="/zeebe-chaos/assets/images/rocks2-c59ae6867a414e62cf53d9f3b230b378.png" width="1838" height="313" class="img_ev3q">
<img loading="lazy" src="https://user-images.githubusercontent.com/2758593/89533130-384fcc80-d7f3-11ea-83b8-69bbe75f5211.png" alt="snapshot" class="img_ev3q"></p><p>I will let the benchmark run a bit longer and I think we need to investigate this issue further.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigation-last-benchmark">Investigation Last Benchmark<a href="#investigation-last-benchmark" class="hash-link" aria-label="Direct link to Investigation Last Benchmark" title="Direct link to Investigation Last Benchmark">​</a></h2><p>Every week I create a benchmark on the chaos day and let it run until the next chaos day. Since I had not much time for trying out other experiments today and I saw that the old benchmark has problems I decided to investigated why the processing went down. I collected here my observations and use this more as a summary, since until now it is not clear what is the issue.</p><p>In the general overview we can see that the processing is in avg under 100 workflow instances per second, normally we would expect something around 130. We can also see that the processing in general is not that stable.
<img loading="lazy" alt="general" src="/zeebe-chaos/assets/images/general-554b0628baa23a11900618380b29ecd5.png" width="1847" height="876" class="img_ev3q"></p><p>If we take a look at the partitions separatly we can see that the partition two died quite early.</p><p><strong>Partition 1 last 7 days</strong>
<img loading="lazy" src="https://user-images.githubusercontent.com/2758593/89543087-cb433380-d800-11ea-9d03-27d60a6cc49d.png" alt="partition-1-general-7-days" class="img_ev3q">
<strong>Partition 2 last 7 days</strong>
<img loading="lazy" src="https://user-images.githubusercontent.com/2758593/89543091-cb433380-d800-11ea-80ab-922c483cd039.png" alt="partition-2-general-7-days" class="img_ev3q">
<strong>Partition 3 last 7 days</strong>
<img loading="lazy" src="https://user-images.githubusercontent.com/2758593/89543093-cbdbca00-d800-11ea-9e86-d14b165e02eb.png" alt="partition-3-general-7-days" class="img_ev3q"></p><p>We can see that the processing seem to be stopped for the partition two and never comes back. This seem to happen on the 31-07-2020 ~ 2 pm.
With the resource panel we can also see that at this time a node preemption happen, since all pod seem to be rescheduled. This can be seen based on the different colors of the graphs.</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/2758593/89543095-cbdbca00-d800-11ea-962e-aee3fa95a826.png" alt="resources" class="img_ev3q"></p><p>In the log we can see that all brokers are getting closed.</p><p>Interesting is that we see the day after, an continously growing disk usage, which never gets reduced.</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/2758593/89543083-c9797000-d800-11ea-82f3-a1b505811171.png" alt="disk-usage" class="img_ev3q"></p><p>Currently I don't understand what was the issue and why it never comes back. I created an issue to further investigate that <a href="https://github.com/zeebe-io/zeebe/issues/5127" target="_blank" rel="noopener noreferrer">#5127</a> . I will keep the old benchmark running and will setup a separe one in order to reproduce this.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Experiment without Exporters]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/07/30/experiment-without-exporters</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/07/30/experiment-without-exporters"/>
        <updated>2020-07-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Run a chaos experiment without exporters]]></summary>
        <content type="html"><![CDATA[<ul><li>Run a chaos experiment without exporters</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p> We wanted to run a chaos experiment, which covers <a href="https://github.com/zeebe-io/zeebe-chaos/issues/20" target="_blank" rel="noopener noreferrer">#20</a>.
Furthermore, it was recently asked in the forum whether it makes a difference performance wise to run a broker without exporters, see <a href="https://forum.zeebe.io/t/zeebe-low-performance/1356/17" target="_blank" rel="noopener noreferrer">here</a> </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p> Running Broker without exporter should work without any problems. We should be able to delete data on every snapshot interval.
Performance wise there should be no difference. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p> We have setup three different benchmarks:</p><ul><li><p>default with elastic and metrics exporter enabled</p></li><li><p>only with metrics exporter</p></li><li><p>without any exporter</p><p>These benchmarks run overnight without bigger issues. This means all of three where able to take snapshots and compact the log. This satisfy our hypothesis of <a href="https://github.com/zeebe-io/zeebe-chaos/issues/20" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe-chaos/issues/20</a> .</p></li></ul><table><thead><tr><th>Default</th><th>Without exporters</th></tr></thead><tbody><tr><td><img loading="lazy" alt="default-pvc" src="/zeebe-chaos/assets/images/default-pvc-469e3d330b70e812076b1a698fca2536.png" width="1839" height="570" class="img_ev3q"></td><td><img loading="lazy" alt="without-exporter-pvc" src="/zeebe-chaos/assets/images/without-exporter-pvc-a0f2ffb742d96daa354f10954cf113ba.png" width="1837" height="570" class="img_ev3q"></td></tr></tbody></table><p>The resource consumption seem to be kind of similar, but we still see that the memory usage increases overtime. This seems to be related to <a href="https://github.com/zeebe-io/zeebe/issues/4812" target="_blank" rel="noopener noreferrer">#4812</a></p><table><thead><tr><th>Default</th><th>Metric Exporter</th><th>Without exporters</th></tr></thead><tbody><tr><td><img loading="lazy" alt="default" src="/zeebe-chaos/assets/images/default-resources-a917df422fb30b6089b249ec5f2578c1.png" width="1829" height="645" class="img_ev3q"></td><td><img loading="lazy" alt="metric" src="/zeebe-chaos/assets/images/metric-exporter-resources-d8b4e6c86bb038799ffc8ab101633be1.png" width="1826" height="638" class="img_ev3q"></td><td><img loading="lazy" alt="without" src="/zeebe-chaos/assets/images/without-exporter-resources-147a33a8d947f84836877a0e0b04149a.png" width="1828" height="639" class="img_ev3q"></td></tr></tbody></table><p> Unexpected was that we see a difference in throughput. The benchmark without exporters seem to have a better throughput overall. It is able to complete ~ 30 workflow instances more per second, then the other benchmarks.</p><table><thead><tr><th>Default</th><th>Metric Exporter</th><th>Without exporters</th></tr></thead><tbody><tr><td><img loading="lazy" alt="default" src="/zeebe-chaos/assets/images/default-general-4ec70f62414cc8ac4f8f553053f2eccf.png" width="1848" height="915" class="img_ev3q"></td><td><img loading="lazy" alt="metric" src="/zeebe-chaos/assets/images/metric-exporter-general-6355043145eca161da102ca2fb6b6991.png" width="1847" height="924" class="img_ev3q"></td><td><img loading="lazy" alt="without" src="/zeebe-chaos/assets/images/without-exporter-general-9ef196f675dfde45fd87c9b728da719f.png" width="1850" height="908" class="img_ev3q"></td></tr></tbody></table><p>  We compared also other benchmarks which we have currently running, e.g. a snapshot from 24-07-2020 or from the 0.24.1 release. </p><table><thead><tr><th>Snapshot 24-07</th><th>Release 0.24.1</th></tr></thead><tbody><tr><td><img loading="lazy" alt="snapshot" src="/zeebe-chaos/assets/images/snapshot-24-7-general-96cf8d8a9a28fd3ea52c3ef883b666d2.png" width="1845" height="916" class="img_ev3q"></td><td><img loading="lazy" alt="release-241" src="/zeebe-chaos/assets/images/release-0241-general-e0ec563cac1ee40807464ef0520833ea.png" width="1845" height="916" class="img_ev3q"></td></tr></tbody></table><p>  All benchmarks with exporters seem to have a throughput around ~140 workflow instance completions per second, but the benchmarks without exporters reaches ~170 workflow instance completions per second.
When we check the metrics we can see that sometimes brokers are leader for all partition and sometimes it is good distributed, but even this makes not that huge difference as the fact to having no exporter.
This is unexpected and we need to investigate further, created new issue for this <a href="https://github.com/zeebe-io/zeebe/issues/5085" target="_blank" rel="noopener noreferrer">#5085</a></p><p> The latency seems to be not affected by this.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="general-observations">General Observations<a href="#general-observations" class="hash-link" aria-label="Direct link to General Observations" title="Direct link to General Observations">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="rocksdb">RocksDB<a href="#rocksdb" class="hash-link" aria-label="Direct link to RocksDB" title="Direct link to RocksDB">​</a></h5><p>After taking a look at the metrics of the different benchmarks we can see that at one benchmark we have a higher live data size, which is unexepected.</p><p>  <img loading="lazy" alt="without-exporter-rocksdb" src="/zeebe-chaos/assets/images/without-exporter-rocksdb-eda01ef46c63c7224081729ba13606b5.png" width="1844" height="719" class="img_ev3q">
<img loading="lazy" alt="default-rocksdb" src="/zeebe-chaos/assets/images/default-rocksdb-6affdc45a3b5336205e162491a99d5e4.png" width="1834" height="713" class="img_ev3q">
<img loading="lazy" alt="metric-exporter-rocksdb" src="/zeebe-chaos/assets/images/default-rocksdb-6affdc45a3b5336205e162491a99d5e4.png" width="1834" height="713" class="img_ev3q"></p><p>Created an issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5081" target="_blank" rel="noopener noreferrer">#5081</a></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="atomix-bootstrap">Atomix Bootstrap<a href="#atomix-bootstrap" class="hash-link" aria-label="Direct link to Atomix Bootstrap" title="Direct link to Atomix Bootstrap">​</a></h5><p>On taking a look at the logs during starting the benchmarks we can see that the logging of atomix is not really useful.</p><p>It prints several statements which seem to be just noisy.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.198527Z TCP server listening for connections on 0.0.0.0:26502 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.199468Z Started </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.223547Z UDP server listening for connections on 0.0.0.0:26502 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.224941Z Joined </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.228644Z Started </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.229384Z Started </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.229856Z Started </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T10:17:54.231121Z Started </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Created an issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5080" target="_blank" rel="noopener noreferrer">#5080</a></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="merged-log-statement">Merged log statement<a href="#merged-log-statement" class="hash-link" aria-label="Direct link to Merged log statement" title="Direct link to Merged log statement">​</a></h5><p>Another issue we can see during startup is that from time the log statements are merged together in stackdriver.</p><p>Looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T09:16:47.053339Z Bootstrap Broker-1 partitions succeeded. Started 3 steps in 166 ms. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T09:16:47.053352763Z {"severity":"DEBUG","logging.googleapis.com/sourceLocation":{"function":"startStepByStep","file":"StartProcess.java","line":63},"message":"Bootstrap Broker-1 partitions [3/3]: partition 1 started in 7 ms","serviceContext":{"service":"zeebe-broker","version":"zeebe-chaos-metric-exporter"},"context":{"threadId":1,"broker-id":"Broker-1","threadPriority":5,"loggerName":"io.zeebe.broker.system","threadName":"main"},"timestampSeconds":1596100607,"timestampNanos":52869000,"logger":"io.zeebe.broker.system","thread":"main"}{"severity":"DEBUG","logging.googleapis.com/sourceLocation":{"function":"calculateHealth","file":"CriticalComponentsHealthMonitor.java","line":91},"message":"The components are healthy. The current health status of components: {ZeebePartition-1=HEALTHY}","serviceContext":{"service":"zeebe-broker","version":"zeebe-chaos-metric-exporter"},"context":{"threadId":263,"threadPriority":5,"loggerName":"io.zeebe.broker.system","threadName":"Broker-1-zb-actors-3","actor-name":"Broker-1-ZeebePartition-1"},"timestampSeconds":1596100607,"timestampNanos":52860000,"logger":"io.zeebe.broker.system","thread":"Broker-1-zb-actors-3"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T09:16:47.053379451Z </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Created an issue for it <a href="https://github.com/zeebe-io/zeebe/issues/5079" target="_blank" rel="noopener noreferrer">#5079</a></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="wrong-exporter-configuration">Wrong Exporter Configuration<a href="#wrong-exporter-configuration" class="hash-link" aria-label="Direct link to Wrong Exporter Configuration" title="Direct link to Wrong Exporter Configuration">​</a></h5><p>When Exporter is configured falsely it breaks the start up, which means the exporter can't be loaded and we see an exception.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> insertId: "1mp0o7821rhxwebj4"  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> jsonPayload: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context: {…}   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exception: "java.lang.IllegalStateException: Failed to load exporter with configuration: ExporterCfg{, jarPath='null', className='', args={index={ignoreVariablesAbove=32767}, url=http://elasticsearch-master:9200}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.system.partitions.ZeebePartition.&lt;init&gt;(ZeebePartition.java:145) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.Broker.lambda$partitionsStep$22(Broker.java:344) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.lambda$startStepByStep$2(StartProcess.java:60) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.takeDuration(StartProcess.java:88) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.startStepByStep(StartProcess.java:58) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.takeDuration(StartProcess.java:88) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.start(StartProcess.java:43) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.Broker.partitionsStep(Broker.java:352) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.Broker.lambda$initStart$10(Broker.java:184) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.lambda$startStepByStep$2(StartProcess.java:60) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.takeDuration(StartProcess.java:88) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.startStepByStep(StartProcess.java:58) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.takeDuration(StartProcess.java:88) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.bootstrap.StartProcess.start(StartProcess.java:43) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.Broker.internalStart(Broker.java:135) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.util.LogUtil.doWithMDC(LogUtil.java:21) [zeebe-util-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.Broker.start(Broker.java:115) [zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.StandaloneBroker.run(StandaloneBroker.java:65) [zeebe-distribution-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:795) [spring-boot-2.3.1.RELEASE.jar:2.3.1.RELEASE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:779) [spring-boot-2.3.1.RELEASE.jar:2.3.1.RELEASE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.springframework.boot.SpringApplication.run(SpringApplication.java:322) [spring-boot-2.3.1.RELEASE.jar:2.3.1.RELEASE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1237) [spring-boot-2.3.1.RELEASE.jar:2.3.1.RELEASE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1226) [spring-boot-2.3.1.RELEASE.jar:2.3.1.RELEASE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.StandaloneBroker.main(StandaloneBroker.java:52) [zeebe-distribution-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.zeebe.broker.exporter.repo.ExporterLoadException: Cannot load exporter [elasticsearch]: cannot load specified class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.exporter.repo.ExporterRepository.load(ExporterRepository.java:81) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.system.partitions.ZeebePartition.&lt;init&gt;(ZeebePartition.java:143) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 23 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: java.lang.ClassNotFoundException: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at jdk.internal.loader.BuiltinClassLoader.loadClass(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.ClassLoader.loadClass(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.exporter.repo.ExporterRepository.load(ExporterRepository.java:78) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.zeebe.broker.system.partitions.ZeebePartition.&lt;init&gt;(ZeebePartition.java:143) ~[zeebe-broker-0.25.0-SNAPSHOT.jar:0.25.0-SNAPSHOT]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... 23 more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger: "io.zeebe.broker.system"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message: "Bootstrap Broker-1 [11/12]: zeebe partitions failed with unexpected exception."   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceContext: {…}   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  thread: "main"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> labels: {…}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> logName: "projects/zeebe-io/logs/stdout"  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> receiveTimestamp: "2020-07-30T04:58:07.561999605Z"  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> resource: {…}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> severity: "INFO"  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> sourceLocation: {…}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> timestamp: "2020-07-30T04:58:04.221614Z"  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The Broker is shutdown afterwards.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.275180Z Bootstrap Broker-1 partitions [1/3]: partition 3 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.288302Z Bootstrap Broker-1 partitions [1/3]: partition 3 failed with unexpected exception. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.289941Z Closing Broker-1 partitions succeeded. Closed 0 steps in 0 ms. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.290305Z Bootstrap Broker-1 [11/12]: zeebe partitions failed with unexpected exception. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.291341Z Closing Broker-1 [1/10]: leader management request handler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.293136Z Closing Broker-1 [1/10]: leader management request handler closed in 2 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.293512Z Closing Broker-1 [2/10]: disk space monitor </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.294140Z Closing Broker-1 [2/10]: disk space monitor closed in 1 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.294509Z Closing Broker-1 [3/10]: monitoring services </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.295059Z Closing Broker-1 [3/10]: monitoring services closed in 1 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.295371Z Closing Broker-1 [4/10]: topology manager </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.295964Z Closing Broker-1 [4/10]: topology manager closed in 0 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.296264Z Closing Broker-1 [5/10]: cluster services </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.296612Z Closing Broker-1 [5/10]: cluster services closed in 0 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.296928Z Closing Broker-1 [6/10]: subscription api </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.297450Z Closing Broker-1 [6/10]: subscription api closed in 0 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.297763Z Closing Broker-1 [7/10]: command api handler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:02:58.298951Z Closing Broker-1 [7/10]: command api handler closed in 0 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:02:58.299366Z Closing Broker-1 [8/10]: command api transport </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.320886Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:00.321691Z Closing Broker-1 [8/10]: command api transport closed in 2022 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.322220Z Closing Broker-1 [9/10]: membership and replication protocol </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.323776Z RaftServer{raft-partition-partition-3} - Transitioning to INACTIVE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.324179Z RaftServer{raft-partition-partition-2} - Transitioning to INACTIVE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.324205Z RaftServer{raft-partition-partition-1} - Transitioning to INACTIVE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.343039Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.344506Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.345422Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.346547Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.347267Z 1 - Member deactivated: Member{id=1, address=zeebe-chaos-zeebe-1.zeebe-chaos-zeebe.zeebe-chaos.svc.cluster.local:26502, properties={brokerInfo=EADJAAAAAQABAAAAAwAAAAMAAAADAAAAAAABCgAAAGNvbW1hbmRBcGlJAAAAemVlYmUtY2hhb3MtemVlYmUtMS56ZWViZS1jaGFvcy16ZWViZS56ZWViZS1jaGFvcy5zdmMuY2x1c3Rlci5sb2NhbDoyNjUwMQUAAAwAAA8AAAAwLjI1LjAtU05BUFNIT1Q=}} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.347747Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.348326Z Left </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:00.349083Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:04.364059Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:04.364994Z Stopped </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.365955Z Closing Broker-1 [9/10]: membership and replication protocol closed in 4043 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:04.366433Z Closing Broker-1 [10/10]: actor scheduler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.366879Z Closing blocking task runner </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.367217Z Closing actor thread ground 'Broker-1-zb-fs-workers' </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.368641Z Closing actor thread ground 'Broker-1-zb-fs-workers': closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.369018Z Closing actor thread ground 'Broker-1-zb-actors' </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.369955Z Closing blocking task runner: closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.370112Z Closing actor thread ground 'Broker-1-zb-actors': closed successfully </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2020-07-30T05:03:04.371034Z Closing Broker-1 [10/10]: actor scheduler closed in 4 ms </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-30T05:03:04.371414Z Closing Broker-1 succeeded. Closed 10 steps in 6080 ms. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2020-07-30T05:03:04.371769Z Failed to start broker 1! </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is works without problems. I think this is good to know.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code">Code<a href="#code" class="hash-link" aria-label="Direct link to Code" title="Direct link to Code">​</a></h3><p>To deploy a benchmark without exporters we had to do a <code>helm template</code> and remove all exporter related env variables.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Big Multi Instance]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/07/16/big-multi-instance</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/07/16/big-multi-instance"/>
        <updated>2020-07-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* investigate and fix automated chaos experiments - works again with 88c404f and cd8d685]]></summary>
        <content type="html"><![CDATA[<ul><li>investigate and fix automated chaos experiments - works again with <a href="https://github.com/zeebe-io/zeebe-chaos/commit/88c404f97514d4a7a511ce9751085acdd1720cd9" target="_blank" rel="noopener noreferrer">88c404f</a> and <a href="https://github.com/zeebe-io/zeebe-chaos/commit/cd8d685b83eaa1ac9050ad3d16868389e1c0c36d" target="_blank" rel="noopener noreferrer">cd8d685</a></li><li>Closed some issues in the backlog</li><li>Run a chaos experiment with bigger multi instance to reach <code>maxMessageSize</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><p> We wanted to run a chaos experiment, which covers <a href="https://github.com/zeebe-io/zeebe-chaos/issues/33" target="_blank" rel="noopener noreferrer">#33</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3><p> If we reach <code>maxMessageSize</code> in a workflow instance, for example via variables we expect that an incident is created or at least an error event and we can see that in operate. Furthermore we expect that the partition processing is not stopped, which means we can still create new instances.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">​</a></h3><p> The experiment uses parallel multiInstance service tasks, to create a lot of tasks which should be completed with big variables.</p><p> <img loading="lazy" alt="multiInstance" src="/zeebe-chaos/assets/images/multiInstance-34834f33ef17ba5beebfe4801420587d.png" width="820" height="553" class="img_ev3q"></p><p> On collecting the output the <code>maxMessageSize</code> should be reached and we expected either an incident or exception for this instance. This should not affect other workflow instance creations.</p><p> <img loading="lazy" alt="overview" src="/zeebe-chaos/assets/images/overview-7c0f42db61db06446bc93d8a94b04fcf.png" width="1888" height="447" class="img_ev3q"></p><p> In operate we can see that we have two running workflow instances, one was started after the first failed. Later we created multiple instance's in a loop, without issues. This means we are not breaking partition processing, otherwise we would see timeouts.</p><p> The problem we have is that we are not able to see in Operate that the workflow instance is actually broken. We have no indication for that.</p><p> <img loading="lazy" alt="broken-multi" src="/zeebe-chaos/assets/images/broken-multi-0df164bbc4633660c5926c2d9caa9b84.png" width="1732" height="731" class="img_ev3q"></p><p> The instances seem still to be in starting the multi instance, but actually they are already blacklisted. If we check the logs we can find the following:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-16T13:05:20.630315Z Error event was committed, we continue with processing. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2020-07-16T13:05:26.699139Z Expected to write one or more follow up events for event 'LoggedEvent [type=0, version=0, streamId=2, position=567, key=4503599627370769, timestamp=1594904720629, sourceEventPosition=565]' without errors, but exception was thrown. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2020-07-16T13:05:26.735966Z Expected to process event 'TypedEventImpl{metadata=RecordMetadata{recordType=EVENT, intentValue=255, intent=ELEMENT_ACTIVATED, requestStreamId=-2147483648, requestId=-1, protocolVersion=1, valueType=WORKFLOW_INSTANCE, rejectionType=NULL_VAL, rejectionReason=}, value={"bpmnProcessId":"chaos","version":2,"workflowKey":2251799813685359,"workflowInstanceKey":4503599627370761,"elementId":"chaosTask","flowScopeKey":4503599627370769,"bpmnElementType":"SERVICE_TASK","parentWorkflowInstanceKey":-1,"parentElementInstanceKey":-1}}' without errors, but exception occurred with message 'Expected to claim segment of size 8439432, but can't claim more than 4194304 bytes.' . </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">W 2020-07-16T13:05:26.737532Z Blacklist workflow instance 4503599627370761, due to previous errors. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-16T13:05:26.738421Z Error record was written at 568, we will continue with processing if event was committed. Current commit position is 567. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2020-07-16T13:05:26.793523Z Error event was committed, we continue with processing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I created a feature request for operate <a href="https://jira.camunda.com/browse/OPE-1037" target="_blank" rel="noopener noreferrer">OPE-1037</a></p><p>In general chaos experiment succeeded, since we not breaking processing and we are still able to process other instances, but we only see that the instance is blacklisted in the logs not in operate, which is a problem from my POV. Furthermore a bit unexpected was, that we already failed before, we are not able to activate jobs, since the size of the multi instance was already to big.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code">Code<a href="#code" class="hash-link" aria-label="Direct link to Code" title="Direct link to Code">​</a></h3><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    // create zeebe client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var client = ZeebeClient.Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .UseLoggerFactory(new NLogLoggerFactory())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .UseGatewayAddress(ZeebeUrl)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .UseTransportEncryption()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .UseAccessTokenSupplier(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CamundaCloudTokenProvider.Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .UseAuthServer(AuthServer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .UseClientId(ClientId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .UseClientSecret(ClientSecret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .UseAudience(Audience)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .Build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var topology = await client.TopologyRequest().Send();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Logger.Info(topology.ToString);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Console.WriteLine(topology);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var deployResponse = await client.NewDeployCommand()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .AddResourceFile(DemoProcessPath)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Send();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // create workflow instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var intArray = Enumerable.Range(0, 10_000).ToArray();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var jsonObject = new {list = intArray};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var jsonString = JsonConvert.SerializeObject(jsonObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await client.NewCreateWorkflowInstanceCommand()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .BpmnProcessId("chaos").LatestVersion()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .Variables(jsonString)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .Send();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // open job worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    using (var signal = new EventWaitHandle(false, EventResetMode.AutoReset))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        client.NewWorker()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .JobType(JobType)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .Handler(HandleJob)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .MaxJobsActive(120)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .Name(WorkerName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .AutoCompletion()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .PollInterval(TimeSpan.FromMilliseconds(100))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .Timeout(TimeSpan.FromSeconds(10))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .PollingTimeout(TimeSpan.FromSeconds(30))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .Open();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // blocks main thread, so that worker can run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signal.WaitOne();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static void HandleJob(IJobClient jobClient, IJob job)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Logger.Debug("Handle job {job}", job.Key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var bigPayload = File.ReadAllText(PayloadPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobClient.NewCompleteJobCommand(job).Variables(bigPayload).Send();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Experiment with Timers and Huge Variables]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/07/09/timer-and-huge-variables</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/07/09/timer-and-huge-variables"/>
        <updated>2020-07-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Failure documentation about RAFT]]></summary>
        <content type="html"><![CDATA[<ul><li>Failure documentation about RAFT</li><li>Added chaos day summaries to repo</li><li>Run Chaos experiment with a lot of timers</li><li>Run Chaos experiment with huge variables</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-lot-of-timers">A Lot of Timers<a href="#a-lot-of-timers" class="hash-link" aria-label="Direct link to A Lot of Timers" title="Direct link to A Lot of Timers">​</a></h3><p>Based on the Hypothesis written here:  <a href="https://github.com/zeebe-io/zeebe-chaos/issues/31" target="_blank" rel="noopener noreferrer">#31</a> we run an experiment with a stable load of 10 simple workflow instances per second (only start and end event) and 10 workflow instances with
multiple timers. We wanted to explore what happens when we have a lot of timers running and especially what happens when the are triggered at once. We created the following workflow model, where timers are exponentially created.</p><p><img loading="lazy" alt="timerProcess" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAArIAAAIdCAAAAADkWMFnAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAQY2FOdgAAB4AAAAQ4AAAAlQAAAKjLeOlxAAAbzElEQVR42u3db3BUdb7n8U8uXIw6kgMlm4RMSEMkC1su3R2MjM7cpIOzJVZpckKcW7VSa2JZO9a41kLV6Bpr5lbaUsq4TBUgdafG2alN2JIaXUu7yfxBL0o3MDpKGLqz44LCQjdCSKpgJs2D3VGvO999kD/kPyH0prvJ+/VAu0/DL92/fueX093nhDwTkEv+hikAyQIkC5AsSBYgWYBkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AscH3mz+YXy2O+cU3B/HWCjayyyF4T/saC+VlwH4AJTfxTmVUWOYZkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AsQLIgWYBkAZIFyQIkC5AsSBYgWYBkQbIAyQIkC5IFSBYgWYBkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AsQLIgWYBkAZIFyQIkC5AsSBYgWYBkQbIAyQIkC5AsSBYgWYBkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AsQLIgWYBkAZIFyQIkC5AsSBYgWYBkAZIFyQIkC5AsSBYgWYBkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AsQLIgWYBkAZIFyQIkC5AsQLLINfNn6ws9P/Tf/13+BNOOmcuz2fk6B+//cvDSTf/4ONOOacUpy2CyuumrwQt/6/+YJwMzT3a29mU3DxWrf56fHfOBXA15tlbZeX8d+ib5v8w6phdnRldZPTV04T/yVOC6Qp6tVXZomWWRxbTjzOwqO7TMssjiOkOetVV2YJllkcX048zwKjuwzD7FE4HrDHn2VlnN+yuLLK4lzkyvsnoq3YtsKsXTOgdDnsVVNrVI/U46x6tVxBFu3DgzvcqmaqXaVDrHi8fTOR5yw+wlm6qNe71pbCzd44FkxxcWjaavsXSPB5KdoDDHSVtj6R4PJDtRYVK6Gkv3eCDZiQtLV2PpHg85ZLI3uZJ7w0rF5XPk1nvSV5ikVKDbd53vTaV7vCxxoqevL6+oqGQVWQ7GOf2zElI7O5IjrnqaN19XEqMKS0Nj6R4vK0TDnesuFRVZX9/tXXVuDb1OmqxsvA5HKmhqj8TMYpH2pgLJ6bCZ6/fJ2z9qg1e+/uwZLxv8dk3DjjNDV05vb/C9k9uPJz0mrNPGr7LJhrhqgoGRC0DwoHwhT3rWxOteF6+M97wktd4A6+ylxlvb1kj6KhaX37dAUrzly7cWs8pOb5WNOSqLjN0YKpMTS9OaeJ3r4pXxgpKk1txfZw8UHTSzHY+sXrDuiSfuXvCvNu0ws8jig6yyE66yYze2S/UTPPn99VJ72oq9jsZGjDci2ZxuNlRrZh8WvrTn+MD1//naS0s/MrPqX5HsNJKNSZsn/uubpVjaip1xYyPHG5lsDjcb+nsze/qevpHbetY9a2YPd5LsVZNNOJMVa7ZZTiJtxc6wsVHjjUo2Z5s9UGt2bsU2M0vsCPgkX2BHwszaVvaY/d0hkr1asj7VTz5AvXwzLCwYDB65svVSMBj8XzNqbPR3wOhkc7TZi8Vm52pPmyWar7y+aE6YnQz0mN2ei9+Es5psu8qmmKP+smvcnR0q7OzfSrfuHdr6f+ZJ+T+aSWNj1uwxyeZms9UHzVacNgs5Un1rpOXZSGu95ITMPqswe389yU6ZbL+jyFQjhORcSxJXCvsvjnTTnwY3r5BufnAmjY3dyxibbC42+9sHzJ7eZtYuldaaWbC1fUciUCq1m73UYvZv/olkp0q2VTVTD1EzMpBrKex7+VLxwMXmm6UlM2ls3H7xuGRzsNk13fbhPWbtUmt/WcQs2OrVC2XWKoXMqo7YHypJdqpkPVMvsmYheWZUrNky6eYGM7P/7kg3X5hBY+NfyY1PNueajTSYFfZZwlGrWajezBJSfWjwte75ErO6ufzu7FWTTajgamMUKDHpbf/4sykKu7xAWvxTsws3S077tBqbcrxJks2JZkc8sM07bMdLZk0qNTPrN7P2gbfF+0vVZLb1FfvJD0l2jBEHH4blXu0TNFfhSW87u8UXmfRT2oVv36Y/P3tK3r8ov2HEa+Mpjh2ccrzJ5MKxiCMeWGedjixTcrfKl4clZ+BJcKSwv1y7kyrtUl3nnP/YdooPbGuu/oZA+xRvggUlx3tg0jXxBzdJtz14i1Ru01sXrzLexKtsLqyzVx7Y8X9rtvq4bVe9RQY/c5QSZv31EavXdvvjnWZ/f5JVdszWkclGrjZGZIoXaEFJcryRyQr715KKpHl/mWZjE47nm/Lbz5cTzV55YPu/a18uGPWqNiTv4KVW1ZjN/2erPUCyo43YMbgsz1V/7ury1H8g1d3gi078U/x/SOrTN97Jv5af5WPHi0/51eO5sm8w+MD6ihTzS0kFxu+cBXRZqjym4l72BCbdMZi46bHdT8uEn9IeL5C0a4Ib+r3THm9aD+bq42WLp+1nT5hJLcHgwF0vkxvuN7NgsEUye+Jn9kPqnHyVTaO8iTb+h8uSfjjtP35Nf+C6/ngGn5Erz4wkKSmF3UW1O5PTXx3mdMdlU7yDNSg2vKs1yS6a5HgjE+9NvrBQklQ1fpGd+NiZCcebzoOZ4lic7NmXlRxv5LVN9vHdZmUjXkTEttdICplF5DWrOmKP7GFfdszWKxfT+PJrgmY/XiTdtkC66cfTK3bi8XxTFuvLhWJHPLD37hv78svMrD/UZLz8mjzZUTsGyastyUk5U93seEPxgCZ+BXRPv257+uht+nLXwVHbp3rHdfx4sXGr1chnO6bpv4ObUYMPrOR2LbjjuFzFFW0Yni/H3dEQVVyuPlk1X0tK2BOYdMdgu5quln2Ttk++eOR7r6zS49ZZv6SA2U++IeV9PY019mrj2STvy2b9Gjvqga04bZtes4QUKAuN/COhslopYbsftc8q5u4iO50PbJ2rjeFMtbsbGZXO6Mb+U750i5nZhpuliukVNtV4kyWbA8WOfGBbtg9+YLvMbOAD26H/edRk9uIu2/Y0yU6e7KiXARMKqWzaX25UY/sXSd84YWZmi6X8fz+DwsY3O0GyOVHsCNEGs6U9ligYPizGzAYOiylI2NllZnWHSXaKZFsVmHqIwDUdfHilsb/MkxbvHLicvFVaGJ5BYeOaHZ9srhVr5ovZR+vMQlKw3xMxC7aaRcpssxQyW3vUuu6aw8VO5xDvAoWmGiGkgmsJ4kpjy6X8h4Y2/8yRbuqdQWFjmx2XbO4Va+/cb/Zsm1m7tCxgA8laYLnUbvbij8zue49kp0rW2uWZ4inv91zriTSDjR3Ovzn/u1c2b73p5vwfzqSwMc2OTTYHizULRMxWnjQLFUhuMNrybDToSgUhs+OrzfZ/dy4XO63TFb1yJx/AneJzhGk1NubGay9s9Hhjks3JYu1Pi816Ap+ZJZquvIvTlDA7HugzW3iZZK+SbKJgqpPCCxLX+jWnaHZGhY0ab3SyuVms2cFqs56Kl8wssb3GK3lrtifM7MXVfWb3fjCni532r97YMvFf3zKzX70xWbMzLGzkeKOSzdVizX71sJm1VJ0fue3s2h+ZWeNv53ax0/8FR+4ET32/O9NfcDRxszMubMR4I5PN3WLNOv/OzI6UbP1vfxy4/sfdLy47amb3zvVip5msxQrkCY3dGPKoIDazLzths9dR2JXxRiSby8WaHVryvpm98u/unH/3E09Uzb/z0V1mtn/hHN8rsGv4ZZ1utwJb6kds2bsjKm/YM8NPhCf4TZrXdRzAlfGCQ//JieMKpnpIjfPaKiV9fSymSv98SUdb8t5aOOcPJpj+r0RuL5Cc5o5ozCwW7Wh2pIL26/heGbfOXueamO7xssE/Vdb9ZPgkr8+21d81p9+PvdZVVlJqR8fZEVfLmrdc1xI2Zp297jUx3eNlhUOdnf6LxcXq7V0Sr6v/zpxfYSdfZSf95z3C0VSqW17HCbie6/7BN7KxNBSW7vGyxKnzvb0qLi6pINaZJJteIxpLS2HpHg85lOzs/LtfV47RTk9h6R4POWSW/nXFocbSVVi6x0PuyJutMzlTgW5fROkrLN3jIQvjzOC+7FBjSmNh6R4PJDtBY0pnYekeDyQ7vjGltbDUIvVTLMn+f21Wziw8JJBsjj0k3NjJ/s2cmwfkOJIFyQIkC5AsSBYgWYBkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AsQLIgWYBkAZIFyQIkC5AsSBYgWYBkAZIFyQIkC5AsSBYgWYBkQbIAyQIkC5IFSBYgWZAsQLIAyYJkAZIFSBYkC5AsQLIgWYBkAZIFyQIkC5AsQLIgWYBkAZIFyQIkC0xiPlOQNU709PXlFRWVrGIqppJnuXznlcv3frRouHPdpaIi6+u7vavOraHMSZ9fks0K+1rKa+qWD14503ko0XY/xZJs9rrUeGvbGklfxeLy+xZIird8+dZikiXZLBV55I1qaeeR2Gm/T7H4Hf6qzVK0MVRNsiSblcKvHJB+37BlmX+1JOl47Nyut9dJNc88SLIkm43F/vIN6ZkPQoUjtl3YGGiTvvfoQyQ7Hu/LZljklTd0vrzww0Ild9b68/L8tTuTWvrRoooLenPbYeZngpBZZTPq0poLOv/oL1Yo+XzH8MbmVo9OfX/PUi055czpONkxyEI1L1SrfP8KhR9Lqd4XeNc2RON75bS7OvnQZzqw9X2SHYsdg4zad2u1nvnBCnU0pEprw8FAfn5y0Y5AaaqhQxWPPaf18/YzR+NYDsvte29mtqbbPrzHrF1q7S+LmAVbvXqhzFqlkFnVEftDZa4/wvQ/vySbSZEGs8I+SzhqNQvVm1lCqg+ZbZaTsPMlZnUHSXYMdgwyKVyjnVsKFUyVBiW3Q1JU9R2uFCxNBVXy5C5VdzJLY5BsJnXW6cgyJXerfHlYciSF5TpS2F+u3UmVdqmOZEk2i5z41nLF/AqrPtLekZIk7VVASnW0R+oVlj+mlf5TzBPJZo2ei/rq9GqF5VMg7EhSWF6P5IQD8imsOz/9WhfPM08kmzX6ihTzS0kFhraE5Q5eCuiyVHlMxb3M02iclZDZZOM+6azePahWSVJU3XtrHOl5faG45I/dXbxpExNFstli+KNHG7yQlMJhBdx6u4HOtyDZG0hRTP7/KpWd3RAY2OBJxqPhg9FoWVDRl73SscfVu+eRufstPeFW9mUzmWyffHHJo+jwJt+WaH+oyZWicqSYX73FzBPJZo2S27XgjuNyFVe0ITW01XF3NEQVl6tPVs3XkhLmiWQz76evSpJWdZ2RPyZXe2ubm5wrNztNzev3ytWxSp2MVzBdJJt5Z7f4IpJU16mqc/I06UzSlVIDN6YkN5lQk0fnqtRZx2yRbBa45Yvujb6I5B7S5l0XFCz4PCiFmwdubA5LW5IFQX3+86d0uJ7ZGosjuTIgKEmON2K+mH20ziwkBfs9EbNgq1mkzDZLIbO1R63rrjl8IBdHcmWbVHeD75EWrQu8LLddQa8nMLA9sHzFTrW72rphrVramKexcvxEmpxXEA6o4jcrFW6+LNcXeMceiMbDKuhwdaLxuN57eU6flTDJiVK5/YMj9y026wl8ZpZourKtKWF2PNBntvDyXN4v4KyELBIcSNPxRuxgtVlPxUtmlthe45W8NdsTZvbi6j6zez+Y08VO8vxyhm0mPB+U5JTtCEj69e43pefeD438yODzjRtelB5+/IG5vFsw2fPLMQYZMhis9KBVH9JLXeueLPXfKUn65Ni5n7+9Vvr2j+d4sZMg2YzI/5eDwUp6yPkXr6+vOr9r/3/+tNKvY7FVlVVnpfca993LPE2EHYOMiAZGXks1zmurlPT1sZgq/fMlHW3Je2shcfLbYrLX/pZvVtetHLxysvN3PW33zflgSTbLHers9F8sLlZv75J4Xf136JVkc8Cp8729Ki4u4dgtksWN9PxyjAFyDMmCZAGSBUgWJAuQLECyIFmAZAGSBckCJAuQLEgWIFmAZEGyAMkCJAuSBUgWIFmQLECyAMmCZAGSBUgWJAuQLECyAMmCZAGSBUgWJAuQLECyIFmAZAGSBckCJAuQLEgWIFmAZEGyAMkCJAuSBUgWIFmQLECyAMmCZAGSBUgWIFmQLECyAMmCZAGSBUgWJAuQLECyIFkgk+YzBVnjRE9fX15RUckqpmIqeZbLd165fO9Hi4Y7110qKrK+vtu76twaypz0+SXZrLCvpbymbvnglTOdhxJt91MsyWavS423tq2R9FUsLr9vgaR4y5dvLSZZks1SkUfeqJZ2Homd9vsUi9/hr9osRRtD1SRLslkp/MoB6fcNW5b5V0uSjsfO7Xp7nVTzzIMkS7LZWOwv35Ce+SBUOGLbhY2BNul7jz5EsuPxvmyGRV55Q+fLCz8sVHJn7fK8vOW1O5Na+tGiigt6c9th5meCkFllM+rSmgs6/+gvVij5fMfwxuZWj059f89SLTnlzOk42THIQjUvVKt8/wqFH0up3hd41zZE43vltLs6+dBnOrD1fZIdix2DjNp3a7We+cEKdTSkSmvDwUB+fnLRjkBpqqFDFY89p/Xz9jNH41gOy+17b2a2pts+vMesXWrtL4uYBVu9eqHMWqWQWdUR+0Nlrj/C9D+/JJtJkQazwj5LOGo1C9WbWUKqD5ltlpOw8yVmdQdJdgx2DGbdT18dvhiu0c4thQqmSoOS2yEpqvoOVwqWpoIqeXKXqjuZsDFIdtad3eKLDF7srNORZUruVvnysORICst1pLC/XLuTKu1SHcmSbMbd8kX3xoFoT3xruWJ+hVUfae9ISZL2KiClOtoj9QrLH9NK/ylmjGQzL9W90ReVei7qq9OrFZZPgbAjSWF5PZITDsinsO789GtdPM90kWx2RNvgi/YVKeaXkgoMbQ7LHbwU0GWp8piKe5ms0XL8rIS8HI42VaunFfdJZ/XuQbVKkqLq3lvjSM/rC8Ulf+zu4k2bqPRGSjbHDX24Y4MXklI4rIBbbzfQ+RbpnzXel51lwYGJd7yR1zbZx3eblSkyfGNse42kkFlEXrOqI/bIHt6X5X3ZbOB4Q/FAUZ98ccmj6PB235Zof6jJlaJypJhfvcVM1mgkm7FgpZLbteCO43IVV7QhNXyju6MhqrhcfbJqvpaUMF0km2n5A8FKq7rOyB+Tq721zU3OiKKbmtfvlatjlToZr2DCSDbDWvcNBCuprlNV5+Rp0pmkK6UGNqYkN5lQk0fnqtRZx4SNxcuvDIo2mC3tsUTB8GExZjZwWExBws4uM6s7PHdffXEkVzbyxeyjdWYhKdjviZgFW80iZbZZCpmtPWpdd83hYnnHIBu1tWhd4GW57Qp6PYO7C4HlK3aq3dXWDWvV0sYcjcWJNJlV2xpQxW9WKtx8Wa4v8I49EI2HVdDh6kTjcb338pw+K4Fzv7LRn1f+SRc2vVqhZHD38MamoEcnnny9UAXnFpIsyWaZQ/9wUBdqH2uRkuFwqltex3U90tY9kUJ9e9u9c7lYks1Sv979pvTc+6GRHxl8vnHDi9LDjz8wp4sl2Wz1q22HpK6GJ0v9d0qSPjl27udvr5W+/eM5XizJZq3Dja+vl3Z1xT6t9OtYbFVl1VPSe4375vZeAclms1TjvLZKSV8fi6nSP1/S0Za8t+b0Ky+SzXb7W75ZXbdy8MrJzt/1tN0354Ml2Sx3qLPTf7G4WL29S+J19d+hV5LNAafO9/aquLiEY7dIFjfS88sxBsgxJAuSBUgWIFmQLECyAMmCZAGSBUgWJAuQLECyIFmAZAGSBckCJAuQLEgWIFmAZEGyAMkCJAuSBUgWIFmQLECyAMkCJAuSBUgWIFmQLECyAMmCZAGSBUgWJAuQLECyIFmAZAGSBckCJAuQLEgWIFmAZEGyAMkCJAuSBUgWIFmAZEGyAMkCJAuSBUgWIFmQLECyAMmCZIFMms8UZI0TPX19eUVFJauYiqnkWS7feeXyvR8tGu5cd6moyPr6bu+qc2soc9Lnl2Szwr6W8pq65YNXznQeSrTdT7Ekm70uNd7atkbSV7G4/L4FkuItX761mGRJNktFHnmjWtp5JHba71Msfoe/arMUbQxVkyzJZqXwKwek3zdsWeZfLUk6Hju36+11Us0zD5IsyWZjsb98Q3rmg1DhiG0XNgbapO89+hDJjsf7shkWeeUNnS8v/LBQyZ21/rw8f+3OpJZ+tKjigt7cdpj5mSBkVtmMurTmgs4/+osVSj7fMbyxudWjU9/fs1RLTjlzOk52DLJQzQvVKt+/QuHHUqr3Bd61DdH4Xjntrk4+9JkObH2fZMdixyCj9t1arWd+sEIdDanS2nAwkJ+fXLQjUJpq6FDFY89p/bz9zNE4lsNy+96bma3ptg/vMWuXWvvLImbBVq9eKLNWKWRWdcT+UJnrjzD9zy/JZlKkwaywzxKOWs1C9WaWkOpDZpvlJOx8iVndQZIdgx2DWffTV4cvhmu0c0uhgqnSoOR2SIqqvsOVgqWpoEqe3KXqTiZsDJKddWe3+CKDFzvrdGSZkrtVvjwsOZLCch0p7C/X7qRKu1RHsiSbcbd80b1xINoT31qumF9h1UfaO1KSpL0KSKmO9ki9wvLHtNJ/ihkj2cxLdW/0RaWei/rq9GqF5VMg7EhSWF6P5IQD8imsOz/9WhfPM10kmx3RNviifUWK+aWkAkObw3IHLwV0Wao8puJeJmu0HD8rIS+Ho03V6mnFfdJZvXtQrZKkqLr31jjS8/pCcckfu7t40yYqHSWnV9lArs/+0Ic7ZgOXklLYXVS7Mzm0YY777sSzhlkWHJh4xxt5bZN9fLdZmSLDN8a210gKmUXkNas6Yo/sYcZ4XzYbON5QPFDUJ19c8ig6vN23JdofanKlqBwp5ldvMZM1GslmLFip5HYtuOO4XMUVbUgN3+juaIgqLlefrJqvJSVMF8lmWv5AsNKqrjPyx+Rqb21zkzOi6Kbm9Xvl6lilTsYrmDCSzbDWfQPBSqrrVNU5eZp0JulKqYGNKclNJtTk0bkqddYxYWOxO59B0QazpT2WKBg+LMbMBg6LKUjY2WVmdYeZpTFINqN8MftonVlICvZ7ImbBVrNImW2WQmZrj1rXXczRWOwYZFRbi9YFXpbbrqDXM7i7EFi+YqfaXW3dsFYtbczRWDl9Is0NoLY1oIrfrFS4+bJcX+AdeyAaD6ugw9WJxuN672XOSiDZLPPnlX/ShU2vVigZ3D28sSno0YknXy9UwbmFTBHJZplD/3BQF2ofa5GS4XCqW17HdT3S1j2RQn17271MEMlmnV/vflN67v3QyI8MPt+44UXp4ccfYHpINgv9atshqavhyVL/nZKkT46d+/nba6Vv/5hiSTY7HW58fb20qyv2aaVfx2KrKquekt5r3MdeAclmq1TjvLZKSV8fi6nSP1/S0Za8t3jlRbJZbH/LN6vrVg5eOdn5u562+5gUks1uhzo7/ReLi9XbuyReV/8dJoRkc8Cp8729Ki4u4dgtksWNhGMMQLIAyQIkC5IFSBYgWZAsMLv+H4uL+9ai3obMAAAAAElFTkSuQmCC" width="690" height="541" class="img_ev3q"></p><p>The experiments is based on the hypotheses we wrote here <a href="https://github.com/zeebe-io/zeebe-chaos/issues/31" target="_blank" rel="noopener noreferrer">#31</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="expectations">Expectations<a href="#expectations" class="hash-link" aria-label="Direct link to Expectations" title="Direct link to Expectations">​</a></h4><ul><li>at some point we can't create new instances from out side, since backpressure will block that</li><li>the metrics for processing records (events/commands) should be stable since there will be always new events/records</li><li>the cluster itself should be stable</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="observations">Observations<a href="#observations" class="hash-link" aria-label="Direct link to Observations" title="Direct link to Observations">​</a></h4><p>During running the experiments we saw that indeed we were not able to create new instances at some point.
The cluster kept stable and there was no leader change at all. Unexpected was the behavior of the processing record metrics, since it fluctuates a lot.</p><p>Furthermore we reached really high processing records throughput, which we normally not see.</p><p><img loading="lazy" alt="overall" src="/zeebe-chaos/assets/images/overall-0bf1b5d88ff99c1c96acde2110c43f5b.png" width="1842" height="917" class="img_ev3q"></p><p>The log appender backpressure seem to work, at some point it deferred around 1.3 million records.</p><p>On resource consumption side it seems that memory is growing, but we create also more timer might be the issue.</p><p><img loading="lazy" alt="mem" src="/zeebe-chaos/assets/images/mem-f8766317213b71c59a5c41b7083e0968.png" width="1837" height="650" class="img_ev3q"></p><p>Interesting was that we saw a huge difference between processing and exporting.</p><p><img loading="lazy" alt="exportvsprocess" src="/zeebe-chaos/assets/images/exportvsprocess-508a331eafa9df80e4cb11c520e2e95f.png" width="1827" height="401" class="img_ev3q"> </p><p>The issue we currently have is that we stop processing to trigger/evaluate due timers and write them to the log.
After we did that we will process a bunch of events again and then trigger/evaluate again. I think this should be decoupled to streamline the processing throughput. I created a new issue for that <a href="https://github.com/zeebe-io/zeebe/issues/4931" target="_blank" rel="noopener noreferrer">#4931</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="huge-variables">Huge Variables<a href="#huge-variables" class="hash-link" aria-label="Direct link to Huge Variables" title="Direct link to Huge Variables">​</a></h3><p>In order to understand better what is the impact of huge variables I did a small experiment with a payload which was ~ 5 MB.</p><p>I expected that this will not work, since this is larger then the maximum message size. I would expect an appropriate error message, but unfortunately I just got a cancel on the client side.</p><p>Starter Exception:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945889183Z 12:27:20.945 [Thread-2] WARN  io.zeebe.ResponseChecker - Request failed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945909759Z java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: CANCELLED: HTTP/2 error code: CANCEL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945924206Z Received Rst Stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945929123Z  at java.util.concurrent.CompletableFuture.reportGet(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945934351Z  at java.util.concurrent.CompletableFuture.get(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945939157Z  at io.zeebe.ResponseChecker.run(ResponseChecker.java:41) [app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945972595Z Caused by: io.grpc.StatusRuntimeException: CANCELLED: HTTP/2 error code: CANCEL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945978663Z Received Rst Stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945983657Z  at io.grpc.Status.asRuntimeException(Status.java:533) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945988515Z  at io.grpc.stub.ClientCalls$StreamObserverToCallListenerAdapter.onClose(ClientCalls.java:449) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945993803Z  at io.grpc.PartialForwardingClientCallListener.onClose(PartialForwardingClientCallListener.java:39) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.945998591Z  at io.grpc.ForwardingClientCallListener.onClose(ForwardingClientCallListener.java:23) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946003749Z  at me.dinowernli.grpc.prometheus.MonitoringClientCallListener.onClose(MonitoringClientCallListener.java:50) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946007316Z  at io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:426) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946010626Z  at io.grpc.internal.ClientCallImpl.access$500(ClientCallImpl.java:66) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946013822Z  at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl.close(ClientCallImpl.java:689) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946017026Z  at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl.access$900(ClientCallImpl.java:577) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946020414Z  at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:751) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946025498Z  at io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:740) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946030508Z  at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946035265Z  at io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123) ~[app.jar:0.23.3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946040Z     at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946045833Z  at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09T12:27:20.946050880Z  at java.lang.Thread.run(Unknown Source) ~[?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> I </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Interesting is what happens on the Gateway:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2020-07-09 14:27:33.929 CEST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stream Error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Expand all | Collapse all{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> insertId: "yoxfczvg9usifqd7d"  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> jsonPayload: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context: {…}   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exception: "io.netty.handler.codec.http2.Http2Exception$StreamException: Received DATA frame for an unknown stream 10277</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.Http2Exception.streamError(Http2Exception.java:147) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.DefaultHttp2ConnectionDecoder$FrameReadListener.shouldIgnoreHeadersOrDataFrame(DefaultHttp2ConnectionDecoder.java:596) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.DefaultHttp2ConnectionDecoder$FrameReadListener.onDataRead(DefaultHttp2ConnectionDecoder.java:239) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.Http2InboundFrameLogger$1.onDataRead(Http2InboundFrameLogger.java:48) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.DefaultHttp2FrameReader.readDataFrame(DefaultHttp2FrameReader.java:422) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.DefaultHttp2FrameReader.processPayloadState(DefaultHttp2FrameReader.java:251) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.DefaultHttp2FrameReader.readFrame(DefaultHttp2FrameReader.java:160) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.Http2InboundFrameLogger.readFrame(Http2InboundFrameLogger.java:41) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.DefaultHttp2ConnectionDecoder.decodeFrame(DefaultHttp2ConnectionDecoder.java:174) ~[netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.Http2ConnectionHandler$FrameDecoder.decode(Http2ConnectionHandler.java:378) [netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.http2.Http2ConnectionHandler.decode(Http2ConnectionHandler.java:438) [netty-codec-http2-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:501) [netty-codec-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:440) [netty-codec-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:276) [netty-codec-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) [netty-transport-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:792) [netty-transport-native-epoll-4.1.50.Final-linux-x86_64.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe$1.run(AbstractEpollChannel.java:387) [netty-transport-native-epoll-4.1.50.Final-linux-x86_64.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:164) [netty-common-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472) [netty-common-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:384) [netty-transport-native-epoll-4.1.50.Final-linux-x86_64.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989) [netty-common-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) [netty-common-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-common-4.1.50.Final.jar:4.1.50.Final]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at java.lang.Thread.run(Unknown Source) [?:?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger: "io.grpc.netty.NettyServerHandler"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message: "Stream Error"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceContext: {…}   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  thread: "grpc-default-worker-ELG-1-1"   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Created an issue for this: <a href="https://github.com/zeebe-io/zeebe/issues/4928" target="_blank" rel="noopener noreferrer">#4928</a></p><p>I will probably continue with this next week.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Extract K8 resources from namespace]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/07/02/extract-k8-resources</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/07/02/extract-k8-resources"/>
        <updated>2020-07-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Research: Read about DiRT (Disaster Recovery Tests) @ google - gave me same new ideas for more game days]]></summary>
        <content type="html"><![CDATA[<ul><li>Research: Read about DiRT (Disaster Recovery Tests) @ google - gave me same new ideas for more game days</li><li>Failure documentation about Log Appender</li></ul><p>Unfortunately I had no time today for new chaos experiment, but I spent with @pihme some time to investigate how we can run the cluster plans in our gke.
We did a bit of progress. I'm finally able to create cluster plans in the ultratest and can extract all resource definitions via command line.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pvc,configmap,service,deployment,statefulset,cronjob,storageclasses -o yaml --export </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">'/resourceVersion: "[0-9]\+"/d'</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">'/uid: [a-z0-9-]\+/d'</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">'/selfLink: [a-z0-9A-Z/]\+/d'</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">'/status:/d'</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">'/phase:/d'</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">'/creationTimestamp:/d'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> s-cluster.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We now need to find a way to successfully deploy it in our cluster - it haven't been successful yet. We thought about using kustomize to adjust some values they use.
Much easier would be to just deploy the operator they use in our gke cloud and use the CRD to deploy the cluster plans. I think we need to investigate a bit more here what is the best approach. In the end I would like to run our chaos experiments against clusters which correspond to the real deployed ones.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@pihme</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Gateway Network Partition]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/06/25/gateway-network-partition</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/06/25/gateway-network-partition"/>
        <updated>2020-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Documented failure cases for AsyncSnasphortDirector. Gave me some ideas where it might make sense to reinstall partition. Discussed a bit with @Deepthi]]></summary>
        <content type="html"><![CDATA[<ul><li>Documented failure cases for AsyncSnasphortDirector. Gave me some ideas where it might make sense to reinstall partition. Discussed a bit with @Deepthi</li><li>Still our automated chaos experiments are not running. I need some time for that, but I had no time for that today.</li><li>Run a chaos experiment together with @pihme, where we do a network partition with the gateway.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos experiment:<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos experiment:" title="Direct link to Chaos experiment:">​</a></h2><p>Actually we already have an network partition experiment with the standalone Gateway, where we completely isolate the gateway and take a look whether it comes back after the network partition. Today we wanted to explore how it behaves when only one node and the gateway has a network partition, so Broker 0 and Gateway can't talk to each other.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected-during-the-experiment">Expected during the experiment:<a href="#expected-during-the-experiment" class="hash-link" aria-label="Direct link to Expected during the experiment:" title="Direct link to Expected during the experiment:">​</a></h3><p>the topology stays the same, since gateway can ping indirectly (is discussable whether this is ideal or not)
when Broker 0 is leader for a partition then the processing for that partition stops but other partitions should not be affected
We can somehow determine in the metrics that they can't connect to each other
After connecting again the affected partition should recover</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="observations">Observations:<a href="#observations" class="hash-link" aria-label="Direct link to Observations:" title="Direct link to Observations:">​</a></h3><p>As expected we see no difference in the Topology. All commands which are send to that partition time out. Other partitions haven't been affected 👍 With the metrics we have we seen that: there is no progress in the partition, the partition is still healthy (which makes sense) and we see a lot of timeouts happening.</p><p>Unfortunately we need multiple metrics to correlate somehow that it might be due to connectivity issues. I think we can improve here. For example it is not directly visible that one partition stopped processing. For that @Peter Ihme had a good idea and we will add a new panel, which directly shows the current record processing stats. I think this is also useful for exporting to directly see whether we have currently exporting problems. Check the attached image.</p><p>What else is missing on the metrics side from my point of view:</p><ul><li>a panel which shows me that all requests to a specific partition currently time out.</li><li>metrics for the transport between gateway and broker to better analyze problems like that. Would be nice to have <a href="https://github.com/zeebe-io/zeebe/issues/4487" target="_blank" rel="noopener noreferrer">#4487</a> </li><li>Liveness and Health stats of the Gateway in the metrics. I think this is currently not supported?</li></ul><p>After reconnecting the nodes we saw that the related partition started to process again. Interesting was that it seems that there piled some traffic up and after reconnecting we saw a burst against partition one (partition 2 was disconnected), but this caused no issues.</p><p>I think was good and interesting experiment again and gave us a bit more insights what else we need.</p><p><img loading="lazy" alt="feedback" src="/zeebe-chaos/assets/images/feedback-b0105cf21496aacb85b4ded1a34e3b9b.png" width="1837" height="890" class="img_ev3q"></p><p><img loading="lazy" alt="reduce2" src="/zeebe-chaos/assets/images/reduce2-4f08deb101d3ceaee52e4d64b09e8ddb.png" width="1825" height="667" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@pihme</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Correlate Message after failover]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/06/18/correlate-message-after-failover</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/06/18/correlate-message-after-failover"/>
        <updated>2020-06-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Documented failure cases for engine and stream processor. I think almost all possible failure cases I can think of we already handle, except problems on reading, which I think can't be handled.]]></summary>
        <content type="html"><![CDATA[<ul><li>Documented failure cases for engine and stream processor. I think almost all possible failure cases I can think of we already handle, except problems on reading, which I think can't be handled.</li><li>Checked what the current issue is with the automated chaos experiments. It seems it is a infra problem. You can check the discussion in #infra. It might be affected due to <a href="https://jira.camunda.com/browse/INFRA-1292" target="_blank" rel="noopener noreferrer">Infra-1292</a></li><li>Run a chaos experiment, where we correlate a message after fail over.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2><ul><li>Start our normal setup and deploy a workflow with an intermediate message catch event.</li><li>Publish a message and kill a random broker.</li><li>Create a workflow instance and await the result.</li></ul><p>I did this experiment several times and it works without any problems, as far as I can tell. First I was wondering that the message was only correlated to one instance, but this seems to be expected <a href="https://docs.zeebe.io/reference/message-correlation/message-correlation.html#message-cardinality" target="_blank" rel="noopener noreferrer">message-correlation.html#message-cardinality</a> So learned something new today about our messages 😁.</p><p>I prepared already an automatable chaos experiment for that. Have to fine tune it a bit.</p><p>No pictures today.</p>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[High CPU load on Standalone Gateway]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/06/11/high-cpu-gateway</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/06/11/high-cpu-gateway"/>
        <updated>2020-06-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[* Updated failure cases documentation for exporter based on review]]></summary>
        <content type="html"><![CDATA[<ul><li>Updated failure cases documentation for exporter based on review</li><li>Documented failure cases for ZeebeDB</li><li>Wrote an chaostoolkit experiment based on the last manual Chaos experiment</li><li>Run a chaos experiment with @Deepthi, where we put high CPU load on the standalone gateway <a href="https://github.com/zeebe-io/zeebe-chaos/issues/28" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe-chaos/issues/28</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos experiment:<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos experiment:" title="Direct link to Chaos experiment:">​</a></h2><p>We did today an chaos experiment where we used our standard setup with a baseline load of 100 workflow instance and 6 workers, which can activate 120 jobs max.
On our steady state we saw that we are able to start and complete 100 workflow instances in a second. One instance took 1 - 2.5 seconds.</p><p>We expected when we introduce stress on the standalone gateway CPU that the latency of the processing goes up and the throughput goes down, but there should be no cluster wide failures happening. We expected that after removing the stress the system should come back to normal and the baseline should be reached again.</p><p><img loading="lazy" alt="/assets/2020-06-11/gw-stress-proc" src="/zeebe-chaos/assets/images/gw-stress-proc-10e34653c245822fd9bdc216e82b87fa.png" width="1827" height="612" class="img_ev3q">
<img loading="lazy" alt="/assets/2020-06-11/gw-cpu" src="/zeebe-chaos/assets/images/gw-cpu-4fb1a8297395d890b879ce25f6d82433.png" width="918" height="309" class="img_ev3q">
<img loading="lazy" alt="/assets/2020-06-11/gw-stress-proc-latency" src="/zeebe-chaos/assets/images/gw-stress-proc-latency-7f90a7904267f553730c5b85ceac779a.png" width="1833" height="880" class="img_ev3q"></p><p>The results look promising. We have seen no outage.
We tested it twice and saw that the throughput goes down and latency up on stress, but comes back to normal after removing it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-was-unexpected-or-what-we-found-out">What was unexpected or what we found out:<a href="#what-was-unexpected-or-what-we-found-out" class="hash-link" aria-label="Direct link to What was unexpected or what we found out:" title="Direct link to What was unexpected or what we found out:">​</a></h3><p>Unexpected was that our Broker back pressure goes up, which means it drops requests during the stress time. This was not expected, since the latency between writing to dispatcher and processing the event should not change. We probably need to investigate this more. Current assumption is that the gateway sends requests in batches and this causes in higher spikes on the back pressure. We need more metrics on the transport module to verify that. There is already an open issue for that <a href="https://github.com/zeebe-io/zeebe/issues/4487" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe/issues/4487</a> We might need to tackle this, before we can find out more here.</p><p>We found out that the standalone gateway is not resource limited, which caused that we used at some point 12 CPU cores. It seems there is also an open issue for that on the helm charts <a href="https://github.com/zeebe-io/zeebe-cluster-helm/issues/74" target="_blank" rel="noopener noreferrer">https://github.com/zeebe-io/zeebe-cluster-helm/issues/74</a></p><p>We want to improve on our current chaos toolkit test. We want to introduce failures and verify the steady state during the failure is happening, on rollback we should remove the failure again. We currently just verify that we can recover, but not the behavior during a failure, which might be also interesting.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@deepthidevaki</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[First Chaos Day!]]></title>
        <id>https://zeebe-io.github.io/zeebe-chaos/2020/06/04/first-chaos-day</id>
        <link href="https://zeebe-io.github.io/zeebe-chaos/2020/06/04/first-chaos-day"/>
        <updated>2020-06-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[First Chaos day]]></summary>
        <content type="html"><![CDATA[<p>First Chaos day 🎉</p><ul><li>Documented failure cases for exporter (already some exist, it seemed) gave me a new idea for ZEP</li><li>Introduced Peter to our Chaos Repository, discussed a bit about the hypothesis backlog, reopened the Chaos Trello board where we will organize ourselves</li><li>Run a chaos experiment, where we put high CPU load on the Leader <a href="https://github.com/zeebe-io/zeebe-chaos/issues/6" target="_blank" rel="noopener noreferrer">#6</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos experiment:<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos experiment:" title="Direct link to Chaos experiment:">​</a></h2><ul><li>We wanted to decrease the blast radius with only one partition, but we found an bug where this seemed not to be possible <a href="https://github.com/zeebe-io/zeebe/issues/4664" target="_blank" rel="noopener noreferrer">#4664</a></li><li>We run the experiment with 2 partitions and put really high CPU load on the Leader (internally in the pod), we expected that this will not impact the complete cluster. That at most we have a leader change because the leader is not able to send heartbeats in time. After removing the cpu load we should be back on our throughput base line, where we start and complete around 70 - 80 workflow instances per second.</li><li>The results where quite promising we had no leader change at all. The leader was able to send heartbeats in time and the backpressure did a good job and drop more requests. After reducing the cpu load we went back to our steady state. </li></ul><p><img loading="lazy" alt="img" src="/zeebe-chaos/assets/images/result-chaos-e2969de362a91b1b965fe1c02be05202.png" width="906" height="859" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="participants">Participants<a href="#participants" class="hash-link" aria-label="Direct link to Participants" title="Direct link to Participants">​</a></h2><ul><li>@pihme</li><li>@zelldon</li></ul>]]></content>
        <author>
            <name>Christopher Zell</name>
            <uri>https://github.com/zelldon</uri>
        </author>
    </entry>
</feed>