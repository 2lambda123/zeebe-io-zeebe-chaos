<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Blog Atom Feed"><title data-react-helmet="true">4 posts tagged with &quot;availability&quot; | Zeebe Chaos</title><meta data-react-helmet="true" property="og:title" content="4 posts tagged with &quot;availability&quot; | Zeebe Chaos"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/tags/availability"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-react-helmet="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/tags/availability"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/tags/availability" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/tags/availability" hreflang="x-default"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.473f1099.css">
<link rel="preload" href="/zeebe-chaos/assets/js/runtime~main.3edf790c.js" as="script">
<link rel="preload" href="/zeebe-chaos/assets/js/main.63c64d72.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>4 posts tagged with &quot;availability&quot;</h1><a href="/zeebe-chaos/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2021</time> Â· 3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>It has been awhile since the last post, I&#x27;m happy to be back.</p><p>In today&#x27;s chaos day we want to verify the hypothesis from <a href="https://github.com/zeebe-io/zeebe-chaos/issues/34" target="_blank" rel="noopener noreferrer">zeebe-chaos#34</a> that old
clients can&#x27;t disrupt a running cluster.</p><p>It might happen that after upgrading your Zeebe to the newest shiny version, you might forget to
update some of your workers or starters etc. This should normally not an issue since Zeebe is
backwards compatible, client wise since 1.x. But what happens when older clients are used. Old
clients should not have a negative effect on a running cluster.</p><p><strong>TLDR</strong> Older clients (0.26) have no negative impact on a running cluster (1.2), and clients after
1.x are still working with the latest version. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>We will run a simple setup with, three nodes and three partitions (replication factor 3). The
version we use is the latest release candidate (1.2.0). Normally we run a load of 200 process
instances per second (pi/s) on our benchmarks. This time we will put a load of 100 pi/s to get
something running and start an old starter (v0.26.x) with the same frequency. Later we will scale
the old starter to see whether it makes any effect.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p>We expect that we can start and complete the 100 pi/s, since we can normally run 200 pi/s.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><p>The cluster was first started with starters of the same version, and we saw a stable load of ~100
process instances completed per second. After starting the old starters (with version 0.26.3), we
can&#x27;t observe any difference. </p><p>Interesting is even when scaling the starters up to 10 replicas, which means 1000 PI creations per
second, it doesn&#x27;t seem to make any effect. <em>Side note:</em> The
<a href="https://github.com/camunda-cloud/zeebe/tree/develop/benchmarks/project" target="_blank" rel="noopener noreferrer">starters</a> have been
modified, such they only start instances without deploying the model.</p><p><img alt="old26-general" src="/zeebe-chaos/assets/images/old26-general-1cbfdf95d7c9b19cad8ca10aa921f34b.png"></p><p>The drops we see in the processing are related to restart&#x27;s.</p><p>The gateway and grpc metrics doesn&#x27;t indicate that more requests are sent. </p><p><img alt="old26-grpc" src="/zeebe-chaos/assets/images/old26-grpc-b5da2bbcf038492c59dea93f36619e69.png">
<img alt="old26-gateway" src="/zeebe-chaos/assets/images/old26-gateway-dd4afa5333796343795b4d80ad498e6b.png"></p><p>If we take a look in the clients log, we can see that the request are failing because the RPC Method names have been changed between 0.26 and 1.0. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">java.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: UNIMPLEMENTED: Method not found: gateway_protocol.Gateway/CreateWorkflowInstance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: io.grpc.StatusRuntimeException: UNIMPLEMENTED: Method not found: gateway_protocol.Gateway/CreateWorkflowInstance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It seems this kind of &quot;old&quot; requests can be blocked quite early in the request chain to make no effect. </p><p>In order to experiment a bit further I created a starter image with version 1.0 to see whether this still works with our newest release candidate 1.2.</p><p>We can see in the metrics right after starting the starter that the throughput goes up and we can reach our 200 pi/s.</p><p><img alt="old10-general" src="/zeebe-chaos/assets/images/old10-general-90bb179937d9178c12b16f0cdea22281.png"></p><p>We run the benchmark overnight, and we haven&#x27;t seen any issues. Be aware that the throughput is calculated over the 24h which makes is lower than 200.</p><p><img alt="general" src="/zeebe-chaos/assets/images/general-67c5d494df6c66211457861139475c6c.png"></p><p>Furthermore, taking a look at the resource consumption, especially at the gateway, gives no evidence that something wrong is going on.</p><p><img alt="res" src="/zeebe-chaos/assets/images/res-951c069149e3ae14d08a997e6fe974b2.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p>We were able to confirm the hypothesis written in <a href="https://github.com/zeebe-io/zeebe-chaos/issues/34" target="_blank" rel="noopener noreferrer">zeebe-chaos#34</a>, that an old client can&#x27;t disrupt a running cluster. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="found-bugs"></a>Found Bugs<a class="hash-link" href="#found-bugs" title="Direct link to heading">#</a></h2><p>None this time :)</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col col--3 text--right"><a aria-label="Read more about Old-Clients" href="/zeebe-chaos/2021/09/23/Old-Clients"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-06T00:00:00.000Z" itemprop="datePublished">July 6, 2021</time> Â· 6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On a previous <a href="/zeebe-chaos/2020/10/06/toxi-proxy">Chaos Day</a> we played around with <a href="https://github.com/Shopify/toxiproxy" target="_blank" rel="noopener noreferrer">ToxiProxy</a> , which allows injecting failures on the network level. For example dropping packages, causing latency etc.</p><p>Last week <a href="https://github.com/deepthidevaki" target="_blank" rel="noopener noreferrer">@Deepthi</a> mentioned to me that we can do similar things with <a href="https://man7.org/linux/man-pages/man8/tc.8.html" target="_blank" rel="noopener noreferrer">tc</a>, which is a built-in linux command. Today I wanted to experiment with latency between leader and followers using <code>tc</code>.</p><p><strong>TL;DR;</strong> The experiment failed; With adding 100ms network delay to the Leader we broke the complete processing throughput. ðŸ’¥</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>We want to experiment with network latency and what kind of effect has a slow network on the cluster. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="hypothesis"></a>Hypothesis<a class="hash-link" href="#hypothesis" title="Direct link to heading">#</a></h3><p>We expect that we can handle certain network latency, due to our heartbeat and election time timeouts. After, reaching the deadlines we expect fail overs and followers which are lagging behind.</p><p>This means under a certain threshold we should be able to still process user commands, with slightly delay but without real issues. After reaching the deadline and the fail overs, it should be possible to continue, since we will add only to one node the delay.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="experiment"></a>Experiment<a class="hash-link" href="#experiment" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="tc"></a>TC<a class="hash-link" href="#tc" title="Direct link to heading">#</a></h4><p>TC is a built in linux command, the manpage summarizes it as <code>tc - show / manipulate traffic control settings</code>.</p><p>In order to <a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener noreferrer">add delay to a network interface</a>, we can run the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">tc qdisc </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> dev eth0 root netem delay 200ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>More details (<a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener noreferrer">taken from the blog post</a>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">qdisc: modify the scheduler (aka queuing discipline)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">add: add a new rule</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev eth0: rules will be applied on device eth0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root: modify the outbound traffic scheduler (aka known as the egress qdisc)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">netem: use the network emulator to emulate a WAN property</span></span><span class="token-line" style="color:#393A34"><span class="token plain">delay: the network property that is modified</span></span><span class="token-line" style="color:#393A34"><span class="token plain">200ms: introduce delay of 200 ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Adding this kind of rule means that we add a delay to all outgoing connections, which are going over this network interface.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h4><p>In order to reduce the blast radius we will run the experiment with one partition on a three broker cluster (replication factor 3).</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="steady-state"></a>Steady State<a class="hash-link" href="#steady-state" title="Direct link to heading">#</a></h5><p> As we can see in the benchmark we are able to reach in avg. ~77 process instance creation and completions per second.</p><p><img alt="base" src="/zeebe-chaos/assets/images/general-18fcb0bda36206ab196aeb507a0c1eac.png"></p><p>The process instance execution time (from start to end) is under 1 second.
<img alt="base" src="/zeebe-chaos/assets/images/latency-50564f2ce63c84257c134178924d2c57.png"></p><p>The commit latency is about 100 ms.
<img alt="base" src="/zeebe-chaos/assets/images/commit-lat-9b72095b6933ef77b97f994ece9d17f9.png"></p><p>We can see that one of the followers is a bit lagging behind, but not too far.</p><p><img alt="base" src="/zeebe-chaos/assets/images/raft-follower-7e8113946fa0a082e57f5ae190a21baa.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="100-ms"></a>100 ms<a class="hash-link" href="#100-ms" title="Direct link to heading">#</a></h5><p>In the first iteration of the experiment we added a 100 ms delay to the leaders outgoing traffic. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos-day/ cluster: zeebe-cluster ns:zell-chaos-day]$ k exec -it zell-chaos-day-zeebe-gateway-579c76978f-npz2k -- zbctl status --insecure</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Cluster size: 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Partitions count: 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Replication factor: 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Gateway version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Brokers:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Broker 0 - zell-chaos-day-zeebe-0.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Follower, Healthy  Broker 1 - zell-chaos-day-zeebe-1.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Follower, Healthy  Broker 2 - zell-chaos-day-zeebe-2.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26501</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Version: 1.1.0-SNAPSHOT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Partition 1 : Leader, Healthy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Based on the <code>zbctl</code> output, or the grafana dashboard we can find out who is the leader. Note that the output of <code>zbctl</code> looks still a bit broken, related issue <a href="https://github.com/camunda-cloud/zeebe/issues/6692" target="_blank" rel="noopener noreferrer">#6692</a>.</p><p>With the following commands we can add the delay of 100 ms to the leaders outgoing traffic.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">[zell zell-chaos-day/ cluster: zeebe-cluster ns:zell-chaos-day]$ k exec -it zell-chaos-day-zeebe-2 -- bash</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-day-zeebe-2:/usr/local/zeebe# tc qdisc add dev eth0 root netem delay 100ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">root@zell-chaos-day-zeebe-2:/usr/local/zeebe# tc -s qdisc</span></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc noqueue 0: dev lo root refcnt 2 </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> backlog 0b 0p requeues 0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">qdisc netem 8001: dev eth0 root refcnt 2 limit 1000 delay 100.0ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Sent 11635496 bytes 10086 pkt (dropped 0, overlimits 0 requeues 0) </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> backlog 339773b 77p requeues 0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Almost immediately we see a drop in our general section of the Grafana Dashboard.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-general-a6a99e2144909bf47c029ebcd8543f33.png"></p><p>The backpressure increased significantly. As expected the commit latency increased.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-commit-lat-e9f2fb099ca82d84761ef6ffaca428db.png"></p><p>The processing latency as well.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-latency-85f7dc47d9d5606469244efc363cc638.png"></p><p>It was unexpected that the throughput breaks down so much. We can see in the send request that a lot of the requests are ended with timeouts or with resource exhausted.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-grpc-5c44c33e0cfa6d55da14c7cc5092c705.png">
<img alt="base" src="/zeebe-chaos/assets/images/100ms-gateway-767136da5cb5e9032275d4ee41b05fff.png"></p><p>Interesting is that no worker is able to activate nor complete any job. This cause increasing of the running process instances, so the state is growing.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-running-proc-8f4fadc0b12cf5ae463c8f82894c5cd5.png"></p><p>Taking a look at the raft metrics we see that this already caused some heartbeat misses, but no leader change.</p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-heartbeats-1b9a59af419679228f9d703afe1819e9.png"></p><p><img alt="base" src="/zeebe-chaos/assets/images/100ms-follower-93ff4bcec9b9cba018a65268f6f069d0.png"></p><p>The follower is now lagging far more behind. We can see in the logs that the Leader tries to send <code>InstallRequests</code>, but these are also timing out.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">raft-partition-partition-1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> - InstallRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">currentTerm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">index</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1173627</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">term</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">chunkId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1744147670</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">nextChunkId</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1283029304</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">position</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">remaining</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">capacity</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">mark</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">java.nio.HeapByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">lim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">cap</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10626817</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1083445787</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">initial</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false, </span><span class="token assign-left variable" style="color:#36acaa">complete</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> failed: java.util.concurrent.CompletionException: java.util.concurrent.TimeoutException: Request ProtocolRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">489616</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">subject</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">raft-partition-partition-1-install, </span><span class="token assign-left variable" style="color:#36acaa">sender</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zell-chaos-day-zeebe-2.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26502, </span><span class="token assign-left variable" style="color:#36acaa">payload</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10647731</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1655826849</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> to zell-chaos-day-zeebe-1.zell-chaos-day-zeebe.zell-chaos-day.svc.cluster.local:26502 timed out </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> PT5S&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The follower is starting regularly elections, but is not able to overturn the existing leader.</p><p>In general, in the Gateway logs we can see the start of the delay injection quite good. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:51.263195Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:53.264480Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.184981Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.213904Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.361408Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:54.986270Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:56.617134Z Received REACHABILITY_CHANGED </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> broker </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> nothing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.072707Z Expected to handle gRPC request, but request timed out between gateway and broker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.126207Z Expected to handle gRPC request, but request timed out between gateway and broker</span></span><span class="token-line" style="color:#393A34"><span class="token plain">D </span><span class="token number" style="color:#36acaa">2021</span><span class="token plain">-07-06T10:05:57.157683Z Expected to handle gRPC request, but request timed out between gateway and broker</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Similar logs we see on the broker side.</p><p>In general, we can say the experiment failed. The cluster was not able to run our normal workload. It seem to behave quite bad, but there were no leader change at all.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="250-ms"></a>250 ms<a class="hash-link" href="#250-ms" title="Direct link to heading">#</a></h5><p>In order to verify whether 250 ms, will cause a leader election we reconfigured the delay. It looked quite similar, performance wise, but the heartbeats for one of the followers increased. Still it was not enough to cause a leader change.</p><p>After several minutes (~30) of running this configuration we were able to observe that one of the other followers missed heartbeats as well. This finally caused a leader change.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-raft-55d2027e863459de3a070d017e813d59.png"></p><p>The throughput came back, it was similar to what is was before.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-general-95e282a9fbe58ff95fe883e7d80c2739.png"></p><p>The processing execution latency was higher than usual.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-latency-0dd3474f142f7d3642605a2b8353186d.png"></p><p>Similar to the commit latency, interesting to see such an affect caused by a follower with network issues.</p><p><img alt="base" src="/zeebe-chaos/assets/images/250ms-commit-lat-0a8e3826a19cdea9b948f42fa639bd6f.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p>As written before the experiment failed, the hypothesis was not met. We were not able to add latency to the network, which is much lower than our deadlines (heartbeat timeout is 2.5 seconds), without causing any harm to our processing throughput/latency.</p><p>Still we had some interesting observations we can use for our next experiments and insight which we need to consider on setting up Zeebe in environment where the network might be unreliable/slow.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col col--3 text--right"><a aria-label="Read more about Slow Network" href="/zeebe-chaos/2021/07/06/Slow-Network"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-08T00:00:00.000Z" itemprop="datePublished">June 8, 2021</time> Â· 8 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>On this chaos day we wanted to experiment with OOD recovery and ELS connection issues. This is related to the following issues from our hypothesis backlog: <a href="https://github.com/zeebe-io/zeebe-chaos/issues/32" target="_blank" rel="noopener noreferrer">zeebe-chaos#32</a> and <a href="https://github.com/zeebe-io/zeebe-chaos/issues/14" target="_blank" rel="noopener noreferrer">zeebe-chaos#14</a>. This time <a href="https://github.com/korthout" target="_blank" rel="noopener noreferrer">@Nico</a> joined me.</p><p><strong>TL;DR</strong> The experiment was successful ðŸ’ª and we found several things in the dashboard which we can improve :)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>With this experiment we want to verify that Zeebe can recover after OOD, which was caused by not exporting to ELS. For that we want to disconnect Zeebe and ELS first and see how it behaves. Afterwards we connect the services again and expect a recovery of the system.</p><p>As usual, we have set up a normal benchmark cluster with three nodes, three partitions and replication factor three. We run 200 PI/s and 12 workers against that cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p>We expect the following properties:</p><ul><li>at the beginning the system is stable (we can start instances without issues)</li><li>after disconnecting ELS we start to fill the disk, since we can&#x27;t export (which means we can&#x27;t compact)</li><li>after reaching the disk limits, Zeebe doesn&#x27;t accept any commands anymore</li><li>after connecting ELS, Zeebe should start to export again (compacting should be possible again)</li><li>after come below the limit, Zeebe should accept commands again</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="network-disconnect-to-els"></a>Network disconnect to ELS<a class="hash-link" href="#network-disconnect-to-els" title="Direct link to heading">#</a></h4><p>In order to disconnect the Brokers with ELS, we wanted to reuse one of our network disconnect scripts, e.g. <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/disconnect-leaders.sh" target="_blank" rel="noopener noreferrer">disconnect-leaders.sh</a>. This resolves the IP&#x27;s of the brokers and creates an unreachable route via the <code>ip</code> tool at the given brokers.</p><p>We copied that and adjusted it to our needs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;elasticsearch-master&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic0Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-0&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic1Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-1&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elastic2Ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$elasticName</span><span class="token variable string" style="color:#e3116c">-2&quot;</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$namespace</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> --template</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{{.status.podIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic0Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic1Ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elastic2Ip</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Small note in order to run this against the benchmark cluster you need to set the following environment variables:</em></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">NAMESPACE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubens -c</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># the namespace where the resources are located</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">CHAOS_SETUP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">helm </span><span class="token comment" style="color:#999988;font-style:italic"># indicates that the installation is done via helm, necessary since we use different labels in the helm charts and in CC.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Running the script above didn&#x27;t work as expected. We still saw records being exported. The issue was that we need to use the service IP instead of the IP&#x27;s of the elastic search pods. The Broker uses only the service to connect with ELS. In order to get the IP we can use this <code>kubectl get services elasticsearch-master --template &quot;{{.spec.clusterIP}}&quot;</code>. </p><p>The service will take care of the request routing, which means we just need to block one IP. This helps to simplify the disconnect script.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -exuo pipefail</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> utils.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getNamespace</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;elasticsearch-master&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker0</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker2</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">broker1</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">getBroker </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">elasticServiceIp</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get services elasticsearch-master --template </span><span class="token variable string" style="color:#e3116c">&quot;{{.spec.clusterIP}}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># we put all into one function because we need to make sure that even after preemption the </span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># dependency is installed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#d73a49">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">toChangedPod</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">targetIp</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># update to have access to ip</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y iproute2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$toChangedPod</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -n </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$namespace</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -- </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> unreachable </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$targetIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker0</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$broker2</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$elasticServiceIp</span><span class="token string" style="color:#e3116c">&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><p>In this section we will describe how we experienced the chaos experiment and what we observed. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="first-try"></a>First Try<a class="hash-link" href="#first-try" title="Direct link to heading">#</a></h4><p>We run the disconnect script and were able to observe that the exporting stopped. </p><p><img alt="elastic-disconnect" src="/zeebe-chaos/assets/images/elastic-disconnect-5638a32fadfab9b778b02fe14a1d3ed7.png"></p><p>As expected we were no longer able to compact, which cause an increasing of log segments.</p><p><img alt="increase-segments" src="/zeebe-chaos/assets/images/increase-segments-bd8431b8424f7c0b8fb0d44307c2ab42.png"></p><p>We realized that our current disk size might be too big (it would take a while until we fill it), so we decided to setup a new benchmark with smaller size and different watermarks.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGECOMMANDWATERMARK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.6&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ZEEBE_BROKER_DATA_DISKUSAGEREPLICATIONWATERMARK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.8&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># PVC</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcAccessMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ReadWriteOnce&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16Gi</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pvcStorageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ssd</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We thought that we might have different performance, because of such a smaller disk size, but this was not the case. We were able to reach the same level, might be worth to think about reducing the disk sizes more in our benchmarks.</p><p><img alt="base" src="/zeebe-chaos/assets/images/next-try-base-12b9f5871392bd43fe1f31224479aa6d.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="second-try"></a>Second Try<a class="hash-link" href="#second-try" title="Direct link to heading">#</a></h4><p><img alt="base1" src="/zeebe-chaos/assets/images/next-try-base1-649226bc28407a654bad7078dca639a0.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="disconnecting"></a>Disconnecting<a class="hash-link" href="#disconnecting" title="Direct link to heading">#</a></h5><p>After running our disconnect script we can immediately see that the exporting is stopping.</p><p><img alt="drop-base" src="/zeebe-chaos/assets/images/next-try-drop-base-4fe3db248fb58bb7fdfef0b08e8b8cd1.png"></p><p>Interesting is the elastic section where we see one of our new panels in actions which shows the failure rate. There are two dots, which show the 100% failure rate.</p><p><img alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png"></p><p>After reaching our disk watermark we can see that the processing stops, and we no longer accept commands.</p><p><img alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png"></p><p>The cluster turns to unhealthy, which is expected.</p><p>Interesting is that we have no metrics at all on the gateway side after reaching the watermark.</p><p><img alt="drop-gw" src="/zeebe-chaos/assets/images/next-try-drop-gw-a0e7f885194b47559bb07c6ad46942d0.png"></p><p>We were able to verify that snapshots are still taken, but no compaction.</p><p><img alt="drop-snapshot" src="/zeebe-chaos/assets/images/next-try-drop-snapshot-d38bd5b1657f7b5a4fa763b26ebba239.png"></p><p>No segments are deleted during this time.</p><p><img alt="drop-segments" src="/zeebe-chaos/assets/images/next-try-drop-segments-3d49aaadb3d3455c25a920281a6c9595.png"></p><p>If we take a look at the processing section we can see that the exporters lag way behind, which of course makes sense.</p><p><img alt="drop-processing" src="/zeebe-chaos/assets/images/next-try-drop-processing-4dc3f1fafd42d2e6560cde27e53a3aa2.png"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="connecting"></a>Connecting<a class="hash-link" href="#connecting" title="Direct link to heading">#</a></h5><p>Luckily we were able to reuse on of our already written reconnect scripts for this experiment, see <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-experiments/scripts/connect-leaders.sh" target="_blank" rel="noopener noreferrer">connect-leaders.sh</a>.</p><p>After removing the ip route (connecting the Brokers with ELS again) we can see that it immediately starts to export again.</p><p><img alt="connect-base" src="/zeebe-chaos/assets/images/next-try-connect-base-dfe3501b990f198861825cec2fb00735.png"></p><p>When we went under the disk watermarks the processing started again and we accepted new commands.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="result"></a>Result<a class="hash-link" href="#result" title="Direct link to heading">#</a></h3><p><img alt="connect-base2" src="/zeebe-chaos/assets/images/next-try-connect-base2-375310b94ccc02fe3333b76954351a44.png"></p><p><strong>The experiment was successful, our system was able to recover after an elastic network outage and handled it properly.</strong> âœ… ðŸ’ª</p><p>We noted several issues with the Dashboard, during the chaos experiment observation. For example the Brokers, which went OOD, never went back to the <code>Healthy</code> state again.</p><p><img alt="connect-healthy" src="/zeebe-chaos/assets/images/next-try-connect-healthy-124040b24b536d608e5c1d94eebabbc6.png"></p><p>Furthermore, the not exported panel seems to be broken, depending on the selected time frame.</p><p><img alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png"></p><p>There have been also other issues with the panels and sections which we should take a look at. I have listed them below.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="possible-improvements"></a>Possible Improvements<a class="hash-link" href="#possible-improvements" title="Direct link to heading">#</a></h3><p>We observed several issues with the grafana dashboard which I wrote down here. I will create issues or PR&#x27;s to resolve them.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="general-metric-section"></a>General Metric Section<a class="hash-link" href="#general-metric-section" title="Direct link to heading">#</a></h4><p>If we take a look at the screenshot where we reach our disk watermarks, and the processing stops, the backpressure metrics are not correctly updated. We would expect that the backpressure shows 100%, since all requests are rejected.</p><p><img alt="drop-base-2" src="/zeebe-chaos/assets/images/next-try-drop-base-2-908ab8f573d0460900504da7b122c5e9.png"></p><p>After the cluster actually becomes healthy again (it accepts new commands) it is not shown as healthy in the panels. The metrics seems not to be updated.</p><p>Another possible improvement would be to make it more visible that the exporting stopped. One idea is to split the processing into exporting and processing, so having two graphs might help.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="processing-section"></a>Processing Section<a class="hash-link" href="#processing-section" title="Direct link to heading">#</a></h4><p>Depending on the time frame the panel <code>Number of records not exported</code>, seems to show quite high values.</p><p><img alt="connect-not-exported" src="/zeebe-chaos/assets/images/next-try-connect-not-exported-afa9d7092c5a219305b92e807e874d06.png"></p><p>If we take a look at other metrics, this doesn&#x27;t make any sense. If we had such a backlog we wouldn&#x27;t expect to compact to one segment for example. Furthemore the tables on the right side show numbers which are quite close to each other.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="elastic-metrics-section"></a>Elastic Metrics Section<a class="hash-link" href="#elastic-metrics-section" title="Direct link to heading">#</a></h4><p>We probably can improve the failure panel, such that it shows a graph, and the limit is not set to 130%.</p><p><img alt="drop-elastic" src="/zeebe-chaos/assets/images/next-try-drop-elastic-section-3e81b323923abc8ed78de26765ad9cfe.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="grpc-metric-section"></a>GRPC Metric Section<a class="hash-link" href="#grpc-metric-section" title="Direct link to heading">#</a></h4><p>The panel <code>gRPC requests</code> should have an dec ordering on the tooltip and should be renamed to <code>Total gRPC requests</code> it was a bit confusing to us.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="throughput-section"></a>Throughput Section<a class="hash-link" href="#throughput-section" title="Direct link to heading">#</a></h4><p>The StreamProcessor vs Exporter panel has no data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="snapshot-section"></a>Snapshot Section<a class="hash-link" href="#snapshot-section" title="Direct link to heading">#</a></h4><p>We saw that snapshots are created, but the Snapshot replication panel show no data. It seem to be broken (again?).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="resources-section"></a>Resources Section<a class="hash-link" href="#resources-section" title="Direct link to heading">#</a></h4><p>The JVM panel has the legend on the right side, which makes it hard to see the metrics if you have multiple windows open on one screen.</p><p>{% if page.author %}<sup><em>Written by: {{page.author}}</em></sup>{% endif %}</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col col--3 text--right"><a aria-label="Read more about Full Disk Recovery" href="/zeebe-chaos/2021/06/08/Full-Disk"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-04-29T00:00:00.000Z" itemprop="datePublished">April 29, 2021</time> Â· 8 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>A while ago we have written an experiment, which should verify that followers are not able to become leader, if they have a corrupted snapshot. You can find that specific experiment <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-experiments/helm/snapshot-corruption" target="_blank" rel="noopener noreferrer">here</a>. This experiment was executed regularly against Production-M and Production-S Camunda Cloud cluster plans. With the latest changes, in the upcoming 1.0 release, we changed some behavior in regard to detect snapshot corruption on followers. </p><p><strong>NEW</strong> If a follower is restarted and has a corrupted snapshot it will detect it on bootstrap and will refuse to
start related services and crash. This means the pod will end in a crash loop, until this is manually fixed.</p><p><strong>OLD</strong> The follower only detects the corrupted snapshot on becoming leader when opening the database. On the restart of a follower this will not be detected.</p><p>The behavior change caused to fail our automated chaos experiments, since we corrupt the snapshot on followers and on a later experiment we restart followers. For this reason we had to disable the execution of the snapshot corruption experiment, see related issue
<a href="https://github.com/zeebe-io/zeebe-cluster-testbench/issues/303" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-cluster-testbench#303</a>.</p><p>In this chaos day we wanted to investigate whether we can improve the experiment and bring it back. For reference, I also opened a issue to discuss the current corruption detection approach <a href="https://github.com/camunda-cloud/zeebe/issues/6907" target="_blank" rel="noopener noreferrer">zeebe#6907</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>This time we look at an already existing experiment. I will run our normal setup and execute the experiment (each step) manually and observe what happens.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="experiment"></a>Experiment<a class="hash-link" href="#experiment" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.1.0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;title&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Zeebe can recover from corrupted snapshots&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Zeebe should be able to detect and recover from corrupted snapshot&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;contributions&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;reliability&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;high&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;availability&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;high&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;steady-state-hypothesis&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;title&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Zeebe is alive&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;probes&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;All pods should be ready&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;probe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;tolerance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;process&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;verify-readiness.sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;timeout&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Should be able to create process instances on partition 3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;probe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;tolerance&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;process&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;verify-steady-state.sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;arguments&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;timeout&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;method&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;action&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Corrupt snapshots on followers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;process&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;corruptFollowers.sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;arguments&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;action&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Terminate leader of partition 3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;provider&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;process&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;shutdown-gracefully-partition.sh&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;arguments&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Leader&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;rollbacks&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As written before we have our normal benchmark setup and I will run the referenced scripts manually and observe the behavior via grafana. The panels below show the base or steady state.
<img alt="before-general" src="/zeebe-chaos/assets/images/before-general-c5e2d4a84d58bfe92397a1950bce66ab.png">
<img alt="before-snap" src="/zeebe-chaos/assets/images/before-snap-af75897dcbf32d097c6a0e79300c23fd.png"></p><p>The first script we will run, corrupts for a certain partition the snapshots of all followers. It does it via just simply deleting some <code>*.sst</code> files.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell scripts/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./corruptFollowers.sh </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">leader</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">zell-chaos-zeebe-1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">followers</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;zell-chaos-zeebe-0</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">zell-chaos-zeebe-2&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kubectl -n zell-chaos </span><span class="token builtin class-name">exec</span><span class="token plain"> zell-chaos-zeebe-0 -- ./corrupting.sh </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partitionDir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">snapshotDir</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$partitionDir</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">/snapshots/*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619 -name </span><span class="token string" style="color:#e3116c">&#x27;*.sst&#x27;</span><span class="token plain"> -print -quit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">fileName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000110.sst</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000110.sst</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ kubectl -n zell-chaos </span><span class="token builtin class-name">exec</span><span class="token plain"> zell-chaos-zeebe-2 -- ./corrupting.sh </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partition</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">partitionDir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">snapshotDir</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$partitionDir</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">/snapshots/*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619 -name </span><span class="token string" style="color:#e3116c">&#x27;*.sst&#x27;</span><span class="token plain"> -print -quit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">fileName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000112.sst</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> data/raft-partition/partitions/3/snapshots/520492-1-1532470-1531619/000112.sst</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The second script just terminated the Leader for the referenced partition.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">zell scripts/ cluster: zeebe-cluster ns:zell-chaos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./terminate-partition.sh </span><span class="token string" style="color:#e3116c">&quot;Leader&quot;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">pod </span><span class="token string" style="color:#e3116c">&quot;zell-chaos-zeebe-1&quot;</span><span class="token plain"> deleted</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>On the first try we had the &quot;luck&quot; that there was a snapshot replication in between, such that the follower was able to become Leader, since it had again a valid snapshot. </p><p><img alt="luck-general" src="/zeebe-chaos/assets/images/luck-general-6284a961fb55242e685ef99a31487f34.png">
<img alt="luck-replication" src="/zeebe-chaos/assets/images/luck-replication-2564925f2731e3c9b5279a8db021b902.png"></p><p>On the second try we were actually able to reproduce the behavior we want to see. We have corrupted the snapshot and restarted the Leader and the partition can make only progress - if the previous leader comes back. This is because the others have a corrupted snapshot and can&#x27;t take over.</p><p><img alt="no-luck-restart-general" src="/zeebe-chaos/assets/images/no-luck-restart-general-1f6e7cdad4128ad263669bf62557bb4f.png">
<img alt="no-luck-restart" src="/zeebe-chaos/assets/images/no-luck-restart-556f37ee3d483e799428e83ad20d1aa5.png"></p><p>In all cases above we were able to make progress. The issue now arises when one of the affected follower is restarted. For our experiment I restarted Broker-2, which was at this point in time follower for Partition 3. After I restarted the follower it first looked like the partition one was completely down.</p><p><img alt="follower-restart-partition-1" src="/zeebe-chaos/assets/images/follower-restart-partition-1-196eaa9f08944822a7eb9bc3e10b3aa1.png"></p><p>After serveral minutes the system recovered and continued.</p><p><img alt="follower-restart-partition-1-cont" src="/zeebe-chaos/assets/images/follower-restart-partition-1-cont-9ea01572ab691821683a0145afeb5c80.png"></p><p>Via Grafana but also via <code>kubectl</code> we can see that the pod doesn&#x27;t become ready again.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          13m</span></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          17m</span></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          5m4s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-854dd5dd5c-b8cpl   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          45m</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  Warning  Unhealthy               4m59s               kubelet                  Readiness probe failed: HTTP probe failed with statuscode: </span><span class="token number" style="color:#36acaa">503</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Warning  Unhealthy               9s </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x30 over 5m9s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  kubelet                  Readiness probe failed: Get http://10.0.29.26:9600/ready: dial tcp </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.29.26:9600: connect: connection refused</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In camunda cloud this will end in a crash loop, because we restart pods after 15 minutes if they are not ready in time. It is interesting to see that it seems not to restart by itself, <strong>which I had expected</strong>. After checking the logs we can also see why.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly md"><pre tabindex="0" class="prism-code language-md codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:44.205851Z RaftServer{raft-partition-partition-1} - Server join completed. Waiting for the server to be READY </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">W 2021-04-29T11:20:44.220338Z Cannot load snapshot in /usr/local/zeebe/data/raft-partition/partitions/3/snapshots/1387684-4-4014493-4014014. The checksum stored does not match the checksum calculated.</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:44.737724Z Loaded disk segment: 33 (raft-partition-partition-3-33.log) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:44.738579Z Found segment: 33 (raft-partition-partition-3-33.log) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.024028Z Loaded disk segment: 34 (raft-partition-partition-3-34.log) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.024688Z Found segment: 34 (raft-partition-partition-3-34.log) </span></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2021-04-29T11:20:45.025826Z Bootstrap Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">6/13</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> cluster</span><span class="token plain"> services failed with unexpected exception. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.038260Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">1/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> subscription</span><span class="token plain"> api </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.040467Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">1/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> subscription</span><span class="token plain"> api closed in 1 ms </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.040926Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">2/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api handler </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:45.042116Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">2/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api handler closed in 1 ms </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:45.042524Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">3/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api transport </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:46.163435Z Created segment: JournalSegment{id=2, index=1556849} </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.065203Z Stopped </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.066007Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">3/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> command</span><span class="token plain"> api transport closed in 2023 ms </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.066552Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">4/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> membership</span><span class="token plain"> and replication protocol </span></span><span class="token-line" style="color:#393A34"><span class="token plain">E 2021-04-29T11:20:47.067664Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">4/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> membership</span><span class="token plain"> and replication protocol failed to close. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.069050Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">5/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> actor</span><span class="token plain"> scheduler </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.069503Z Closing actor thread ground &#x27;Broker-2-zb-fs-workers&#x27; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.071276Z Closing actor thread ground &#x27;Broker-2-zb-fs-workers&#x27;: closed successfully </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.071642Z Closing actor thread ground &#x27;Broker-2-zb-actors&#x27; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.073287Z Closing actor thread ground &#x27;Broker-2-zb-actors&#x27;: closed successfully </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:20:47.074101Z Closing Broker-2 </span><span class="token url-reference url punctuation" style="color:#393A34">[</span><span class="token url-reference url variable" style="color:#36acaa">5/5</span><span class="token url-reference url punctuation" style="color:#393A34">]</span><span class="token url-reference url punctuation" style="color:#393A34">:</span><span class="token url-reference url" style="color:#36acaa"> actor</span><span class="token plain"> scheduler closed in 4 ms </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.074468Z Closing Broker-2 succeeded. Closed 5 steps in 2036 ms. </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">E 2021-04-29T11:20:47.074845Z Failed to start broker 2!</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.078669Z </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Error starting ApplicationContext. To display the conditions report re-run your application with &#x27;debug&#x27; enabled. </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token bold content">E 2021-04-29T11:20:47.093828Z Application run failed</span><span class="token bold punctuation" style="color:#393A34">**</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.120419Z Shutting down ExecutorService &#x27;applicationTaskExecutor&#x27; </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.132016Z RaftServer{raft-partition-partition-1}{role=FOLLOWER} - No heartbeat from null in the last PT2.926S (calculated from last 2926 ms), sending poll requests </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.260582Z RaftServer{raft-partition-partition-1} - Found leader 0 </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.262407Z RaftServer{raft-partition-partition-1} - Setting firstCommitIndex to 1507899. RaftServer is ready only after it has committed events upto this index </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:20:47.263428Z RaftPartitionServer{raft-partition-partition-1} - Successfully started server for partition PartitionId{id=1, group=raft-partition} in 10098ms </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:21:05.128572Z Created segment: JournalSegment{id=3, index=1570617} </span></span><span class="token-line" style="color:#393A34"><span class="token plain">D 2021-04-29T11:21:26.376398Z Created segment: JournalSegment{id=4, index=1584886} </span></span><span class="token-line" style="color:#393A34"><span class="token plain">I 2021-04-29T11:21:28.129677Z RaftPartitionServer{raft-partition-partition-2} - Successfully started server for partition PartitionId{id=2, group=raft-partition} in 51572ms </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We can see in the logs that the corruption is detected and the broker seems to stop, but actually it doesn&#x27;t.
After <code>Failed to start broker 2</code> the process should normally end. It looks like the thread for the other raft partitions are still running and continuing. This is a bug which I reported in one of my last chaos days,
see <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a>.</p><p>With this current behavior we could easily fix the snapshot corruption experiments, since we just need a separate clean up step. It could look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> k </span><span class="token builtin class-name">exec</span><span class="token plain"> -it zell-chaos-zeebe-2 -- </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -r data/raft-partition/partitions/3 </span><span class="token comment" style="color:#999988;font-style:italic"># remove partition three data</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> k delete pod zell-chaos-zeebe-2 </span><span class="token comment" style="color:#999988;font-style:italic"># restart broker 2</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I tried this and it worked, after some minutes the Broker-2 was able to come back.</p><p><img alt="success-after-fix.png" src="/zeebe-chaos/assets/images/success-after-fix-6c7506d3368e85a046fc4d0745965292.png"></p><p>Why does it work you may ask. If we remove the corrupted partition data from the follower and restart it, then it will join the cluster with an empty state. The Leader for that partition will immediately replicate the snapshot for that partition, such that the follower is up to date again. This allows the follower then to bootstrap without issues again.</p><p>One problem with this approach we have if we actually fix the bug above, where we&#x27;re not shutting down, then we have the issue that we might not be able to access the data, since the pod is not up. I need to do some more research to solve this, but one possible solution I can think of would be to patch the <em>StatefulSet</em>, such that we can claim the PV via multiple pods. This would allow us to start a separate POD in order to access the data and delete it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="found-bugs"></a>Found Bugs<a class="hash-link" href="#found-bugs" title="Direct link to heading">#</a></h2><ul><li>Broker is not shutting down properly <a href="https://github.com/camunda-cloud/zeebe/issues/6702" target="_blank" rel="noopener noreferrer">camunda-cloud/zeebe#6702</a></li></ul><p>{% if page.author %}<sup><em>Written by: {{page.author}}</em></sup>{% endif %}</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col col--3 text--right"><a aria-label="Read more about Corrupted Snapshot Experiment Investigation" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zeebe-chaos/assets/js/runtime~main.3edf790c.js"></script>
<script src="/zeebe-chaos/assets/js/main.63c64d72.js"></script>
</body>
</html>