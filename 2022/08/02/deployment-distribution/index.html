<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Blog Atom Feed"><title data-react-helmet="true">Bring Deployment distribution experiment back | Zeebe Chaos</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2022/08/02/deployment-distribution"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Bring Deployment distribution experiment back | Zeebe Chaos"><meta data-react-helmet="true" name="description" content="We encountered recently a severe bug zeebe#9877 and I was wondering why we haven&#x27;t spotted it earlier, since we have chaos experiments for it. I realized two things:"><meta data-react-helmet="true" property="og:description" content="We encountered recently a severe bug zeebe#9877 and I was wondering why we haven&#x27;t spotted it earlier, since we have chaos experiments for it. I realized two things:"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-08-02T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/zelldon"><meta data-react-helmet="true" property="article:tag" content="availability"><link data-react-helmet="true" rel="shortcut icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-react-helmet="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2022/08/02/deployment-distribution"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2022/08/02/deployment-distribution" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2022/08/02/deployment-distribution" hreflang="x-default"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.878b0132.css">
<link rel="preload" href="/zeebe-chaos/assets/js/runtime~main.ddb61ad1.js" as="script">
<link rel="preload" href="/zeebe-chaos/assets/js/main.adba556f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/zeebe-chaos/2022/08/02/deployment-distribution">Bring Deployment distribution experiment back</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2022/02/01/High-Snapshot-Frequency">High Snapshot Frequency</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2022/01/19/big-variables">Handling of Big Variables</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance">Worker count should not impact performance</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys">Not produce duplicate Keys</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/10/29/Throughput-on-big-state">Throughput on big state</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Bring Deployment distribution experiment back</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-08-02T00:00:00.000Z" itemprop="datePublished">August 2, 2022</time> Â· 10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/zelldon.png" alt="Christopher Zell"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>We encountered recently a severe bug <a href="https://github.com/camunda/zeebe/issues/9877" target="_blank" rel="noopener noreferrer">zeebe#9877</a> and I was wondering why we haven&#x27;t spotted it earlier, since we have chaos experiments for it. I realized two things:</p><ol><li>The experiments only check for parts of it (BPMN resource only). The production code has changed, and a new feature has been added (DMN) but the experiments/tests haven&#x27;t been adjusted.</li><li>More importantly we disabled the automated execution of the deployment distribution experiment because it was flaky due to a missing standalone gateway in Camunda Cloud SaaS <a href="https://github.com/zeebe-io/zeebe-chaos/issues/61" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-chaos#61</a>. This is no longer the case, see <a href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li></ol><p>On this chaos day I want to bring the automation of this chaos experiment back to life. If I have still time I want to enhance the experiment. </p><p><strong>TL;DR;</strong> The experiment still worked, and our deployment distribution is still resilient against network partitions. It also works with DMN resources. I can enable the experiment again, and we can close <a href="https://github.com/zeebe-io/zeebe-chaos/issues/61" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-chaos#61</a>. Unfortunately, we were not able to reproduce <a href="https://github.com/camunda/zeebe/issues/9877" target="_blank" rel="noopener noreferrer">zeebe#9877</a> but we did some good preparation work for it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="chaos-experiment"></a>Chaos Experiment<a class="hash-link" href="#chaos-experiment" title="Direct link to heading">#</a></h2><p>To recap, when a deployment is created by a client it is sent to the partition one leader. Partition one is in charge of distributing the deployment to the other partitions. That means it will send the deployment to the other partition leaders, this is retried as long no ACK was received from the corresponding partition leader.</p><p><img alt="deploymentDistribution" src="/zeebe-chaos/assets/images/deploymentDistribution-d300fff30d9d6cab27d9fe01c6504cd4.png"></p><p>We already have covered that in more detail in another chaos day you can read <a href="/zeebe-chaos/2021/01/26/deployments">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="expected"></a>Expected<a class="hash-link" href="#expected" title="Direct link to heading">#</a></h3><p><img src="/zeebe-chaos/assets/images/deploymentDistributionExperiment-8f120f1fafbca4d31ecf2fb0f8e909ba.png"></p><p>As you can see in the image we will create an asymmetric network partition and disconnect the partition one leader from partition three. That means the sending to partition three will not be possible. We use here an asymmetric network partition, in order to reduce the probability to cause a leader change. The partition one leader is a follower of partition three and will still receive heartbeats.</p><p>After disconnecting the leaders we deploy multiple process versions and after connecting the leaders again we expect that the deployments are distributed. It is expected that we can create instances of the last version on all partitions.</p><p>We will run the existing experiment against the latest minor version, to verify whether the experiment still works. When we enable the experiment again for automation it will be executed against SNAPSHOT automatically.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="actual"></a>Actual<a class="hash-link" href="#actual" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h4><p>As a first step, we created a new Production-S cluster, which has three partitions, three nodes (brokers), and two standalone gateways. The Zeebe version was set to 8.0.4 (latest minor).</p><p>It was a while since I used the <a href="https://chaostoolkit.org/" target="_blank" rel="noopener noreferrer">chaostoolkit</a> which is the reason I had to reinstall it again, which is quite a simple see <a href="https://chaostoolkit.org/reference/usage/install/" target="_blank" rel="noopener noreferrer">here</a>.</p><p>TL;DR:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sh"><pre tabindex="0" class="prism-code language-sh codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m venv ~/.venvs/chaostk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">source  ~/.venvs/chaostk/bin/activate</span></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install -U chaostoolkit</span></span><span class="token-line" style="color:#393A34"><span class="token plain">chaos --version</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="executing-chaos-toolkit"></a>Executing chaos toolkit<a class="hash-link" href="#executing-chaos-toolkit" title="Direct link to heading">#</a></h4><p>As mentioned, the deployment distribution was not enabled for Production-S clusters, which is currently the only configuration we test via <a href="https://github.com/zeebe-io/zeebe-cluster-testbench" target="_blank" rel="noopener noreferrer">Zeebe Testbench</a>. We have to use the experiment that is defined under <a href="https://github.com/zeebe-io/zeebe-chaos/tree/master/chaos-workers/chaos-experiments/camunda-cloud/production-l/deployment-distribution" target="_blank" rel="noopener noreferrer">production-l/deployment-distribution</a>, which is the same*.</p><sub>* That is not 100% true. During running the Production-l experiment I realized that it made some assumptions regarding the <a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-workers/chaos-experiments/scripts/disconnect-leaders-one-way.sh#L19" target="_blank" rel="noopener noreferrer">partition count</a> which needs to be adjusted for the Production-S setup.</sub><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sh"><pre tabindex="0" class="prism-code language-sh codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> chaos run production-l/deployment-distribution/experiment.json </span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Validating the experiment&#x27;s syntax</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Experiment looks valid</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Running experiment: Zeebe deployment distribution</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Steady-state strategy: default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Rollbacks strategy: default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Steady state hypothesis: Zeebe is alive</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Probe: All pods should be ready</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Steady state hypothesis is met!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Playing your experiment&#x27;s method now...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:25 INFO] Action: Enable net_admin capabilities</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:26 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:35:26 INFO] Pausing after activity for 180s...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:26 INFO] Probe: All pods should be ready</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:33 INFO] Action: Create network partition between leaders</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:34 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:34 INFO] Action: Deploy different deployment versions.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:40 INFO] Action: Delete network partition</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:42 INFO] Probe: Create process instance of latest version on partition one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:43 INFO] Probe: Create process instance of latest version on partition two</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:44 INFO] Probe: Create process instance of latest version on partition three</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:44 INFO] Steady state hypothesis: Zeebe is alive</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:44 INFO] Probe: All pods should be ready</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] Steady state hypothesis is met!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] Let&#x27;s rollback...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] No declared rollbacks, let&#x27;s move on.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 09:38:45 INFO] Experiment ended with status: completed</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Based on the tool output it looks like it succeed, to make sure it really worked, we will take a look at the logs in stackdriver.</p><p>In the following logs we can see that deployment distribution is failing for partition 3 and is retried, which is expected and what we wanted.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.114 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685347-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.115 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685347 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.157 CEST zeebe Received new exporter state {elasticsearch=228, MetricsExporter=228} </span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.157 CEST zeebe Received new exporter state {elasticsearch=228, MetricsExporter=228}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.241 CEST zeebe Received new exporter state {elasticsearch=232, MetricsExporter=232}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.241 CEST zeebe Received new exporter state {elasticsearch=232, MetricsExporter=232}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.464 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685351-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:53.466 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685351 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.216 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685353-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.218 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685353 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.224 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685355-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:54.225 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685355 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.055 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685359-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.057 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685359 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.689 CEST zeebe Received new exporter state {elasticsearch=299, MetricsExporter=299}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:55.690 CEST zeebe Received new exporter state {elasticsearch=299, MetricsExporter=299}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.089 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685357-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.090 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685357 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.272 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685363-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.273 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685363 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.920 CEST zeebe Failed to receive deployment response for partition 3 (on topic &#x27;deployment-response-2251799813685361-3&#x27;). Retrying</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:38:56.922 CEST zeebe Deployment DISTRIBUTE command for deployment 2251799813685361 was written on partition 3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-08-02 09:39:08.369 CEST zeebe Received new exporter state {elasticsearch=252, MetricsExporter=252}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>At some point, the retry stopped, and we can see in the experiment output that we were able to start process instances on all partitions. This is great because it means the experiment was successfully executed and our deployment distribution is failure tolerant.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="enhancement"></a>Enhancement<a class="hash-link" href="#enhancement" title="Direct link to heading">#</a></h4><p>As described earlier the current experiment deploys a BPMN process model only. It looks like this:</p><p><img alt="v1" src="/zeebe-chaos/assets/images/multiVersionModel-bae5089e350bb8e3ef1f11b3e01be25c.png"></p><p>In order to make DMN part of the experiment, we change the service task to a <a href="https://docs.camunda.io/docs/components/modeler/bpmn/business-rule-tasks/" target="_blank" rel="noopener noreferrer">Business Rule task</a>. </p><p><img alt="v2" src="/zeebe-chaos/assets/images/multiVersionModelv2-7fa903fb40c6a640222206e5922de001.png"></p><p>The decision is really simple and just defines a static input and returns that as output.</p><p><img alt="decision" src="/zeebe-chaos/assets/images/decision-3e1b9db140fbc19b0250ee1fd804a33d.png"></p><p>When we run our experiment and create process instances on all partitions the DMN needs to be available otherwise the execution would fail. Currently, we can&#x27;t specify a specific version of the DMN in the Business Rule Task (always the latest will be executed). Because of that, we will not deploy different DMN model versions, since it is currently not that easy to verify whether the right version was chosen. </p><p>After adjusting the model and adjusting the script, we run the experiment again.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$ chaos run production-l/deployment-distribution/experiment.json </span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Validating the experiment&#x27;s syntax</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Experiment looks valid</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Running experiment: Zeebe deployment distribution</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Steady-state strategy: default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Rollbacks strategy: default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Steady state hypothesis: Zeebe is alive</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:12 INFO] Probe: All pods should be ready</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Steady state hypothesis is met!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Playing your experiment&#x27;s method now...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Action: Enable net_admin capabilities</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:05:13 INFO] Pausing after activity for 180s...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:14 INFO] Probe: All pods should be ready</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:14 INFO] Action: Create network partition between leaders</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:16 WARNING] This process returned a non-zero exit code. This may indicate some error and not what you expected. Please have a look at the logs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:16 INFO] Action: Deploy different deployment versions.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:25 INFO] Action: Delete network partition</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:27 INFO] Probe: Create process instance of latest version on partition one</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:27 INFO] Probe: Create process instance of latest version on partition two</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:28 INFO] Probe: Create process instance of latest version on partition three</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Steady state hypothesis: Zeebe is alive</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Probe: All pods should be ready</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Steady state hypothesis is met!</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Let&#x27;s rollback...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] No declared rollbacks, let&#x27;s move on.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-08-02 11:08:29 INFO] Experiment ended with status: completed</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It succeeded as well.</p><p>Taking a look at Operate we can see some incidents.</p><p><img alt="dmn-error" src="/zeebe-chaos/assets/images/dmn-error-422b88cf3273e715c442c76ecce338d9.png"></p><p>It seems the process instance execution runs into the Business Rule Task, but the DMN resource was not available on the partition. </p><p><img alt="dmn-retry" src="/zeebe-chaos/assets/images/dmn-retry-665320690997b2566a40ac99505a2f84.png"></p><p>After retrying in Operate the incident was resolved, which means the DMN resource was distributed at that time.</p><p>We can adjust the experiment further to await the result of the process execution, but I will stop here and leave that for a later point.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="reproduce-our-bug"></a>Reproduce our bug<a class="hash-link" href="#reproduce-our-bug" title="Direct link to heading">#</a></h4><p>The current experiment didn&#x27;t reproduce the bug in <a href="https://github.com/camunda/zeebe/issues/9877" target="_blank" rel="noopener noreferrer">zeebe#9877</a>, since the DMN resource has to be distributed multiple times. Currently, we create a network partition such that the distribution doesn&#x27;t work at all. </p><p><img src="/zeebe-chaos/assets/images/deploymentDistributionExperimentV2-271448cf9bf1690fc24acdd0f89581d9.png"></p><p>In order to reproduce our scenario, we can set the network partition in the other direction, such that the acknowledgment is not received by the leader one.</p><p>Adjusting the experiment (script) like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI diff"><pre tabindex="0" class="prism-code language-diff codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">retryUntilSuccess disconnect &quot;$leader&quot; &quot;$leaderTwoIp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token deleted-sign deleted line" style="color:#d73a49"></span><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">retryUntilSuccess disconnect &quot;$leaderTwo&quot; &quot;$leaderIp&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Should do the trick, but I was not yet able to reproduce the issue with 8.0.4. It seems we need to spend some more time reproducing the bug. But I think with today&#x27;s changes we already did a good step in the right direction, and we can improve based on that. I will create a follow-up issue to improve our experiment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="further-work"></a>Further Work<a class="hash-link" href="#further-work" title="Direct link to heading">#</a></h2><p>Based on today&#x27;s outcome we can enable again the Deployment Distribution experiment for Production-S, such that is executed by Zeebe Testbench (our automation tooling). We can close <a href="https://github.com/zeebe-io/zeebe-chaos/issues/61" target="_blank" rel="noopener noreferrer">zeebe-io/zeebe-chaos#61</a></p><p>We should adjust our Chaos Worker implementation such that we also deploy DMN resources as we did in today&#x27;s Chaos Day, since the scripts we changed aren&#x27;t used in the automation.</p><p> I will create a follow-up issue to improve our experiment, so we can reproduce the critical bug.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="found-bugs"></a>Found Bugs<a class="hash-link" href="#found-bugs" title="Direct link to heading">#</a></h2><p><em>none</em></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/zeebe-chaos/tags/availability">availability</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2022-08-02-deployment-distribution/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Standalone Gateway in CCSaaS Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#chaos-experiment" class="table-of-contents__link">Chaos Experiment</a><ul><li><a href="#expected" class="table-of-contents__link">Expected</a></li><li><a href="#actual" class="table-of-contents__link">Actual</a></li></ul></li><li><a href="#further-work" class="table-of-contents__link">Further Work</a></li><li><a href="#found-bugs" class="table-of-contents__link">Found Bugs</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zeebe-chaos/assets/js/runtime~main.ddb61ad1.js"></script>
<script src="/zeebe-chaos/assets/js/main.adba556f.js"></script>
</body>
</html>